{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"source/images/WechatIMG3.jpeg","path":"images/WechatIMG3.jpeg","modified":0,"renderable":0},{"_id":"source/images/clipboard.png","path":"images/clipboard.png","modified":0,"renderable":0},{"_id":"source/images/WechatIMG4.jpeg","path":"images/WechatIMG4.jpeg","modified":0,"renderable":0},{"_id":"source/images/WechatIMG6.jpeg","path":"images/WechatIMG6.jpeg","modified":0,"renderable":0},{"_id":"source/images/gangji.jpeg","path":"images/gangji.jpeg","modified":0,"renderable":0},{"_id":"source/images/gitlab-runner.jpg","path":"images/gitlab-runner.jpg","modified":0,"renderable":0},{"_id":"source/images/how_single-spa_works.png","path":"images/how_single-spa_works.png","modified":0,"renderable":0},{"_id":"source/images/sync-process.png","path":"images/sync-process.png","modified":0,"renderable":0},{"_id":"source/images/strategy_pattern.jpg","path":"images/strategy_pattern.jpg","modified":0,"renderable":0},{"_id":"themes/pure/source/favicon.ico","path":"favicon.ico","modified":0,"renderable":1},{"_id":"source/images/WechatIMG1.jpeg","path":"images/WechatIMG1.jpeg","modified":0,"renderable":0},{"_id":"source/images/WechatIMG2.jpeg","path":"images/WechatIMG2.jpeg","modified":0,"renderable":0},{"_id":"source/images/WechatIMG28.jpeg","path":"images/WechatIMG28.jpeg","modified":0,"renderable":0},{"_id":"source/images/WechatIMG5.jpeg","path":"images/WechatIMG5.jpeg","modified":0,"renderable":0},{"_id":"source/images/clipboard2.png","path":"images/clipboard2.png","modified":0,"renderable":0},{"_id":"source/images/clipboard1.png","path":"images/clipboard1.png","modified":0,"renderable":0},{"_id":"source/images/gitlab-runner-job.png","path":"images/gitlab-runner-job.png","modified":0,"renderable":0},{"_id":"source/images/icon.png","path":"images/icon.png","modified":0,"renderable":0},{"_id":"source/images/svg_node.png","path":"images/svg_node.png","modified":0,"renderable":0},{"_id":"source/images/woff.png","path":"images/woff.png","modified":0,"renderable":0},{"_id":"themes/pure/source/fonts/README.md","path":"fonts/README.md","modified":0,"renderable":1},{"_id":"themes/pure/source/fonts/iconfont.eot","path":"fonts/iconfont.eot","modified":0,"renderable":1},{"_id":"themes/pure/source/fonts/iconfont.ttf","path":"fonts/iconfont.ttf","modified":0,"renderable":1},{"_id":"themes/pure/source/fonts/iconfont.woff","path":"fonts/iconfont.woff","modified":0,"renderable":1},{"_id":"themes/pure/source/images/avatar.jpg","path":"images/avatar.jpg","modified":0,"renderable":1},{"_id":"themes/pure/source/images/gangji.jpeg","path":"images/gangji.jpeg","modified":0,"renderable":1},{"_id":"themes/pure/source/js/application.js","path":"js/application.js","modified":0,"renderable":1},{"_id":"themes/pure/source/images/thumb-default.png","path":"images/thumb-default.png","modified":0,"renderable":1},{"_id":"themes/pure/source/images/xingqiu-qrcode.jpg","path":"images/xingqiu-qrcode.jpg","modified":0,"renderable":1},{"_id":"themes/pure/source/js/application.min.js","path":"js/application.min.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/insight.js","path":"js/insight.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/plugin.min.js","path":"js/plugin.min.js","modified":0,"renderable":1},{"_id":"source/images/envelop-mess.png","path":"images/envelop-mess.png","modified":0,"renderable":0},{"_id":"themes/pure/source/css/style.min.css","path":"css/style.min.css","modified":0,"renderable":1},{"_id":"themes/pure/source/images/favatar/SzsFox-logo.png","path":"images/favatar/SzsFox-logo.png","modified":0,"renderable":1},{"_id":"themes/pure/source/images/favatar/chuangzaoshi-logo.png","path":"images/favatar/chuangzaoshi-logo.png","modified":0,"renderable":1},{"_id":"themes/pure/source/images/donate/alipayimg.png","path":"images/donate/alipayimg.png","modified":0,"renderable":1},{"_id":"themes/pure/source/images/favatar/idesign-logo.png","path":"images/favatar/idesign-logo.png","modified":0,"renderable":1},{"_id":"themes/pure/source/images/donate/wechatpayimg.png","path":"images/donate/wechatpayimg.png","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/aes.js","path":"js/crypto-js/aes.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/cipher-core.js","path":"js/crypto-js/cipher-core.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/core.js","path":"js/crypto-js/core.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/enc-hex.js","path":"js/crypto-js/enc-hex.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/enc-base64.js","path":"js/crypto-js/enc-base64.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/enc-utf16.js","path":"js/crypto-js/enc-utf16.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/enc-utf8.js","path":"js/crypto-js/enc-utf8.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/enc-latin1.js","path":"js/crypto-js/enc-latin1.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/evpkdf.js","path":"js/crypto-js/evpkdf.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/format-openssl.js","path":"js/crypto-js/format-openssl.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/hmac-md5.js","path":"js/crypto-js/hmac-md5.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/hmac-sha224.js","path":"js/crypto-js/hmac-sha224.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/format-hex.js","path":"js/crypto-js/format-hex.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/hmac-ripemd160.js","path":"js/crypto-js/hmac-ripemd160.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/hmac-sha1.js","path":"js/crypto-js/hmac-sha1.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/hmac-sha3.js","path":"js/crypto-js/hmac-sha3.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/hmac-sha256.js","path":"js/crypto-js/hmac-sha256.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/hmac-sha384.js","path":"js/crypto-js/hmac-sha384.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/hmac.js","path":"js/crypto-js/hmac.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/index.js","path":"js/crypto-js/index.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/mode-cfb.js","path":"js/crypto-js/mode-cfb.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/hmac-sha512.js","path":"js/crypto-js/hmac-sha512.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/md5.js","path":"js/crypto-js/md5.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/lib-typedarrays.js","path":"js/crypto-js/lib-typedarrays.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/mode-ctr.js","path":"js/crypto-js/mode-ctr.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/mode-ctr-gladman.js","path":"js/crypto-js/mode-ctr-gladman.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/mode-ofb.js","path":"js/crypto-js/mode-ofb.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/mode-ecb.js","path":"js/crypto-js/mode-ecb.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/pad-ansix923.js","path":"js/crypto-js/pad-ansix923.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/pad-iso97971.js","path":"js/crypto-js/pad-iso97971.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/pad-iso10126.js","path":"js/crypto-js/pad-iso10126.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/pad-nopadding.js","path":"js/crypto-js/pad-nopadding.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/pad-pkcs7.js","path":"js/crypto-js/pad-pkcs7.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/pad-zeropadding.js","path":"js/crypto-js/pad-zeropadding.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/pbkdf2.js","path":"js/crypto-js/pbkdf2.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/rabbit.js","path":"js/crypto-js/rabbit.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/rabbit-legacy.js","path":"js/crypto-js/rabbit-legacy.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/rc4.js","path":"js/crypto-js/rc4.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/ripemd160.js","path":"js/crypto-js/ripemd160.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/sha224.js","path":"js/crypto-js/sha224.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/sha1.js","path":"js/crypto-js/sha1.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/sha256.js","path":"js/crypto-js/sha256.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/sha3.js","path":"js/crypto-js/sha3.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/sha384.js","path":"js/crypto-js/sha384.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/jquery.min.js","path":"js/jquery.min.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/plugin.js","path":"js/plugin.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/plugin.js.map","path":"js/plugin.js.map","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/sha512.js","path":"js/crypto-js/sha512.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/crypto-js/tripledes.js","path":"js/crypto-js/tripledes.js","modified":0,"renderable":1},{"_id":"source/images/splitter.gif","path":"images/splitter.gif","modified":0,"renderable":0},{"_id":"themes/pure/source/js/crypto-js/x64-core.js","path":"js/crypto-js/x64-core.js","modified":0,"renderable":1},{"_id":"themes/pure/source/css/style.css","path":"css/style.css","modified":0,"renderable":1},{"_id":"themes/pure/source/fonts/iconfont.svg","path":"fonts/iconfont.svg","modified":0,"renderable":1},{"_id":"source/images/search.jpg","path":"images/search.jpg","modified":0,"renderable":0},{"_id":"themes/pure/source/js/crypto-js/crypto-js.js","path":"js/crypto-js/crypto-js.js","modified":0,"renderable":1},{"_id":"source/images/repo.jpg","path":"images/repo.jpg","modified":0,"renderable":0},{"_id":"source/images/gitlab-runner-sample.png","path":"images/gitlab-runner-sample.png","modified":0,"renderable":0},{"_id":"source/images/macnotes.gif","path":"images/macnotes.gif","modified":0,"renderable":0}],"Cache":[{"_id":"source/.DS_Store","hash":"b0a5844d0c3c4d10179c89eb59cf05af12f3da30","modified":1613635191580},{"_id":"themes/pure/.DS_Store","hash":"323ddb919740e38cee711f5e8231022e02354d45","modified":1542975833126},{"_id":"themes/pure/LICENSE","hash":"c480fce396b23997ee23cc535518ffaaf7f458f8","modified":1541250703000},{"_id":"themes/pure/.gitignore","hash":"a21b2cee1dfa54443d0a67fb5608a82f008f3764","modified":1541927961000},{"_id":"themes/pure/README.cn.md","hash":"a634af4addbb57088935e060e8ec6035ea7bab76","modified":1541250703000},{"_id":"themes/pure/README.md","hash":"5861cec81712af9197a210fd5212d007aad8b0de","modified":1541250703000},{"_id":"themes/pure/_config.yml","hash":"607b94a87c3a13f2365a038dd6b1ea350805db64","modified":1542975858697},{"_id":"themes/pure/_config.yml.example","hash":"4714f87fdb6d4a6ea5ece84f4fe37f922337f14d","modified":1541250703000},{"_id":"themes/pure/package.json","hash":"a61723eead5cae2c4d9f0f05cf40d2de7c286fee","modified":1541250703000},{"_id":"source/_posts/2.记一次Icon没展示的bugfix.md","hash":"0953b580ff5a9780e5432da21264257db3204e50","modified":1611282448486},{"_id":"source/_posts/.DS_Store","hash":"87119c1efcec6ef8064d6feacfbc304a4db68177","modified":1542593262001},{"_id":"source/_posts/1.记一次koa转发请求遇到的bug.md","hash":"f64a698595309df6a4bea1f41e0343b1d1a68324","modified":1611282440659},{"_id":"source/_posts/2020年微前端踩坑回顾.md","hash":"ea4671c663dfaafa516ead44db061f0b79cf6509","modified":1612172501525},{"_id":"source/_posts/3.Referer理解错误导致的跨域.md","hash":"f653fe7cb5575b2f1f3cbb0948369be016cadc49","modified":1611282456422},{"_id":"source/_posts/4.Vue升级引发nextTick的bug(一).md","hash":"82d11466c62bc57c72b1db722c737ed5daa62a10","modified":1611663351629},{"_id":"source/_posts/5.Vue升级引发nextTick的bug(二).md","hash":"d07028435e4f7ea13b5ba0401cf389965763c08b","modified":1611838051556},{"_id":"source/_posts/Hexo-Github搭建静态博客-一.md","hash":"10c495582fb6411b526f5a72da1d71a478f4907f","modified":1582166083907},{"_id":"source/_posts/Hexo-Github搭建静态博客-二.md","hash":"42be7d58e8a7550f117cb8fccdaa9efcae4bf9fd","modified":1543198864426},{"_id":"source/_posts/JavaScript策略模式浅析.md","hash":"26f4a7c4f01327965f7d61c467a05fb2c876dda6","modified":1591269582127},{"_id":"source/_posts/SVG-Sprite优化滴滴云项目中的图标.md","hash":"4cb665f493050f45d761f399b3e0a9cb440f5c46","modified":1542946165451},{"_id":"source/_posts/Single-spa微服务化前端项目总结.md","hash":"747cef4f92294685ca85f0cda179e443c711eee8","modified":1592119720531},{"_id":"source/_posts/cross-site-cookies.md","hash":"615441c510f192de7339f5a3c381c6f7f418b638","modified":1604295801886},{"_id":"source/_posts/angular-splitter.md","hash":"51670f526cfeb7a1a3648eede7a8f88217ae567d","modified":1582166008949},{"_id":"source/_posts/bakery性能优化.md","hash":"7fa7b8ec473751b996daac1e5dddc949ca725127","modified":1541910418000},{"_id":"source/_posts/fork项目自动同步机器人.md","hash":"e1827d11e5440e987ed7314642282fbde643546b","modified":1582991446100},{"_id":"source/_posts/vue-cli4加载css重复？.md","hash":"fa692071ca6578b09e403070b4c3160cee230d57","modified":1584083966380},{"_id":"source/_posts/一次项目合并经历.md","hash":"9d45bd0c5e2c898a52a4aaf1f1394113503de953","modified":1569741904209},{"_id":"source/_posts/gitlab-CI和Docker前端自动化.md","hash":"221a8d51395ff5314d1533b3a7f6bd698c413236","modified":1571214722048},{"_id":"source/_posts/前端需要知道的nginx知识.md","hash":"0a8c8418f2db56a2e2f668e70440070de42d3e65","modified":1589727911223},{"_id":"source/_posts/信封弹出特效-可能是从业以来最复杂的效果.md","hash":"170469b90663f13ffda4e5f07f31ab0f1381f750","modified":1601374165081},{"_id":"source/_posts/如何使用GZIP来优化你的网站.md","hash":"076054121dcd69495a91714e9225e9ca61e9c0e7","modified":1541910427000},{"_id":"source/_posts/滴滴云控制台Selenium自动化测试初探.md","hash":"1424a3a9eee1d67e9778b3e7491cf743de6ae046","modified":1550138873225},{"_id":"source/_posts/证明：Click是一个EventLoop宏任务.md","hash":"83accb48449be61124ed624872f43f8ff1fc9192","modified":1611627127351},{"_id":"source/about/index.md","hash":"19e473cc71e639a7c443d9c856e208b143e53560","modified":1541741796000},{"_id":"source/categories/index.md","hash":"5d2a4f103d27bebbe3eef1604649d0f5c6d86ac6","modified":1541777426000},{"_id":"source/images/.DS_Store","hash":"65d6e211287e53942935f0fc52460033811a67f8","modified":1608792958099},{"_id":"source/images/WechatIMG3.jpeg","hash":"f9ecb69b1c2218e9cb5ba26b0b5e28cdfe6a9071","modified":1536830380000},{"_id":"source/images/clipboard.png","hash":"52236bc1d20f322ad4c7a778e7a1eecdff0ae2e4","modified":1504613318000},{"_id":"source/images/WechatIMG4.jpeg","hash":"307303c5f00baae0d2e6695553272134c5a2f965","modified":1536830381000},{"_id":"source/images/WechatIMG6.jpeg","hash":"0b4bd569c26c0585a6b34d27500af86ca68f2617","modified":1536830381000},{"_id":"source/images/gangji.jpeg","hash":"924ec9cd8227444336ec57b4c97d5e049152ff3d","modified":1541344364000},{"_id":"source/images/gitlab-runner.jpg","hash":"bf711978272398dfe593266c490c250ac168d589","modified":1571193222573},{"_id":"source/images/how_single-spa_works.png","hash":"310512f13f91f3bdad153bdfcd6e8ced70b0ebad","modified":1590891838667},{"_id":"source/images/sync-process.png","hash":"f82775206c936c539a4b994f3e0b44a0df73ed5a","modified":1582989182953},{"_id":"source/images/strategy_pattern.jpg","hash":"2285153bed25ef65ed82cab55fecd1f31b9cc350","modified":1591262253317},{"_id":"source/tags/index.md","hash":"42e9c904ea63b0a7dd4033e2e8f153225bc5cda5","modified":1541905189000},{"_id":"source/repository/index.md","hash":"c6b5ecbcea3a10aff68748c741d63d6be63dd4ff","modified":1541775944000},{"_id":"themes/pure/.git/HEAD","hash":"acbaef275e46a7f14c1ef456fff2c8bbe8c84724","modified":1541250703000},{"_id":"themes/pure/.git/COMMIT_EDITMSG","hash":"bbd0cb7d1d6c47a5efff639c3b8576170571047a","modified":1541928016000},{"_id":"themes/pure/.git/config","hash":"7ec6421043b0f1135362e6c04e1f42251478e733","modified":1541250703000},{"_id":"themes/pure/.git/description","hash":"9635f1b7e12c045212819dd934d809ef07efa2f4","modified":1541250668000},{"_id":"themes/pure/.git/index","hash":"782d247b6be8a9cc57afbd3036484dcf975969a1","modified":1541928016000},{"_id":"themes/pure/.git/packed-refs","hash":"3ddfd0f92192a4a6b3591f5b058d8797c32dedf2","modified":1541250703000},{"_id":"themes/pure/languages/default.yml","hash":"167ea0db98f4db156ea68c4644f64c0287ae2b6f","modified":1541250703000},{"_id":"themes/pure/languages/en.yml","hash":"167ea0db98f4db156ea68c4644f64c0287ae2b6f","modified":1541250703000},{"_id":"themes/pure/languages/zh-TW.yml","hash":"6d27c3114be539b8783ffce944f68b2e26a8c3b9","modified":1541250703000},{"_id":"themes/pure/languages/zh-CN.yml","hash":"057ebc043f09449af9768791c89c86dfc2938365","modified":1541250703000},{"_id":"themes/pure/layout/.DS_Store","hash":"b88706fe2a74afa4a60b8f666b8b252f5c067b10","modified":1541773745000},{"_id":"themes/pure/layout/about.ejs","hash":"4f5c769e183249b12eb9d3141432bc0039519730","modified":1541250703000},{"_id":"themes/pure/layout/archive.ejs","hash":"ded5d953b35666e30f4c6e48e2d2c62af8d95ebf","modified":1541250703000},{"_id":"themes/pure/layout/books.ejs","hash":"6c64719cd7071b5319b01339aa524fdaab391385","modified":1541250703000},{"_id":"themes/pure/layout/index.ejs","hash":"07825d8d8b21eb7b694f5585567b9df5c5a91a60","modified":1541250703000},{"_id":"themes/pure/layout/categories.ejs","hash":"2084974ba68f799216a8b216752f7fc87c693cc0","modified":1541250703000},{"_id":"themes/pure/layout/category.ejs","hash":"68632e8ac45088a929ca82b6cca8ba60323d6aac","modified":1541250703000},{"_id":"themes/pure/layout/links.ejs","hash":"77c5d1561e2c606c5b3bb39610133d84324074df","modified":1541250703000},{"_id":"themes/pure/layout/layout.ejs","hash":"a29ab2e881954a252bfc0dc1a7eb5aa52768dd2a","modified":1541250703000},{"_id":"themes/pure/layout/post.ejs","hash":"5c27475c176627e6e2e6a16172eb6980e56bcaff","modified":1541250703000},{"_id":"themes/pure/layout/page.ejs","hash":"5c27475c176627e6e2e6a16172eb6980e56bcaff","modified":1541250703000},{"_id":"themes/pure/layout/repository.ejs","hash":"fe4b3e051a8b0debe9ee22c2cc2cc935d92ee23f","modified":1541250703000},{"_id":"themes/pure/layout/tag.ejs","hash":"6e4e6660cf58beb3e5e2e52b59c51393e4796c36","modified":1541250703000},{"_id":"themes/pure/layout/tags.ejs","hash":"4c0b797a45cf238be367932927edc88599aa3255","modified":1541250703000},{"_id":"themes/pure/scripts/thumbnail.js","hash":"e667a611f9baac270281b765832020d50bf8fb7f","modified":1541250703000},{"_id":"themes/pure/scripts/.DS_Store","hash":"1c00a1087b86e6b62d3553f2a555f6d355da811e","modified":1541773779000},{"_id":"themes/pure/source/.DS_Store","hash":"ea3446b6c0b3e7727a0a8ab4b042bfb454fe3da2","modified":1542508904886},{"_id":"themes/pure/source/favicon.ico","hash":"e62c2ce1630ea9971b3fc0a4c5e7169db942b1df","modified":1542975776229},{"_id":"source/images/WechatIMG1.jpeg","hash":"d2fa527dd5dce7d6b8ba975e217f3013876d1ee7","modified":1536830379000},{"_id":"source/images/WechatIMG2.jpeg","hash":"86295dd6643165cf998e75a27358033cb4f8a07f","modified":1536830380000},{"_id":"source/images/WechatIMG28.jpeg","hash":"aa669322366eb2b78e04391d6cbdff101ca2d162","modified":1541309829000},{"_id":"source/images/WechatIMG5.jpeg","hash":"fd0479596433eaa00e897a2c10f38869fee0bbf1","modified":1536830381000},{"_id":"source/images/clipboard2.png","hash":"3966dcb05e9cec629866f863929ace0b3f20be2c","modified":1504613318000},{"_id":"source/images/clipboard1.png","hash":"e077a8d685ba1a398a17dbc839b414cc251eb5e6","modified":1504613318000},{"_id":"source/images/gitlab-runner-job.png","hash":"635e81150f231c1791a7a9ad38c01e66acf8042d","modified":1571193933697},{"_id":"source/images/icon.png","hash":"e1dd3f89bb2fd5c5aacaec75a8d56901201ab41f","modified":1608723477954},{"_id":"themes/pure/screenshot/pure-theme-black.png","hash":"10b40f398af7eb7e8ba2bf2f2a959d8779fc1fe1","modified":1541250703000},{"_id":"themes/pure/screenshot/pure-theme-blue.png","hash":"6146890a68d5ea9d343c48d50151ddd5a2a1872c","modified":1541250703000},{"_id":"themes/pure/screenshot/pure-theme-green.png","hash":"12ec0c6033cb2762839fdf75434bbb4fbf946022","modified":1541250703000},{"_id":"themes/pure/screenshot/pure-theme-purple.png","hash":"9855d2eb0acd23370209354f232471df8f4f72e2","modified":1541250703000},{"_id":"themes/pure/screenshot/pure.png","hash":"8f4cfd8d7edfa4fbffdf375291302d9807f5cc1c","modified":1541250703000},{"_id":"source/images/svg_node.png","hash":"ca77e5dcae5347a20db41d60df21dccd0a674f74","modified":1542942639253},{"_id":"source/images/woff.png","hash":"9ecfdf8606687f4b86fe13c5076da60af59e9179","modified":1608713402003},{"_id":"themes/pure/.git/hooks/commit-msg.sample","hash":"ee1ed5aad98a435f2020b6de35c173b75d9affac","modified":1541250668000},{"_id":"themes/pure/.git/hooks/post-update.sample","hash":"b614c2f63da7dca9f1db2e7ade61ef30448fc96c","modified":1541250668000},{"_id":"themes/pure/.git/hooks/applypatch-msg.sample","hash":"4de88eb95a5e93fd27e78b5fb3b5231a8d8917dd","modified":1541250668000},{"_id":"themes/pure/.git/hooks/pre-commit.sample","hash":"36aed8976dcc08b5076844f0ec645b18bc37758f","modified":1541250668000},{"_id":"themes/pure/.git/hooks/pre-applypatch.sample","hash":"f208287c1a92525de9f5462e905a9d31de1e2d75","modified":1541250668000},{"_id":"themes/pure/.git/hooks/pre-push.sample","hash":"5c8518bfd1d1d3d2c1a7194994c0a16d8a313a41","modified":1541250668000},{"_id":"themes/pure/.git/hooks/pre-rebase.sample","hash":"18be3eb275c1decd3614e139f5a311b75f1b0ab8","modified":1541250668000},{"_id":"themes/pure/.git/hooks/pre-receive.sample","hash":"705a17d259e7896f0082fe2e9f2c0c3b127be5ac","modified":1541250668000},{"_id":"themes/pure/.git/hooks/prepare-commit-msg.sample","hash":"2b6275eda365cad50d167fe3a387c9bc9fedd54f","modified":1541250668000},{"_id":"themes/pure/.git/hooks/update.sample","hash":"e729cd61b27c128951d139de8e7c63d1a3758dde","modified":1541250668000},{"_id":"themes/pure/.git/info/exclude","hash":"c879df015d97615050afa7b9641e3352a1e701ac","modified":1541250668000},{"_id":"themes/pure/.git/logs/HEAD","hash":"c04df8b3d1bc4c86420e8b6605227703803e22be","modified":1541928016000},{"_id":"themes/pure/_source/_data/gallery.yml","hash":"e2b3fad87be3d1cfde1effa655d39678ee90907e","modified":1541250703000},{"_id":"themes/pure/_source/_data/links.yml","hash":"aa443a4508550820c77c2a4f6abff1d38ad85054","modified":1541250703000},{"_id":"themes/pure/_source/404/index.md","hash":"8d493f624fdd29c8d0266767e56f343d549e16d8","modified":1541250703000},{"_id":"themes/pure/_source/about/index.md","hash":"9c95cabb533409d06daefc4295021ad199761efc","modified":1541250703000},{"_id":"themes/pure/_source/books/index.md","hash":"cf4163959c23244059cbbbc1c0fe379cc3b2cb73","modified":1541250703000},{"_id":"themes/pure/_source/categories/index.md","hash":"5d2a4f103d27bebbe3eef1604649d0f5c6d86ac6","modified":1541250703000},{"_id":"themes/pure/_source/links/index.md","hash":"febcf87eb0ab3c5080578275d25f3970bba39625","modified":1541250703000},{"_id":"themes/pure/_source/repository/index.md","hash":"ed0e082c30f233dd5c140d188f1e4bce44bdbf79","modified":1541250703000},{"_id":"themes/pure/_source/tags/index.md","hash":"42e9c904ea63b0a7dd4033e2e8f153225bc5cda5","modified":1541250703000},{"_id":"themes/pure/layout/_common/head.ejs","hash":"a48ef0fa22712b29ec044b9e5134461f3a21c10d","modified":1541250703000},{"_id":"themes/pure/layout/_common/header.ejs","hash":"3d739d1e2b2991927c08ec222db123830a44a519","modified":1541250703000},{"_id":"themes/pure/layout/_common/footer.ejs","hash":"cdc48ec70d9202b947f2a9334234d038d7014a7d","modified":1541250703000},{"_id":"themes/pure/layout/_common/social.ejs","hash":"a35a2610e9da762df96587b76b51470507a88cad","modified":1541250703000},{"_id":"themes/pure/layout/_common/script.ejs","hash":"d783415318f9c649275902fe1af25fe8c71567f8","modified":1541774312000},{"_id":"themes/pure/layout/_partial/archive-book.ejs","hash":"977f97f3636947006ad738e502858c46d4cd5ec7","modified":1541250703000},{"_id":"themes/pure/layout/_partial/archive-link.ejs","hash":"fe4d9bf526d8176683cea89b8561ced571374db0","modified":1541250703000},{"_id":"themes/pure/layout/_partial/archive-category.ejs","hash":"9c364fd6b5172890784141802f5f466241d233fd","modified":1541250703000},{"_id":"themes/pure/layout/_partial/archive-list.ejs","hash":"c66c86d6a6a90e00494c380603426fc0f4006311","modified":1541250703000},{"_id":"themes/pure/layout/_partial/archive-post.ejs","hash":"13039fec017332029122ef99901755fcecbfc8ea","modified":1541250703000},{"_id":"themes/pure/layout/_partial/archive-repository.ejs","hash":"e39dc762d9fe238cede462532e40eaa3d8651122","modified":1541250703000},{"_id":"themes/pure/layout/_partial/archive.ejs","hash":"4d6793f50d41fbd47dc50aa36b24d496006bba6c","modified":1541250703000},{"_id":"themes/pure/layout/_partial/article-about.ejs","hash":"7b80319daeb63401d1745b81cd9a6d1d21a4fb60","modified":1541250703000},{"_id":"themes/pure/layout/_partial/archive-tag.ejs","hash":"5de90244c3cedad531cccc03c40e5f9a3aef3c61","modified":1541250703000},{"_id":"themes/pure/layout/_partial/item-post.ejs","hash":"9f755b0da1ea928dece32c2050d8a04b3a9fb13b","modified":1541250703000},{"_id":"themes/pure/layout/_partial/pagination.ejs","hash":"41a319642da5af07d6cfb8525796aa610b721879","modified":1541250703000},{"_id":"themes/pure/layout/_partial/sidebar-about.ejs","hash":"e10ea0176ba87e64888234bafedc01c92544352c","modified":1541250703000},{"_id":"themes/pure/layout/_partial/sidebar-toc.ejs","hash":"152538ceceb0fdef65c46470ebf0189f7b891c5b","modified":1541250703000},{"_id":"themes/pure/layout/_partial/sidebar.ejs","hash":"2aa8a9f90838e7c105e75e6d3d03cbf860bb1239","modified":1541250703000},{"_id":"themes/pure/layout/_partial/article.ejs","hash":"0f9b71de0087d1f777d92c5a0f3873971aec5a5b","modified":1541250703000},{"_id":"themes/pure/layout/_script/.DS_Store","hash":"ee51e42712b1b8618ff17da9dbeca305d769ddb2","modified":1541771621000},{"_id":"themes/pure/layout/_script/analytics.ejs","hash":"e756a81f8c20a187fb863b9689f2f1fa15e2f4e1","modified":1541250703000},{"_id":"themes/pure/layout/_script/comment.ejs","hash":"6f951510bab9dc15474b6664e0329defccf29a30","modified":1541250703000},{"_id":"themes/pure/layout/_script/douban.ejs","hash":"143087db0573772b0bdaf7f93312553158942ec7","modified":1541250703000},{"_id":"themes/pure/layout/_script/fancybox.ejs","hash":"8f1be01e70a15b2c31ae57d8c6bce54622ebf8a7","modified":1541250703000},{"_id":"themes/pure/layout/_script/mathjax.ejs","hash":"f618393ab971b2faa80d541f2e6a553d9ace9816","modified":1541250703000},{"_id":"themes/pure/layout/_script/pv.ejs","hash":"fb9b5f16029f2ccef4b83cf4facfdcdd748b65b4","modified":1541250703000},{"_id":"themes/pure/layout/_script/repository.ejs","hash":"10829b843aea546216e05c99932c8fd61ae84a70","modified":1541774558000},{"_id":"themes/pure/layout/_script/search.ejs","hash":"7be33dc260ce788aa1a2cd3bd0386d95057533cb","modified":1541250703000},{"_id":"themes/pure/layout/_search/baidu.ejs","hash":"67aab280a3ea34429f086cc5c3de7de17727c567","modified":1541250703000},{"_id":"themes/pure/layout/_search/index-mobile.ejs","hash":"c726e234c0166da69fdfbd3dd613a5eaf4c80258","modified":1541250703000},{"_id":"themes/pure/layout/_search/index.ejs","hash":"f8d5a9c3f777250f5fb6512bba585307f784d5cd","modified":1541250703000},{"_id":"themes/pure/layout/_search/insight.ejs","hash":"4af3e92ef98bedba9680d45699cb04dde4640536","modified":1541250703000},{"_id":"themes/pure/layout/_search/swiftype.ejs","hash":"4baeca36e410181300ae7d47ba1fb4755bcfcff0","modified":1541250703000},{"_id":"themes/pure/layout/_widget/archive.ejs","hash":"af8ad7f62877764b75d5272d9d899fd6c8e3845c","modified":1541250703000},{"_id":"themes/pure/layout/_widget/board.ejs","hash":"acd27451be52703e670ce0b313f2da6fa24071e4","modified":1541250703000},{"_id":"themes/pure/layout/_widget/category.ejs","hash":"331b7642a0f58b9088b937436ab39076a4c5dd7e","modified":1541250703000},{"_id":"themes/pure/layout/_widget/recent_posts.ejs","hash":"8942d60311797a591ba2d157c5cdd23e85ceb694","modified":1541250703000},{"_id":"themes/pure/layout/_widget/tag.ejs","hash":"487628925da5fcac91463cdad3d9e55d071bd5ed","modified":1541250703000},{"_id":"themes/pure/layout/_widget/tagcloud.ejs","hash":"3291108e5411c48b2c5b3e17adace6ffa90d1c29","modified":1541250703000},{"_id":"themes/pure/source/fonts/README.md","hash":"c5772b99ad81291fb137b330813f866bdceea0a3","modified":1541250703000},{"_id":"themes/pure/source/fonts/iconfont.eot","hash":"6819d9bb643bdeafc17bfecb0746ae641b018fdf","modified":1541250703000},{"_id":"themes/pure/source/fonts/iconfont.ttf","hash":"9b8837f9f79cf6ab794736301d0665345183a20c","modified":1541250703000},{"_id":"themes/pure/source/fonts/iconfont.woff","hash":"78d29194287b8885d25212048c4f787705212a6e","modified":1541250703000},{"_id":"themes/pure/source/images/avatar.jpg","hash":"f86eafc318f3900319b25057811720168f24d248","modified":1541250703000},{"_id":"themes/pure/source/images/gangji.jpeg","hash":"924ec9cd8227444336ec57b4c97d5e049152ff3d","modified":1541310497000},{"_id":"themes/pure/source/js/application.js","hash":"46d1fb207ce5f0acb83803f927985dfcea86f9ef","modified":1541250703000},{"_id":"themes/pure/source/images/thumb-default.png","hash":"e8403b97ed9251f9f5207765b0ce796c5000b4ba","modified":1541250703000},{"_id":"themes/pure/source/images/xingqiu-qrcode.jpg","hash":"ef2c2848dc79db6df7c752510651ed8ba57f2daf","modified":1541250703000},{"_id":"themes/pure/source/js/application.min.js","hash":"34d765e982c7d6360c37f82202d99f63ac40e408","modified":1541250703000},{"_id":"themes/pure/source/js/insight.js","hash":"298e8ca42517984bd26f34caa4c45560b0e909ad","modified":1541250703000},{"_id":"themes/pure/source/js/.DS_Store","hash":"bc9473a66caf7a9f5b3a1056cdf6afba519717f6","modified":1541773745000},{"_id":"themes/pure/source/images/.DS_Store","hash":"fee9f5830be7051250155772d56a05e2c970bdff","modified":1541342238000},{"_id":"themes/pure/source/js/plugin.min.js","hash":"07fe34638f9832702c5f81d8583c5e4e8b3d9659","modified":1541250703000},{"_id":"source/images/envelop-mess.png","hash":"7f544385ca1b5817e6eb3404a1c351654b8e1b95","modified":1601362316904},{"_id":"themes/pure/.git/objects/00/36e2b887c69f0ae89073354a3792b88c20dfdd","hash":"2392afee43a536b8c84cbd01f4fca2180b899569","modified":1541927899000},{"_id":"themes/pure/.git/objects/00/effdfb2de64f03ae744669098f027f4d27087d","hash":"78af720ed49c150eff44d019ac808ca28889a249","modified":1541927840000},{"_id":"themes/pure/.git/objects/14/7601dac63ead8e570863d19bdf164c0e53e8da","hash":"94289909392e1576e86c6883554e6aac361dd322","modified":1541928016000},{"_id":"themes/pure/.git/objects/0b/570cbc31a5651d1a9287028848a1252b7f56c3","hash":"0a964fb2ecfbac96bf799c144ddcfd370638362b","modified":1541927899000},{"_id":"themes/pure/.git/objects/12/48804966613af18ce1ab4d65f19edaef32e11e","hash":"af985d77485c34391337e9e65d294354c8b7d9af","modified":1541927899000},{"_id":"themes/pure/.git/objects/12/58251a58f9c46b68d9d7552680fa2010c25704","hash":"d1c524170b27d1a92f7f1ed950dcd3948c17b8bf","modified":1541927899000},{"_id":"themes/pure/.git/objects/12/b0fdd4b4f00066c52969ead2bac439f668df2d","hash":"c1c8f8aa57975950c3afbbe6a422edab2156dd4e","modified":1541927899000},{"_id":"themes/pure/.git/objects/0e/8a859cfdcf13f16127ff18e7988e2c4f745a5b","hash":"2857147fc5fa9765cfbad1d8a359ff4db0796335","modified":1541927899000},{"_id":"themes/pure/.git/objects/0e/4bdff517f01602ac862305889b2fbaeee1bf36","hash":"3e007018cc62bab38e6386e646e4944379236963","modified":1541927899000},{"_id":"themes/pure/.git/objects/1b/0683362026c7143324e142515310e6f80fde00","hash":"7450271a28b2b8b1aeaf668e86548c7407e1dde9","modified":1541927899000},{"_id":"themes/pure/.git/objects/24/feb47c75f2ba14079a0fe0b2ec44e7bfc5f8b3","hash":"3bbc9fb0600005298cd431647991c056812d72a5","modified":1541927899000},{"_id":"themes/pure/.git/objects/1d/70e60c08e122d925dbad13594bf49312268c4b","hash":"35e6e56048e2893bd8fe25e5991a6c9cc5a6b874","modified":1541928016000},{"_id":"themes/pure/.git/objects/28/e34c13c1ebedfc2ffdd22a0c9cd8aa0af7cca9","hash":"b0d2b6c1baaef03b77c9ca135b2dd23e3f4e5fa5","modified":1541927899000},{"_id":"themes/pure/.git/objects/2e/9a861f0cbaedcdc97a65034acb7ae590cd70e3","hash":"17cf46f7a41951b95d67e68a864e2abaeaeb1aec","modified":1541927899000},{"_id":"themes/pure/.git/objects/33/73edc6a66fbaaaa5f31e22d230bb56ca7e1a42","hash":"8ee21d07fb75b0c89db22cbf60e1eb6f6dc0dbef","modified":1541927899000},{"_id":"themes/pure/.git/objects/33/5931585567e61d38c9fd4e1dfa96d3008051e1","hash":"f252a57e5275e98af639ab45d90db22385091221","modified":1541927899000},{"_id":"themes/pure/.git/objects/35/55168566e57e7baf9e13cdd48002ed92f8ea3e","hash":"cf068cc92595513705f36f7738765166cc91039e","modified":1541927899000},{"_id":"themes/pure/.git/objects/3f/e5c01c843aa766a8138a08981740e0fbd9eb65","hash":"3fa14d716a666d5e1218ffbacdaf7e78fcf3ee59","modified":1541927899000},{"_id":"themes/pure/.git/objects/33/b0c9fec202fd6a2262ace762f4e32156eb4c40","hash":"3ba243f4b02e253bc6775abe724a7d7d31c891a2","modified":1541927899000},{"_id":"themes/pure/.git/objects/41/049b45fc335ce11af619c9af5622fc5cda4621","hash":"c6456a946544351c44e353386513831b76fedb9e","modified":1541927899000},{"_id":"themes/pure/.git/objects/50/8d512772164ea04bec7b6d3ecc6fe0e1d6caec","hash":"56eb34b0f7ddeffde06d7a8ee8411a05cfde7cee","modified":1541927899000},{"_id":"themes/pure/.git/objects/4f/b27fe45e180331a225ada078d3311bab123bc8","hash":"22874aeb823151678efcff27d562ad48f79a0fff","modified":1541927899000},{"_id":"themes/pure/.git/objects/57/dcc144b042207243d12dc0a488545ea4d794e6","hash":"b0810507deb2c7f0dc3ccb4914de79b9474380bd","modified":1541927899000},{"_id":"themes/pure/.git/objects/66/9114962a3ffcaebcf98cff345d2043f6ae5e45","hash":"b98dfc348f7a81d1b37434b7862ce83b2aa9aea3","modified":1541927899000},{"_id":"themes/pure/.git/objects/37/78863ac416f03e7ffff1dc69c13f35628e7e5c","hash":"1d2fc462a6639af8cc94d1757ada5081e1a6ebdc","modified":1541927899000},{"_id":"themes/pure/.git/objects/26/4b210742682d09a07094f3ccda90064fb6b0cf","hash":"bf410b59682b76fec2bb377b769f9efd0ee732ad","modified":1541927899000},{"_id":"themes/pure/.git/objects/6e/2aefd8394228ed4573b4294ff7f7a6a65649f1","hash":"55f096d1287623924d40a762cc38fde3d20df14f","modified":1541927899000},{"_id":"themes/pure/.git/objects/73/d55a77013f5d8b318d2e6bc550e203aae78697","hash":"de6675d79c834dc03f852c101460a0c75acd5af8","modified":1541927899000},{"_id":"themes/pure/.git/objects/75/1c816684ac75ee23ed9aa1ed796f63b642ec7b","hash":"a6c2a156323dc7af80d7d063fe43562dabba1177","modified":1541927899000},{"_id":"themes/pure/.git/objects/86/231f1b3f1e376f25fb566e654e742f6f860d28","hash":"ee518c7dd1f4158a06aabe0529e0d457409d1b59","modified":1541927899000},{"_id":"themes/pure/.git/objects/7d/e62457a52e57f3cf3dc53db0023764bc522920","hash":"55d58202ccb884bd4e29d8b94c51c29165013cb5","modified":1541927899000},{"_id":"themes/pure/.git/objects/88/161ff5f629c5b7a14598614c4e9df7a677e4f8","hash":"263e8018a2f7a5eae3db88ad6ebf72816d74218f","modified":1541927899000},{"_id":"themes/pure/.git/objects/8c/098511429d0c01ebd7adb44df4acaacdf2ae25","hash":"a11f8420cdaead93132c091531205bfa81458a7a","modified":1541927899000},{"_id":"themes/pure/.git/objects/75/6d8e6e58e7fbaacb1ef6ceb272d60b9f01487c","hash":"b10dbf3ce9b206d5b42380ad91e73132232b22a8","modified":1541927840000},{"_id":"themes/pure/.git/objects/8c/56079e1cb3cf819cb0f1ea37edbd146f2ac130","hash":"58dc0d1c4a96d83df770ab360d71f4d6cce80705","modified":1541927840000},{"_id":"themes/pure/.git/objects/51/1a0e6137cdde0c1b946559f15ef44ebb044949","hash":"5573486a74e6ad9b9babb52456a82e960e93f3d1","modified":1541928016000},{"_id":"themes/pure/.git/objects/a0/b95bf6328b2dae9d44554f35dfce7c82d57407","hash":"ddd200a8c342ce8d9febb58ba99423efb35b9753","modified":1541927899000},{"_id":"themes/pure/.git/objects/a0/7356c36a1abdfbf70f4623ad83299cabb705c3","hash":"3c68ba3eb83a3dc706a347db8c85c4bca7767cf6","modified":1541927840000},{"_id":"themes/pure/.git/objects/a7/eb0c8c45d0850e926cd141aa594bfe6ceaae99","hash":"0d377f9b3493ac6ffdb462f2c9bd3c3c4c3e8e4b","modified":1541927840000},{"_id":"themes/pure/.git/objects/90/ea85dc3a80cf38e3d0e0494b712e15c5193218","hash":"de9bbe49e9d8c3387d75bd0713911fe026e30ebe","modified":1541927840000},{"_id":"themes/pure/.git/objects/ad/e56dcd49425fdaac7bd87645f5592a39d31d9a","hash":"589318a21cc50838d3e63c9d0a22b3162eeefd87","modified":1541927899000},{"_id":"themes/pure/.git/objects/ad/7a90adc27f6b407f7d278d5c4bb21d0dd5ad0d","hash":"e256a37b3706fef87247fb000c0520eaacf071ce","modified":1541927899000},{"_id":"themes/pure/.git/objects/ba/41aff9854cabe841334c66689d2c09e61a0de0","hash":"42fa1d8806b12bc3196fc78f5464fa0651160fc7","modified":1541927840000},{"_id":"themes/pure/.git/objects/bb/c56876e3cf854f7620aae07c2125eb3dbb19a5","hash":"3b31e5e3b3d8217e97fa64e8b8be614d1b7627ff","modified":1541927899000},{"_id":"themes/pure/.git/objects/c0/1314c2284da6d92910ccb4d98e76f5e5fe1564","hash":"32a38504645b777e93032b87341ab97ab6100448","modified":1541927899000},{"_id":"themes/pure/.git/objects/c7/787c94d2e01d979ba45d2163b90ed05e902e35","hash":"6cd91b6c76349d9c6e1523c39b33a6883fcc3829","modified":1541927899000},{"_id":"themes/pure/.git/objects/c1/005b6ac5223132073e0183e090c4c02eb9cb87","hash":"2e244cc64c4c844b29ba610cf867c50d6525f0f4","modified":1541927899000},{"_id":"themes/pure/.git/objects/c7/becf3b70ad64bd271e718a73db61286f114356","hash":"45e7756a43f7874f1a51ced56bc1170122ce9775","modified":1541927899000},{"_id":"themes/pure/.git/objects/c3/d470a6fac667465c5fe460a85bd3a7ad1c70a5","hash":"a57bbc3bbae9a3d076e5493803926e1e1b408083","modified":1541927899000},{"_id":"themes/pure/.git/objects/c9/3556a71598fddb82ab62ed06c5d51e44cdb1de","hash":"63717d200a24a735648af204af805b994017d33d","modified":1541927899000},{"_id":"themes/pure/.git/objects/cf/7e4f056be34ece831e02ff9987379c374e24ff","hash":"c2f7ce8ed231703c0c15f3a629d1f51dc2ca0b39","modified":1541927840000},{"_id":"themes/pure/.git/objects/bd/9b65bae9797024eb4cf2988d94c6d963e5050b","hash":"5552580d9ea108382ddfe971d207bdd84a0c0d77","modified":1541928016000},{"_id":"themes/pure/.git/objects/d5/d40824d698242de4536c5c825beb43932560a6","hash":"6ad1531bdb650930744ce282e6e00d5668db4e4b","modified":1541927899000},{"_id":"themes/pure/.git/objects/cd/44c5cf09686b670b22716951c792099cd3dbc1","hash":"b6984819c8d8dedef705ed174e93951161e93bd8","modified":1541928016000},{"_id":"themes/pure/.git/objects/d8/ce9885268313ae356a655ed641c71f5163c4f2","hash":"d4aa0bd6131a3630c4889d94275eece55ff12dc5","modified":1541927899000},{"_id":"themes/pure/.git/objects/d9/988af897d2e5c6b64b4f7b4e647326ece514d0","hash":"50eb5a9c5d88cb7d806ca3ff417b2ea59fa0aed5","modified":1541927840000},{"_id":"themes/pure/.git/objects/de/2d7fca1019d0e23a0f85055f28aaf51b7e0f21","hash":"067117f2aeae858471fe6efc7b76e315f4f33731","modified":1541927899000},{"_id":"themes/pure/.git/objects/e1/18b6b6a28b3ddc6d1547e42f16f8f34715e486","hash":"c7422a1f7128916c491ae4406ca49fd3c7f32112","modified":1541927899000},{"_id":"themes/pure/.git/objects/e7/a251d885bd88af5a67078b3e65b866fd8de36d","hash":"67ee37a8b3c6b7448a265ecf0d48831e3f4d1ca2","modified":1541927899000},{"_id":"themes/pure/.git/objects/f2/2fe96fa573e665d69269ab6c6bf26abcc831b6","hash":"c1e7f398c29bc17a0d1309aab2ef9fbadc9ca8ef","modified":1541927840000},{"_id":"themes/pure/.git/objects/ff/0692175b6dd588c023f25b10798ee25bd6d374","hash":"eda1b627755c28e9b7b799e5e66c9f64a2e11b90","modified":1541927899000},{"_id":"themes/pure/.git/objects/dd/823c462f8f10c0cab5a55b1aad35840fc42b42","hash":"3fc0e47bc47c5cce1b248655519102ae7068fec0","modified":1541928016000},{"_id":"themes/pure/.git/refs/heads/master","hash":"13e49e76a07e482dfa7a79bc9720aa6fec5f7951","modified":1541928016000},{"_id":"themes/pure/.git/objects/f0/1f21e45cc2e54e78fe9968a42e4e0f9c5372e1","hash":"ea28ef012bcebc8994455e96f042c7e09424013b","modified":1541927899000},{"_id":"themes/pure/layout/_partial/post/comment.ejs","hash":"3c0da69fcea6ccfd97b82d50e740107a88eec5c4","modified":1541250703000},{"_id":"themes/pure/layout/_partial/post/category.ejs","hash":"fcee6b4aef8b6c4627831ff8dbb2d73478511426","modified":1541250703000},{"_id":"themes/pure/layout/_partial/post/copyright.ejs","hash":"a9d3d05428e5844a07706c7fcfeb842e44a36a64","modified":1541250703000},{"_id":"themes/pure/layout/_partial/post/date.ejs","hash":"7d4979652998abf92a64bfae8157b70d6e514057","modified":1541250703000},{"_id":"themes/pure/layout/_partial/post/donate.ejs","hash":"a251dc34d660601a2e8b7d98b3bfe2b9023dbbce","modified":1541250703000},{"_id":"themes/pure/layout/_partial/post/gallery.ejs","hash":"3d9d81a3c693ff2378ef06ddb6810254e509de5b","modified":1541250703000},{"_id":"themes/pure/layout/_partial/post/nav.ejs","hash":"95eabc0fe4033ec61b240a16eeaf7dc62a9e3da1","modified":1541250703000},{"_id":"themes/pure/layout/_partial/post/pv.ejs","hash":"ec3ccf322432afc2761f860c5a3000ac34d46e4c","modified":1541250703000},{"_id":"themes/pure/layout/_partial/post/tag.ejs","hash":"39f53ead07f75c181a7ba93e586dd1b8171620f1","modified":1541250703000},{"_id":"themes/pure/layout/_partial/post/thumbnail.ejs","hash":"080d5c5f3e95accf51893a7092695fe32d34a087","modified":1541250703000},{"_id":"themes/pure/layout/_partial/post/title.ejs","hash":"2f275739b6f1193c123646a5a31f37d48644c667","modified":1541250703000},{"_id":"themes/pure/layout/_partial/post/wordcount.ejs","hash":"bd06c4c8449ed96aabf655fe1ae3be1f0707b81e","modified":1541250703000},{"_id":"themes/pure/layout/_script/_analytics/baidu-analytics.ejs","hash":"f314be7860c1d5930f1600d010e3120ba5c85325","modified":1541250703000},{"_id":"themes/pure/layout/_script/_analytics/google-analytics.ejs","hash":"54f1dc9375cbdb65464e0ac1b58847aa5e8bc6a5","modified":1541250703000},{"_id":"themes/pure/layout/_script/_analytics/tencent-analytics.ejs","hash":"77defb41a1613a758ff5a6a5128c6107fc584190","modified":1541250703000},{"_id":"themes/pure/layout/_script/_search/baidu.ejs","hash":"9b60ffa2e2725a993e9cecfb81ddedd9b9361011","modified":1541250703000},{"_id":"themes/pure/layout/_script/_comment/disqus.ejs","hash":"a051e3eddc75586e69131c29ab8c89d69626e0fd","modified":1541250703000},{"_id":"themes/pure/layout/_script/_search/insight.ejs","hash":"ff1b56ee2022f7587bc14f847323187de9af6c16","modified":1541925597000},{"_id":"themes/pure/layout/_script/_comment/gitalk.ejs","hash":"fb01f1631c3ae7fe6211dc03233506cb344229be","modified":1541250703000},{"_id":"themes/pure/layout/_script/_comment/gitment.ejs","hash":"a64852076483395738a398deb4c10bdb0f3b7b71","modified":1541250703000},{"_id":"themes/pure/layout/_script/_comment/livere.ejs","hash":"5ab997d5ee4475d2f89f882fab4a52648dbe0e30","modified":1541250703000},{"_id":"themes/pure/layout/_script/_comment/valine.ejs","hash":"acf81f9a59dc45f197d723f70484de5fcd166577","modified":1541250703000},{"_id":"themes/pure/layout/_script/_comment/youyan.ejs","hash":"095649a173573d03b5845c2e331ec7be976b152a","modified":1541250703000},{"_id":"themes/pure/source/css/style.min.css","hash":"1d23abc76726ebe042f7df4749f00f8f73338444","modified":1541250703000},{"_id":"themes/pure/source/images/favatar/SzsFox-logo.png","hash":"d71fcc73b7bc2a439d8c7ba461137856d190bd76","modified":1541250703000},{"_id":"themes/pure/source/images/favatar/chuangzaoshi-logo.png","hash":"7fa5734072050952159a02d330bbc008b5a99122","modified":1541250703000},{"_id":"themes/pure/source/images/donate/alipayimg.png","hash":"9562f23f2eb57841c65dc769b6cc43a2cf0efa94","modified":1541250703000},{"_id":"themes/pure/source/images/favatar/idesign-logo.png","hash":"6b150a2dbb9912b7a7662255c27e4d4baaecee71","modified":1541250703000},{"_id":"themes/pure/source/images/donate/wechatpayimg.png","hash":"c0844d9a633696cb00ae64fde06f0f924f63b596","modified":1541250703000},{"_id":"themes/pure/source/js/crypto-js/.DS_Store","hash":"dcd9dd50bb4fc64a5d078e9d366c3e99d03992bc","modified":1541771802000},{"_id":"themes/pure/source/js/crypto-js/aes.js","hash":"556e1fe15241fae6398f21ed20ce3e0329361258","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/cipher-core.js","hash":"d52fe3d253eaffa687427bae6f4bb724a83ae641","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/core.js","hash":"a5069c6c029a404071b27f636c39173618abdfc5","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/enc-hex.js","hash":"27f6a54ae346ef0a9a63084990591e0f986bea38","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/enc-base64.js","hash":"9d0e75fb496975f6e2e33e5527d5cea5099f377f","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/enc-utf16.js","hash":"01f29539d0bc1e2c10638d0f3b9af99d978e15f7","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/enc-utf8.js","hash":"16bab2dd76daec10b9b3e2569f3fc1a207b5f726","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/enc-latin1.js","hash":"9753af5959867f998f0feffd6f1699e88c92f39e","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/evpkdf.js","hash":"8f5e0f356eb4abab5ba7d9babd5501f718508cc1","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/format-openssl.js","hash":"7507a0c1ccf7049a8a10bf2ed73f24af5ed00aa3","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/hmac-md5.js","hash":"143d92d0c7d56bc57036c318cf78dc50cd72b557","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/hmac-sha224.js","hash":"586cc496e368eb6f6119e0a6089ef7f8f421dee6","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/format-hex.js","hash":"a359182575c8d43c6e5381209472f8954e4d5496","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/hmac-ripemd160.js","hash":"29a848612a72b95abd8d8a9ee8d4874939fac6f0","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/hmac-sha1.js","hash":"8fbe2fbecb2caa64f74c0393f9f6641f78e3b732","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/hmac-sha3.js","hash":"0d8f8002491a9311c7035aaf07d4a0329f38ced0","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/hmac-sha256.js","hash":"84c60e2a1dce8f06c1e4340542199cc9cc9a3454","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/hmac-sha384.js","hash":"9196d839c46163f6e51c63410ba0076a09ccf178","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/hmac.js","hash":"d68f1ed4e3aed7807fe17a8193fca4775221dfa3","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/index.js","hash":"fc7dc46d4863a6115f5c18413b970256950f82ff","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/mode-cfb.js","hash":"19fafa837dd3d4fcca9f71fc4d175c432a51bc31","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/hmac-sha512.js","hash":"4b07089a6c56852d15ec948b58408d5b5d32cafd","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/md5.js","hash":"e626c530154c07527abcfb1f83b9ec578a81b234","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/lib-typedarrays.js","hash":"622fc0f297b3799ff91b08469989e6fe113cbda4","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/mode-ctr.js","hash":"591484053ed26919fa6e4cecf7aa723dcade4bb6","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/mode-ctr-gladman.js","hash":"cabbcc4100b4d363f1b55d42b930ec547ad67dd1","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/mode-ofb.js","hash":"4e97befa1e4d0003cd2fe9d21d85d6636513fdb4","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/mode-ecb.js","hash":"fe621e95709e31a5289c78d114aad4a920f14923","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/pad-ansix923.js","hash":"505018913484e110aa81842a4511a2a52cbf2231","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/pad-iso97971.js","hash":"b7034e19bcb012cf7549baea65a70d25b8e71480","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/pad-iso10126.js","hash":"9c081665a8d0f4399c5f3874f38f811932900d54","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/pad-nopadding.js","hash":"af4df0df185ab10e12fe8c01f885027eabe3c8f3","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/pad-pkcs7.js","hash":"d21f12b724eccd65c9f20503bdac2c41eb8ce985","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/pad-zeropadding.js","hash":"c352ca95390bcacdb5bfff71fec5bf38f2f5bf4f","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/pbkdf2.js","hash":"d9383ee2dc36eb56abadba701c3168d2556a7d8d","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/rabbit.js","hash":"4bd339e3a9e954c2766a07a96cf7ec2547e76cab","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/rabbit-legacy.js","hash":"23dc78f4b418c296ffc166bbcad8c678d6ab2efa","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/rc4.js","hash":"fbb684811bde18ce2faad2ffbda3aa9c00939e90","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/ripemd160.js","hash":"9187ea140085390e357f1e7804f95e7a5812d494","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/sha224.js","hash":"b10b13e02fadeea29119f6976b346d9b06c84342","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/sha1.js","hash":"7401e77dccaff4ecaab8e57fd11fccfaf5f33c75","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/sha256.js","hash":"7593f14b59ba2099cbb4ffb806e75758fdeb12f5","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/sha3.js","hash":"23b3c6147151e6df57339d29e96b53c415cb2eb7","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/sha384.js","hash":"8d7bb4a99b713d53723f8f1ad3442cf9e9edf9a4","modified":1481716853000},{"_id":"themes/pure/source/js/jquery.min.js","hash":"5a9dcfbef655a2668e78baebeaa8dc6f41d8dabb","modified":1541250703000},{"_id":"themes/pure/source/js/plugin.js","hash":"a8524d42b8621bfaa06602a163c6a1f82702b91d","modified":1541250703000},{"_id":"themes/pure/source/js/plugin.js.map","hash":"1730c0cc660f863120aca0a439d7264e2e245fc5","modified":1541250703000},{"_id":"themes/pure/source/js/crypto-js/sha512.js","hash":"43aedf4d42df77a699f889ebe9854df970771cf3","modified":1481716853000},{"_id":"themes/pure/source/js/crypto-js/tripledes.js","hash":"940ff5fc73a696fd7ef44b20ae74f7f7cebd6c8b","modified":1481716853000},{"_id":"source/images/splitter.gif","hash":"0b87f964aea00ddcdab43b30eb5344c6b439e1df","modified":1541309634000},{"_id":"themes/pure/source/js/crypto-js/x64-core.js","hash":"966f596f1adb7e7780021ae463a62890de8b19fc","modified":1481716853000},{"_id":"themes/pure/.git/objects/17/f2b1163a74d56fd16b4e2de193d975a0f464d2","hash":"a1d7cdbcdd9bad033c912ae17d6b1fce95a19583","modified":1541927899000},{"_id":"themes/pure/.git/objects/pack/pack-a8bbf079d9e5a98a3c3a4f24d030ed3082380192.idx","hash":"f266e38ee1ed76e6ba3dbc113ba0c21a660ea0c0","modified":1541250703000},{"_id":"themes/pure/source/css/style.css","hash":"3b693ce41c2e35ece4773593e94b4c17aeaee02f","modified":1541250703000},{"_id":"themes/pure/source/fonts/iconfont.svg","hash":"25929e6e74f7027acd1f6467a67e95b153bcd8d5","modified":1541250703000},{"_id":"source/images/search.jpg","hash":"a5b2738db8fe29244f2f738be7adf6a60a3b1ff4","modified":1541947952000},{"_id":"themes/pure/.git/logs/refs/heads/master","hash":"c04df8b3d1bc4c86420e8b6605227703803e22be","modified":1541928016000},{"_id":"themes/pure/.git/refs/remotes/origin/HEAD","hash":"d9427cda09aba1cdde5c69c2b13c905bddb0bc51","modified":1541250703000},{"_id":"themes/pure/source/js/crypto-js/crypto-js.js","hash":"3dd73b6f13dc818a3a9c5c7424c1c4a9649b00a2","modified":1481716853000},{"_id":"themes/pure/.git/logs/refs/remotes/origin/HEAD","hash":"ba24b9f0e26dc84e585c6e39ce2cb20d5fb1f306","modified":1541250703000},{"_id":"source/images/repo.jpg","hash":"1ba3d5f06d41485eea9638196a24945aeca81cfb","modified":1542074851000},{"_id":"source/images/gitlab-runner-sample.png","hash":"61d3fac8140db65e927c2fed04db314fd670a8d3","modified":1571213728476},{"_id":"source/images/macnotes.gif","hash":"b9a7377686ba07b39d4711dd8927bc8b2eb595eb","modified":1541309634000},{"_id":"themes/pure/screenshot/pure.psd","hash":"a31cea40b45bdc31f051fca2f1e2f4ecbaee1a94","modified":1541250703000},{"_id":"themes/pure/.git/objects/pack/pack-a8bbf079d9e5a98a3c3a4f24d030ed3082380192.pack","hash":"b09df110abc679521487510282785b20e0073c50","modified":1541928016000}],"Category":[{"name":"组件","_id":"ckrix8zds000pk1jf2ftye6on"}],"Data":[],"Page":[{"title":"迷你糊的老干爹","date":"2018-11-09T05:31:45.000Z","_content":"![小刚几](/images/WechatIMG1.jpeg)\n![小刚几](/images/WechatIMG2.jpeg)\n![小刚几](/images/WechatIMG3.jpeg)\n![小刚几](/images/WechatIMG4.jpeg)\n![小刚几](/images/WechatIMG5.jpeg)\n![小刚几](/images/WechatIMG6.jpeg)\n![小刚几](/images/WechatIMG28.jpeg)\n","source":"about/index.md","raw":"---\ntitle: 迷你糊的老干爹\ndate: 2018-11-09 13:31:45\n---\n![小刚几](/images/WechatIMG1.jpeg)\n![小刚几](/images/WechatIMG2.jpeg)\n![小刚几](/images/WechatIMG3.jpeg)\n![小刚几](/images/WechatIMG4.jpeg)\n![小刚几](/images/WechatIMG5.jpeg)\n![小刚几](/images/WechatIMG6.jpeg)\n![小刚几](/images/WechatIMG28.jpeg)\n","updated":"2018-11-09T05:36:36.000Z","path":"about/index.html","comments":1,"layout":"page","_id":"ckrix8zd70001k1jfvngooa24","content":"<p><img src=\"/images/WechatIMG1.jpeg\" alt=\"小刚几\"><br><img src=\"/images/WechatIMG2.jpeg\" alt=\"小刚几\"><br><img src=\"/images/WechatIMG3.jpeg\" alt=\"小刚几\"><br><img src=\"/images/WechatIMG4.jpeg\" alt=\"小刚几\"><br><img src=\"/images/WechatIMG5.jpeg\" alt=\"小刚几\"><br><img src=\"/images/WechatIMG6.jpeg\" alt=\"小刚几\"><br><img src=\"/images/WechatIMG28.jpeg\" alt=\"小刚几\"></p>\n","site":{"data":{}},"excerpt":"","more":"<p><img src=\"/images/WechatIMG1.jpeg\" alt=\"小刚几\"><br><img src=\"/images/WechatIMG2.jpeg\" alt=\"小刚几\"><br><img src=\"/images/WechatIMG3.jpeg\" alt=\"小刚几\"><br><img src=\"/images/WechatIMG4.jpeg\" alt=\"小刚几\"><br><img src=\"/images/WechatIMG5.jpeg\" alt=\"小刚几\"><br><img src=\"/images/WechatIMG6.jpeg\" alt=\"小刚几\"><br><img src=\"/images/WechatIMG28.jpeg\" alt=\"小刚几\"></p>\n"},{"title":"分类","layout":"categories","comments":0,"_content":"","source":"categories/index.md","raw":"---\ntitle: 分类\nlayout: categories\ncomments: false\n---\n","date":"2018-11-09T15:30:26.000Z","updated":"2018-11-09T15:30:26.000Z","path":"categories/index.html","_id":"ckrix8zda0003k1jfu3twgstn","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"项目","layout":"repository","comments":0,"sidebar":"none","_content":"","source":"repository/index.md","raw":"---\ntitle: 项目\nlayout: repository\ncomments: false\nsidebar: none\n---\n","date":"2018-11-09T15:05:44.000Z","updated":"2018-11-09T15:05:44.000Z","path":"repository/index.html","_id":"ckrix8zdd0006k1jfy3g4yfsf","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"标签","layout":"tags","comments":0,"_content":"","source":"tags/index.md","raw":"---\ntitle: 标签\nlayout: tags\ncomments: false\n---\n","date":"2018-11-11T02:59:49.000Z","updated":"2018-11-11T02:59:49.000Z","path":"tags/index.html","_id":"ckrix8zdf0008k1jf3naei44k","content":"","site":{"data":{}},"excerpt":"","more":""}],"Post":[{"title":"2.记一次Icon没展示的bugfix","date":"2020-12-23T09:49:28.000Z","_content":"> 滴滴云控制台为了升级vue，UI库和脚手架，使用qiankun做了拆分。拆分后的发现Icon的展示有问题。\n\n项目结构如下\n```\n|____node_modules\n| |____ui-lib\n| | |____index.css\n| | |____fonts\n| | | |____ui-lib.woff\n|____src\n| |____main.js\n```\n\nmain.js\n```\nimport 'ui-lib/index.css'\n```\n\nnode_modules中的ui-lib\n```\n@font-face{font-family:ui-lib;src:url(fonts/ui-lib.woff) format(\"woff\")}\n```\nvue.config.js\n```\nconst publicPath = process.env.NODE_ENV === \"production\" ? '//cdn.myservice.com/' : `/`;\nmodule.exports = {\n    publicPath,\n    configureWebpack: {\n        entry: { app:'./src/main.js'},\n        module: {\n            rules: [\n                {\n                    test: /\\.css$/,\n                    exclude: /node_modules/,\n                    use: [\n                      'style-loader',\n                      {\n                        loader: 'css-loader',\n                        options: {\n                          importLoaders: 1,\n                        },\n                      },\n                      {\n                        loader: \"postcss-loader\",\n                        options: {\n                          postcssOptions: {\n                          },\n                          execute: true,\n                        },\n                      },\n                    ],\n                },\n            ],\n        },\n    },\n    chainWebpack: config => {\n      const imgRule = config.module.rule('images');\n      imgRule.uses.clear();\n      imgRule\n        .use('file-loader')\n        .loader('file-loader')\n        .options({\n          name: 'img/[name].[hash:8].[ext]',\n          publicPath\n        })\n        .end()\n    },\n  }\n```\n\n编译后的文件app.css\n```\n@font-face{font-family:ui-lib;src:url(../fonts/ui-lib.woff) format(\"woff\")}\n```\n这里变成了`../fonts/ui-lib.woff`,而没有变成预期的`cdn.myservice.com/fonts/ui-lib.woff`。所以浏览器加载的时候path报错了。\n我最先尝试的是在configureWebpack.module.rules增加`url-loader`\n```\n{\n    test: /\\.(woff?|eot|ttf|otf)(\\?.*)?$/,\n    loader: 'url-loader',\n    query: {\n    limit: 2048,\n    name: 'fonts/[name].[hash:7].[ext]'\n    }\n},\n```\n结果顺利的被解析成了base64。而base64的内容是`module.exports = __webpack_public_path__ + \"node_modules/ui-lib//fonts/ui-lib.b3909f8.woff\";`虽然浏览器调试台里preview展示如下，但是Icon仍然没展示出来。(这里为什么展示出来，但是没生效我也没想明白)\n\n![](/images/icon.png)\n\n项目是vue-cli搭建的，其实非常困惑的是 `const imgRule = config.module.rule('images');`这里的images是代表什么，又没定义过，只好去翻[vue-cli的文档](https://cli.vuejs.org/zh/guide/webpack.html#%E5%AE%A1%E6%9F%A5%E9%A1%B9%E7%9B%AE%E7%9A%84-webpack-%E9%85%8D%E7%BD%AE)\n这里忍不住想吐槽一下vue-cli，为了简化上手成本，它默认内置了常用的loader和plugin，但是没有暴露出来。webpack的配置进到@vue/cli-service的项目中都看不到webpack的配置。根据文档，`vue inspect > output.js`。可以把所有内置的webpack信息输出出来。\n\n```\n➜  demo git: ✗ vue inspect --rules\n[\n  'vue',\n  'images',\n  'svg',\n  'media',\n  'fonts',\n  'pug',\n  'css',\n  'postcss',\n  'scss',\n  'sass',\n  'less',\n  'stylus',\n  'js',\n  'eslint',\n  'Nameless Rule (*)'\n]\n➜  demo git: ✗ vue inspect --rule fonts\n/* config.module.rule('fonts') */\n{\n  test: /\\.(woff2?|eot|ttf|otf)(\\?.*)?$/,\n  use: [\n    {\n      loader: 'file-loader',\n      options: {\n        publicPath: '/',\n        name: 'fonts/[name].[hash:8].[ext]'\n      }\n    }\n  ]\n}\n```\n同上例的config.module.rule('fonts')一样，images也是对图片适用的loader配置，这猜破了脑袋也猜不出来（小声比比）。这页文档太宝贵了，这个问题迟早得遇到，早遇到早明白。\n\n**能解决问题的配置**\n```\n config.module.rule('fonts')\n.test(/\\.(woff2?|eot|ttf|otf)(\\?.*)?$/)\n.use('url-loader')\n.loader('file-loader')\n.options({\n    publicPath,\n    name: 'fonts/[name].[hash:8].[ext]'\n})\n```\n上边的配置强行解释一波，把`fonts`的规则，test改为`/\\.(woff2?|eot|ttf|otf)(\\?.*)?$/`,把原来fonts的`url-loader`改为带options的`file-loader`。\n\n顺手把woff文件刨了一下，扔到解析网站，发现它是如下的样子\n\n![](/images/woff.png)\n\n具体为什么在content里写上对应的code，就展示出了对应的icon。我也没搞懂。\n\n\n","source":"_posts/2.记一次Icon没展示的bugfix.md","raw":"---\ntitle: 2.记一次Icon没展示的bugfix\ndate: 2020-12-23 17:49:28\ntags: Bugfix\n---\n> 滴滴云控制台为了升级vue，UI库和脚手架，使用qiankun做了拆分。拆分后的发现Icon的展示有问题。\n\n项目结构如下\n```\n|____node_modules\n| |____ui-lib\n| | |____index.css\n| | |____fonts\n| | | |____ui-lib.woff\n|____src\n| |____main.js\n```\n\nmain.js\n```\nimport 'ui-lib/index.css'\n```\n\nnode_modules中的ui-lib\n```\n@font-face{font-family:ui-lib;src:url(fonts/ui-lib.woff) format(\"woff\")}\n```\nvue.config.js\n```\nconst publicPath = process.env.NODE_ENV === \"production\" ? '//cdn.myservice.com/' : `/`;\nmodule.exports = {\n    publicPath,\n    configureWebpack: {\n        entry: { app:'./src/main.js'},\n        module: {\n            rules: [\n                {\n                    test: /\\.css$/,\n                    exclude: /node_modules/,\n                    use: [\n                      'style-loader',\n                      {\n                        loader: 'css-loader',\n                        options: {\n                          importLoaders: 1,\n                        },\n                      },\n                      {\n                        loader: \"postcss-loader\",\n                        options: {\n                          postcssOptions: {\n                          },\n                          execute: true,\n                        },\n                      },\n                    ],\n                },\n            ],\n        },\n    },\n    chainWebpack: config => {\n      const imgRule = config.module.rule('images');\n      imgRule.uses.clear();\n      imgRule\n        .use('file-loader')\n        .loader('file-loader')\n        .options({\n          name: 'img/[name].[hash:8].[ext]',\n          publicPath\n        })\n        .end()\n    },\n  }\n```\n\n编译后的文件app.css\n```\n@font-face{font-family:ui-lib;src:url(../fonts/ui-lib.woff) format(\"woff\")}\n```\n这里变成了`../fonts/ui-lib.woff`,而没有变成预期的`cdn.myservice.com/fonts/ui-lib.woff`。所以浏览器加载的时候path报错了。\n我最先尝试的是在configureWebpack.module.rules增加`url-loader`\n```\n{\n    test: /\\.(woff?|eot|ttf|otf)(\\?.*)?$/,\n    loader: 'url-loader',\n    query: {\n    limit: 2048,\n    name: 'fonts/[name].[hash:7].[ext]'\n    }\n},\n```\n结果顺利的被解析成了base64。而base64的内容是`module.exports = __webpack_public_path__ + \"node_modules/ui-lib//fonts/ui-lib.b3909f8.woff\";`虽然浏览器调试台里preview展示如下，但是Icon仍然没展示出来。(这里为什么展示出来，但是没生效我也没想明白)\n\n![](/images/icon.png)\n\n项目是vue-cli搭建的，其实非常困惑的是 `const imgRule = config.module.rule('images');`这里的images是代表什么，又没定义过，只好去翻[vue-cli的文档](https://cli.vuejs.org/zh/guide/webpack.html#%E5%AE%A1%E6%9F%A5%E9%A1%B9%E7%9B%AE%E7%9A%84-webpack-%E9%85%8D%E7%BD%AE)\n这里忍不住想吐槽一下vue-cli，为了简化上手成本，它默认内置了常用的loader和plugin，但是没有暴露出来。webpack的配置进到@vue/cli-service的项目中都看不到webpack的配置。根据文档，`vue inspect > output.js`。可以把所有内置的webpack信息输出出来。\n\n```\n➜  demo git: ✗ vue inspect --rules\n[\n  'vue',\n  'images',\n  'svg',\n  'media',\n  'fonts',\n  'pug',\n  'css',\n  'postcss',\n  'scss',\n  'sass',\n  'less',\n  'stylus',\n  'js',\n  'eslint',\n  'Nameless Rule (*)'\n]\n➜  demo git: ✗ vue inspect --rule fonts\n/* config.module.rule('fonts') */\n{\n  test: /\\.(woff2?|eot|ttf|otf)(\\?.*)?$/,\n  use: [\n    {\n      loader: 'file-loader',\n      options: {\n        publicPath: '/',\n        name: 'fonts/[name].[hash:8].[ext]'\n      }\n    }\n  ]\n}\n```\n同上例的config.module.rule('fonts')一样，images也是对图片适用的loader配置，这猜破了脑袋也猜不出来（小声比比）。这页文档太宝贵了，这个问题迟早得遇到，早遇到早明白。\n\n**能解决问题的配置**\n```\n config.module.rule('fonts')\n.test(/\\.(woff2?|eot|ttf|otf)(\\?.*)?$/)\n.use('url-loader')\n.loader('file-loader')\n.options({\n    publicPath,\n    name: 'fonts/[name].[hash:8].[ext]'\n})\n```\n上边的配置强行解释一波，把`fonts`的规则，test改为`/\\.(woff2?|eot|ttf|otf)(\\?.*)?$/`,把原来fonts的`url-loader`改为带options的`file-loader`。\n\n顺手把woff文件刨了一下，扔到解析网站，发现它是如下的样子\n\n![](/images/woff.png)\n\n具体为什么在content里写上对应的code，就展示出了对应的icon。我也没搞懂。\n\n\n","slug":"2.记一次Icon没展示的bugfix","published":1,"updated":"2021-01-22T02:27:28.486Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckrix8zd10000k1jfj1fxpc6r","content":"<blockquote>\n<p>滴滴云控制台为了升级vue，UI库和脚手架，使用qiankun做了拆分。拆分后的发现Icon的展示有问题。</p>\n</blockquote>\n<p>项目结构如下<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">|____node_modules</span><br><span class=\"line\">| |____ui-lib</span><br><span class=\"line\">| | |____index.css</span><br><span class=\"line\">| | |____fonts</span><br><span class=\"line\">| | | |____ui-lib.woff</span><br><span class=\"line\">|____src</span><br><span class=\"line\">| |____main.js</span><br></pre></td></tr></table></figure></p>\n<p>main.js<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import &apos;ui-lib/index.css&apos;</span><br></pre></td></tr></table></figure></p>\n<p>node_modules中的ui-lib<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@font-face&#123;font-family:ui-lib;src:url(fonts/ui-lib.woff) format(&quot;woff&quot;)&#125;</span><br></pre></td></tr></table></figure></p>\n<p>vue.config.js<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">const publicPath = process.env.NODE_ENV === &quot;production&quot; ? &apos;//cdn.myservice.com/&apos; : `/`;</span><br><span class=\"line\">module.exports = &#123;</span><br><span class=\"line\">    publicPath,</span><br><span class=\"line\">    configureWebpack: &#123;</span><br><span class=\"line\">        entry: &#123; app:&apos;./src/main.js&apos;&#125;,</span><br><span class=\"line\">        module: &#123;</span><br><span class=\"line\">            rules: [</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    test: /\\.css$/,</span><br><span class=\"line\">                    exclude: /node_modules/,</span><br><span class=\"line\">                    use: [</span><br><span class=\"line\">                      &apos;style-loader&apos;,</span><br><span class=\"line\">                      &#123;</span><br><span class=\"line\">                        loader: &apos;css-loader&apos;,</span><br><span class=\"line\">                        options: &#123;</span><br><span class=\"line\">                          importLoaders: 1,</span><br><span class=\"line\">                        &#125;,</span><br><span class=\"line\">                      &#125;,</span><br><span class=\"line\">                      &#123;</span><br><span class=\"line\">                        loader: &quot;postcss-loader&quot;,</span><br><span class=\"line\">                        options: &#123;</span><br><span class=\"line\">                          postcssOptions: &#123;</span><br><span class=\"line\">                          &#125;,</span><br><span class=\"line\">                          execute: true,</span><br><span class=\"line\">                        &#125;,</span><br><span class=\"line\">                      &#125;,</span><br><span class=\"line\">                    ],</span><br><span class=\"line\">                &#125;,</span><br><span class=\"line\">            ],</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    chainWebpack: config =&gt; &#123;</span><br><span class=\"line\">      const imgRule = config.module.rule(&apos;images&apos;);</span><br><span class=\"line\">      imgRule.uses.clear();</span><br><span class=\"line\">      imgRule</span><br><span class=\"line\">        .use(&apos;file-loader&apos;)</span><br><span class=\"line\">        .loader(&apos;file-loader&apos;)</span><br><span class=\"line\">        .options(&#123;</span><br><span class=\"line\">          name: &apos;img/[name].[hash:8].[ext]&apos;,</span><br><span class=\"line\">          publicPath</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">        .end()</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure></p>\n<p>编译后的文件app.css<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@font-face&#123;font-family:ui-lib;src:url(../fonts/ui-lib.woff) format(&quot;woff&quot;)&#125;</span><br></pre></td></tr></table></figure></p>\n<p>这里变成了<code>../fonts/ui-lib.woff</code>,而没有变成预期的<code>cdn.myservice.com/fonts/ui-lib.woff</code>。所以浏览器加载的时候path报错了。<br>我最先尝试的是在configureWebpack.module.rules增加<code>url-loader</code><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    test: /\\.(woff?|eot|ttf|otf)(\\?.*)?$/,</span><br><span class=\"line\">    loader: &apos;url-loader&apos;,</span><br><span class=\"line\">    query: &#123;</span><br><span class=\"line\">    limit: 2048,</span><br><span class=\"line\">    name: &apos;fonts/[name].[hash:7].[ext]&apos;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;,</span><br></pre></td></tr></table></figure></p>\n<p>结果顺利的被解析成了base64。而base64的内容是<code>module.exports = __webpack_public_path__ + &quot;node_modules/ui-lib//fonts/ui-lib.b3909f8.woff&quot;;</code>虽然浏览器调试台里preview展示如下，但是Icon仍然没展示出来。(这里为什么展示出来，但是没生效我也没想明白)</p>\n<p><img src=\"/images/icon.png\" alt=\"\"></p>\n<p>项目是vue-cli搭建的，其实非常困惑的是 <code>const imgRule = config.module.rule(&#39;images&#39;);</code>这里的images是代表什么，又没定义过，只好去翻<a href=\"https://cli.vuejs.org/zh/guide/webpack.html#%E5%AE%A1%E6%9F%A5%E9%A1%B9%E7%9B%AE%E7%9A%84-webpack-%E9%85%8D%E7%BD%AE\" target=\"_blank\" rel=\"noopener\">vue-cli的文档</a><br>这里忍不住想吐槽一下vue-cli，为了简化上手成本，它默认内置了常用的loader和plugin，但是没有暴露出来。webpack的配置进到@vue/cli-service的项目中都看不到webpack的配置。根据文档，<code>vue inspect &gt; output.js</code>。可以把所有内置的webpack信息输出出来。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  demo git: ✗ vue inspect --rules</span><br><span class=\"line\">[</span><br><span class=\"line\">  &apos;vue&apos;,</span><br><span class=\"line\">  &apos;images&apos;,</span><br><span class=\"line\">  &apos;svg&apos;,</span><br><span class=\"line\">  &apos;media&apos;,</span><br><span class=\"line\">  &apos;fonts&apos;,</span><br><span class=\"line\">  &apos;pug&apos;,</span><br><span class=\"line\">  &apos;css&apos;,</span><br><span class=\"line\">  &apos;postcss&apos;,</span><br><span class=\"line\">  &apos;scss&apos;,</span><br><span class=\"line\">  &apos;sass&apos;,</span><br><span class=\"line\">  &apos;less&apos;,</span><br><span class=\"line\">  &apos;stylus&apos;,</span><br><span class=\"line\">  &apos;js&apos;,</span><br><span class=\"line\">  &apos;eslint&apos;,</span><br><span class=\"line\">  &apos;Nameless Rule (*)&apos;</span><br><span class=\"line\">]</span><br><span class=\"line\">➜  demo git: ✗ vue inspect --rule fonts</span><br><span class=\"line\">/* config.module.rule(&apos;fonts&apos;) */</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  test: /\\.(woff2?|eot|ttf|otf)(\\?.*)?$/,</span><br><span class=\"line\">  use: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      loader: &apos;file-loader&apos;,</span><br><span class=\"line\">      options: &#123;</span><br><span class=\"line\">        publicPath: &apos;/&apos;,</span><br><span class=\"line\">        name: &apos;fonts/[name].[hash:8].[ext]&apos;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>同上例的config.module.rule(‘fonts’)一样，images也是对图片适用的loader配置，这猜破了脑袋也猜不出来（小声比比）。这页文档太宝贵了，这个问题迟早得遇到，早遇到早明白。</p>\n<p><strong>能解决问题的配置</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> config.module.rule(&apos;fonts&apos;)</span><br><span class=\"line\">.test(/\\.(woff2?|eot|ttf|otf)(\\?.*)?$/)</span><br><span class=\"line\">.use(&apos;url-loader&apos;)</span><br><span class=\"line\">.loader(&apos;file-loader&apos;)</span><br><span class=\"line\">.options(&#123;</span><br><span class=\"line\">    publicPath,</span><br><span class=\"line\">    name: &apos;fonts/[name].[hash:8].[ext]&apos;</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure></p>\n<p>上边的配置强行解释一波，把<code>fonts</code>的规则，test改为<code>/\\.(woff2?|eot|ttf|otf)(\\?.*)?$/</code>,把原来fonts的<code>url-loader</code>改为带options的<code>file-loader</code>。</p>\n<p>顺手把woff文件刨了一下，扔到解析网站，发现它是如下的样子</p>\n<p><img src=\"/images/woff.png\" alt=\"\"></p>\n<p>具体为什么在content里写上对应的code，就展示出了对应的icon。我也没搞懂。</p>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p>滴滴云控制台为了升级vue，UI库和脚手架，使用qiankun做了拆分。拆分后的发现Icon的展示有问题。</p>\n</blockquote>\n<p>项目结构如下<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">|____node_modules</span><br><span class=\"line\">| |____ui-lib</span><br><span class=\"line\">| | |____index.css</span><br><span class=\"line\">| | |____fonts</span><br><span class=\"line\">| | | |____ui-lib.woff</span><br><span class=\"line\">|____src</span><br><span class=\"line\">| |____main.js</span><br></pre></td></tr></table></figure></p>\n<p>main.js<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import &apos;ui-lib/index.css&apos;</span><br></pre></td></tr></table></figure></p>\n<p>node_modules中的ui-lib<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@font-face&#123;font-family:ui-lib;src:url(fonts/ui-lib.woff) format(&quot;woff&quot;)&#125;</span><br></pre></td></tr></table></figure></p>\n<p>vue.config.js<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">const publicPath = process.env.NODE_ENV === &quot;production&quot; ? &apos;//cdn.myservice.com/&apos; : `/`;</span><br><span class=\"line\">module.exports = &#123;</span><br><span class=\"line\">    publicPath,</span><br><span class=\"line\">    configureWebpack: &#123;</span><br><span class=\"line\">        entry: &#123; app:&apos;./src/main.js&apos;&#125;,</span><br><span class=\"line\">        module: &#123;</span><br><span class=\"line\">            rules: [</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    test: /\\.css$/,</span><br><span class=\"line\">                    exclude: /node_modules/,</span><br><span class=\"line\">                    use: [</span><br><span class=\"line\">                      &apos;style-loader&apos;,</span><br><span class=\"line\">                      &#123;</span><br><span class=\"line\">                        loader: &apos;css-loader&apos;,</span><br><span class=\"line\">                        options: &#123;</span><br><span class=\"line\">                          importLoaders: 1,</span><br><span class=\"line\">                        &#125;,</span><br><span class=\"line\">                      &#125;,</span><br><span class=\"line\">                      &#123;</span><br><span class=\"line\">                        loader: &quot;postcss-loader&quot;,</span><br><span class=\"line\">                        options: &#123;</span><br><span class=\"line\">                          postcssOptions: &#123;</span><br><span class=\"line\">                          &#125;,</span><br><span class=\"line\">                          execute: true,</span><br><span class=\"line\">                        &#125;,</span><br><span class=\"line\">                      &#125;,</span><br><span class=\"line\">                    ],</span><br><span class=\"line\">                &#125;,</span><br><span class=\"line\">            ],</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    chainWebpack: config =&gt; &#123;</span><br><span class=\"line\">      const imgRule = config.module.rule(&apos;images&apos;);</span><br><span class=\"line\">      imgRule.uses.clear();</span><br><span class=\"line\">      imgRule</span><br><span class=\"line\">        .use(&apos;file-loader&apos;)</span><br><span class=\"line\">        .loader(&apos;file-loader&apos;)</span><br><span class=\"line\">        .options(&#123;</span><br><span class=\"line\">          name: &apos;img/[name].[hash:8].[ext]&apos;,</span><br><span class=\"line\">          publicPath</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">        .end()</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure></p>\n<p>编译后的文件app.css<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@font-face&#123;font-family:ui-lib;src:url(../fonts/ui-lib.woff) format(&quot;woff&quot;)&#125;</span><br></pre></td></tr></table></figure></p>\n<p>这里变成了<code>../fonts/ui-lib.woff</code>,而没有变成预期的<code>cdn.myservice.com/fonts/ui-lib.woff</code>。所以浏览器加载的时候path报错了。<br>我最先尝试的是在configureWebpack.module.rules增加<code>url-loader</code><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    test: /\\.(woff?|eot|ttf|otf)(\\?.*)?$/,</span><br><span class=\"line\">    loader: &apos;url-loader&apos;,</span><br><span class=\"line\">    query: &#123;</span><br><span class=\"line\">    limit: 2048,</span><br><span class=\"line\">    name: &apos;fonts/[name].[hash:7].[ext]&apos;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;,</span><br></pre></td></tr></table></figure></p>\n<p>结果顺利的被解析成了base64。而base64的内容是<code>module.exports = __webpack_public_path__ + &quot;node_modules/ui-lib//fonts/ui-lib.b3909f8.woff&quot;;</code>虽然浏览器调试台里preview展示如下，但是Icon仍然没展示出来。(这里为什么展示出来，但是没生效我也没想明白)</p>\n<p><img src=\"/images/icon.png\" alt=\"\"></p>\n<p>项目是vue-cli搭建的，其实非常困惑的是 <code>const imgRule = config.module.rule(&#39;images&#39;);</code>这里的images是代表什么，又没定义过，只好去翻<a href=\"https://cli.vuejs.org/zh/guide/webpack.html#%E5%AE%A1%E6%9F%A5%E9%A1%B9%E7%9B%AE%E7%9A%84-webpack-%E9%85%8D%E7%BD%AE\" target=\"_blank\" rel=\"noopener\">vue-cli的文档</a><br>这里忍不住想吐槽一下vue-cli，为了简化上手成本，它默认内置了常用的loader和plugin，但是没有暴露出来。webpack的配置进到@vue/cli-service的项目中都看不到webpack的配置。根据文档，<code>vue inspect &gt; output.js</code>。可以把所有内置的webpack信息输出出来。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  demo git: ✗ vue inspect --rules</span><br><span class=\"line\">[</span><br><span class=\"line\">  &apos;vue&apos;,</span><br><span class=\"line\">  &apos;images&apos;,</span><br><span class=\"line\">  &apos;svg&apos;,</span><br><span class=\"line\">  &apos;media&apos;,</span><br><span class=\"line\">  &apos;fonts&apos;,</span><br><span class=\"line\">  &apos;pug&apos;,</span><br><span class=\"line\">  &apos;css&apos;,</span><br><span class=\"line\">  &apos;postcss&apos;,</span><br><span class=\"line\">  &apos;scss&apos;,</span><br><span class=\"line\">  &apos;sass&apos;,</span><br><span class=\"line\">  &apos;less&apos;,</span><br><span class=\"line\">  &apos;stylus&apos;,</span><br><span class=\"line\">  &apos;js&apos;,</span><br><span class=\"line\">  &apos;eslint&apos;,</span><br><span class=\"line\">  &apos;Nameless Rule (*)&apos;</span><br><span class=\"line\">]</span><br><span class=\"line\">➜  demo git: ✗ vue inspect --rule fonts</span><br><span class=\"line\">/* config.module.rule(&apos;fonts&apos;) */</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  test: /\\.(woff2?|eot|ttf|otf)(\\?.*)?$/,</span><br><span class=\"line\">  use: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      loader: &apos;file-loader&apos;,</span><br><span class=\"line\">      options: &#123;</span><br><span class=\"line\">        publicPath: &apos;/&apos;,</span><br><span class=\"line\">        name: &apos;fonts/[name].[hash:8].[ext]&apos;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>同上例的config.module.rule(‘fonts’)一样，images也是对图片适用的loader配置，这猜破了脑袋也猜不出来（小声比比）。这页文档太宝贵了，这个问题迟早得遇到，早遇到早明白。</p>\n<p><strong>能解决问题的配置</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> config.module.rule(&apos;fonts&apos;)</span><br><span class=\"line\">.test(/\\.(woff2?|eot|ttf|otf)(\\?.*)?$/)</span><br><span class=\"line\">.use(&apos;url-loader&apos;)</span><br><span class=\"line\">.loader(&apos;file-loader&apos;)</span><br><span class=\"line\">.options(&#123;</span><br><span class=\"line\">    publicPath,</span><br><span class=\"line\">    name: &apos;fonts/[name].[hash:8].[ext]&apos;</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure></p>\n<p>上边的配置强行解释一波，把<code>fonts</code>的规则，test改为<code>/\\.(woff2?|eot|ttf|otf)(\\?.*)?$/</code>,把原来fonts的<code>url-loader</code>改为带options的<code>file-loader</code>。</p>\n<p>顺手把woff文件刨了一下，扔到解析网站，发现它是如下的样子</p>\n<p><img src=\"/images/woff.png\" alt=\"\"></p>\n<p>具体为什么在content里写上对应的code，就展示出了对应的icon。我也没搞懂。</p>\n"},{"title":"2020年微前端踩坑回顾","date":"2021-02-01T06:23:11.000Z","_content":"\n2020年已经过去，在家办公了小半年，回顾过去，Time flies。\n\n今年听说是微前端的大年，应该每个前端都会听说过微前端的概念，就像几年前angular，vue，react流行时那样。我个人是特别的佩服single-spa的作者John Denning。大概2016-2017年的样子，Angularjs出了巨大变更的Angular，React在国外也风光无两。同样是面对新旧框架不兼容的情况，我们的方案是重构，用Angular5重构项目，同时轮流负责修改之前Angularjs1.4的bug。而John写了第一版的single-spa来解决了这个问题，在新feature上使用React，已有页面维持旧项目来逐步过渡。\n\n今年先后试用了single-spa和qiankun来对两个项目做了重构，使用[single-spa来改造Mis的过往总结在这](https://guguji5.github.io/Single-spa%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%8C%96%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93/)。这篇文字注意记录一下使用qiankun遇到的问题。这里的问题必须解释一下不是qiankun的问题，而是我们项目中case by case的问题。\n\n#### 项目背景\n先介绍一下为啥要用qiankun来拆分滴滴云控制台，当时考虑我们的**控制台开发体验差，热更新慢，太臃肿，无法引入新的技术栈、升级组件库，为了更好支持平台化建设项目。遂考虑微服务拆分项目。**\n这里来盗个kuitos知乎上的图，如果想做一个长长久久公有云控制台，考虑迭代和升级越早收益越高。\n\n![](http://img-ys011.didistatic.com/static/dc2img/do1_erbRkYpYxwlqUBsp57i5)\n\n#### 愿景\n希望将控制台庖丁解牛，拆分成几个独立的项目。每一个可以独立部署，独立开发。**自由选择和升级技术栈，UI库，热更新快速。**\n\n#### 框架对比\n\n|框架\t| github stars（2020.10.29）|\t主应用|\t共享依赖|\t子应用可否单独开发调试|\t部署\t|entry|\tjs，css隔离|\t路由控制|\t应用间通信|\t工程化\t|官方支持|\n|  ----  | ----  | ----  | ----  | ----  | ----  | ----  | ----  | ----  | ----  | ----  | ----  | ----  | ----  | ----  | ----  |\n|飞冰|\t906|\t必须react|\t无|\t可独立启动的子应用，可以|\t如飞冰的截图，子应用单独部署|\thtml，js，简单如iframe|\t[暂未完善](https://ice.work/docs/icestark/guide/sandbox)|\t简单的路由规则|\t[有方案](https://ice.work/docs/icestark/guide/interaction)|\t无|\t没有专门的群，效率差|\n|qiankun|\t7.3k|\tqiankun|\t无|\t可独立启动的子应用，可以|\t子应用单独部署|\thtml，js，简单如iframe|\t[js沙箱，css shadow dom等方案](https://zhuanlan.zhihu.com/p/200775337)|\t基于single-spa|\t[没方案，但有一些建议](https://zhuanlan.zhihu.com/p/200775337)|\t无|\t有群，效率一般|\n|single-spa|\t7.6k|\tsingle-spa|\t[utility-modules-styleguide-api-etc](https://single-spa.js.org/docs/recommended-setup#utility-modules-styleguide-api-etc)|\timport-map-override完美解决|\t子应用部署，需更新import-map|\t需要systemjs，有一定成本|\t官方未提供建议|\t精准的路由控制|\t[有方案](https://single-spa.js.org/docs/recommended-setup/)|\t有|\tslack，效率一般。有热心John|\n\n大概对比下来，single-spa和qiankun各有千秋。但是single-spa要求的是子项目单文件入口，如果html中插入了多个chunk，single-spa无法保证其按顺序加载，对我们的项目冲击较大，而qiankun是根据html解析，将其css script链接进行加载，无需改动，最后选择了qiankun，趟一趟水。\n\n#### 实践\n因为这次重构和其他需求是并行的，将任务拆解为以下几项\n1. 涉及到梳理业务模块及依赖关系，根据依赖关系抽取公共模块。\n1. 将必要模块放在root应用中，如登录，权限，导航等等。\n1. 如何几个子项目如何构建，部署，上线\n1. 项目结束后如何跟旧项目的feature 解决冲突\n1. 抽取公共模块后，原项目的引用路径会变化，如何使用脚本来做这件事。\n\n\n#### 遇到的问题\n重构嘛，肯定会遇到问题。但是qiankun没有太多问题，花费我巨量时间的还是项目中的一些问题，举一两个小例子吧，没太多营养，也不想浪费笔墨。\n\n1. 将公共样式和公共JS逻辑抽取到公共模块后，使用了import-html-entry加载，但是css的加载顺序会变化。如此脆弱的css，顺序变一下最终渲染的就会不同。\n1. 公共模块中的postcss解析不对，postcss-nested这个插件，在webpack升级后需要升级，但是升级到最新Version 5会报错，还原到原来Version 1还是还会报错，试着往下降了一版到Version 4，可以work。难受。\n1. 脚手架从webpack使用vue-cli后icon，竟然无法展示，具体记录在[记一次Icon没展示的bugfix](https://guguji5.github.io/2.%E8%AE%B0%E4%B8%80%E6%AC%A1Icon%E6%B2%A1%E5%B1%95%E7%A4%BA%E7%9A%84bugfix/)\n1. store如何控制，因为是项目拆分，原来公用一个的vuex现在还想维持原状，不想做过多改动，最后使用`registerModule`将子应用的store注册为主应用的一个module，幸运的是大部分代码都是用getter来获取store中的值，getter的注册具有[全局命名空间](https://vuex.vuejs.org/zh/guide/modules.html#%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4)，无论真是的store是在全局还是子模块。\n1. 不想每次都启动N+1个项目，如何处理呢，临时使用npm-run-all来过渡。\n1. 权限如何控制？ 其实本来权限也有后端设置的cookie来决定，但是原来是一个spa项目，404页面和* 页面，都需要处理。因为不属于该项目的路由，需要去适配其他的子应用，而不是展示一个404。\n1. 子应用之前切换路由，不能使用vue-router的 name，而需要用path。\n\n#### 待解决的问题\n\n1. 不想每次都启动N+1个项目，考虑实现一个类似 import-map-overrides 的工具。可以动态改变publicPath，只启动需要调试的子项目即可。\n1. 多个Vue子项目同时启动后，vue-devtool时不时的失效。说不清就加载哪一个项目的状态，我在使用single-spa时没有这个问题。有待深入调查\n1. 对于使用镜像来部署的场景，每个镜像中跑一个nginx，里边serve一个html感觉有点浪费，因为js，css，font，img等等全都放cdn上，对于一个三个子项目的项目，每个项目2个节点，有点浪费。\n\n#### 写在最后的话\n回到最初的愿景，我们还没实现，因为拆分才是我们重构的第一步，下一步要进一步细分，将服务拆的更小，然后才好进行无论是Vue升级，还是UI库升级。\n\n项目上线灰度结束，发现花时间最多的\n1. 是处理cookie鉴权\n1. 多个项目间路由的处理\n1. 并行项目间合并代码\n1. 多个项目构建太慢如何优化\n\n为了分析组件间的依赖关系，通过数据说话来决定哪些utils和components需要抽取到公共模块（被依赖太多和被main.js所依赖都需要抽取），自己实现了nodejs脚本来分析webpack的stat文件。\n通过自动合并代码及查看diff，又写了个nodejs脚本来自动合并。\n也很有趣。\n\n#### Reference\n\n1. 飞冰官网：https://ice.work/docs/icestark/about\n1. 飞冰作者分享：https://zhuanlan.zhihu.com/p/88449415\n1. qiankun官网：https://qiankun.umijs.org/zh\n1. qiankun作者博客：https://zhuanlan.zhihu.com/p/95085796  \n1. qiankun作者博客：https://zhuanlan.zhihu.com/p/200775337 \n1. https://juejin.im/post/6856569463950639117#heading-15 \n1. signle-spa官网：https://single-spa.js.org/\n","source":"_posts/2020年微前端踩坑回顾.md","raw":"---\ntitle: 2020年微前端踩坑回顾\ndate: 2021-02-01 14:23:11\ntags:\n---\n\n2020年已经过去，在家办公了小半年，回顾过去，Time flies。\n\n今年听说是微前端的大年，应该每个前端都会听说过微前端的概念，就像几年前angular，vue，react流行时那样。我个人是特别的佩服single-spa的作者John Denning。大概2016-2017年的样子，Angularjs出了巨大变更的Angular，React在国外也风光无两。同样是面对新旧框架不兼容的情况，我们的方案是重构，用Angular5重构项目，同时轮流负责修改之前Angularjs1.4的bug。而John写了第一版的single-spa来解决了这个问题，在新feature上使用React，已有页面维持旧项目来逐步过渡。\n\n今年先后试用了single-spa和qiankun来对两个项目做了重构，使用[single-spa来改造Mis的过往总结在这](https://guguji5.github.io/Single-spa%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%8C%96%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93/)。这篇文字注意记录一下使用qiankun遇到的问题。这里的问题必须解释一下不是qiankun的问题，而是我们项目中case by case的问题。\n\n#### 项目背景\n先介绍一下为啥要用qiankun来拆分滴滴云控制台，当时考虑我们的**控制台开发体验差，热更新慢，太臃肿，无法引入新的技术栈、升级组件库，为了更好支持平台化建设项目。遂考虑微服务拆分项目。**\n这里来盗个kuitos知乎上的图，如果想做一个长长久久公有云控制台，考虑迭代和升级越早收益越高。\n\n![](http://img-ys011.didistatic.com/static/dc2img/do1_erbRkYpYxwlqUBsp57i5)\n\n#### 愿景\n希望将控制台庖丁解牛，拆分成几个独立的项目。每一个可以独立部署，独立开发。**自由选择和升级技术栈，UI库，热更新快速。**\n\n#### 框架对比\n\n|框架\t| github stars（2020.10.29）|\t主应用|\t共享依赖|\t子应用可否单独开发调试|\t部署\t|entry|\tjs，css隔离|\t路由控制|\t应用间通信|\t工程化\t|官方支持|\n|  ----  | ----  | ----  | ----  | ----  | ----  | ----  | ----  | ----  | ----  | ----  | ----  | ----  | ----  | ----  | ----  |\n|飞冰|\t906|\t必须react|\t无|\t可独立启动的子应用，可以|\t如飞冰的截图，子应用单独部署|\thtml，js，简单如iframe|\t[暂未完善](https://ice.work/docs/icestark/guide/sandbox)|\t简单的路由规则|\t[有方案](https://ice.work/docs/icestark/guide/interaction)|\t无|\t没有专门的群，效率差|\n|qiankun|\t7.3k|\tqiankun|\t无|\t可独立启动的子应用，可以|\t子应用单独部署|\thtml，js，简单如iframe|\t[js沙箱，css shadow dom等方案](https://zhuanlan.zhihu.com/p/200775337)|\t基于single-spa|\t[没方案，但有一些建议](https://zhuanlan.zhihu.com/p/200775337)|\t无|\t有群，效率一般|\n|single-spa|\t7.6k|\tsingle-spa|\t[utility-modules-styleguide-api-etc](https://single-spa.js.org/docs/recommended-setup#utility-modules-styleguide-api-etc)|\timport-map-override完美解决|\t子应用部署，需更新import-map|\t需要systemjs，有一定成本|\t官方未提供建议|\t精准的路由控制|\t[有方案](https://single-spa.js.org/docs/recommended-setup/)|\t有|\tslack，效率一般。有热心John|\n\n大概对比下来，single-spa和qiankun各有千秋。但是single-spa要求的是子项目单文件入口，如果html中插入了多个chunk，single-spa无法保证其按顺序加载，对我们的项目冲击较大，而qiankun是根据html解析，将其css script链接进行加载，无需改动，最后选择了qiankun，趟一趟水。\n\n#### 实践\n因为这次重构和其他需求是并行的，将任务拆解为以下几项\n1. 涉及到梳理业务模块及依赖关系，根据依赖关系抽取公共模块。\n1. 将必要模块放在root应用中，如登录，权限，导航等等。\n1. 如何几个子项目如何构建，部署，上线\n1. 项目结束后如何跟旧项目的feature 解决冲突\n1. 抽取公共模块后，原项目的引用路径会变化，如何使用脚本来做这件事。\n\n\n#### 遇到的问题\n重构嘛，肯定会遇到问题。但是qiankun没有太多问题，花费我巨量时间的还是项目中的一些问题，举一两个小例子吧，没太多营养，也不想浪费笔墨。\n\n1. 将公共样式和公共JS逻辑抽取到公共模块后，使用了import-html-entry加载，但是css的加载顺序会变化。如此脆弱的css，顺序变一下最终渲染的就会不同。\n1. 公共模块中的postcss解析不对，postcss-nested这个插件，在webpack升级后需要升级，但是升级到最新Version 5会报错，还原到原来Version 1还是还会报错，试着往下降了一版到Version 4，可以work。难受。\n1. 脚手架从webpack使用vue-cli后icon，竟然无法展示，具体记录在[记一次Icon没展示的bugfix](https://guguji5.github.io/2.%E8%AE%B0%E4%B8%80%E6%AC%A1Icon%E6%B2%A1%E5%B1%95%E7%A4%BA%E7%9A%84bugfix/)\n1. store如何控制，因为是项目拆分，原来公用一个的vuex现在还想维持原状，不想做过多改动，最后使用`registerModule`将子应用的store注册为主应用的一个module，幸运的是大部分代码都是用getter来获取store中的值，getter的注册具有[全局命名空间](https://vuex.vuejs.org/zh/guide/modules.html#%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4)，无论真是的store是在全局还是子模块。\n1. 不想每次都启动N+1个项目，如何处理呢，临时使用npm-run-all来过渡。\n1. 权限如何控制？ 其实本来权限也有后端设置的cookie来决定，但是原来是一个spa项目，404页面和* 页面，都需要处理。因为不属于该项目的路由，需要去适配其他的子应用，而不是展示一个404。\n1. 子应用之前切换路由，不能使用vue-router的 name，而需要用path。\n\n#### 待解决的问题\n\n1. 不想每次都启动N+1个项目，考虑实现一个类似 import-map-overrides 的工具。可以动态改变publicPath，只启动需要调试的子项目即可。\n1. 多个Vue子项目同时启动后，vue-devtool时不时的失效。说不清就加载哪一个项目的状态，我在使用single-spa时没有这个问题。有待深入调查\n1. 对于使用镜像来部署的场景，每个镜像中跑一个nginx，里边serve一个html感觉有点浪费，因为js，css，font，img等等全都放cdn上，对于一个三个子项目的项目，每个项目2个节点，有点浪费。\n\n#### 写在最后的话\n回到最初的愿景，我们还没实现，因为拆分才是我们重构的第一步，下一步要进一步细分，将服务拆的更小，然后才好进行无论是Vue升级，还是UI库升级。\n\n项目上线灰度结束，发现花时间最多的\n1. 是处理cookie鉴权\n1. 多个项目间路由的处理\n1. 并行项目间合并代码\n1. 多个项目构建太慢如何优化\n\n为了分析组件间的依赖关系，通过数据说话来决定哪些utils和components需要抽取到公共模块（被依赖太多和被main.js所依赖都需要抽取），自己实现了nodejs脚本来分析webpack的stat文件。\n通过自动合并代码及查看diff，又写了个nodejs脚本来自动合并。\n也很有趣。\n\n#### Reference\n\n1. 飞冰官网：https://ice.work/docs/icestark/about\n1. 飞冰作者分享：https://zhuanlan.zhihu.com/p/88449415\n1. qiankun官网：https://qiankun.umijs.org/zh\n1. qiankun作者博客：https://zhuanlan.zhihu.com/p/95085796  \n1. qiankun作者博客：https://zhuanlan.zhihu.com/p/200775337 \n1. https://juejin.im/post/6856569463950639117#heading-15 \n1. signle-spa官网：https://single-spa.js.org/\n","slug":"2020年微前端踩坑回顾","published":1,"updated":"2021-02-01T09:41:41.525Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckrix8zd90002k1jf8txbu93y","content":"<p>2020年已经过去，在家办公了小半年，回顾过去，Time flies。</p>\n<p>今年听说是微前端的大年，应该每个前端都会听说过微前端的概念，就像几年前angular，vue，react流行时那样。我个人是特别的佩服single-spa的作者John Denning。大概2016-2017年的样子，Angularjs出了巨大变更的Angular，React在国外也风光无两。同样是面对新旧框架不兼容的情况，我们的方案是重构，用Angular5重构项目，同时轮流负责修改之前Angularjs1.4的bug。而John写了第一版的single-spa来解决了这个问题，在新feature上使用React，已有页面维持旧项目来逐步过渡。</p>\n<p>今年先后试用了single-spa和qiankun来对两个项目做了重构，使用<a href=\"https://guguji5.github.io/Single-spa%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%8C%96%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93/\">single-spa来改造Mis的过往总结在这</a>。这篇文字注意记录一下使用qiankun遇到的问题。这里的问题必须解释一下不是qiankun的问题，而是我们项目中case by case的问题。</p>\n<h4 id=\"项目背景\"><a href=\"#项目背景\" class=\"headerlink\" title=\"项目背景\"></a>项目背景</h4><p>先介绍一下为啥要用qiankun来拆分滴滴云控制台，当时考虑我们的<strong>控制台开发体验差，热更新慢，太臃肿，无法引入新的技术栈、升级组件库，为了更好支持平台化建设项目。遂考虑微服务拆分项目。</strong><br>这里来盗个kuitos知乎上的图，如果想做一个长长久久公有云控制台，考虑迭代和升级越早收益越高。</p>\n<p><img src=\"http://img-ys011.didistatic.com/static/dc2img/do1_erbRkYpYxwlqUBsp57i5\" alt=\"\"></p>\n<h4 id=\"愿景\"><a href=\"#愿景\" class=\"headerlink\" title=\"愿景\"></a>愿景</h4><p>希望将控制台庖丁解牛，拆分成几个独立的项目。每一个可以独立部署，独立开发。<strong>自由选择和升级技术栈，UI库，热更新快速。</strong></p>\n<h4 id=\"框架对比\"><a href=\"#框架对比\" class=\"headerlink\" title=\"框架对比\"></a>框架对比</h4><table>\n<thead>\n<tr>\n<th>框架</th>\n<th>github stars（2020.10.29）</th>\n<th>主应用</th>\n<th>共享依赖</th>\n<th>子应用可否单独开发调试</th>\n<th>部署</th>\n<th>entry</th>\n<th>js，css隔离</th>\n<th>路由控制</th>\n<th>应用间通信</th>\n<th>工程化</th>\n<th>官方支持</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>飞冰</td>\n<td>906</td>\n<td>必须react</td>\n<td>无</td>\n<td>可独立启动的子应用，可以</td>\n<td>如飞冰的截图，子应用单独部署</td>\n<td>html，js，简单如iframe</td>\n<td><a href=\"https://ice.work/docs/icestark/guide/sandbox\" target=\"_blank\" rel=\"noopener\">暂未完善</a></td>\n<td>简单的路由规则</td>\n<td><a href=\"https://ice.work/docs/icestark/guide/interaction\" target=\"_blank\" rel=\"noopener\">有方案</a></td>\n<td>无</td>\n<td>没有专门的群，效率差</td>\n</tr>\n<tr>\n<td>qiankun</td>\n<td>7.3k</td>\n<td>qiankun</td>\n<td>无</td>\n<td>可独立启动的子应用，可以</td>\n<td>子应用单独部署</td>\n<td>html，js，简单如iframe</td>\n<td><a href=\"https://zhuanlan.zhihu.com/p/200775337\" target=\"_blank\" rel=\"noopener\">js沙箱，css shadow dom等方案</a></td>\n<td>基于single-spa</td>\n<td><a href=\"https://zhuanlan.zhihu.com/p/200775337\" target=\"_blank\" rel=\"noopener\">没方案，但有一些建议</a></td>\n<td>无</td>\n<td>有群，效率一般</td>\n</tr>\n<tr>\n<td>single-spa</td>\n<td>7.6k</td>\n<td>single-spa</td>\n<td><a href=\"https://single-spa.js.org/docs/recommended-setup#utility-modules-styleguide-api-etc\" target=\"_blank\" rel=\"noopener\">utility-modules-styleguide-api-etc</a></td>\n<td>import-map-override完美解决</td>\n<td>子应用部署，需更新import-map</td>\n<td>需要systemjs，有一定成本</td>\n<td>官方未提供建议</td>\n<td>精准的路由控制</td>\n<td><a href=\"https://single-spa.js.org/docs/recommended-setup/\" target=\"_blank\" rel=\"noopener\">有方案</a></td>\n<td>有</td>\n<td>slack，效率一般。有热心John</td>\n</tr>\n</tbody>\n</table>\n<p>大概对比下来，single-spa和qiankun各有千秋。但是single-spa要求的是子项目单文件入口，如果html中插入了多个chunk，single-spa无法保证其按顺序加载，对我们的项目冲击较大，而qiankun是根据html解析，将其css script链接进行加载，无需改动，最后选择了qiankun，趟一趟水。</p>\n<h4 id=\"实践\"><a href=\"#实践\" class=\"headerlink\" title=\"实践\"></a>实践</h4><p>因为这次重构和其他需求是并行的，将任务拆解为以下几项</p>\n<ol>\n<li>涉及到梳理业务模块及依赖关系，根据依赖关系抽取公共模块。</li>\n<li>将必要模块放在root应用中，如登录，权限，导航等等。</li>\n<li>如何几个子项目如何构建，部署，上线</li>\n<li>项目结束后如何跟旧项目的feature 解决冲突</li>\n<li>抽取公共模块后，原项目的引用路径会变化，如何使用脚本来做这件事。</li>\n</ol>\n<h4 id=\"遇到的问题\"><a href=\"#遇到的问题\" class=\"headerlink\" title=\"遇到的问题\"></a>遇到的问题</h4><p>重构嘛，肯定会遇到问题。但是qiankun没有太多问题，花费我巨量时间的还是项目中的一些问题，举一两个小例子吧，没太多营养，也不想浪费笔墨。</p>\n<ol>\n<li>将公共样式和公共JS逻辑抽取到公共模块后，使用了import-html-entry加载，但是css的加载顺序会变化。如此脆弱的css，顺序变一下最终渲染的就会不同。</li>\n<li>公共模块中的postcss解析不对，postcss-nested这个插件，在webpack升级后需要升级，但是升级到最新Version 5会报错，还原到原来Version 1还是还会报错，试着往下降了一版到Version 4，可以work。难受。</li>\n<li>脚手架从webpack使用vue-cli后icon，竟然无法展示，具体记录在<a href=\"https://guguji5.github.io/2.%E8%AE%B0%E4%B8%80%E6%AC%A1Icon%E6%B2%A1%E5%B1%95%E7%A4%BA%E7%9A%84bugfix/\">记一次Icon没展示的bugfix</a></li>\n<li>store如何控制，因为是项目拆分，原来公用一个的vuex现在还想维持原状，不想做过多改动，最后使用<code>registerModule</code>将子应用的store注册为主应用的一个module，幸运的是大部分代码都是用getter来获取store中的值，getter的注册具有<a href=\"https://vuex.vuejs.org/zh/guide/modules.html#%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4\" target=\"_blank\" rel=\"noopener\">全局命名空间</a>，无论真是的store是在全局还是子模块。</li>\n<li>不想每次都启动N+1个项目，如何处理呢，临时使用npm-run-all来过渡。</li>\n<li>权限如何控制？ 其实本来权限也有后端设置的cookie来决定，但是原来是一个spa项目，404页面和* 页面，都需要处理。因为不属于该项目的路由，需要去适配其他的子应用，而不是展示一个404。</li>\n<li>子应用之前切换路由，不能使用vue-router的 name，而需要用path。</li>\n</ol>\n<h4 id=\"待解决的问题\"><a href=\"#待解决的问题\" class=\"headerlink\" title=\"待解决的问题\"></a>待解决的问题</h4><ol>\n<li>不想每次都启动N+1个项目，考虑实现一个类似 import-map-overrides 的工具。可以动态改变publicPath，只启动需要调试的子项目即可。</li>\n<li>多个Vue子项目同时启动后，vue-devtool时不时的失效。说不清就加载哪一个项目的状态，我在使用single-spa时没有这个问题。有待深入调查</li>\n<li>对于使用镜像来部署的场景，每个镜像中跑一个nginx，里边serve一个html感觉有点浪费，因为js，css，font，img等等全都放cdn上，对于一个三个子项目的项目，每个项目2个节点，有点浪费。</li>\n</ol>\n<h4 id=\"写在最后的话\"><a href=\"#写在最后的话\" class=\"headerlink\" title=\"写在最后的话\"></a>写在最后的话</h4><p>回到最初的愿景，我们还没实现，因为拆分才是我们重构的第一步，下一步要进一步细分，将服务拆的更小，然后才好进行无论是Vue升级，还是UI库升级。</p>\n<p>项目上线灰度结束，发现花时间最多的</p>\n<ol>\n<li>是处理cookie鉴权</li>\n<li>多个项目间路由的处理</li>\n<li>并行项目间合并代码</li>\n<li>多个项目构建太慢如何优化</li>\n</ol>\n<p>为了分析组件间的依赖关系，通过数据说话来决定哪些utils和components需要抽取到公共模块（被依赖太多和被main.js所依赖都需要抽取），自己实现了nodejs脚本来分析webpack的stat文件。<br>通过自动合并代码及查看diff，又写了个nodejs脚本来自动合并。<br>也很有趣。</p>\n<h4 id=\"Reference\"><a href=\"#Reference\" class=\"headerlink\" title=\"Reference\"></a>Reference</h4><ol>\n<li>飞冰官网：<a href=\"https://ice.work/docs/icestark/about\" target=\"_blank\" rel=\"noopener\">https://ice.work/docs/icestark/about</a></li>\n<li>飞冰作者分享：<a href=\"https://zhuanlan.zhihu.com/p/88449415\" target=\"_blank\" rel=\"noopener\">https://zhuanlan.zhihu.com/p/88449415</a></li>\n<li>qiankun官网：<a href=\"https://qiankun.umijs.org/zh\" target=\"_blank\" rel=\"noopener\">https://qiankun.umijs.org/zh</a></li>\n<li>qiankun作者博客：<a href=\"https://zhuanlan.zhihu.com/p/95085796\" target=\"_blank\" rel=\"noopener\">https://zhuanlan.zhihu.com/p/95085796</a>  </li>\n<li>qiankun作者博客：<a href=\"https://zhuanlan.zhihu.com/p/200775337\" target=\"_blank\" rel=\"noopener\">https://zhuanlan.zhihu.com/p/200775337</a> </li>\n<li><a href=\"https://juejin.im/post/6856569463950639117#heading-15\" target=\"_blank\" rel=\"noopener\">https://juejin.im/post/6856569463950639117#heading-15</a> </li>\n<li>signle-spa官网：<a href=\"https://single-spa.js.org/\" target=\"_blank\" rel=\"noopener\">https://single-spa.js.org/</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<p>2020年已经过去，在家办公了小半年，回顾过去，Time flies。</p>\n<p>今年听说是微前端的大年，应该每个前端都会听说过微前端的概念，就像几年前angular，vue，react流行时那样。我个人是特别的佩服single-spa的作者John Denning。大概2016-2017年的样子，Angularjs出了巨大变更的Angular，React在国外也风光无两。同样是面对新旧框架不兼容的情况，我们的方案是重构，用Angular5重构项目，同时轮流负责修改之前Angularjs1.4的bug。而John写了第一版的single-spa来解决了这个问题，在新feature上使用React，已有页面维持旧项目来逐步过渡。</p>\n<p>今年先后试用了single-spa和qiankun来对两个项目做了重构，使用<a href=\"https://guguji5.github.io/Single-spa%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%8C%96%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93/\">single-spa来改造Mis的过往总结在这</a>。这篇文字注意记录一下使用qiankun遇到的问题。这里的问题必须解释一下不是qiankun的问题，而是我们项目中case by case的问题。</p>\n<h4 id=\"项目背景\"><a href=\"#项目背景\" class=\"headerlink\" title=\"项目背景\"></a>项目背景</h4><p>先介绍一下为啥要用qiankun来拆分滴滴云控制台，当时考虑我们的<strong>控制台开发体验差，热更新慢，太臃肿，无法引入新的技术栈、升级组件库，为了更好支持平台化建设项目。遂考虑微服务拆分项目。</strong><br>这里来盗个kuitos知乎上的图，如果想做一个长长久久公有云控制台，考虑迭代和升级越早收益越高。</p>\n<p><img src=\"http://img-ys011.didistatic.com/static/dc2img/do1_erbRkYpYxwlqUBsp57i5\" alt=\"\"></p>\n<h4 id=\"愿景\"><a href=\"#愿景\" class=\"headerlink\" title=\"愿景\"></a>愿景</h4><p>希望将控制台庖丁解牛，拆分成几个独立的项目。每一个可以独立部署，独立开发。<strong>自由选择和升级技术栈，UI库，热更新快速。</strong></p>\n<h4 id=\"框架对比\"><a href=\"#框架对比\" class=\"headerlink\" title=\"框架对比\"></a>框架对比</h4><table>\n<thead>\n<tr>\n<th>框架</th>\n<th>github stars（2020.10.29）</th>\n<th>主应用</th>\n<th>共享依赖</th>\n<th>子应用可否单独开发调试</th>\n<th>部署</th>\n<th>entry</th>\n<th>js，css隔离</th>\n<th>路由控制</th>\n<th>应用间通信</th>\n<th>工程化</th>\n<th>官方支持</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>飞冰</td>\n<td>906</td>\n<td>必须react</td>\n<td>无</td>\n<td>可独立启动的子应用，可以</td>\n<td>如飞冰的截图，子应用单独部署</td>\n<td>html，js，简单如iframe</td>\n<td><a href=\"https://ice.work/docs/icestark/guide/sandbox\" target=\"_blank\" rel=\"noopener\">暂未完善</a></td>\n<td>简单的路由规则</td>\n<td><a href=\"https://ice.work/docs/icestark/guide/interaction\" target=\"_blank\" rel=\"noopener\">有方案</a></td>\n<td>无</td>\n<td>没有专门的群，效率差</td>\n</tr>\n<tr>\n<td>qiankun</td>\n<td>7.3k</td>\n<td>qiankun</td>\n<td>无</td>\n<td>可独立启动的子应用，可以</td>\n<td>子应用单独部署</td>\n<td>html，js，简单如iframe</td>\n<td><a href=\"https://zhuanlan.zhihu.com/p/200775337\" target=\"_blank\" rel=\"noopener\">js沙箱，css shadow dom等方案</a></td>\n<td>基于single-spa</td>\n<td><a href=\"https://zhuanlan.zhihu.com/p/200775337\" target=\"_blank\" rel=\"noopener\">没方案，但有一些建议</a></td>\n<td>无</td>\n<td>有群，效率一般</td>\n</tr>\n<tr>\n<td>single-spa</td>\n<td>7.6k</td>\n<td>single-spa</td>\n<td><a href=\"https://single-spa.js.org/docs/recommended-setup#utility-modules-styleguide-api-etc\" target=\"_blank\" rel=\"noopener\">utility-modules-styleguide-api-etc</a></td>\n<td>import-map-override完美解决</td>\n<td>子应用部署，需更新import-map</td>\n<td>需要systemjs，有一定成本</td>\n<td>官方未提供建议</td>\n<td>精准的路由控制</td>\n<td><a href=\"https://single-spa.js.org/docs/recommended-setup/\" target=\"_blank\" rel=\"noopener\">有方案</a></td>\n<td>有</td>\n<td>slack，效率一般。有热心John</td>\n</tr>\n</tbody>\n</table>\n<p>大概对比下来，single-spa和qiankun各有千秋。但是single-spa要求的是子项目单文件入口，如果html中插入了多个chunk，single-spa无法保证其按顺序加载，对我们的项目冲击较大，而qiankun是根据html解析，将其css script链接进行加载，无需改动，最后选择了qiankun，趟一趟水。</p>\n<h4 id=\"实践\"><a href=\"#实践\" class=\"headerlink\" title=\"实践\"></a>实践</h4><p>因为这次重构和其他需求是并行的，将任务拆解为以下几项</p>\n<ol>\n<li>涉及到梳理业务模块及依赖关系，根据依赖关系抽取公共模块。</li>\n<li>将必要模块放在root应用中，如登录，权限，导航等等。</li>\n<li>如何几个子项目如何构建，部署，上线</li>\n<li>项目结束后如何跟旧项目的feature 解决冲突</li>\n<li>抽取公共模块后，原项目的引用路径会变化，如何使用脚本来做这件事。</li>\n</ol>\n<h4 id=\"遇到的问题\"><a href=\"#遇到的问题\" class=\"headerlink\" title=\"遇到的问题\"></a>遇到的问题</h4><p>重构嘛，肯定会遇到问题。但是qiankun没有太多问题，花费我巨量时间的还是项目中的一些问题，举一两个小例子吧，没太多营养，也不想浪费笔墨。</p>\n<ol>\n<li>将公共样式和公共JS逻辑抽取到公共模块后，使用了import-html-entry加载，但是css的加载顺序会变化。如此脆弱的css，顺序变一下最终渲染的就会不同。</li>\n<li>公共模块中的postcss解析不对，postcss-nested这个插件，在webpack升级后需要升级，但是升级到最新Version 5会报错，还原到原来Version 1还是还会报错，试着往下降了一版到Version 4，可以work。难受。</li>\n<li>脚手架从webpack使用vue-cli后icon，竟然无法展示，具体记录在<a href=\"https://guguji5.github.io/2.%E8%AE%B0%E4%B8%80%E6%AC%A1Icon%E6%B2%A1%E5%B1%95%E7%A4%BA%E7%9A%84bugfix/\">记一次Icon没展示的bugfix</a></li>\n<li>store如何控制，因为是项目拆分，原来公用一个的vuex现在还想维持原状，不想做过多改动，最后使用<code>registerModule</code>将子应用的store注册为主应用的一个module，幸运的是大部分代码都是用getter来获取store中的值，getter的注册具有<a href=\"https://vuex.vuejs.org/zh/guide/modules.html#%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4\" target=\"_blank\" rel=\"noopener\">全局命名空间</a>，无论真是的store是在全局还是子模块。</li>\n<li>不想每次都启动N+1个项目，如何处理呢，临时使用npm-run-all来过渡。</li>\n<li>权限如何控制？ 其实本来权限也有后端设置的cookie来决定，但是原来是一个spa项目，404页面和* 页面，都需要处理。因为不属于该项目的路由，需要去适配其他的子应用，而不是展示一个404。</li>\n<li>子应用之前切换路由，不能使用vue-router的 name，而需要用path。</li>\n</ol>\n<h4 id=\"待解决的问题\"><a href=\"#待解决的问题\" class=\"headerlink\" title=\"待解决的问题\"></a>待解决的问题</h4><ol>\n<li>不想每次都启动N+1个项目，考虑实现一个类似 import-map-overrides 的工具。可以动态改变publicPath，只启动需要调试的子项目即可。</li>\n<li>多个Vue子项目同时启动后，vue-devtool时不时的失效。说不清就加载哪一个项目的状态，我在使用single-spa时没有这个问题。有待深入调查</li>\n<li>对于使用镜像来部署的场景，每个镜像中跑一个nginx，里边serve一个html感觉有点浪费，因为js，css，font，img等等全都放cdn上，对于一个三个子项目的项目，每个项目2个节点，有点浪费。</li>\n</ol>\n<h4 id=\"写在最后的话\"><a href=\"#写在最后的话\" class=\"headerlink\" title=\"写在最后的话\"></a>写在最后的话</h4><p>回到最初的愿景，我们还没实现，因为拆分才是我们重构的第一步，下一步要进一步细分，将服务拆的更小，然后才好进行无论是Vue升级，还是UI库升级。</p>\n<p>项目上线灰度结束，发现花时间最多的</p>\n<ol>\n<li>是处理cookie鉴权</li>\n<li>多个项目间路由的处理</li>\n<li>并行项目间合并代码</li>\n<li>多个项目构建太慢如何优化</li>\n</ol>\n<p>为了分析组件间的依赖关系，通过数据说话来决定哪些utils和components需要抽取到公共模块（被依赖太多和被main.js所依赖都需要抽取），自己实现了nodejs脚本来分析webpack的stat文件。<br>通过自动合并代码及查看diff，又写了个nodejs脚本来自动合并。<br>也很有趣。</p>\n<h4 id=\"Reference\"><a href=\"#Reference\" class=\"headerlink\" title=\"Reference\"></a>Reference</h4><ol>\n<li>飞冰官网：<a href=\"https://ice.work/docs/icestark/about\" target=\"_blank\" rel=\"noopener\">https://ice.work/docs/icestark/about</a></li>\n<li>飞冰作者分享：<a href=\"https://zhuanlan.zhihu.com/p/88449415\" target=\"_blank\" rel=\"noopener\">https://zhuanlan.zhihu.com/p/88449415</a></li>\n<li>qiankun官网：<a href=\"https://qiankun.umijs.org/zh\" target=\"_blank\" rel=\"noopener\">https://qiankun.umijs.org/zh</a></li>\n<li>qiankun作者博客：<a href=\"https://zhuanlan.zhihu.com/p/95085796\" target=\"_blank\" rel=\"noopener\">https://zhuanlan.zhihu.com/p/95085796</a>  </li>\n<li>qiankun作者博客：<a href=\"https://zhuanlan.zhihu.com/p/200775337\" target=\"_blank\" rel=\"noopener\">https://zhuanlan.zhihu.com/p/200775337</a> </li>\n<li><a href=\"https://juejin.im/post/6856569463950639117#heading-15\" target=\"_blank\" rel=\"noopener\">https://juejin.im/post/6856569463950639117#heading-15</a> </li>\n<li>signle-spa官网：<a href=\"https://single-spa.js.org/\" target=\"_blank\" rel=\"noopener\">https://single-spa.js.org/</a></li>\n</ol>\n"},{"title":"5.Vue升级引发nextTick的bug(二)","date":"2021-01-27T03:34:37.000Z","_content":"\nnextTick是Vue绕不开的一个方法，nextTick的实现变了，莫名的bug就会出现，再举一个例子。\n\n首先，[Vue升级引发nextTick的bug(一)](https://guguji5.github.io/4.Vue%E5%8D%87%E7%BA%A7%E5%BC%95%E5%8F%91nextTick%E7%9A%84bug(%E4%B8%80)/)提到，Vue2.5.2中的nextTick是宏任务 -> 微任务 -> 宏任务交替触发，先使用宏任务。而Vue2.6.10中nextTick全部使用微任务。\n\n我们的场景是view中有一个form组件，其内部有一个input-number组件。用户填写完信息后submit。\n\n![](http://img-ys011.didistatic.com/static/dc2img/do1_96rC48y3RhuUTb1e5xSk)\n\n顺便介绍一下input-number，可以参考el-input-number，返回值是数字，当输入其他非法类型时，回弹为上一次有效数字。这一过程会在nextTick中完成。\n\nsubmit的入参为params {num: string}。为啥num要传string，额~~ 一言难尽。\n\n如何将input-number组件的**数字num**,转成字符串呢，form组件中有个方法来处理数据`transData`。\n\n每次reactive的数据变化都会触发nextTick。\n\n![](https://img-ys011.didistatic.com/static/dc2img/do1_RaSpWcBtIY6jM8Pgsy79)\n\n所以提交动作的事件流为：\n\n**submit -> $refs.form.transData() -> axios request**\n\n但是，input-number为form的子组件，当子组件值变化时，会改变form中的值，引用传递，不用多讲啦。\n\n所以**Vue2.5.2**完整的事件流为：\n\n**submit -> $refs.form.transData() -> axios request -> num回弹为数字**\n\n![](https://img-ys011.didistatic.com/static/dc2img/do1_DJv1lVGZvksjimDrdD8E)\n\naxios的拦截器中是使用promise来处理数据，promise的then为微任务。\n\n而根据上一篇的讨论，[]() num值的变化是在nextTick中完成的。所以当**Vue升级成2.6.10**，nextTick变成微任务后，事件流为：\n\n**submit -> num回弹为数字 -> $refs.form.transData() -> axios request**\n\n![](https://img-ys011.didistatic.com/static/dc2img/axiosNum2.6.10.png)\n\n从console中可以看到，在Vue2.5.2中是先axios请求，然后值回弹为数字，所以发送的num为字符串，符合预期。\n\n而升级为Vue2.6.10后，会先回弹，再发送数据，所以发送的num为数字，bug出现。\n\n\n","source":"_posts/5.Vue升级引发nextTick的bug(二).md","raw":"---\ntitle: 5.Vue升级引发nextTick的bug(二)\ndate: 2021-01-27 11:34:37\ntags: Bugfix\n---\n\nnextTick是Vue绕不开的一个方法，nextTick的实现变了，莫名的bug就会出现，再举一个例子。\n\n首先，[Vue升级引发nextTick的bug(一)](https://guguji5.github.io/4.Vue%E5%8D%87%E7%BA%A7%E5%BC%95%E5%8F%91nextTick%E7%9A%84bug(%E4%B8%80)/)提到，Vue2.5.2中的nextTick是宏任务 -> 微任务 -> 宏任务交替触发，先使用宏任务。而Vue2.6.10中nextTick全部使用微任务。\n\n我们的场景是view中有一个form组件，其内部有一个input-number组件。用户填写完信息后submit。\n\n![](http://img-ys011.didistatic.com/static/dc2img/do1_96rC48y3RhuUTb1e5xSk)\n\n顺便介绍一下input-number，可以参考el-input-number，返回值是数字，当输入其他非法类型时，回弹为上一次有效数字。这一过程会在nextTick中完成。\n\nsubmit的入参为params {num: string}。为啥num要传string，额~~ 一言难尽。\n\n如何将input-number组件的**数字num**,转成字符串呢，form组件中有个方法来处理数据`transData`。\n\n每次reactive的数据变化都会触发nextTick。\n\n![](https://img-ys011.didistatic.com/static/dc2img/do1_RaSpWcBtIY6jM8Pgsy79)\n\n所以提交动作的事件流为：\n\n**submit -> $refs.form.transData() -> axios request**\n\n但是，input-number为form的子组件，当子组件值变化时，会改变form中的值，引用传递，不用多讲啦。\n\n所以**Vue2.5.2**完整的事件流为：\n\n**submit -> $refs.form.transData() -> axios request -> num回弹为数字**\n\n![](https://img-ys011.didistatic.com/static/dc2img/do1_DJv1lVGZvksjimDrdD8E)\n\naxios的拦截器中是使用promise来处理数据，promise的then为微任务。\n\n而根据上一篇的讨论，[]() num值的变化是在nextTick中完成的。所以当**Vue升级成2.6.10**，nextTick变成微任务后，事件流为：\n\n**submit -> num回弹为数字 -> $refs.form.transData() -> axios request**\n\n![](https://img-ys011.didistatic.com/static/dc2img/axiosNum2.6.10.png)\n\n从console中可以看到，在Vue2.5.2中是先axios请求，然后值回弹为数字，所以发送的num为字符串，符合预期。\n\n而升级为Vue2.6.10后，会先回弹，再发送数据，所以发送的num为数字，bug出现。\n\n\n","slug":"5.Vue升级引发nextTick的bug(二)","published":1,"updated":"2021-01-28T12:47:31.556Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckrix8zdc0005k1jf2c3ytiva","content":"<p>nextTick是Vue绕不开的一个方法，nextTick的实现变了，莫名的bug就会出现，再举一个例子。</p>\n<p>首先，<a href=\"https://guguji5.github.io/4.Vue%E5%8D%87%E7%BA%A7%E5%BC%95%E5%8F%91nextTick%E7%9A%84bug(%E4%B8%80\">Vue升级引发nextTick的bug(一)</a>/)提到，Vue2.5.2中的nextTick是宏任务 -&gt; 微任务 -&gt; 宏任务交替触发，先使用宏任务。而Vue2.6.10中nextTick全部使用微任务。</p>\n<p>我们的场景是view中有一个form组件，其内部有一个input-number组件。用户填写完信息后submit。</p>\n<p><img src=\"http://img-ys011.didistatic.com/static/dc2img/do1_96rC48y3RhuUTb1e5xSk\" alt=\"\"></p>\n<p>顺便介绍一下input-number，可以参考el-input-number，返回值是数字，当输入其他非法类型时，回弹为上一次有效数字。这一过程会在nextTick中完成。</p>\n<p>submit的入参为params {num: string}。为啥num要传string，额~~ 一言难尽。</p>\n<p>如何将input-number组件的<strong>数字num</strong>,转成字符串呢，form组件中有个方法来处理数据<code>transData</code>。</p>\n<p>每次reactive的数据变化都会触发nextTick。</p>\n<p><img src=\"https://img-ys011.didistatic.com/static/dc2img/do1_RaSpWcBtIY6jM8Pgsy79\" alt=\"\"></p>\n<p>所以提交动作的事件流为：</p>\n<p><strong>submit -&gt; $refs.form.transData() -&gt; axios request</strong></p>\n<p>但是，input-number为form的子组件，当子组件值变化时，会改变form中的值，引用传递，不用多讲啦。</p>\n<p>所以<strong>Vue2.5.2</strong>完整的事件流为：</p>\n<p><strong>submit -&gt; $refs.form.transData() -&gt; axios request -&gt; num回弹为数字</strong></p>\n<p><img src=\"https://img-ys011.didistatic.com/static/dc2img/do1_DJv1lVGZvksjimDrdD8E\" alt=\"\"></p>\n<p>axios的拦截器中是使用promise来处理数据，promise的then为微任务。</p>\n<p>而根据上一篇的讨论，<a href=\"\"></a> num值的变化是在nextTick中完成的。所以当<strong>Vue升级成2.6.10</strong>，nextTick变成微任务后，事件流为：</p>\n<p><strong>submit -&gt; num回弹为数字 -&gt; $refs.form.transData() -&gt; axios request</strong></p>\n<p><img src=\"https://img-ys011.didistatic.com/static/dc2img/axiosNum2.6.10.png\" alt=\"\"></p>\n<p>从console中可以看到，在Vue2.5.2中是先axios请求，然后值回弹为数字，所以发送的num为字符串，符合预期。</p>\n<p>而升级为Vue2.6.10后，会先回弹，再发送数据，所以发送的num为数字，bug出现。</p>\n","site":{"data":{}},"excerpt":"","more":"<p>nextTick是Vue绕不开的一个方法，nextTick的实现变了，莫名的bug就会出现，再举一个例子。</p>\n<p>首先，<a href=\"https://guguji5.github.io/4.Vue%E5%8D%87%E7%BA%A7%E5%BC%95%E5%8F%91nextTick%E7%9A%84bug(%E4%B8%80\">Vue升级引发nextTick的bug(一)</a>/)提到，Vue2.5.2中的nextTick是宏任务 -&gt; 微任务 -&gt; 宏任务交替触发，先使用宏任务。而Vue2.6.10中nextTick全部使用微任务。</p>\n<p>我们的场景是view中有一个form组件，其内部有一个input-number组件。用户填写完信息后submit。</p>\n<p><img src=\"http://img-ys011.didistatic.com/static/dc2img/do1_96rC48y3RhuUTb1e5xSk\" alt=\"\"></p>\n<p>顺便介绍一下input-number，可以参考el-input-number，返回值是数字，当输入其他非法类型时，回弹为上一次有效数字。这一过程会在nextTick中完成。</p>\n<p>submit的入参为params {num: string}。为啥num要传string，额~~ 一言难尽。</p>\n<p>如何将input-number组件的<strong>数字num</strong>,转成字符串呢，form组件中有个方法来处理数据<code>transData</code>。</p>\n<p>每次reactive的数据变化都会触发nextTick。</p>\n<p><img src=\"https://img-ys011.didistatic.com/static/dc2img/do1_RaSpWcBtIY6jM8Pgsy79\" alt=\"\"></p>\n<p>所以提交动作的事件流为：</p>\n<p><strong>submit -&gt; $refs.form.transData() -&gt; axios request</strong></p>\n<p>但是，input-number为form的子组件，当子组件值变化时，会改变form中的值，引用传递，不用多讲啦。</p>\n<p>所以<strong>Vue2.5.2</strong>完整的事件流为：</p>\n<p><strong>submit -&gt; $refs.form.transData() -&gt; axios request -&gt; num回弹为数字</strong></p>\n<p><img src=\"https://img-ys011.didistatic.com/static/dc2img/do1_DJv1lVGZvksjimDrdD8E\" alt=\"\"></p>\n<p>axios的拦截器中是使用promise来处理数据，promise的then为微任务。</p>\n<p>而根据上一篇的讨论，<a href=\"\"></a> num值的变化是在nextTick中完成的。所以当<strong>Vue升级成2.6.10</strong>，nextTick变成微任务后，事件流为：</p>\n<p><strong>submit -&gt; num回弹为数字 -&gt; $refs.form.transData() -&gt; axios request</strong></p>\n<p><img src=\"https://img-ys011.didistatic.com/static/dc2img/axiosNum2.6.10.png\" alt=\"\"></p>\n<p>从console中可以看到，在Vue2.5.2中是先axios请求，然后值回弹为数字，所以发送的num为字符串，符合预期。</p>\n<p>而升级为Vue2.6.10后，会先回弹，再发送数据，所以发送的num为数字，bug出现。</p>\n"},{"title":"4.Vue升级引发nextTick的bug(一)","date":"2021-01-26T10:15:07.000Z","_content":"\n最近项目使用qiankun做了个简单的重构和拆分，顺手把Vue版本往上升级了一丢丢（2.5.5 -> 2.6.10)。出现了一点问题，记录之。\n\n简单介绍一下场景，也很简单，就是点击button，出现dialog，而点击其他区域，关闭该dialog，应该是个非常常见的需求。\n\n![](http://img-ys011.didistatic.com/static/dc2img/do1_yngcCDJ7zLxtVZ5WlJPi)\n\nVue2.5.2事件流如下:\n\n**button clicked -> document clicked（冒泡） -> dialog render -> directive bind function 触发 -> document.addEventListener 触发 **\n\n**其中`document.addEventListener`中的callback，就是关闭该dialog。**点击其他区域关闭弹窗，合情合理，符合需求。\n\n代码在Vue2.5.2下工作正常，升级到Vue2.6.10之后，点击button后没有显示dialog，经过各种排查，发现原来是nextTick搞的鬼。\n\n**因为click事件是宏任务**，如果不清楚可以点击 [证明：Click是一个EventLoop宏任务](https://guguji5.github.io/%E8%AF%81%E6%98%8E%EF%BC%9AClick%E6%98%AF%E4%B8%80%E4%B8%AAEventLoop%E5%AE%8F%E4%BB%BB%E5%8A%A1/) 查看证明过程。\n\n而Vue2.5.2中的nextTick是宏任务 -> 微任务 -> 宏任务交替触发，第一次使用宏任务。而Vue2.6.10中nextTick全部使用微任务。\n\n重新解释一下 Vue2.5.2事件流：\n\n**button clicked (触发nextTick) -> document clicked（冒泡） -> nextTick 触发（dialog render -> directive bind function 触发 -> document.addEventListener 触发 ）**\n\n而根据EventLoop中微任务优先于宏任务执行的逻辑，Vue2.6.10事件流：\n\n**button clicked (触发nextTick) -> nextTick 触发（dialog render -> directive bind function 触发 -> document.addEventListener 触发 ） -> document clicked（冒泡 触发listener函数）-> callback 触发 关闭dialog**\n\n所以表现上弹窗没打开。慢动作是打开了，又关闭了。Bug由此产生。\n\n---\n\n进一步刨根问题一下为啥会触发nextTick，如果清楚的同学就不用往下看了。\n先看一下nextTick在不同Vue版本中的注释\n```\n// Vue 2.5.2\n// Here we have async deferring wrappers using both micro and macro tasks.\n// In < 2.4 we used micro tasks everywhere, but there are some scenarios where\n// micro tasks have too high a priority and fires in between supposedly\n// sequential events (e.g. #4521, #6690) or even between bubbling of the same\n// event (#6566). However, using macro tasks everywhere also has subtle problems\n// when state is changed right before repaint (e.g. #6813, out-in transitions).\n// Here we use micro task by default, but expose a way to force macro task when\n// needed (e.g. in event handlers attached by v-on).\n```\n```\n// Vue 2.6.10\n// Here we have async deferring wrappers using microtasks.\n// In 2.5 we used (macro) tasks (in combination with microtasks).\n// However, it has subtle problems when state is changed right before repaint\n// (e.g. #6813, out-in transitions).\n// Also, using (macro) tasks in event handler would cause some weird behaviors\n// that cannot be circumvented (e.g. #7109, #7153, #7546, #7834, #8109).\n// So we now use microtasks everywhere, again.\n// A major drawback of this tradeoff is that there are some scenarios\n// where microtasks have too high a priority and fire in between supposedly\n// sequential events (e.g. #4521, #6690, which have workarounds)\n// or even between bubbling of the same event (#6566).\n```\n\n首先明确，dialog的打开关闭是用一个data中的变量来控制的，它是reactive的，而button点击打开dialog的过程无非就是将该值设为true，而设置的过程必然会触发defineProperty中的set函数。触发过程如下\n\n**set function -> dep.notify() -> subs[].update() -> queueWatcher() -> nextTick()**\n\n也就是说每次赋值都会触发nextTick，或者说每次数据的更新后续的变更都是在nextTick中进行的（不知道这么说是不是准确）。\n\n*https://unpkg.com/vue@2.5.2/dist/vue.js*\n\n","source":"_posts/4.Vue升级引发nextTick的bug(一).md","raw":"---\ntitle: 4.Vue升级引发nextTick的bug(一)\ndate: 2021-01-26 18:15:07\ntags: Bugfix\n---\n\n最近项目使用qiankun做了个简单的重构和拆分，顺手把Vue版本往上升级了一丢丢（2.5.5 -> 2.6.10)。出现了一点问题，记录之。\n\n简单介绍一下场景，也很简单，就是点击button，出现dialog，而点击其他区域，关闭该dialog，应该是个非常常见的需求。\n\n![](http://img-ys011.didistatic.com/static/dc2img/do1_yngcCDJ7zLxtVZ5WlJPi)\n\nVue2.5.2事件流如下:\n\n**button clicked -> document clicked（冒泡） -> dialog render -> directive bind function 触发 -> document.addEventListener 触发 **\n\n**其中`document.addEventListener`中的callback，就是关闭该dialog。**点击其他区域关闭弹窗，合情合理，符合需求。\n\n代码在Vue2.5.2下工作正常，升级到Vue2.6.10之后，点击button后没有显示dialog，经过各种排查，发现原来是nextTick搞的鬼。\n\n**因为click事件是宏任务**，如果不清楚可以点击 [证明：Click是一个EventLoop宏任务](https://guguji5.github.io/%E8%AF%81%E6%98%8E%EF%BC%9AClick%E6%98%AF%E4%B8%80%E4%B8%AAEventLoop%E5%AE%8F%E4%BB%BB%E5%8A%A1/) 查看证明过程。\n\n而Vue2.5.2中的nextTick是宏任务 -> 微任务 -> 宏任务交替触发，第一次使用宏任务。而Vue2.6.10中nextTick全部使用微任务。\n\n重新解释一下 Vue2.5.2事件流：\n\n**button clicked (触发nextTick) -> document clicked（冒泡） -> nextTick 触发（dialog render -> directive bind function 触发 -> document.addEventListener 触发 ）**\n\n而根据EventLoop中微任务优先于宏任务执行的逻辑，Vue2.6.10事件流：\n\n**button clicked (触发nextTick) -> nextTick 触发（dialog render -> directive bind function 触发 -> document.addEventListener 触发 ） -> document clicked（冒泡 触发listener函数）-> callback 触发 关闭dialog**\n\n所以表现上弹窗没打开。慢动作是打开了，又关闭了。Bug由此产生。\n\n---\n\n进一步刨根问题一下为啥会触发nextTick，如果清楚的同学就不用往下看了。\n先看一下nextTick在不同Vue版本中的注释\n```\n// Vue 2.5.2\n// Here we have async deferring wrappers using both micro and macro tasks.\n// In < 2.4 we used micro tasks everywhere, but there are some scenarios where\n// micro tasks have too high a priority and fires in between supposedly\n// sequential events (e.g. #4521, #6690) or even between bubbling of the same\n// event (#6566). However, using macro tasks everywhere also has subtle problems\n// when state is changed right before repaint (e.g. #6813, out-in transitions).\n// Here we use micro task by default, but expose a way to force macro task when\n// needed (e.g. in event handlers attached by v-on).\n```\n```\n// Vue 2.6.10\n// Here we have async deferring wrappers using microtasks.\n// In 2.5 we used (macro) tasks (in combination with microtasks).\n// However, it has subtle problems when state is changed right before repaint\n// (e.g. #6813, out-in transitions).\n// Also, using (macro) tasks in event handler would cause some weird behaviors\n// that cannot be circumvented (e.g. #7109, #7153, #7546, #7834, #8109).\n// So we now use microtasks everywhere, again.\n// A major drawback of this tradeoff is that there are some scenarios\n// where microtasks have too high a priority and fire in between supposedly\n// sequential events (e.g. #4521, #6690, which have workarounds)\n// or even between bubbling of the same event (#6566).\n```\n\n首先明确，dialog的打开关闭是用一个data中的变量来控制的，它是reactive的，而button点击打开dialog的过程无非就是将该值设为true，而设置的过程必然会触发defineProperty中的set函数。触发过程如下\n\n**set function -> dep.notify() -> subs[].update() -> queueWatcher() -> nextTick()**\n\n也就是说每次赋值都会触发nextTick，或者说每次数据的更新后续的变更都是在nextTick中进行的（不知道这么说是不是准确）。\n\n*https://unpkg.com/vue@2.5.2/dist/vue.js*\n\n","slug":"4.Vue升级引发nextTick的bug(一)","published":1,"updated":"2021-01-26T12:15:51.629Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckrix8zdf0007k1jfmaj7lfai","content":"<p>最近项目使用qiankun做了个简单的重构和拆分，顺手把Vue版本往上升级了一丢丢（2.5.5 -&gt; 2.6.10)。出现了一点问题，记录之。</p>\n<p>简单介绍一下场景，也很简单，就是点击button，出现dialog，而点击其他区域，关闭该dialog，应该是个非常常见的需求。</p>\n<p><img src=\"http://img-ys011.didistatic.com/static/dc2img/do1_yngcCDJ7zLxtVZ5WlJPi\" alt=\"\"></p>\n<p>Vue2.5.2事件流如下:</p>\n<p><strong>button clicked -&gt; document clicked（冒泡） -&gt; dialog render -&gt; directive bind function 触发 -&gt; document.addEventListener 触发 </strong></p>\n<p><strong>其中<code>document.addEventListener</code>中的callback，就是关闭该dialog。</strong>点击其他区域关闭弹窗，合情合理，符合需求。</p>\n<p>代码在Vue2.5.2下工作正常，升级到Vue2.6.10之后，点击button后没有显示dialog，经过各种排查，发现原来是nextTick搞的鬼。</p>\n<p><strong>因为click事件是宏任务</strong>，如果不清楚可以点击 <a href=\"https://guguji5.github.io/%E8%AF%81%E6%98%8E%EF%BC%9AClick%E6%98%AF%E4%B8%80%E4%B8%AAEventLoop%E5%AE%8F%E4%BB%BB%E5%8A%A1/\">证明：Click是一个EventLoop宏任务</a> 查看证明过程。</p>\n<p>而Vue2.5.2中的nextTick是宏任务 -&gt; 微任务 -&gt; 宏任务交替触发，第一次使用宏任务。而Vue2.6.10中nextTick全部使用微任务。</p>\n<p>重新解释一下 Vue2.5.2事件流：</p>\n<p><strong>button clicked (触发nextTick) -&gt; document clicked（冒泡） -&gt; nextTick 触发（dialog render -&gt; directive bind function 触发 -&gt; document.addEventListener 触发 ）</strong></p>\n<p>而根据EventLoop中微任务优先于宏任务执行的逻辑，Vue2.6.10事件流：</p>\n<p><strong>button clicked (触发nextTick) -&gt; nextTick 触发（dialog render -&gt; directive bind function 触发 -&gt; document.addEventListener 触发 ） -&gt; document clicked（冒泡 触发listener函数）-&gt; callback 触发 关闭dialog</strong></p>\n<p>所以表现上弹窗没打开。慢动作是打开了，又关闭了。Bug由此产生。</p>\n<hr>\n<p>进一步刨根问题一下为啥会触发nextTick，如果清楚的同学就不用往下看了。<br>先看一下nextTick在不同Vue版本中的注释<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// Vue 2.5.2</span><br><span class=\"line\">// Here we have async deferring wrappers using both micro and macro tasks.</span><br><span class=\"line\">// In &lt; 2.4 we used micro tasks everywhere, but there are some scenarios where</span><br><span class=\"line\">// micro tasks have too high a priority and fires in between supposedly</span><br><span class=\"line\">// sequential events (e.g. #4521, #6690) or even between bubbling of the same</span><br><span class=\"line\">// event (#6566). However, using macro tasks everywhere also has subtle problems</span><br><span class=\"line\">// when state is changed right before repaint (e.g. #6813, out-in transitions).</span><br><span class=\"line\">// Here we use micro task by default, but expose a way to force macro task when</span><br><span class=\"line\">// needed (e.g. in event handlers attached by v-on).</span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// Vue 2.6.10</span><br><span class=\"line\">// Here we have async deferring wrappers using microtasks.</span><br><span class=\"line\">// In 2.5 we used (macro) tasks (in combination with microtasks).</span><br><span class=\"line\">// However, it has subtle problems when state is changed right before repaint</span><br><span class=\"line\">// (e.g. #6813, out-in transitions).</span><br><span class=\"line\">// Also, using (macro) tasks in event handler would cause some weird behaviors</span><br><span class=\"line\">// that cannot be circumvented (e.g. #7109, #7153, #7546, #7834, #8109).</span><br><span class=\"line\">// So we now use microtasks everywhere, again.</span><br><span class=\"line\">// A major drawback of this tradeoff is that there are some scenarios</span><br><span class=\"line\">// where microtasks have too high a priority and fire in between supposedly</span><br><span class=\"line\">// sequential events (e.g. #4521, #6690, which have workarounds)</span><br><span class=\"line\">// or even between bubbling of the same event (#6566).</span><br></pre></td></tr></table></figure>\n<p>首先明确，dialog的打开关闭是用一个data中的变量来控制的，它是reactive的，而button点击打开dialog的过程无非就是将该值设为true，而设置的过程必然会触发defineProperty中的set函数。触发过程如下</p>\n<p><strong>set function -&gt; dep.notify() -&gt; subs[].update() -&gt; queueWatcher() -&gt; nextTick()</strong></p>\n<p>也就是说每次赋值都会触发nextTick，或者说每次数据的更新后续的变更都是在nextTick中进行的（不知道这么说是不是准确）。</p>\n<p><em><a href=\"https://unpkg.com/vue@2.5.2/dist/vue.js\" target=\"_blank\" rel=\"noopener\">https://unpkg.com/vue@2.5.2/dist/vue.js</a></em></p>\n","site":{"data":{}},"excerpt":"","more":"<p>最近项目使用qiankun做了个简单的重构和拆分，顺手把Vue版本往上升级了一丢丢（2.5.5 -&gt; 2.6.10)。出现了一点问题，记录之。</p>\n<p>简单介绍一下场景，也很简单，就是点击button，出现dialog，而点击其他区域，关闭该dialog，应该是个非常常见的需求。</p>\n<p><img src=\"http://img-ys011.didistatic.com/static/dc2img/do1_yngcCDJ7zLxtVZ5WlJPi\" alt=\"\"></p>\n<p>Vue2.5.2事件流如下:</p>\n<p><strong>button clicked -&gt; document clicked（冒泡） -&gt; dialog render -&gt; directive bind function 触发 -&gt; document.addEventListener 触发 </strong></p>\n<p><strong>其中<code>document.addEventListener</code>中的callback，就是关闭该dialog。</strong>点击其他区域关闭弹窗，合情合理，符合需求。</p>\n<p>代码在Vue2.5.2下工作正常，升级到Vue2.6.10之后，点击button后没有显示dialog，经过各种排查，发现原来是nextTick搞的鬼。</p>\n<p><strong>因为click事件是宏任务</strong>，如果不清楚可以点击 <a href=\"https://guguji5.github.io/%E8%AF%81%E6%98%8E%EF%BC%9AClick%E6%98%AF%E4%B8%80%E4%B8%AAEventLoop%E5%AE%8F%E4%BB%BB%E5%8A%A1/\">证明：Click是一个EventLoop宏任务</a> 查看证明过程。</p>\n<p>而Vue2.5.2中的nextTick是宏任务 -&gt; 微任务 -&gt; 宏任务交替触发，第一次使用宏任务。而Vue2.6.10中nextTick全部使用微任务。</p>\n<p>重新解释一下 Vue2.5.2事件流：</p>\n<p><strong>button clicked (触发nextTick) -&gt; document clicked（冒泡） -&gt; nextTick 触发（dialog render -&gt; directive bind function 触发 -&gt; document.addEventListener 触发 ）</strong></p>\n<p>而根据EventLoop中微任务优先于宏任务执行的逻辑，Vue2.6.10事件流：</p>\n<p><strong>button clicked (触发nextTick) -&gt; nextTick 触发（dialog render -&gt; directive bind function 触发 -&gt; document.addEventListener 触发 ） -&gt; document clicked（冒泡 触发listener函数）-&gt; callback 触发 关闭dialog</strong></p>\n<p>所以表现上弹窗没打开。慢动作是打开了，又关闭了。Bug由此产生。</p>\n<hr>\n<p>进一步刨根问题一下为啥会触发nextTick，如果清楚的同学就不用往下看了。<br>先看一下nextTick在不同Vue版本中的注释<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// Vue 2.5.2</span><br><span class=\"line\">// Here we have async deferring wrappers using both micro and macro tasks.</span><br><span class=\"line\">// In &lt; 2.4 we used micro tasks everywhere, but there are some scenarios where</span><br><span class=\"line\">// micro tasks have too high a priority and fires in between supposedly</span><br><span class=\"line\">// sequential events (e.g. #4521, #6690) or even between bubbling of the same</span><br><span class=\"line\">// event (#6566). However, using macro tasks everywhere also has subtle problems</span><br><span class=\"line\">// when state is changed right before repaint (e.g. #6813, out-in transitions).</span><br><span class=\"line\">// Here we use micro task by default, but expose a way to force macro task when</span><br><span class=\"line\">// needed (e.g. in event handlers attached by v-on).</span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// Vue 2.6.10</span><br><span class=\"line\">// Here we have async deferring wrappers using microtasks.</span><br><span class=\"line\">// In 2.5 we used (macro) tasks (in combination with microtasks).</span><br><span class=\"line\">// However, it has subtle problems when state is changed right before repaint</span><br><span class=\"line\">// (e.g. #6813, out-in transitions).</span><br><span class=\"line\">// Also, using (macro) tasks in event handler would cause some weird behaviors</span><br><span class=\"line\">// that cannot be circumvented (e.g. #7109, #7153, #7546, #7834, #8109).</span><br><span class=\"line\">// So we now use microtasks everywhere, again.</span><br><span class=\"line\">// A major drawback of this tradeoff is that there are some scenarios</span><br><span class=\"line\">// where microtasks have too high a priority and fire in between supposedly</span><br><span class=\"line\">// sequential events (e.g. #4521, #6690, which have workarounds)</span><br><span class=\"line\">// or even between bubbling of the same event (#6566).</span><br></pre></td></tr></table></figure>\n<p>首先明确，dialog的打开关闭是用一个data中的变量来控制的，它是reactive的，而button点击打开dialog的过程无非就是将该值设为true，而设置的过程必然会触发defineProperty中的set函数。触发过程如下</p>\n<p><strong>set function -&gt; dep.notify() -&gt; subs[].update() -&gt; queueWatcher() -&gt; nextTick()</strong></p>\n<p>也就是说每次赋值都会触发nextTick，或者说每次数据的更新后续的变更都是在nextTick中进行的（不知道这么说是不是准确）。</p>\n<p><em><a href=\"https://unpkg.com/vue@2.5.2/dist/vue.js\" target=\"_blank\" rel=\"noopener\">https://unpkg.com/vue@2.5.2/dist/vue.js</a></em></p>\n"},{"title":"Hexo + Github搭建静态博客(一)","date":"2018-11-09T05:19:48.000Z","comments":1,"_content":"### 快速介绍\nHexo是一个基于Node.js搭建的静态博客框架，通过Hexo，用户可以\b以博文的方式发布\bMarkdown文档。\b\b结合默认或定制化\b主题模板（很像其他静态博客生成框架，Jekyll或Ghost）博文会被转化和生成为HTML/CSS。Hexo所需的所有组件都是模块化的，\b所以你可以按需安装。\n\n### 提前准备\n\b跟着本博客，你可能需要提前准备：\n\n1. git\n2. Node.js\n3. Github账号\n\n### 第一步 安装和初始化Hexo\n这一步需要安装好Hexo所需的东西，Hexo是有许多软件包组成的，而最必要的一个就是npm，Node.js包管理器。\n\n首先，安装hexo-cli,最重要最核心的Hexo命令。\n```\n$ npm install hexo-cli -g\n```\n其次，我们需要创建一些\b基础文件，很幸运，Hexo为我们提供了一键生成的命令。我们只需要\b切换到准备好的文件夹目录，执行如下命令。\n```\n$ hexo init \n```\n此时，文件夹下可能会出现很多文件和文件夹，如下图所示：\n```shell\nblog/\n├── _config.yml\n├── node_modules\n├── package.json\n├── scaffolds\n├── source\n└── theme\n\n4 directory, 2 files\n```\n\n### 第二步 \b设置Hexo主要的配置文件 _config.yml\n上图的这些文件中，_config.yml是至关重要的，所有的核心配置都存储在这个博客中，如果将来你想调整博客的一些设置，\b\b大概率就是这个文件。\n\n我们将会一步一步的\b\b修改配置，选择你喜欢的编辑器，vi， nano 或者sublime等打开_config.yml，在最上边你会看到如下的内容。\n```\n# Site\ntitle: Hexo\nsubtitle:\ndescription:\nauthor: John Doe\nlanguage:\ntimezone:\n```\n前四行分别是博客的名称，\b二级名称，描述和作者的名称。目前不是所有的Hexo主题都会显示这些信息，所以它大多数当成网站\b基本信息。\n\n后边两行是语言和时区，语言选择两字符ISO 639-1代码。时区默认指的是用户服务器的时区，用“tz database\"格式。你可以根据需要修改他们，下边是一个例子：\n```\n#Site\ntitle: 滴滴云博客 \nsubtitle: 为开发者而生 \ndescription: 滴滴云基于滴滴出行的业务技术和经验积累,采用领先的云计算架构、高规格服务器集群搭建、高性能资源配置机制、精细化运营模式,致力于为开发者提供简单快捷、高效稳定。\nauthor: \bdidicloud \nlanguage: zh-CN \ntimezone: \n```\n**主题** 的更换是在_config.yml中`theme`字段。\n\n最后我们要更改的设置是default_layout:\b 在Writing\b下边，在一个博文没发表之前，它是\b不可见的，我们想存成草稿，所以我们把default_layout\b设置成draft。\n```\n# Writing\nnew_post_name: :title.md # File name of new posts\ndefault_layout: draft\ntitlecase: false # Transform title into titlecase\n```\n### 第三步 \b创建和发表博客\n用如下命令来创建一个博文（草稿）,这里的‘first-page’是博文的名称。\n\n```\n$ hexo new first-post\n```\n然后我们应该会看到这样的显示：\n```\nOutput\nINFO  Created: ~/hexo_blog/source/_drafts/first-post.md\n```\n我们可以选择自己喜欢的编辑器，打开first-post.md\n\n每一个博文都有一个\bfront-matter设置，Front-matter是一个\bJSON or YAML块，它可以用来设置这标题，发布时间，标签等等。Front-matter\b\b一般用`---`或者`;;;`标志结尾。在Front-matter之后，你可以用Markdown语法写自己的博文。\n\n用如下的内容替换\bfirst-post.md的内容。\n```\ntitle: 滴滴云--为开发者而生\ntags:\n  - Test\n  - Blog\ncategories:\n  - Hexo\ncomments: true\ndate: 2018-11-04 00:00:00\n---\n\n## Markdown goes here.\n\n**This is our first post!**\n```\n然后执行`$ hexo publish first-post`会看到如下的结果：\n```\nOutput\nINFO  Published: ~/hexo_blog/source/_posts/first-post.md\n```\n### 第四步 启动服务器\n\b到目前为止，所有的配置文件和博文都已准备完毕，接下来，我们启动服务器。\n```\n$ hexo server\n```\n现在，我们可以访问自己的博客通过`http://localhost:4000`。你会看到自己预设的hello-world博客,\b`ctrl+c`可以停止服务器。\n![draw](https://img-blog.csdn.net/20161023150235594?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)\n### 第五步 设置部署脚本\n到目前为止，Hexo有许多不同的方法可以部署，本博客是用git来进行存储，上传，托管博客。除此之外，还支持Heroku, Git, Rsync, OpenShift, FTPSync等多种工具。\n\n这里需要一个git仓库来存储Hexo生成的静态HTML文件，为了简单起见，这里我们用Github提供的git仓库。\n\n在Github上创建一个`<username>.Github.io`的仓库，选择“\bPublic”，并且点击“Initialize this repository with a README”\b选择框。然后打开_config.yml。\n```\n# Deployment\n## Docs: https://hexo.io/docs/deployment.html\ndeploy:\n  type:\n```\n按如下所示，填上\bdeploy选项，你必须\b\b替换`username`为自己的Github账号。\n```\n\ndeploy:\n  type: git\n  repo: https://Github.com/username/username.Github.io.git //e.g. https://Github.com/guguji5/guguji5.Github.io.git\n  branch: master\n```\n\b因为我们选择了git来部署，所以我们需要安装Hexo包来发布静态模板到git仓库。用npm来安装：\n```\n$ npm install hexo-deployer-git --save\n```\n现在你可以部署你的代码到Github仓库了。\n```\n$ hexo generate && hexo deploy\n```\n在Github密码校验框输入密码以后，如下是成功结果。\n```\nhexo HEXO G\nINFO  Start processing\nINFO  Files loaded in 214 ms\nINFO  Generated: archives/2018/index.html\nINFO  Generated: repository/index.html\nINFO  Generated: archives/index.html\nINFO  Generated: about/index.html\nINFO  Generated: archives/2018/11/index.html\nINFO  Generated: index.html\nINFO  Generated: angular-splitter/index.html\nINFO  Generated: 如何使用GZIP来优化你的网站/index.html\nINFO  8 files generated in 231 ms\n➜  hexo HEXO D\nINFO  Deploying: git\nINFO  Clearing .deploy_git folder...\nINFO  Copying files from public folder...\nINFO  Copying files from extend dirs...\n[master 143ec29] Site updated: 2018-11-04 23:14:03\n 8 files changed, 80 deletions(-)\nTo https://Github.com/guguji5/guguji5.Github.io.git\n   c8f0b04..143ec29  HEAD -> master\nBranch master set up to track remote branch master from https://Github.com/guguji5/guguji5.Github.io.git.\nINFO  Deploy done: git\n```\n### 结语\n完成了所有配置，\b快去搭建属于自己的静态博客吧。\n1. https://guguji5.Github.io/\n2. https://kouss.com/\n\n*Hexo\b的子页面包括归档、分类，标签使用，github项目的关联，ejs模板的配置将在下一篇《Hexo + Github搭建静态博客(二)》中给大家分享。*","source":"_posts/Hexo-Github搭建静态博客-一.md","raw":"---\ntitle: Hexo + Github搭建静态博客(一)\ndate: 2018-11-09 13:19:48\ntags: Hexo\ncomments: true\n---\n### 快速介绍\nHexo是一个基于Node.js搭建的静态博客框架，通过Hexo，用户可以\b以博文的方式发布\bMarkdown文档。\b\b结合默认或定制化\b主题模板（很像其他静态博客生成框架，Jekyll或Ghost）博文会被转化和生成为HTML/CSS。Hexo所需的所有组件都是模块化的，\b所以你可以按需安装。\n\n### 提前准备\n\b跟着本博客，你可能需要提前准备：\n\n1. git\n2. Node.js\n3. Github账号\n\n### 第一步 安装和初始化Hexo\n这一步需要安装好Hexo所需的东西，Hexo是有许多软件包组成的，而最必要的一个就是npm，Node.js包管理器。\n\n首先，安装hexo-cli,最重要最核心的Hexo命令。\n```\n$ npm install hexo-cli -g\n```\n其次，我们需要创建一些\b基础文件，很幸运，Hexo为我们提供了一键生成的命令。我们只需要\b切换到准备好的文件夹目录，执行如下命令。\n```\n$ hexo init \n```\n此时，文件夹下可能会出现很多文件和文件夹，如下图所示：\n```shell\nblog/\n├── _config.yml\n├── node_modules\n├── package.json\n├── scaffolds\n├── source\n└── theme\n\n4 directory, 2 files\n```\n\n### 第二步 \b设置Hexo主要的配置文件 _config.yml\n上图的这些文件中，_config.yml是至关重要的，所有的核心配置都存储在这个博客中，如果将来你想调整博客的一些设置，\b\b大概率就是这个文件。\n\n我们将会一步一步的\b\b修改配置，选择你喜欢的编辑器，vi， nano 或者sublime等打开_config.yml，在最上边你会看到如下的内容。\n```\n# Site\ntitle: Hexo\nsubtitle:\ndescription:\nauthor: John Doe\nlanguage:\ntimezone:\n```\n前四行分别是博客的名称，\b二级名称，描述和作者的名称。目前不是所有的Hexo主题都会显示这些信息，所以它大多数当成网站\b基本信息。\n\n后边两行是语言和时区，语言选择两字符ISO 639-1代码。时区默认指的是用户服务器的时区，用“tz database\"格式。你可以根据需要修改他们，下边是一个例子：\n```\n#Site\ntitle: 滴滴云博客 \nsubtitle: 为开发者而生 \ndescription: 滴滴云基于滴滴出行的业务技术和经验积累,采用领先的云计算架构、高规格服务器集群搭建、高性能资源配置机制、精细化运营模式,致力于为开发者提供简单快捷、高效稳定。\nauthor: \bdidicloud \nlanguage: zh-CN \ntimezone: \n```\n**主题** 的更换是在_config.yml中`theme`字段。\n\n最后我们要更改的设置是default_layout:\b 在Writing\b下边，在一个博文没发表之前，它是\b不可见的，我们想存成草稿，所以我们把default_layout\b设置成draft。\n```\n# Writing\nnew_post_name: :title.md # File name of new posts\ndefault_layout: draft\ntitlecase: false # Transform title into titlecase\n```\n### 第三步 \b创建和发表博客\n用如下命令来创建一个博文（草稿）,这里的‘first-page’是博文的名称。\n\n```\n$ hexo new first-post\n```\n然后我们应该会看到这样的显示：\n```\nOutput\nINFO  Created: ~/hexo_blog/source/_drafts/first-post.md\n```\n我们可以选择自己喜欢的编辑器，打开first-post.md\n\n每一个博文都有一个\bfront-matter设置，Front-matter是一个\bJSON or YAML块，它可以用来设置这标题，发布时间，标签等等。Front-matter\b\b一般用`---`或者`;;;`标志结尾。在Front-matter之后，你可以用Markdown语法写自己的博文。\n\n用如下的内容替换\bfirst-post.md的内容。\n```\ntitle: 滴滴云--为开发者而生\ntags:\n  - Test\n  - Blog\ncategories:\n  - Hexo\ncomments: true\ndate: 2018-11-04 00:00:00\n---\n\n## Markdown goes here.\n\n**This is our first post!**\n```\n然后执行`$ hexo publish first-post`会看到如下的结果：\n```\nOutput\nINFO  Published: ~/hexo_blog/source/_posts/first-post.md\n```\n### 第四步 启动服务器\n\b到目前为止，所有的配置文件和博文都已准备完毕，接下来，我们启动服务器。\n```\n$ hexo server\n```\n现在，我们可以访问自己的博客通过`http://localhost:4000`。你会看到自己预设的hello-world博客,\b`ctrl+c`可以停止服务器。\n![draw](https://img-blog.csdn.net/20161023150235594?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)\n### 第五步 设置部署脚本\n到目前为止，Hexo有许多不同的方法可以部署，本博客是用git来进行存储，上传，托管博客。除此之外，还支持Heroku, Git, Rsync, OpenShift, FTPSync等多种工具。\n\n这里需要一个git仓库来存储Hexo生成的静态HTML文件，为了简单起见，这里我们用Github提供的git仓库。\n\n在Github上创建一个`<username>.Github.io`的仓库，选择“\bPublic”，并且点击“Initialize this repository with a README”\b选择框。然后打开_config.yml。\n```\n# Deployment\n## Docs: https://hexo.io/docs/deployment.html\ndeploy:\n  type:\n```\n按如下所示，填上\bdeploy选项，你必须\b\b替换`username`为自己的Github账号。\n```\n\ndeploy:\n  type: git\n  repo: https://Github.com/username/username.Github.io.git //e.g. https://Github.com/guguji5/guguji5.Github.io.git\n  branch: master\n```\n\b因为我们选择了git来部署，所以我们需要安装Hexo包来发布静态模板到git仓库。用npm来安装：\n```\n$ npm install hexo-deployer-git --save\n```\n现在你可以部署你的代码到Github仓库了。\n```\n$ hexo generate && hexo deploy\n```\n在Github密码校验框输入密码以后，如下是成功结果。\n```\nhexo HEXO G\nINFO  Start processing\nINFO  Files loaded in 214 ms\nINFO  Generated: archives/2018/index.html\nINFO  Generated: repository/index.html\nINFO  Generated: archives/index.html\nINFO  Generated: about/index.html\nINFO  Generated: archives/2018/11/index.html\nINFO  Generated: index.html\nINFO  Generated: angular-splitter/index.html\nINFO  Generated: 如何使用GZIP来优化你的网站/index.html\nINFO  8 files generated in 231 ms\n➜  hexo HEXO D\nINFO  Deploying: git\nINFO  Clearing .deploy_git folder...\nINFO  Copying files from public folder...\nINFO  Copying files from extend dirs...\n[master 143ec29] Site updated: 2018-11-04 23:14:03\n 8 files changed, 80 deletions(-)\nTo https://Github.com/guguji5/guguji5.Github.io.git\n   c8f0b04..143ec29  HEAD -> master\nBranch master set up to track remote branch master from https://Github.com/guguji5/guguji5.Github.io.git.\nINFO  Deploy done: git\n```\n### 结语\n完成了所有配置，\b快去搭建属于自己的静态博客吧。\n1. https://guguji5.Github.io/\n2. https://kouss.com/\n\n*Hexo\b的子页面包括归档、分类，标签使用，github项目的关联，ejs模板的配置将在下一篇《Hexo + Github搭建静态博客(二)》中给大家分享。*","slug":"Hexo-Github搭建静态博客-一","published":1,"updated":"2020-02-20T02:34:43.907Z","layout":"post","photos":[],"link":"","_id":"ckrix8zdg0009k1jfj2bwme1k","content":"<h3 id=\"快速介绍\"><a href=\"#快速介绍\" class=\"headerlink\" title=\"快速介绍\"></a>快速介绍</h3><p>Hexo是一个基于Node.js搭建的静态博客框架，通过Hexo，用户可以\b以博文的方式发布\bMarkdown文档。\b\b结合默认或定制化\b主题模板（很像其他静态博客生成框架，Jekyll或Ghost）博文会被转化和生成为HTML/CSS。Hexo所需的所有组件都是模块化的，\b所以你可以按需安装。</p>\n<h3 id=\"提前准备\"><a href=\"#提前准备\" class=\"headerlink\" title=\"提前准备\"></a>提前准备</h3><p>\b跟着本博客，你可能需要提前准备：</p>\n<ol>\n<li>git</li>\n<li>Node.js</li>\n<li>Github账号</li>\n</ol>\n<h3 id=\"第一步-安装和初始化Hexo\"><a href=\"#第一步-安装和初始化Hexo\" class=\"headerlink\" title=\"第一步 安装和初始化Hexo\"></a>第一步 安装和初始化Hexo</h3><p>这一步需要安装好Hexo所需的东西，Hexo是有许多软件包组成的，而最必要的一个就是npm，Node.js包管理器。</p>\n<p>首先，安装hexo-cli,最重要最核心的Hexo命令。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ npm install hexo-cli -g</span><br></pre></td></tr></table></figure></p>\n<p>其次，我们需要创建一些\b基础文件，很幸运，Hexo为我们提供了一键生成的命令。我们只需要\b切换到准备好的文件夹目录，执行如下命令。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo init</span><br></pre></td></tr></table></figure></p>\n<p>此时，文件夹下可能会出现很多文件和文件夹，如下图所示：<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">blog/</span><br><span class=\"line\">├── _config.yml</span><br><span class=\"line\">├── node_modules</span><br><span class=\"line\">├── package.json</span><br><span class=\"line\">├── scaffolds</span><br><span class=\"line\">├── source</span><br><span class=\"line\">└── theme</span><br><span class=\"line\"></span><br><span class=\"line\">4 directory, 2 files</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"第二步-设置Hexo主要的配置文件-config-yml\"><a href=\"#第二步-设置Hexo主要的配置文件-config-yml\" class=\"headerlink\" title=\"第二步 \b设置Hexo主要的配置文件 _config.yml\"></a>第二步 \b设置Hexo主要的配置文件 _config.yml</h3><p>上图的这些文件中，_config.yml是至关重要的，所有的核心配置都存储在这个博客中，如果将来你想调整博客的一些设置，\b\b大概率就是这个文件。</p>\n<p>我们将会一步一步的\b\b修改配置，选择你喜欢的编辑器，vi， nano 或者sublime等打开_config.yml，在最上边你会看到如下的内容。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># Site</span><br><span class=\"line\">title: Hexo</span><br><span class=\"line\">subtitle:</span><br><span class=\"line\">description:</span><br><span class=\"line\">author: John Doe</span><br><span class=\"line\">language:</span><br><span class=\"line\">timezone:</span><br></pre></td></tr></table></figure></p>\n<p>前四行分别是博客的名称，\b二级名称，描述和作者的名称。目前不是所有的Hexo主题都会显示这些信息，所以它大多数当成网站\b基本信息。</p>\n<p>后边两行是语言和时区，语言选择两字符ISO 639-1代码。时区默认指的是用户服务器的时区，用“tz database”格式。你可以根据需要修改他们，下边是一个例子：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#Site</span><br><span class=\"line\">title: 滴滴云博客 </span><br><span class=\"line\">subtitle: 为开发者而生 </span><br><span class=\"line\">description: 滴滴云基于滴滴出行的业务技术和经验积累,采用领先的云计算架构、高规格服务器集群搭建、高性能资源配置机制、精细化运营模式,致力于为开发者提供简单快捷、高效稳定。</span><br><span class=\"line\">author: \bdidicloud </span><br><span class=\"line\">language: zh-CN </span><br><span class=\"line\">timezone:</span><br></pre></td></tr></table></figure></p>\n<p><strong>主题</strong> 的更换是在_config.yml中<code>theme</code>字段。</p>\n<p>最后我们要更改的设置是default_layout:\b 在Writing\b下边，在一个博文没发表之前，它是\b不可见的，我们想存成草稿，所以我们把default_layout\b设置成draft。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># Writing</span><br><span class=\"line\">new_post_name: :title.md # File name of new posts</span><br><span class=\"line\">default_layout: draft</span><br><span class=\"line\">titlecase: false # Transform title into titlecase</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"第三步-创建和发表博客\"><a href=\"#第三步-创建和发表博客\" class=\"headerlink\" title=\"第三步 \b创建和发表博客\"></a>第三步 \b创建和发表博客</h3><p>用如下命令来创建一个博文（草稿）,这里的‘first-page’是博文的名称。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo new first-post</span><br></pre></td></tr></table></figure>\n<p>然后我们应该会看到这样的显示：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Output</span><br><span class=\"line\">INFO  Created: ~/hexo_blog/source/_drafts/first-post.md</span><br></pre></td></tr></table></figure></p>\n<p>我们可以选择自己喜欢的编辑器，打开first-post.md</p>\n<p>每一个博文都有一个\bfront-matter设置，Front-matter是一个\bJSON or YAML块，它可以用来设置这标题，发布时间，标签等等。Front-matter\b\b一般用<code>---</code>或者<code>;;;</code>标志结尾。在Front-matter之后，你可以用Markdown语法写自己的博文。</p>\n<p>用如下的内容替换\bfirst-post.md的内容。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">title: 滴滴云--为开发者而生</span><br><span class=\"line\">tags:</span><br><span class=\"line\">  - Test</span><br><span class=\"line\">  - Blog</span><br><span class=\"line\">categories:</span><br><span class=\"line\">  - Hexo</span><br><span class=\"line\">comments: true</span><br><span class=\"line\">date: 2018-11-04 00:00:00</span><br><span class=\"line\">---</span><br><span class=\"line\"></span><br><span class=\"line\">## Markdown goes here.</span><br><span class=\"line\"></span><br><span class=\"line\">**This is our first post!**</span><br></pre></td></tr></table></figure></p>\n<p>然后执行<code>$ hexo publish first-post</code>会看到如下的结果：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Output</span><br><span class=\"line\">INFO  Published: ~/hexo_blog/source/_posts/first-post.md</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"第四步-启动服务器\"><a href=\"#第四步-启动服务器\" class=\"headerlink\" title=\"第四步 启动服务器\"></a>第四步 启动服务器</h3><p>\b到目前为止，所有的配置文件和博文都已准备完毕，接下来，我们启动服务器。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo server</span><br></pre></td></tr></table></figure></p>\n<p>现在，我们可以访问自己的博客通过<code>http://localhost:4000</code>。你会看到自己预设的hello-world博客,\b<code>ctrl+c</code>可以停止服务器。<br><img src=\"https://img-blog.csdn.net/20161023150235594?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center\" alt=\"draw\"></p>\n<h3 id=\"第五步-设置部署脚本\"><a href=\"#第五步-设置部署脚本\" class=\"headerlink\" title=\"第五步 设置部署脚本\"></a>第五步 设置部署脚本</h3><p>到目前为止，Hexo有许多不同的方法可以部署，本博客是用git来进行存储，上传，托管博客。除此之外，还支持Heroku, Git, Rsync, OpenShift, FTPSync等多种工具。</p>\n<p>这里需要一个git仓库来存储Hexo生成的静态HTML文件，为了简单起见，这里我们用Github提供的git仓库。</p>\n<p>在Github上创建一个<code>&lt;username&gt;.Github.io</code>的仓库，选择“\bPublic”，并且点击“Initialize this repository with a README”\b选择框。然后打开_config.yml。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># Deployment</span><br><span class=\"line\">## Docs: https://hexo.io/docs/deployment.html</span><br><span class=\"line\">deploy:</span><br><span class=\"line\">  type:</span><br></pre></td></tr></table></figure></p>\n<p>按如下所示，填上\bdeploy选项，你必须\b\b替换<code>username</code>为自己的Github账号。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">deploy:</span><br><span class=\"line\">  type: git</span><br><span class=\"line\">  repo: https://Github.com/username/username.Github.io.git //e.g. https://Github.com/guguji5/guguji5.Github.io.git</span><br><span class=\"line\">  branch: master</span><br></pre></td></tr></table></figure></p>\n<p>\b因为我们选择了git来部署，所以我们需要安装Hexo包来发布静态模板到git仓库。用npm来安装：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure></p>\n<p>现在你可以部署你的代码到Github仓库了。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo generate &amp;&amp; hexo deploy</span><br></pre></td></tr></table></figure></p>\n<p>在Github密码校验框输入密码以后，如下是成功结果。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo HEXO G</span><br><span class=\"line\">INFO  Start processing</span><br><span class=\"line\">INFO  Files loaded in 214 ms</span><br><span class=\"line\">INFO  Generated: archives/2018/index.html</span><br><span class=\"line\">INFO  Generated: repository/index.html</span><br><span class=\"line\">INFO  Generated: archives/index.html</span><br><span class=\"line\">INFO  Generated: about/index.html</span><br><span class=\"line\">INFO  Generated: archives/2018/11/index.html</span><br><span class=\"line\">INFO  Generated: index.html</span><br><span class=\"line\">INFO  Generated: angular-splitter/index.html</span><br><span class=\"line\">INFO  Generated: 如何使用GZIP来优化你的网站/index.html</span><br><span class=\"line\">INFO  8 files generated in 231 ms</span><br><span class=\"line\">➜  hexo HEXO D</span><br><span class=\"line\">INFO  Deploying: git</span><br><span class=\"line\">INFO  Clearing .deploy_git folder...</span><br><span class=\"line\">INFO  Copying files from public folder...</span><br><span class=\"line\">INFO  Copying files from extend dirs...</span><br><span class=\"line\">[master 143ec29] Site updated: 2018-11-04 23:14:03</span><br><span class=\"line\"> 8 files changed, 80 deletions(-)</span><br><span class=\"line\">To https://Github.com/guguji5/guguji5.Github.io.git</span><br><span class=\"line\">   c8f0b04..143ec29  HEAD -&gt; master</span><br><span class=\"line\">Branch master set up to track remote branch master from https://Github.com/guguji5/guguji5.Github.io.git.</span><br><span class=\"line\">INFO  Deploy done: git</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"结语\"><a href=\"#结语\" class=\"headerlink\" title=\"结语\"></a>结语</h3><p>完成了所有配置，\b快去搭建属于自己的静态博客吧。</p>\n<ol>\n<li><a href=\"https://guguji5.Github.io/\">https://guguji5.Github.io/</a></li>\n<li><a href=\"https://kouss.com/\" target=\"_blank\" rel=\"noopener\">https://kouss.com/</a></li>\n</ol>\n<p><em>Hexo\b的子页面包括归档、分类，标签使用，github项目的关联，ejs模板的配置将在下一篇《Hexo + Github搭建静态博客(二)》中给大家分享。</em></p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"快速介绍\"><a href=\"#快速介绍\" class=\"headerlink\" title=\"快速介绍\"></a>快速介绍</h3><p>Hexo是一个基于Node.js搭建的静态博客框架，通过Hexo，用户可以\b以博文的方式发布\bMarkdown文档。\b\b结合默认或定制化\b主题模板（很像其他静态博客生成框架，Jekyll或Ghost）博文会被转化和生成为HTML/CSS。Hexo所需的所有组件都是模块化的，\b所以你可以按需安装。</p>\n<h3 id=\"提前准备\"><a href=\"#提前准备\" class=\"headerlink\" title=\"提前准备\"></a>提前准备</h3><p>\b跟着本博客，你可能需要提前准备：</p>\n<ol>\n<li>git</li>\n<li>Node.js</li>\n<li>Github账号</li>\n</ol>\n<h3 id=\"第一步-安装和初始化Hexo\"><a href=\"#第一步-安装和初始化Hexo\" class=\"headerlink\" title=\"第一步 安装和初始化Hexo\"></a>第一步 安装和初始化Hexo</h3><p>这一步需要安装好Hexo所需的东西，Hexo是有许多软件包组成的，而最必要的一个就是npm，Node.js包管理器。</p>\n<p>首先，安装hexo-cli,最重要最核心的Hexo命令。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ npm install hexo-cli -g</span><br></pre></td></tr></table></figure></p>\n<p>其次，我们需要创建一些\b基础文件，很幸运，Hexo为我们提供了一键生成的命令。我们只需要\b切换到准备好的文件夹目录，执行如下命令。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo init</span><br></pre></td></tr></table></figure></p>\n<p>此时，文件夹下可能会出现很多文件和文件夹，如下图所示：<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">blog/</span><br><span class=\"line\">├── _config.yml</span><br><span class=\"line\">├── node_modules</span><br><span class=\"line\">├── package.json</span><br><span class=\"line\">├── scaffolds</span><br><span class=\"line\">├── source</span><br><span class=\"line\">└── theme</span><br><span class=\"line\"></span><br><span class=\"line\">4 directory, 2 files</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"第二步-设置Hexo主要的配置文件-config-yml\"><a href=\"#第二步-设置Hexo主要的配置文件-config-yml\" class=\"headerlink\" title=\"第二步 \b设置Hexo主要的配置文件 _config.yml\"></a>第二步 \b设置Hexo主要的配置文件 _config.yml</h3><p>上图的这些文件中，_config.yml是至关重要的，所有的核心配置都存储在这个博客中，如果将来你想调整博客的一些设置，\b\b大概率就是这个文件。</p>\n<p>我们将会一步一步的\b\b修改配置，选择你喜欢的编辑器，vi， nano 或者sublime等打开_config.yml，在最上边你会看到如下的内容。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># Site</span><br><span class=\"line\">title: Hexo</span><br><span class=\"line\">subtitle:</span><br><span class=\"line\">description:</span><br><span class=\"line\">author: John Doe</span><br><span class=\"line\">language:</span><br><span class=\"line\">timezone:</span><br></pre></td></tr></table></figure></p>\n<p>前四行分别是博客的名称，\b二级名称，描述和作者的名称。目前不是所有的Hexo主题都会显示这些信息，所以它大多数当成网站\b基本信息。</p>\n<p>后边两行是语言和时区，语言选择两字符ISO 639-1代码。时区默认指的是用户服务器的时区，用“tz database”格式。你可以根据需要修改他们，下边是一个例子：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#Site</span><br><span class=\"line\">title: 滴滴云博客 </span><br><span class=\"line\">subtitle: 为开发者而生 </span><br><span class=\"line\">description: 滴滴云基于滴滴出行的业务技术和经验积累,采用领先的云计算架构、高规格服务器集群搭建、高性能资源配置机制、精细化运营模式,致力于为开发者提供简单快捷、高效稳定。</span><br><span class=\"line\">author: \bdidicloud </span><br><span class=\"line\">language: zh-CN </span><br><span class=\"line\">timezone:</span><br></pre></td></tr></table></figure></p>\n<p><strong>主题</strong> 的更换是在_config.yml中<code>theme</code>字段。</p>\n<p>最后我们要更改的设置是default_layout:\b 在Writing\b下边，在一个博文没发表之前，它是\b不可见的，我们想存成草稿，所以我们把default_layout\b设置成draft。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># Writing</span><br><span class=\"line\">new_post_name: :title.md # File name of new posts</span><br><span class=\"line\">default_layout: draft</span><br><span class=\"line\">titlecase: false # Transform title into titlecase</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"第三步-创建和发表博客\"><a href=\"#第三步-创建和发表博客\" class=\"headerlink\" title=\"第三步 \b创建和发表博客\"></a>第三步 \b创建和发表博客</h3><p>用如下命令来创建一个博文（草稿）,这里的‘first-page’是博文的名称。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo new first-post</span><br></pre></td></tr></table></figure>\n<p>然后我们应该会看到这样的显示：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Output</span><br><span class=\"line\">INFO  Created: ~/hexo_blog/source/_drafts/first-post.md</span><br></pre></td></tr></table></figure></p>\n<p>我们可以选择自己喜欢的编辑器，打开first-post.md</p>\n<p>每一个博文都有一个\bfront-matter设置，Front-matter是一个\bJSON or YAML块，它可以用来设置这标题，发布时间，标签等等。Front-matter\b\b一般用<code>---</code>或者<code>;;;</code>标志结尾。在Front-matter之后，你可以用Markdown语法写自己的博文。</p>\n<p>用如下的内容替换\bfirst-post.md的内容。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">title: 滴滴云--为开发者而生</span><br><span class=\"line\">tags:</span><br><span class=\"line\">  - Test</span><br><span class=\"line\">  - Blog</span><br><span class=\"line\">categories:</span><br><span class=\"line\">  - Hexo</span><br><span class=\"line\">comments: true</span><br><span class=\"line\">date: 2018-11-04 00:00:00</span><br><span class=\"line\">---</span><br><span class=\"line\"></span><br><span class=\"line\">## Markdown goes here.</span><br><span class=\"line\"></span><br><span class=\"line\">**This is our first post!**</span><br></pre></td></tr></table></figure></p>\n<p>然后执行<code>$ hexo publish first-post</code>会看到如下的结果：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Output</span><br><span class=\"line\">INFO  Published: ~/hexo_blog/source/_posts/first-post.md</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"第四步-启动服务器\"><a href=\"#第四步-启动服务器\" class=\"headerlink\" title=\"第四步 启动服务器\"></a>第四步 启动服务器</h3><p>\b到目前为止，所有的配置文件和博文都已准备完毕，接下来，我们启动服务器。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo server</span><br></pre></td></tr></table></figure></p>\n<p>现在，我们可以访问自己的博客通过<code>http://localhost:4000</code>。你会看到自己预设的hello-world博客,\b<code>ctrl+c</code>可以停止服务器。<br><img src=\"https://img-blog.csdn.net/20161023150235594?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center\" alt=\"draw\"></p>\n<h3 id=\"第五步-设置部署脚本\"><a href=\"#第五步-设置部署脚本\" class=\"headerlink\" title=\"第五步 设置部署脚本\"></a>第五步 设置部署脚本</h3><p>到目前为止，Hexo有许多不同的方法可以部署，本博客是用git来进行存储，上传，托管博客。除此之外，还支持Heroku, Git, Rsync, OpenShift, FTPSync等多种工具。</p>\n<p>这里需要一个git仓库来存储Hexo生成的静态HTML文件，为了简单起见，这里我们用Github提供的git仓库。</p>\n<p>在Github上创建一个<code>&lt;username&gt;.Github.io</code>的仓库，选择“\bPublic”，并且点击“Initialize this repository with a README”\b选择框。然后打开_config.yml。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># Deployment</span><br><span class=\"line\">## Docs: https://hexo.io/docs/deployment.html</span><br><span class=\"line\">deploy:</span><br><span class=\"line\">  type:</span><br></pre></td></tr></table></figure></p>\n<p>按如下所示，填上\bdeploy选项，你必须\b\b替换<code>username</code>为自己的Github账号。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">deploy:</span><br><span class=\"line\">  type: git</span><br><span class=\"line\">  repo: https://Github.com/username/username.Github.io.git //e.g. https://Github.com/guguji5/guguji5.Github.io.git</span><br><span class=\"line\">  branch: master</span><br></pre></td></tr></table></figure></p>\n<p>\b因为我们选择了git来部署，所以我们需要安装Hexo包来发布静态模板到git仓库。用npm来安装：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure></p>\n<p>现在你可以部署你的代码到Github仓库了。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo generate &amp;&amp; hexo deploy</span><br></pre></td></tr></table></figure></p>\n<p>在Github密码校验框输入密码以后，如下是成功结果。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo HEXO G</span><br><span class=\"line\">INFO  Start processing</span><br><span class=\"line\">INFO  Files loaded in 214 ms</span><br><span class=\"line\">INFO  Generated: archives/2018/index.html</span><br><span class=\"line\">INFO  Generated: repository/index.html</span><br><span class=\"line\">INFO  Generated: archives/index.html</span><br><span class=\"line\">INFO  Generated: about/index.html</span><br><span class=\"line\">INFO  Generated: archives/2018/11/index.html</span><br><span class=\"line\">INFO  Generated: index.html</span><br><span class=\"line\">INFO  Generated: angular-splitter/index.html</span><br><span class=\"line\">INFO  Generated: 如何使用GZIP来优化你的网站/index.html</span><br><span class=\"line\">INFO  8 files generated in 231 ms</span><br><span class=\"line\">➜  hexo HEXO D</span><br><span class=\"line\">INFO  Deploying: git</span><br><span class=\"line\">INFO  Clearing .deploy_git folder...</span><br><span class=\"line\">INFO  Copying files from public folder...</span><br><span class=\"line\">INFO  Copying files from extend dirs...</span><br><span class=\"line\">[master 143ec29] Site updated: 2018-11-04 23:14:03</span><br><span class=\"line\"> 8 files changed, 80 deletions(-)</span><br><span class=\"line\">To https://Github.com/guguji5/guguji5.Github.io.git</span><br><span class=\"line\">   c8f0b04..143ec29  HEAD -&gt; master</span><br><span class=\"line\">Branch master set up to track remote branch master from https://Github.com/guguji5/guguji5.Github.io.git.</span><br><span class=\"line\">INFO  Deploy done: git</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"结语\"><a href=\"#结语\" class=\"headerlink\" title=\"结语\"></a>结语</h3><p>完成了所有配置，\b快去搭建属于自己的静态博客吧。</p>\n<ol>\n<li><a href=\"https://guguji5.Github.io/\">https://guguji5.Github.io/</a></li>\n<li><a href=\"https://kouss.com/\" target=\"_blank\" rel=\"noopener\">https://kouss.com/</a></li>\n</ol>\n<p><em>Hexo\b的子页面包括归档、分类，标签使用，github项目的关联，ejs模板的配置将在下一篇《Hexo + Github搭建静态博客(二)》中给大家分享。</em></p>\n"},{"title":"Hexo + Github搭建静态博客(二)","date":"2018-11-11T08:43:29.000Z","comments":1,"_content":"\n### 快速介绍\n本文是接Hexo + Github搭建静态博客(一)，Hexo环境的搭建，依赖的下载请根据[上文](https://guguji5.github.io/Hexo-Github%E6%90%AD%E5%BB%BA%E9%9D%99%E6%80%81%E5%8D%9A%E5%AE%A2-%E4%B8%80/)自行配置。本文主要介绍Hexo的**归档，标签，分类**，以及依靠插件支持的**评论，站内搜索，字数统计**等功能。\n\n### 归档，分类，标签\n三者\b是众多博客模板的必要元素，而在文档中却没有详细的解释，匆匆一笔带过。笔者阅历浅薄，结合自己的理解，强行解释\b一波，通过对比将意思表达的更清楚。\n\n归档（archives）是按照一定的周期对博客进行分类，大多数是按年，月等。\n\n分类\b（categories）和 标签（tags）都是用来描述博客的内容，\b但却又不尽相同。分类 定义博客的常规主题，而标签会深入反应内容。分类会\b构成博客的大纲，反应博客的基本结构，而标签会更具体一些。（其实还是\b会让人confuse）下边我\b希望通过一个小故事解释清\b“分类”和“标签”的不同。\n\n假如我们运营着一个关于电子产品（3C）的博客，有\b众多的博文，可能会有以下的分类\n\n- 笔记本\n- 手机\n- 存储设备\n- 数码相机\n\n当新出iphone的时候，我们可能会写一个\b新产品开箱博客，他分类肯定是”手机“，而标签会是”iphone“。\n\n创建对应的页面也很简单，只需一行命令。\n\n```\nhexo new page \"archives\"\nhexo new page \"tags\"\nhexo new page \"categories\"\n```\n### 站内搜索\n\n方式有以下三种，insight、swiftype、baidu。\n\ninsight只需安装hexo-generator-json-content组件即可。\nswiftype需要去其官网注册key。\nbaidu搜索的话需要禁用其他两种。\n\n三种都很简单，这里展示第一种的效果图。\n\n![站内搜索](/images/search.jpg)\n\n### 评论\n\n\b评论是博客必不可少的一项功能。而Hexo作为一个静态博客，没有WordPress那样\b的server和数据库，评论的功能可想而知肯定是用的第三方的评论系统。大浪淘沙，对比各色的需求，接下来我们\bXXX。\n\n- 来必力 : 504报错，跨域\n- Hypercomments: 付费\n- 畅言 : 畅言\n- Valine : sound good\n- 多说 : 关闭\n- 网易云跟帖 : 关闭\n- disqus : 科学上网\n- gitalk : 需要Github账号\n- 搜狐畅言 : 备案\n\n这个topic展开的话会很冗长，搜索引擎上也有很多这类的文章。我最后选择了gittalk，\b简单大方，技术类的文章，\bGithub不是门槛。\n### 字数统计，阅读时间统计\n\n这一部分比较简单，只需要安装hexo-wordcount插件，\b传入博客的内容即可计算得出。先安装插件：\n```\nnpm i --save hexo-wordcount\n```\n在主题模板文件中即可使用wordcount方法计算字数统计和阅读时长。\n```\n<% if(theme.postCount.enable){  %>\n\t<% if(theme.postCount.wordcount){  %>\n\t\t<span class=\"post-wordcount hidden-xs\" itemprop=\"wordCount\"><%= __('article.wordcount') %>: <%= wordcount(post.content) %>(<%= __('unit.word') %>)</span>\n\t<% } %>\n\t<% if(theme.postCount.min2read){  %>\n\t\t<span class=\"post-readcount hidden-xs\" itemprop=\"timeRequired\"><%= __('article.readcount') %>: <%= min2read(post.content) %>(<%= __('unit.time') %>)</span>\n\t<% } %>\n<% } %>\n```\n\n### 如何在博客展示自己github托管的项目\n\n作为一个程序员，GitHub开源项目是程序员展示编程技术和工作阅历，释放程序员个人魅力的宽广舞台。所以，很有必要在博客的核心页面展示自己GitHub的repository。Hexo可以在主题内通过ejs或swig模板引擎来构建页面，GitHub提供开源api支持获取repo列表。所以我们可以通过调用引入JavaScript请求api。展示效果如下\n\n![repository](/images/repo.jpg)\n\n问题出在Github的未授权状态的api每小时只可以请求60次，而超出次数就会403。而授权的api每小时可以访问50000次。所以需要去[https://developer.github.com/v3/auth/#basic-authentication](https://developer.github.com/v3/auth/#basic-authentication)申请授权，我们搭建的Hexo静态博客，没有Server，所以oauth2的方式\b不可取，这里我用的access_token来对api授权，Github出于安全的考虑，不允许我们把access_token上传到Github仓库，所以我们需要借助你擅长的加密方式，对access_token加密，运行时解密。伪代码如下：\n```\nvar key = 'U2FsdGVkX1+VWdiIkoA3PCbz9KKGlKilMs6UztGd2VQuYuSAoZLyCi8fM2qxUbviYt35kf/tpFvEqNmtY3WppQ='\nvar access_token = CryptoJS.AES.decrypt(key, 'guguji5').toString(CryptoJS.enc.Utf8);\n$.get(\"https://api.github.com/users/<%=theme.github.username%>/repos?access_token=\"+access_token, function(result) {\n})\n```\n*参考链接*\n\nhttps://developer.github.com/v3/auth/#basic-authentication\n\nhttps://developer.github.com/v3/#rate-limiting\n\nhttps://amylynnandrews.com/categories-vs-tags/","source":"_posts/Hexo-Github搭建静态博客-二.md","raw":"---\ntitle: Hexo + Github搭建静态博客(二)\ndate: 2018-11-11 16:43:29\ntags: Hexo\ncomments: true\n---\n\n### 快速介绍\n本文是接Hexo + Github搭建静态博客(一)，Hexo环境的搭建，依赖的下载请根据[上文](https://guguji5.github.io/Hexo-Github%E6%90%AD%E5%BB%BA%E9%9D%99%E6%80%81%E5%8D%9A%E5%AE%A2-%E4%B8%80/)自行配置。本文主要介绍Hexo的**归档，标签，分类**，以及依靠插件支持的**评论，站内搜索，字数统计**等功能。\n\n### 归档，分类，标签\n三者\b是众多博客模板的必要元素，而在文档中却没有详细的解释，匆匆一笔带过。笔者阅历浅薄，结合自己的理解，强行解释\b一波，通过对比将意思表达的更清楚。\n\n归档（archives）是按照一定的周期对博客进行分类，大多数是按年，月等。\n\n分类\b（categories）和 标签（tags）都是用来描述博客的内容，\b但却又不尽相同。分类 定义博客的常规主题，而标签会深入反应内容。分类会\b构成博客的大纲，反应博客的基本结构，而标签会更具体一些。（其实还是\b会让人confuse）下边我\b希望通过一个小故事解释清\b“分类”和“标签”的不同。\n\n假如我们运营着一个关于电子产品（3C）的博客，有\b众多的博文，可能会有以下的分类\n\n- 笔记本\n- 手机\n- 存储设备\n- 数码相机\n\n当新出iphone的时候，我们可能会写一个\b新产品开箱博客，他分类肯定是”手机“，而标签会是”iphone“。\n\n创建对应的页面也很简单，只需一行命令。\n\n```\nhexo new page \"archives\"\nhexo new page \"tags\"\nhexo new page \"categories\"\n```\n### 站内搜索\n\n方式有以下三种，insight、swiftype、baidu。\n\ninsight只需安装hexo-generator-json-content组件即可。\nswiftype需要去其官网注册key。\nbaidu搜索的话需要禁用其他两种。\n\n三种都很简单，这里展示第一种的效果图。\n\n![站内搜索](/images/search.jpg)\n\n### 评论\n\n\b评论是博客必不可少的一项功能。而Hexo作为一个静态博客，没有WordPress那样\b的server和数据库，评论的功能可想而知肯定是用的第三方的评论系统。大浪淘沙，对比各色的需求，接下来我们\bXXX。\n\n- 来必力 : 504报错，跨域\n- Hypercomments: 付费\n- 畅言 : 畅言\n- Valine : sound good\n- 多说 : 关闭\n- 网易云跟帖 : 关闭\n- disqus : 科学上网\n- gitalk : 需要Github账号\n- 搜狐畅言 : 备案\n\n这个topic展开的话会很冗长，搜索引擎上也有很多这类的文章。我最后选择了gittalk，\b简单大方，技术类的文章，\bGithub不是门槛。\n### 字数统计，阅读时间统计\n\n这一部分比较简单，只需要安装hexo-wordcount插件，\b传入博客的内容即可计算得出。先安装插件：\n```\nnpm i --save hexo-wordcount\n```\n在主题模板文件中即可使用wordcount方法计算字数统计和阅读时长。\n```\n<% if(theme.postCount.enable){  %>\n\t<% if(theme.postCount.wordcount){  %>\n\t\t<span class=\"post-wordcount hidden-xs\" itemprop=\"wordCount\"><%= __('article.wordcount') %>: <%= wordcount(post.content) %>(<%= __('unit.word') %>)</span>\n\t<% } %>\n\t<% if(theme.postCount.min2read){  %>\n\t\t<span class=\"post-readcount hidden-xs\" itemprop=\"timeRequired\"><%= __('article.readcount') %>: <%= min2read(post.content) %>(<%= __('unit.time') %>)</span>\n\t<% } %>\n<% } %>\n```\n\n### 如何在博客展示自己github托管的项目\n\n作为一个程序员，GitHub开源项目是程序员展示编程技术和工作阅历，释放程序员个人魅力的宽广舞台。所以，很有必要在博客的核心页面展示自己GitHub的repository。Hexo可以在主题内通过ejs或swig模板引擎来构建页面，GitHub提供开源api支持获取repo列表。所以我们可以通过调用引入JavaScript请求api。展示效果如下\n\n![repository](/images/repo.jpg)\n\n问题出在Github的未授权状态的api每小时只可以请求60次，而超出次数就会403。而授权的api每小时可以访问50000次。所以需要去[https://developer.github.com/v3/auth/#basic-authentication](https://developer.github.com/v3/auth/#basic-authentication)申请授权，我们搭建的Hexo静态博客，没有Server，所以oauth2的方式\b不可取，这里我用的access_token来对api授权，Github出于安全的考虑，不允许我们把access_token上传到Github仓库，所以我们需要借助你擅长的加密方式，对access_token加密，运行时解密。伪代码如下：\n```\nvar key = 'U2FsdGVkX1+VWdiIkoA3PCbz9KKGlKilMs6UztGd2VQuYuSAoZLyCi8fM2qxUbviYt35kf/tpFvEqNmtY3WppQ='\nvar access_token = CryptoJS.AES.decrypt(key, 'guguji5').toString(CryptoJS.enc.Utf8);\n$.get(\"https://api.github.com/users/<%=theme.github.username%>/repos?access_token=\"+access_token, function(result) {\n})\n```\n*参考链接*\n\nhttps://developer.github.com/v3/auth/#basic-authentication\n\nhttps://developer.github.com/v3/#rate-limiting\n\nhttps://amylynnandrews.com/categories-vs-tags/","slug":"Hexo-Github搭建静态博客-二","published":1,"updated":"2018-11-26T02:21:04.426Z","layout":"post","photos":[],"link":"","_id":"ckrix8zdk000ck1jfityp9138","content":"<h3 id=\"快速介绍\"><a href=\"#快速介绍\" class=\"headerlink\" title=\"快速介绍\"></a>快速介绍</h3><p>本文是接Hexo + Github搭建静态博客(一)，Hexo环境的搭建，依赖的下载请根据<a href=\"https://guguji5.github.io/Hexo-Github%E6%90%AD%E5%BB%BA%E9%9D%99%E6%80%81%E5%8D%9A%E5%AE%A2-%E4%B8%80/\">上文</a>自行配置。本文主要介绍Hexo的<strong>归档，标签，分类</strong>，以及依靠插件支持的<strong>评论，站内搜索，字数统计</strong>等功能。</p>\n<h3 id=\"归档，分类，标签\"><a href=\"#归档，分类，标签\" class=\"headerlink\" title=\"归档，分类，标签\"></a>归档，分类，标签</h3><p>三者\b是众多博客模板的必要元素，而在文档中却没有详细的解释，匆匆一笔带过。笔者阅历浅薄，结合自己的理解，强行解释\b一波，通过对比将意思表达的更清楚。</p>\n<p>归档（archives）是按照一定的周期对博客进行分类，大多数是按年，月等。</p>\n<p>分类\b（categories）和 标签（tags）都是用来描述博客的内容，\b但却又不尽相同。分类 定义博客的常规主题，而标签会深入反应内容。分类会\b构成博客的大纲，反应博客的基本结构，而标签会更具体一些。（其实还是\b会让人confuse）下边我\b希望通过一个小故事解释清\b“分类”和“标签”的不同。</p>\n<p>假如我们运营着一个关于电子产品（3C）的博客，有\b众多的博文，可能会有以下的分类</p>\n<ul>\n<li>笔记本</li>\n<li>手机</li>\n<li>存储设备</li>\n<li>数码相机</li>\n</ul>\n<p>当新出iphone的时候，我们可能会写一个\b新产品开箱博客，他分类肯定是”手机“，而标签会是”iphone“。</p>\n<p>创建对应的页面也很简单，只需一行命令。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo new page &quot;archives&quot;</span><br><span class=\"line\">hexo new page &quot;tags&quot;</span><br><span class=\"line\">hexo new page &quot;categories&quot;</span><br></pre></td></tr></table></figure>\n<h3 id=\"站内搜索\"><a href=\"#站内搜索\" class=\"headerlink\" title=\"站内搜索\"></a>站内搜索</h3><p>方式有以下三种，insight、swiftype、baidu。</p>\n<p>insight只需安装hexo-generator-json-content组件即可。<br>swiftype需要去其官网注册key。<br>baidu搜索的话需要禁用其他两种。</p>\n<p>三种都很简单，这里展示第一种的效果图。</p>\n<p><img src=\"/images/search.jpg\" alt=\"站内搜索\"></p>\n<h3 id=\"评论\"><a href=\"#评论\" class=\"headerlink\" title=\"评论\"></a>评论</h3><p>\b评论是博客必不可少的一项功能。而Hexo作为一个静态博客，没有WordPress那样\b的server和数据库，评论的功能可想而知肯定是用的第三方的评论系统。大浪淘沙，对比各色的需求，接下来我们\bXXX。</p>\n<ul>\n<li>来必力 : 504报错，跨域</li>\n<li>Hypercomments: 付费</li>\n<li>畅言 : 畅言</li>\n<li>Valine : sound good</li>\n<li>多说 : 关闭</li>\n<li>网易云跟帖 : 关闭</li>\n<li>disqus : 科学上网</li>\n<li>gitalk : 需要Github账号</li>\n<li>搜狐畅言 : 备案</li>\n</ul>\n<p>这个topic展开的话会很冗长，搜索引擎上也有很多这类的文章。我最后选择了gittalk，\b简单大方，技术类的文章，\bGithub不是门槛。</p>\n<h3 id=\"字数统计，阅读时间统计\"><a href=\"#字数统计，阅读时间统计\" class=\"headerlink\" title=\"字数统计，阅读时间统计\"></a>字数统计，阅读时间统计</h3><p>这一部分比较简单，只需要安装hexo-wordcount插件，\b传入博客的内容即可计算得出。先安装插件：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm i --save hexo-wordcount</span><br></pre></td></tr></table></figure></p>\n<p>在主题模板文件中即可使用wordcount方法计算字数统计和阅读时长。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;% if(theme.postCount.enable)&#123;  %&gt;</span><br><span class=\"line\">\t&lt;% if(theme.postCount.wordcount)&#123;  %&gt;</span><br><span class=\"line\">\t\t&lt;span class=&quot;post-wordcount hidden-xs&quot; itemprop=&quot;wordCount&quot;&gt;&lt;%= __(&apos;article.wordcount&apos;) %&gt;: &lt;%= wordcount(post.content) %&gt;(&lt;%= __(&apos;unit.word&apos;) %&gt;)&lt;/span&gt;</span><br><span class=\"line\">\t&lt;% &#125; %&gt;</span><br><span class=\"line\">\t&lt;% if(theme.postCount.min2read)&#123;  %&gt;</span><br><span class=\"line\">\t\t&lt;span class=&quot;post-readcount hidden-xs&quot; itemprop=&quot;timeRequired&quot;&gt;&lt;%= __(&apos;article.readcount&apos;) %&gt;: &lt;%= min2read(post.content) %&gt;(&lt;%= __(&apos;unit.time&apos;) %&gt;)&lt;/span&gt;</span><br><span class=\"line\">\t&lt;% &#125; %&gt;</span><br><span class=\"line\">&lt;% &#125; %&gt;</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"如何在博客展示自己github托管的项目\"><a href=\"#如何在博客展示自己github托管的项目\" class=\"headerlink\" title=\"如何在博客展示自己github托管的项目\"></a>如何在博客展示自己github托管的项目</h3><p>作为一个程序员，GitHub开源项目是程序员展示编程技术和工作阅历，释放程序员个人魅力的宽广舞台。所以，很有必要在博客的核心页面展示自己GitHub的repository。Hexo可以在主题内通过ejs或swig模板引擎来构建页面，GitHub提供开源api支持获取repo列表。所以我们可以通过调用引入JavaScript请求api。展示效果如下</p>\n<p><img src=\"/images/repo.jpg\" alt=\"repository\"></p>\n<p>问题出在Github的未授权状态的api每小时只可以请求60次，而超出次数就会403。而授权的api每小时可以访问50000次。所以需要去<a href=\"https://developer.github.com/v3/auth/#basic-authentication\" target=\"_blank\" rel=\"noopener\">https://developer.github.com/v3/auth/#basic-authentication</a>申请授权，我们搭建的Hexo静态博客，没有Server，所以oauth2的方式\b不可取，这里我用的access_token来对api授权，Github出于安全的考虑，不允许我们把access_token上传到Github仓库，所以我们需要借助你擅长的加密方式，对access_token加密，运行时解密。伪代码如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var key = &apos;U2FsdGVkX1+VWdiIkoA3PCbz9KKGlKilMs6UztGd2VQuYuSAoZLyCi8fM2qxUbviYt35kf/tpFvEqNmtY3WppQ=&apos;</span><br><span class=\"line\">var access_token = CryptoJS.AES.decrypt(key, &apos;guguji5&apos;).toString(CryptoJS.enc.Utf8);</span><br><span class=\"line\">$.get(&quot;https://api.github.com/users/&lt;%=theme.github.username%&gt;/repos?access_token=&quot;+access_token, function(result) &#123;</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure></p>\n<p><em>参考链接</em></p>\n<p><a href=\"https://developer.github.com/v3/auth/#basic-authentication\" target=\"_blank\" rel=\"noopener\">https://developer.github.com/v3/auth/#basic-authentication</a></p>\n<p><a href=\"https://developer.github.com/v3/#rate-limiting\" target=\"_blank\" rel=\"noopener\">https://developer.github.com/v3/#rate-limiting</a></p>\n<p><a href=\"https://amylynnandrews.com/categories-vs-tags/\" target=\"_blank\" rel=\"noopener\">https://amylynnandrews.com/categories-vs-tags/</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"快速介绍\"><a href=\"#快速介绍\" class=\"headerlink\" title=\"快速介绍\"></a>快速介绍</h3><p>本文是接Hexo + Github搭建静态博客(一)，Hexo环境的搭建，依赖的下载请根据<a href=\"https://guguji5.github.io/Hexo-Github%E6%90%AD%E5%BB%BA%E9%9D%99%E6%80%81%E5%8D%9A%E5%AE%A2-%E4%B8%80/\">上文</a>自行配置。本文主要介绍Hexo的<strong>归档，标签，分类</strong>，以及依靠插件支持的<strong>评论，站内搜索，字数统计</strong>等功能。</p>\n<h3 id=\"归档，分类，标签\"><a href=\"#归档，分类，标签\" class=\"headerlink\" title=\"归档，分类，标签\"></a>归档，分类，标签</h3><p>三者\b是众多博客模板的必要元素，而在文档中却没有详细的解释，匆匆一笔带过。笔者阅历浅薄，结合自己的理解，强行解释\b一波，通过对比将意思表达的更清楚。</p>\n<p>归档（archives）是按照一定的周期对博客进行分类，大多数是按年，月等。</p>\n<p>分类\b（categories）和 标签（tags）都是用来描述博客的内容，\b但却又不尽相同。分类 定义博客的常规主题，而标签会深入反应内容。分类会\b构成博客的大纲，反应博客的基本结构，而标签会更具体一些。（其实还是\b会让人confuse）下边我\b希望通过一个小故事解释清\b“分类”和“标签”的不同。</p>\n<p>假如我们运营着一个关于电子产品（3C）的博客，有\b众多的博文，可能会有以下的分类</p>\n<ul>\n<li>笔记本</li>\n<li>手机</li>\n<li>存储设备</li>\n<li>数码相机</li>\n</ul>\n<p>当新出iphone的时候，我们可能会写一个\b新产品开箱博客，他分类肯定是”手机“，而标签会是”iphone“。</p>\n<p>创建对应的页面也很简单，只需一行命令。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo new page &quot;archives&quot;</span><br><span class=\"line\">hexo new page &quot;tags&quot;</span><br><span class=\"line\">hexo new page &quot;categories&quot;</span><br></pre></td></tr></table></figure>\n<h3 id=\"站内搜索\"><a href=\"#站内搜索\" class=\"headerlink\" title=\"站内搜索\"></a>站内搜索</h3><p>方式有以下三种，insight、swiftype、baidu。</p>\n<p>insight只需安装hexo-generator-json-content组件即可。<br>swiftype需要去其官网注册key。<br>baidu搜索的话需要禁用其他两种。</p>\n<p>三种都很简单，这里展示第一种的效果图。</p>\n<p><img src=\"/images/search.jpg\" alt=\"站内搜索\"></p>\n<h3 id=\"评论\"><a href=\"#评论\" class=\"headerlink\" title=\"评论\"></a>评论</h3><p>\b评论是博客必不可少的一项功能。而Hexo作为一个静态博客，没有WordPress那样\b的server和数据库，评论的功能可想而知肯定是用的第三方的评论系统。大浪淘沙，对比各色的需求，接下来我们\bXXX。</p>\n<ul>\n<li>来必力 : 504报错，跨域</li>\n<li>Hypercomments: 付费</li>\n<li>畅言 : 畅言</li>\n<li>Valine : sound good</li>\n<li>多说 : 关闭</li>\n<li>网易云跟帖 : 关闭</li>\n<li>disqus : 科学上网</li>\n<li>gitalk : 需要Github账号</li>\n<li>搜狐畅言 : 备案</li>\n</ul>\n<p>这个topic展开的话会很冗长，搜索引擎上也有很多这类的文章。我最后选择了gittalk，\b简单大方，技术类的文章，\bGithub不是门槛。</p>\n<h3 id=\"字数统计，阅读时间统计\"><a href=\"#字数统计，阅读时间统计\" class=\"headerlink\" title=\"字数统计，阅读时间统计\"></a>字数统计，阅读时间统计</h3><p>这一部分比较简单，只需要安装hexo-wordcount插件，\b传入博客的内容即可计算得出。先安装插件：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm i --save hexo-wordcount</span><br></pre></td></tr></table></figure></p>\n<p>在主题模板文件中即可使用wordcount方法计算字数统计和阅读时长。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;% if(theme.postCount.enable)&#123;  %&gt;</span><br><span class=\"line\">\t&lt;% if(theme.postCount.wordcount)&#123;  %&gt;</span><br><span class=\"line\">\t\t&lt;span class=&quot;post-wordcount hidden-xs&quot; itemprop=&quot;wordCount&quot;&gt;&lt;%= __(&apos;article.wordcount&apos;) %&gt;: &lt;%= wordcount(post.content) %&gt;(&lt;%= __(&apos;unit.word&apos;) %&gt;)&lt;/span&gt;</span><br><span class=\"line\">\t&lt;% &#125; %&gt;</span><br><span class=\"line\">\t&lt;% if(theme.postCount.min2read)&#123;  %&gt;</span><br><span class=\"line\">\t\t&lt;span class=&quot;post-readcount hidden-xs&quot; itemprop=&quot;timeRequired&quot;&gt;&lt;%= __(&apos;article.readcount&apos;) %&gt;: &lt;%= min2read(post.content) %&gt;(&lt;%= __(&apos;unit.time&apos;) %&gt;)&lt;/span&gt;</span><br><span class=\"line\">\t&lt;% &#125; %&gt;</span><br><span class=\"line\">&lt;% &#125; %&gt;</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"如何在博客展示自己github托管的项目\"><a href=\"#如何在博客展示自己github托管的项目\" class=\"headerlink\" title=\"如何在博客展示自己github托管的项目\"></a>如何在博客展示自己github托管的项目</h3><p>作为一个程序员，GitHub开源项目是程序员展示编程技术和工作阅历，释放程序员个人魅力的宽广舞台。所以，很有必要在博客的核心页面展示自己GitHub的repository。Hexo可以在主题内通过ejs或swig模板引擎来构建页面，GitHub提供开源api支持获取repo列表。所以我们可以通过调用引入JavaScript请求api。展示效果如下</p>\n<p><img src=\"/images/repo.jpg\" alt=\"repository\"></p>\n<p>问题出在Github的未授权状态的api每小时只可以请求60次，而超出次数就会403。而授权的api每小时可以访问50000次。所以需要去<a href=\"https://developer.github.com/v3/auth/#basic-authentication\" target=\"_blank\" rel=\"noopener\">https://developer.github.com/v3/auth/#basic-authentication</a>申请授权，我们搭建的Hexo静态博客，没有Server，所以oauth2的方式\b不可取，这里我用的access_token来对api授权，Github出于安全的考虑，不允许我们把access_token上传到Github仓库，所以我们需要借助你擅长的加密方式，对access_token加密，运行时解密。伪代码如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var key = &apos;U2FsdGVkX1+VWdiIkoA3PCbz9KKGlKilMs6UztGd2VQuYuSAoZLyCi8fM2qxUbviYt35kf/tpFvEqNmtY3WppQ=&apos;</span><br><span class=\"line\">var access_token = CryptoJS.AES.decrypt(key, &apos;guguji5&apos;).toString(CryptoJS.enc.Utf8);</span><br><span class=\"line\">$.get(&quot;https://api.github.com/users/&lt;%=theme.github.username%&gt;/repos?access_token=&quot;+access_token, function(result) &#123;</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure></p>\n<p><em>参考链接</em></p>\n<p><a href=\"https://developer.github.com/v3/auth/#basic-authentication\" target=\"_blank\" rel=\"noopener\">https://developer.github.com/v3/auth/#basic-authentication</a></p>\n<p><a href=\"https://developer.github.com/v3/#rate-limiting\" target=\"_blank\" rel=\"noopener\">https://developer.github.com/v3/#rate-limiting</a></p>\n<p><a href=\"https://amylynnandrews.com/categories-vs-tags/\" target=\"_blank\" rel=\"noopener\">https://amylynnandrews.com/categories-vs-tags/</a></p>\n"},{"title":"3.Referer理解错误导致的跨域","date":"2021-01-21T11:54:06.000Z","_content":"\n在前后端分离的情况下，大多数请求都是跨域请求。\n\n组里的Nodejs Koa服务CORS不知道在网上参考哪个倒霉博客，在Referer上取CORS的值，差不多代码如下：\n\n```\nctx.set('Access-Control-Allow-Origin', ctx.header.referer.slice(0, -1));\n```\n\nReferer 有个规则，#之后的会丢掉（e.g. #section),顺便说一句鉴权的也不行（e.g. https://username:password@example.com)。Currently 单页应用大行其道，hash路由下，只会返回Origin。\n\nReferer为 `https://app.example.com/` 时把CORS设为 `https://app.example.com`。刚开始岁月安好，符合预期。\n\n问题出在当用户访问 `https://app.example.com/page.html` 时请求 `https://api.example.com/getData`，跨域了，。在不同浏览器下（严谨点说是不同的 [Referrer-Policy](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referrer-Policy)下）会展示为\n\n```\nno-referrer-when-downgrade \nhttps://app.example.com/page.html\n\norigin-when-cross-origin\nhttps://app.example.com/\n\n```\n\n在之前默认值为 `no-referrer-when-downgrade`,悄咪咪的，谷歌粑粑把默认值改成了 `strict-origin-when-cross-origin`。这导致所有跨域网站的Referer都会变成Origin。\n\n**Chrome plans to switch its default policy from no-referrer-when-downgrade to strict-origin-when-cross-origin, starting in version 85.**（[From developers.google.com](https://developers.google.com/web/updates/2020/07/referrer-policy-new-chrome-default))\n\nHowever，safari浏览器还是no-referrer-when-downgrade，这意味着尽管同一个页面，referer可能在 safari下为 `https://app.example.com/page.html` 而在chrome下为 `https://app.example.com/`,所以用Referer是个愚蠢的选择，改成使用Origin来判断。\n\n```\nif (/^(.+?)\\.example\\.com$/.test(ctx.header.origin)) {\n    ctx.set('Access-Control-Allow-Origin', ctx.header.origin);\n}\n```\n\n\n\n## Reference\n\nhttps://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referer\nhttps://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referrer-Policy\nhttps://developers.google.com/web/updates/2020/07/referrer-policy-new-chrome-default","source":"_posts/3.Referer理解错误导致的跨域.md","raw":"---\ntitle: 3.Referer理解错误导致的跨域\ndate: 2021-01-21 19:54:06\ntags: Bugfix\n---\n\n在前后端分离的情况下，大多数请求都是跨域请求。\n\n组里的Nodejs Koa服务CORS不知道在网上参考哪个倒霉博客，在Referer上取CORS的值，差不多代码如下：\n\n```\nctx.set('Access-Control-Allow-Origin', ctx.header.referer.slice(0, -1));\n```\n\nReferer 有个规则，#之后的会丢掉（e.g. #section),顺便说一句鉴权的也不行（e.g. https://username:password@example.com)。Currently 单页应用大行其道，hash路由下，只会返回Origin。\n\nReferer为 `https://app.example.com/` 时把CORS设为 `https://app.example.com`。刚开始岁月安好，符合预期。\n\n问题出在当用户访问 `https://app.example.com/page.html` 时请求 `https://api.example.com/getData`，跨域了，。在不同浏览器下（严谨点说是不同的 [Referrer-Policy](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referrer-Policy)下）会展示为\n\n```\nno-referrer-when-downgrade \nhttps://app.example.com/page.html\n\norigin-when-cross-origin\nhttps://app.example.com/\n\n```\n\n在之前默认值为 `no-referrer-when-downgrade`,悄咪咪的，谷歌粑粑把默认值改成了 `strict-origin-when-cross-origin`。这导致所有跨域网站的Referer都会变成Origin。\n\n**Chrome plans to switch its default policy from no-referrer-when-downgrade to strict-origin-when-cross-origin, starting in version 85.**（[From developers.google.com](https://developers.google.com/web/updates/2020/07/referrer-policy-new-chrome-default))\n\nHowever，safari浏览器还是no-referrer-when-downgrade，这意味着尽管同一个页面，referer可能在 safari下为 `https://app.example.com/page.html` 而在chrome下为 `https://app.example.com/`,所以用Referer是个愚蠢的选择，改成使用Origin来判断。\n\n```\nif (/^(.+?)\\.example\\.com$/.test(ctx.header.origin)) {\n    ctx.set('Access-Control-Allow-Origin', ctx.header.origin);\n}\n```\n\n\n\n## Reference\n\nhttps://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referer\nhttps://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referrer-Policy\nhttps://developers.google.com/web/updates/2020/07/referrer-policy-new-chrome-default","slug":"3.Referer理解错误导致的跨域","published":1,"updated":"2021-01-22T02:27:36.422Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckrix8zdm000ek1jfvexyi5gx","content":"<p>在前后端分离的情况下，大多数请求都是跨域请求。</p>\n<p>组里的Nodejs Koa服务CORS不知道在网上参考哪个倒霉博客，在Referer上取CORS的值，差不多代码如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ctx.set(&apos;Access-Control-Allow-Origin&apos;, ctx.header.referer.slice(0, -1));</span><br></pre></td></tr></table></figure>\n<p>Referer 有个规则，#之后的会丢掉（e.g. #section),顺便说一句鉴权的也不行（e.g. <a href=\"https://username:password@example.com)。Currently\" target=\"_blank\" rel=\"noopener\">https://username:password@example.com)。Currently</a> 单页应用大行其道，hash路由下，只会返回Origin。</p>\n<p>Referer为 <code>https://app.example.com/</code> 时把CORS设为 <code>https://app.example.com</code>。刚开始岁月安好，符合预期。</p>\n<p>问题出在当用户访问 <code>https://app.example.com/page.html</code> 时请求 <code>https://api.example.com/getData</code>，跨域了，。在不同浏览器下（严谨点说是不同的 <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referrer-Policy\" target=\"_blank\" rel=\"noopener\">Referrer-Policy</a>下）会展示为</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">no-referrer-when-downgrade </span><br><span class=\"line\">https://app.example.com/page.html</span><br><span class=\"line\"></span><br><span class=\"line\">origin-when-cross-origin</span><br><span class=\"line\">https://app.example.com/</span><br></pre></td></tr></table></figure>\n<p>在之前默认值为 <code>no-referrer-when-downgrade</code>,悄咪咪的，谷歌粑粑把默认值改成了 <code>strict-origin-when-cross-origin</code>。这导致所有跨域网站的Referer都会变成Origin。</p>\n<p><strong>Chrome plans to switch its default policy from no-referrer-when-downgrade to strict-origin-when-cross-origin, starting in version 85.</strong>（<a href=\"https://developers.google.com/web/updates/2020/07/referrer-policy-new-chrome-default\" target=\"_blank\" rel=\"noopener\">From developers.google.com</a>)</p>\n<p>However，safari浏览器还是no-referrer-when-downgrade，这意味着尽管同一个页面，referer可能在 safari下为 <code>https://app.example.com/page.html</code> 而在chrome下为 <code>https://app.example.com/</code>,所以用Referer是个愚蠢的选择，改成使用Origin来判断。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if (/^(.+?)\\.example\\.com$/.test(ctx.header.origin)) &#123;</span><br><span class=\"line\">    ctx.set(&apos;Access-Control-Allow-Origin&apos;, ctx.header.origin);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"Reference\"><a href=\"#Reference\" class=\"headerlink\" title=\"Reference\"></a>Reference</h2><p><a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referer\" target=\"_blank\" rel=\"noopener\">https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referer</a><br><a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referrer-Policy\" target=\"_blank\" rel=\"noopener\">https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referrer-Policy</a><br><a href=\"https://developers.google.com/web/updates/2020/07/referrer-policy-new-chrome-default\" target=\"_blank\" rel=\"noopener\">https://developers.google.com/web/updates/2020/07/referrer-policy-new-chrome-default</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>在前后端分离的情况下，大多数请求都是跨域请求。</p>\n<p>组里的Nodejs Koa服务CORS不知道在网上参考哪个倒霉博客，在Referer上取CORS的值，差不多代码如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ctx.set(&apos;Access-Control-Allow-Origin&apos;, ctx.header.referer.slice(0, -1));</span><br></pre></td></tr></table></figure>\n<p>Referer 有个规则，#之后的会丢掉（e.g. #section),顺便说一句鉴权的也不行（e.g. <a href=\"https://username:password@example.com)。Currently\" target=\"_blank\" rel=\"noopener\">https://username:password@example.com)。Currently</a> 单页应用大行其道，hash路由下，只会返回Origin。</p>\n<p>Referer为 <code>https://app.example.com/</code> 时把CORS设为 <code>https://app.example.com</code>。刚开始岁月安好，符合预期。</p>\n<p>问题出在当用户访问 <code>https://app.example.com/page.html</code> 时请求 <code>https://api.example.com/getData</code>，跨域了，。在不同浏览器下（严谨点说是不同的 <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referrer-Policy\" target=\"_blank\" rel=\"noopener\">Referrer-Policy</a>下）会展示为</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">no-referrer-when-downgrade </span><br><span class=\"line\">https://app.example.com/page.html</span><br><span class=\"line\"></span><br><span class=\"line\">origin-when-cross-origin</span><br><span class=\"line\">https://app.example.com/</span><br></pre></td></tr></table></figure>\n<p>在之前默认值为 <code>no-referrer-when-downgrade</code>,悄咪咪的，谷歌粑粑把默认值改成了 <code>strict-origin-when-cross-origin</code>。这导致所有跨域网站的Referer都会变成Origin。</p>\n<p><strong>Chrome plans to switch its default policy from no-referrer-when-downgrade to strict-origin-when-cross-origin, starting in version 85.</strong>（<a href=\"https://developers.google.com/web/updates/2020/07/referrer-policy-new-chrome-default\" target=\"_blank\" rel=\"noopener\">From developers.google.com</a>)</p>\n<p>However，safari浏览器还是no-referrer-when-downgrade，这意味着尽管同一个页面，referer可能在 safari下为 <code>https://app.example.com/page.html</code> 而在chrome下为 <code>https://app.example.com/</code>,所以用Referer是个愚蠢的选择，改成使用Origin来判断。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if (/^(.+?)\\.example\\.com$/.test(ctx.header.origin)) &#123;</span><br><span class=\"line\">    ctx.set(&apos;Access-Control-Allow-Origin&apos;, ctx.header.origin);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"Reference\"><a href=\"#Reference\" class=\"headerlink\" title=\"Reference\"></a>Reference</h2><p><a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referer\" target=\"_blank\" rel=\"noopener\">https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referer</a><br><a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referrer-Policy\" target=\"_blank\" rel=\"noopener\">https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referrer-Policy</a><br><a href=\"https://developers.google.com/web/updates/2020/07/referrer-policy-new-chrome-default\" target=\"_blank\" rel=\"noopener\">https://developers.google.com/web/updates/2020/07/referrer-policy-new-chrome-default</a></p>\n"},{"title":"SVG Sprite优化滴滴云项目中的图标","date":"2018-11-22T13:54:26.000Z","comments":1,"_content":"### 背景介绍\n\n滴滴云用户系统随着\b模块，功能，页面的增多，小图标也越来越多，随着开发人员的不断加入\b以及图片需求的\b不断更新，项目中图片的引用方法也变得多种多样。本次调研旨在整理项目中的图标，网站加载\b速率，统一开发人员\b引用图片的用法。\n\n### 项目\b现状\n\n项目中图片的使用方式有以下三种\n1. iconfont，单色小图片。\n2. inline直接引用图片。\n3. inline直接引用，图片小于2k，\b转为base64。\n\n第2项中大图片直接引用无可否非，\b但目前项目中有70-80多个4k-8k的小图片也是直接引用到项目里，这次调研主要针对小图片进行合并，减少请求数，优化网站的响应速度。\n\n### CSS \bSPRITE\n\nCSS Sprite是传统的优化图片的方法，基本原理也很简单，把小图标按照\b一定顺序合并在一个大图上，使用时需按background-image方式引入，辅以background-position来控制需要显示图片的位置。\n\n\bwebpack-spritesmith组件可以实现合并小图片，并生成相对于的css样式，在原来使用的标签上\b添加对应的class类名即可。但是此方法针对项目中通过`<img src=\"imgages/demo.png />`标签内联引用图片的方式改动较大，需将img标签转换为background显示，\b\b可读性减弱，改动\beffort较大，样式\b出错的\b机会及测试的成本都很大，顾放弃此方法。\n\n### SVG \bSPRITE\n\nSVG 是一种基于 XML 语法的图像格式，全称是可缩放矢量图（Scalable Vector Graphics）。其他图像格式都是基于像素处理的，SVG 则是属于对图像的形状描述，所以它本质上是文本文件，体积较小，且不管放大多少倍都不会失真。\n\nSVG可以直接\b放在HTML，CSS里\b使用。SVG Sprite是依赖其symbol标签和use标签实现其合并的效果。合并完以后的\bsvg大概如下图\n```\n<svg>\n    <symbol id=\"shape\">\n        <!-- 第1个图标路径形状之类代码 -->\n    </symbol>\n    <symbol>\n        <!-- 第2个图标路径形状之类代码 -->\n    </symbol>\n    <symbol>\n        <!-- 第3个图标路径形状之类代码 -->\n    </symbol>\n</svg>\n```\nuse的语法如下\n```\n<svg>\n  <use xlink:href=\"#shape\" x=\"200\" y=\"50\" />\n</svg>\n```\n我们\b期望的效果是把所有svg都通过symbol合并到一个大的svg sprite，而手动维护显然是不现实的，所以我们需要[svg-sprite-loader](https://github.com/kisenka/svg-sprite-loader)，他可以根据config来自动合并所有的svg，形成\b一个大的svg sprite。需在webpack中添加的配置如下：\n```\n{\n    test: /\\.svg$/,\n    loader: 'svg-sprite-loader',\n    include: [resolve('src/assets/images/svg')], //只合并固定目录\n    options: {\n        extract: true, // 将合并后的svg提取为一个单独文件，默认false，会将svg\b解析后以内联方式打包到模板里\n        spriteFilename: utils.assetsPath('img/sprite.svg'),\n        symbolId: 'icon-[name]', //symbol id的rename规则\n    }\n},\n// 主动调用webpack 方法，\b循环遍历\bsvg目标文件夹下所有svg格式文件。\nconst req = require.context('assets/images/svg', false, /\\.svg$/)\nconst requireAll = requireContext => requireContext.keys().map(requireContext)\nrequireAll(req)\n```\n至此，项目中就可以以`<svg><use xlink:href=\"#shape\"/></svg>`\b方式来用svg展示icon。进一步可以封装为vue组件以方便使用。\n```\n<template>\n  <svg class=\"svg-icon\" aria-hidden=\"true\">\n    <use :xlink:href=\"iconName\"></use>\n  </svg>\n</template>\n\n<script>\nexport default {\n  name: 'icon-svg',\n  props: {\n    iconClass: {\n      type: String,\n      required: true\n    }\n  },\n  computed: {\n    iconName () {\n      return `sprite.svg#icon-${this.iconClass}`\n    }\n  }\n}\n</script>\n\n<style>\n.svg-icon {\n  width: 1em;    //能继承font-size的大小\n  height: 1em;\n  vertical-align: -0.15em;\n  fill: currentColor;   //可以接受外部color，改变svg内部currentColor的路径\n  overflow: hidden;\n}\n</style>\n```\n组件可以实现和iconfont一样的通过font-size，color修改图标的大小和颜色，使用方法也更加友好，只需`<icon-svg icon-class=\"wechat-for-signin\" />`,在icon-class传入svg名字即可。在页面中的node节点渲染如图：\n![svg](/images/svg_node.png)\n\n### svg vs iconfont\n\nicon-svg     | iconfont\n-------- | -----\n多种色彩  | 单一色彩\n真正的矢量  | 字体文件\ncss控制大小，颜色，甚至局部颜色  | css控制大小，颜色\nwebpack实现  | 需要借助外部工具\nIE9+  | IE6\n\n### SVG待解决问题\n\n通过symbol+use的方式引入svg，当`<use xlink:href=\"\">`引用的是外部资源时在vue的template里v-if渲染会有问题。\b尤大大解释说这是chrome的bug。\n[https://github.com/vuejs/vue/issues/2661](https://github.com/vuejs/vue/issues/2661)\n[https://github.com/vuejs/vue/issues/2782](https://github.com/vuejs/vue/issues/2782)\n\nissue提出\b已经两年了，\b有没有官方的解决方案还需继续调研。目前的workaround有一下三种：\n- 将v-if改为v-show\n- 不提取sprint.svg,内联引用\b，\n- 将sprint.svg通过webpack达成chunk包,通过js引用sprint.svg。\n\n### 总结\n\n项目中4k-8k的小图片没有以iconfont方式引入的方式，原因不管是\b“多色”，“图片格式限制”。引入icon-svg后，随着设计师更新icon，我们希望尽量将图切成svg，一并合到sprite.svg中，svg文件经过gzip的压缩，会达到减少请求，增加传输的效率的目的。\n\n*参考链接*\n\nhttps://css-tricks.com/svg-symbol-good-choice-icons/\nhttps://github.com/PanJiaChen/vue-element-admin","source":"_posts/SVG-Sprite优化滴滴云项目中的图标.md","raw":"---\ntitle: SVG Sprite优化滴滴云项目中的图标\ndate: 2018-11-22 21:54:26\ntags: 优化\ncomments: true\n---\n### 背景介绍\n\n滴滴云用户系统随着\b模块，功能，页面的增多，小图标也越来越多，随着开发人员的不断加入\b以及图片需求的\b不断更新，项目中图片的引用方法也变得多种多样。本次调研旨在整理项目中的图标，网站加载\b速率，统一开发人员\b引用图片的用法。\n\n### 项目\b现状\n\n项目中图片的使用方式有以下三种\n1. iconfont，单色小图片。\n2. inline直接引用图片。\n3. inline直接引用，图片小于2k，\b转为base64。\n\n第2项中大图片直接引用无可否非，\b但目前项目中有70-80多个4k-8k的小图片也是直接引用到项目里，这次调研主要针对小图片进行合并，减少请求数，优化网站的响应速度。\n\n### CSS \bSPRITE\n\nCSS Sprite是传统的优化图片的方法，基本原理也很简单，把小图标按照\b一定顺序合并在一个大图上，使用时需按background-image方式引入，辅以background-position来控制需要显示图片的位置。\n\n\bwebpack-spritesmith组件可以实现合并小图片，并生成相对于的css样式，在原来使用的标签上\b添加对应的class类名即可。但是此方法针对项目中通过`<img src=\"imgages/demo.png />`标签内联引用图片的方式改动较大，需将img标签转换为background显示，\b\b可读性减弱，改动\beffort较大，样式\b出错的\b机会及测试的成本都很大，顾放弃此方法。\n\n### SVG \bSPRITE\n\nSVG 是一种基于 XML 语法的图像格式，全称是可缩放矢量图（Scalable Vector Graphics）。其他图像格式都是基于像素处理的，SVG 则是属于对图像的形状描述，所以它本质上是文本文件，体积较小，且不管放大多少倍都不会失真。\n\nSVG可以直接\b放在HTML，CSS里\b使用。SVG Sprite是依赖其symbol标签和use标签实现其合并的效果。合并完以后的\bsvg大概如下图\n```\n<svg>\n    <symbol id=\"shape\">\n        <!-- 第1个图标路径形状之类代码 -->\n    </symbol>\n    <symbol>\n        <!-- 第2个图标路径形状之类代码 -->\n    </symbol>\n    <symbol>\n        <!-- 第3个图标路径形状之类代码 -->\n    </symbol>\n</svg>\n```\nuse的语法如下\n```\n<svg>\n  <use xlink:href=\"#shape\" x=\"200\" y=\"50\" />\n</svg>\n```\n我们\b期望的效果是把所有svg都通过symbol合并到一个大的svg sprite，而手动维护显然是不现实的，所以我们需要[svg-sprite-loader](https://github.com/kisenka/svg-sprite-loader)，他可以根据config来自动合并所有的svg，形成\b一个大的svg sprite。需在webpack中添加的配置如下：\n```\n{\n    test: /\\.svg$/,\n    loader: 'svg-sprite-loader',\n    include: [resolve('src/assets/images/svg')], //只合并固定目录\n    options: {\n        extract: true, // 将合并后的svg提取为一个单独文件，默认false，会将svg\b解析后以内联方式打包到模板里\n        spriteFilename: utils.assetsPath('img/sprite.svg'),\n        symbolId: 'icon-[name]', //symbol id的rename规则\n    }\n},\n// 主动调用webpack 方法，\b循环遍历\bsvg目标文件夹下所有svg格式文件。\nconst req = require.context('assets/images/svg', false, /\\.svg$/)\nconst requireAll = requireContext => requireContext.keys().map(requireContext)\nrequireAll(req)\n```\n至此，项目中就可以以`<svg><use xlink:href=\"#shape\"/></svg>`\b方式来用svg展示icon。进一步可以封装为vue组件以方便使用。\n```\n<template>\n  <svg class=\"svg-icon\" aria-hidden=\"true\">\n    <use :xlink:href=\"iconName\"></use>\n  </svg>\n</template>\n\n<script>\nexport default {\n  name: 'icon-svg',\n  props: {\n    iconClass: {\n      type: String,\n      required: true\n    }\n  },\n  computed: {\n    iconName () {\n      return `sprite.svg#icon-${this.iconClass}`\n    }\n  }\n}\n</script>\n\n<style>\n.svg-icon {\n  width: 1em;    //能继承font-size的大小\n  height: 1em;\n  vertical-align: -0.15em;\n  fill: currentColor;   //可以接受外部color，改变svg内部currentColor的路径\n  overflow: hidden;\n}\n</style>\n```\n组件可以实现和iconfont一样的通过font-size，color修改图标的大小和颜色，使用方法也更加友好，只需`<icon-svg icon-class=\"wechat-for-signin\" />`,在icon-class传入svg名字即可。在页面中的node节点渲染如图：\n![svg](/images/svg_node.png)\n\n### svg vs iconfont\n\nicon-svg     | iconfont\n-------- | -----\n多种色彩  | 单一色彩\n真正的矢量  | 字体文件\ncss控制大小，颜色，甚至局部颜色  | css控制大小，颜色\nwebpack实现  | 需要借助外部工具\nIE9+  | IE6\n\n### SVG待解决问题\n\n通过symbol+use的方式引入svg，当`<use xlink:href=\"\">`引用的是外部资源时在vue的template里v-if渲染会有问题。\b尤大大解释说这是chrome的bug。\n[https://github.com/vuejs/vue/issues/2661](https://github.com/vuejs/vue/issues/2661)\n[https://github.com/vuejs/vue/issues/2782](https://github.com/vuejs/vue/issues/2782)\n\nissue提出\b已经两年了，\b有没有官方的解决方案还需继续调研。目前的workaround有一下三种：\n- 将v-if改为v-show\n- 不提取sprint.svg,内联引用\b，\n- 将sprint.svg通过webpack达成chunk包,通过js引用sprint.svg。\n\n### 总结\n\n项目中4k-8k的小图片没有以iconfont方式引入的方式，原因不管是\b“多色”，“图片格式限制”。引入icon-svg后，随着设计师更新icon，我们希望尽量将图切成svg，一并合到sprite.svg中，svg文件经过gzip的压缩，会达到减少请求，增加传输的效率的目的。\n\n*参考链接*\n\nhttps://css-tricks.com/svg-symbol-good-choice-icons/\nhttps://github.com/PanJiaChen/vue-element-admin","slug":"SVG-Sprite优化滴滴云项目中的图标","published":1,"updated":"2018-11-23T04:09:25.451Z","layout":"post","photos":[],"link":"","_id":"ckrix8zdo000hk1jf0ej3hhdh","content":"<h3 id=\"背景介绍\"><a href=\"#背景介绍\" class=\"headerlink\" title=\"背景介绍\"></a>背景介绍</h3><p>滴滴云用户系统随着\b模块，功能，页面的增多，小图标也越来越多，随着开发人员的不断加入\b以及图片需求的\b不断更新，项目中图片的引用方法也变得多种多样。本次调研旨在整理项目中的图标，网站加载\b速率，统一开发人员\b引用图片的用法。</p>\n<h3 id=\"项目现状\"><a href=\"#项目现状\" class=\"headerlink\" title=\"项目\b现状\"></a>项目\b现状</h3><p>项目中图片的使用方式有以下三种</p>\n<ol>\n<li>iconfont，单色小图片。</li>\n<li>inline直接引用图片。</li>\n<li>inline直接引用，图片小于2k，\b转为base64。</li>\n</ol>\n<p>第2项中大图片直接引用无可否非，\b但目前项目中有70-80多个4k-8k的小图片也是直接引用到项目里，这次调研主要针对小图片进行合并，减少请求数，优化网站的响应速度。</p>\n<h3 id=\"CSS-SPRITE\"><a href=\"#CSS-SPRITE\" class=\"headerlink\" title=\"CSS \bSPRITE\"></a>CSS \bSPRITE</h3><p>CSS Sprite是传统的优化图片的方法，基本原理也很简单，把小图标按照\b一定顺序合并在一个大图上，使用时需按background-image方式引入，辅以background-position来控制需要显示图片的位置。</p>\n<p>\bwebpack-spritesmith组件可以实现合并小图片，并生成相对于的css样式，在原来使用的标签上\b添加对应的class类名即可。但是此方法针对项目中通过<code>&lt;img src=&quot;imgages/demo.png /&gt;</code>标签内联引用图片的方式改动较大，需将img标签转换为background显示，\b\b可读性减弱，改动\beffort较大，样式\b出错的\b机会及测试的成本都很大，顾放弃此方法。</p>\n<h3 id=\"SVG-SPRITE\"><a href=\"#SVG-SPRITE\" class=\"headerlink\" title=\"SVG \bSPRITE\"></a>SVG \bSPRITE</h3><p>SVG 是一种基于 XML 语法的图像格式，全称是可缩放矢量图（Scalable Vector Graphics）。其他图像格式都是基于像素处理的，SVG 则是属于对图像的形状描述，所以它本质上是文本文件，体积较小，且不管放大多少倍都不会失真。</p>\n<p>SVG可以直接\b放在HTML，CSS里\b使用。SVG Sprite是依赖其symbol标签和use标签实现其合并的效果。合并完以后的\bsvg大概如下图<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;</span><br><span class=\"line\">    &lt;symbol id=&quot;shape&quot;&gt;</span><br><span class=\"line\">        &lt;!-- 第1个图标路径形状之类代码 --&gt;</span><br><span class=\"line\">    &lt;/symbol&gt;</span><br><span class=\"line\">    &lt;symbol&gt;</span><br><span class=\"line\">        &lt;!-- 第2个图标路径形状之类代码 --&gt;</span><br><span class=\"line\">    &lt;/symbol&gt;</span><br><span class=\"line\">    &lt;symbol&gt;</span><br><span class=\"line\">        &lt;!-- 第3个图标路径形状之类代码 --&gt;</span><br><span class=\"line\">    &lt;/symbol&gt;</span><br><span class=\"line\">&lt;/svg&gt;</span><br></pre></td></tr></table></figure></p>\n<p>use的语法如下<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;</span><br><span class=\"line\">  &lt;use xlink:href=&quot;#shape&quot; x=&quot;200&quot; y=&quot;50&quot; /&gt;</span><br><span class=\"line\">&lt;/svg&gt;</span><br></pre></td></tr></table></figure></p>\n<p>我们\b期望的效果是把所有svg都通过symbol合并到一个大的svg sprite，而手动维护显然是不现实的，所以我们需要<a href=\"https://github.com/kisenka/svg-sprite-loader\" target=\"_blank\" rel=\"noopener\">svg-sprite-loader</a>，他可以根据config来自动合并所有的svg，形成\b一个大的svg sprite。需在webpack中添加的配置如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    test: /\\.svg$/,</span><br><span class=\"line\">    loader: &apos;svg-sprite-loader&apos;,</span><br><span class=\"line\">    include: [resolve(&apos;src/assets/images/svg&apos;)], //只合并固定目录</span><br><span class=\"line\">    options: &#123;</span><br><span class=\"line\">        extract: true, // 将合并后的svg提取为一个单独文件，默认false，会将svg\b解析后以内联方式打包到模板里</span><br><span class=\"line\">        spriteFilename: utils.assetsPath(&apos;img/sprite.svg&apos;),</span><br><span class=\"line\">        symbolId: &apos;icon-[name]&apos;, //symbol id的rename规则</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;,</span><br><span class=\"line\">// 主动调用webpack 方法，\b循环遍历\bsvg目标文件夹下所有svg格式文件。</span><br><span class=\"line\">const req = require.context(&apos;assets/images/svg&apos;, false, /\\.svg$/)</span><br><span class=\"line\">const requireAll = requireContext =&gt; requireContext.keys().map(requireContext)</span><br><span class=\"line\">requireAll(req)</span><br></pre></td></tr></table></figure></p>\n<p>至此，项目中就可以以<code>&lt;svg&gt;&lt;use xlink:href=&quot;#shape&quot;/&gt;&lt;/svg&gt;</code>\b方式来用svg展示icon。进一步可以封装为vue组件以方便使用。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;template&gt;</span><br><span class=\"line\">  &lt;svg class=&quot;svg-icon&quot; aria-hidden=&quot;true&quot;&gt;</span><br><span class=\"line\">    &lt;use :xlink:href=&quot;iconName&quot;&gt;&lt;/use&gt;</span><br><span class=\"line\">  &lt;/svg&gt;</span><br><span class=\"line\">&lt;/template&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">export default &#123;</span><br><span class=\"line\">  name: &apos;icon-svg&apos;,</span><br><span class=\"line\">  props: &#123;</span><br><span class=\"line\">    iconClass: &#123;</span><br><span class=\"line\">      type: String,</span><br><span class=\"line\">      required: true</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  computed: &#123;</span><br><span class=\"line\">    iconName () &#123;</span><br><span class=\"line\">      return `sprite.svg#icon-$&#123;this.iconClass&#125;`</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;style&gt;</span><br><span class=\"line\">.svg-icon &#123;</span><br><span class=\"line\">  width: 1em;    //能继承font-size的大小</span><br><span class=\"line\">  height: 1em;</span><br><span class=\"line\">  vertical-align: -0.15em;</span><br><span class=\"line\">  fill: currentColor;   //可以接受外部color，改变svg内部currentColor的路径</span><br><span class=\"line\">  overflow: hidden;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&lt;/style&gt;</span><br></pre></td></tr></table></figure></p>\n<p>组件可以实现和iconfont一样的通过font-size，color修改图标的大小和颜色，使用方法也更加友好，只需<code>&lt;icon-svg icon-class=&quot;wechat-for-signin&quot; /&gt;</code>,在icon-class传入svg名字即可。在页面中的node节点渲染如图：<br><img src=\"/images/svg_node.png\" alt=\"svg\"></p>\n<h3 id=\"svg-vs-iconfont\"><a href=\"#svg-vs-iconfont\" class=\"headerlink\" title=\"svg vs iconfont\"></a>svg vs iconfont</h3><table>\n<thead>\n<tr>\n<th>icon-svg</th>\n<th>iconfont</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>多种色彩</td>\n<td>单一色彩</td>\n</tr>\n<tr>\n<td>真正的矢量</td>\n<td>字体文件</td>\n</tr>\n<tr>\n<td>css控制大小，颜色，甚至局部颜色</td>\n<td>css控制大小，颜色</td>\n</tr>\n<tr>\n<td>webpack实现</td>\n<td>需要借助外部工具</td>\n</tr>\n<tr>\n<td>IE9+</td>\n<td>IE6</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"SVG待解决问题\"><a href=\"#SVG待解决问题\" class=\"headerlink\" title=\"SVG待解决问题\"></a>SVG待解决问题</h3><p>通过symbol+use的方式引入svg，当<code>&lt;use xlink:href=&quot;&quot;&gt;</code>引用的是外部资源时在vue的template里v-if渲染会有问题。\b尤大大解释说这是chrome的bug。<br><a href=\"https://github.com/vuejs/vue/issues/2661\" target=\"_blank\" rel=\"noopener\">https://github.com/vuejs/vue/issues/2661</a><br><a href=\"https://github.com/vuejs/vue/issues/2782\" target=\"_blank\" rel=\"noopener\">https://github.com/vuejs/vue/issues/2782</a></p>\n<p>issue提出\b已经两年了，\b有没有官方的解决方案还需继续调研。目前的workaround有一下三种：</p>\n<ul>\n<li>将v-if改为v-show</li>\n<li>不提取sprint.svg,内联引用\b，</li>\n<li>将sprint.svg通过webpack达成chunk包,通过js引用sprint.svg。</li>\n</ul>\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>项目中4k-8k的小图片没有以iconfont方式引入的方式，原因不管是\b“多色”，“图片格式限制”。引入icon-svg后，随着设计师更新icon，我们希望尽量将图切成svg，一并合到sprite.svg中，svg文件经过gzip的压缩，会达到减少请求，增加传输的效率的目的。</p>\n<p><em>参考链接</em></p>\n<p><a href=\"https://css-tricks.com/svg-symbol-good-choice-icons/\" target=\"_blank\" rel=\"noopener\">https://css-tricks.com/svg-symbol-good-choice-icons/</a><br><a href=\"https://github.com/PanJiaChen/vue-element-admin\" target=\"_blank\" rel=\"noopener\">https://github.com/PanJiaChen/vue-element-admin</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"背景介绍\"><a href=\"#背景介绍\" class=\"headerlink\" title=\"背景介绍\"></a>背景介绍</h3><p>滴滴云用户系统随着\b模块，功能，页面的增多，小图标也越来越多，随着开发人员的不断加入\b以及图片需求的\b不断更新，项目中图片的引用方法也变得多种多样。本次调研旨在整理项目中的图标，网站加载\b速率，统一开发人员\b引用图片的用法。</p>\n<h3 id=\"项目现状\"><a href=\"#项目现状\" class=\"headerlink\" title=\"项目\b现状\"></a>项目\b现状</h3><p>项目中图片的使用方式有以下三种</p>\n<ol>\n<li>iconfont，单色小图片。</li>\n<li>inline直接引用图片。</li>\n<li>inline直接引用，图片小于2k，\b转为base64。</li>\n</ol>\n<p>第2项中大图片直接引用无可否非，\b但目前项目中有70-80多个4k-8k的小图片也是直接引用到项目里，这次调研主要针对小图片进行合并，减少请求数，优化网站的响应速度。</p>\n<h3 id=\"CSS-SPRITE\"><a href=\"#CSS-SPRITE\" class=\"headerlink\" title=\"CSS \bSPRITE\"></a>CSS \bSPRITE</h3><p>CSS Sprite是传统的优化图片的方法，基本原理也很简单，把小图标按照\b一定顺序合并在一个大图上，使用时需按background-image方式引入，辅以background-position来控制需要显示图片的位置。</p>\n<p>\bwebpack-spritesmith组件可以实现合并小图片，并生成相对于的css样式，在原来使用的标签上\b添加对应的class类名即可。但是此方法针对项目中通过<code>&lt;img src=&quot;imgages/demo.png /&gt;</code>标签内联引用图片的方式改动较大，需将img标签转换为background显示，\b\b可读性减弱，改动\beffort较大，样式\b出错的\b机会及测试的成本都很大，顾放弃此方法。</p>\n<h3 id=\"SVG-SPRITE\"><a href=\"#SVG-SPRITE\" class=\"headerlink\" title=\"SVG \bSPRITE\"></a>SVG \bSPRITE</h3><p>SVG 是一种基于 XML 语法的图像格式，全称是可缩放矢量图（Scalable Vector Graphics）。其他图像格式都是基于像素处理的，SVG 则是属于对图像的形状描述，所以它本质上是文本文件，体积较小，且不管放大多少倍都不会失真。</p>\n<p>SVG可以直接\b放在HTML，CSS里\b使用。SVG Sprite是依赖其symbol标签和use标签实现其合并的效果。合并完以后的\bsvg大概如下图<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;</span><br><span class=\"line\">    &lt;symbol id=&quot;shape&quot;&gt;</span><br><span class=\"line\">        &lt;!-- 第1个图标路径形状之类代码 --&gt;</span><br><span class=\"line\">    &lt;/symbol&gt;</span><br><span class=\"line\">    &lt;symbol&gt;</span><br><span class=\"line\">        &lt;!-- 第2个图标路径形状之类代码 --&gt;</span><br><span class=\"line\">    &lt;/symbol&gt;</span><br><span class=\"line\">    &lt;symbol&gt;</span><br><span class=\"line\">        &lt;!-- 第3个图标路径形状之类代码 --&gt;</span><br><span class=\"line\">    &lt;/symbol&gt;</span><br><span class=\"line\">&lt;/svg&gt;</span><br></pre></td></tr></table></figure></p>\n<p>use的语法如下<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;</span><br><span class=\"line\">  &lt;use xlink:href=&quot;#shape&quot; x=&quot;200&quot; y=&quot;50&quot; /&gt;</span><br><span class=\"line\">&lt;/svg&gt;</span><br></pre></td></tr></table></figure></p>\n<p>我们\b期望的效果是把所有svg都通过symbol合并到一个大的svg sprite，而手动维护显然是不现实的，所以我们需要<a href=\"https://github.com/kisenka/svg-sprite-loader\" target=\"_blank\" rel=\"noopener\">svg-sprite-loader</a>，他可以根据config来自动合并所有的svg，形成\b一个大的svg sprite。需在webpack中添加的配置如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    test: /\\.svg$/,</span><br><span class=\"line\">    loader: &apos;svg-sprite-loader&apos;,</span><br><span class=\"line\">    include: [resolve(&apos;src/assets/images/svg&apos;)], //只合并固定目录</span><br><span class=\"line\">    options: &#123;</span><br><span class=\"line\">        extract: true, // 将合并后的svg提取为一个单独文件，默认false，会将svg\b解析后以内联方式打包到模板里</span><br><span class=\"line\">        spriteFilename: utils.assetsPath(&apos;img/sprite.svg&apos;),</span><br><span class=\"line\">        symbolId: &apos;icon-[name]&apos;, //symbol id的rename规则</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;,</span><br><span class=\"line\">// 主动调用webpack 方法，\b循环遍历\bsvg目标文件夹下所有svg格式文件。</span><br><span class=\"line\">const req = require.context(&apos;assets/images/svg&apos;, false, /\\.svg$/)</span><br><span class=\"line\">const requireAll = requireContext =&gt; requireContext.keys().map(requireContext)</span><br><span class=\"line\">requireAll(req)</span><br></pre></td></tr></table></figure></p>\n<p>至此，项目中就可以以<code>&lt;svg&gt;&lt;use xlink:href=&quot;#shape&quot;/&gt;&lt;/svg&gt;</code>\b方式来用svg展示icon。进一步可以封装为vue组件以方便使用。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;template&gt;</span><br><span class=\"line\">  &lt;svg class=&quot;svg-icon&quot; aria-hidden=&quot;true&quot;&gt;</span><br><span class=\"line\">    &lt;use :xlink:href=&quot;iconName&quot;&gt;&lt;/use&gt;</span><br><span class=\"line\">  &lt;/svg&gt;</span><br><span class=\"line\">&lt;/template&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">export default &#123;</span><br><span class=\"line\">  name: &apos;icon-svg&apos;,</span><br><span class=\"line\">  props: &#123;</span><br><span class=\"line\">    iconClass: &#123;</span><br><span class=\"line\">      type: String,</span><br><span class=\"line\">      required: true</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  computed: &#123;</span><br><span class=\"line\">    iconName () &#123;</span><br><span class=\"line\">      return `sprite.svg#icon-$&#123;this.iconClass&#125;`</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;style&gt;</span><br><span class=\"line\">.svg-icon &#123;</span><br><span class=\"line\">  width: 1em;    //能继承font-size的大小</span><br><span class=\"line\">  height: 1em;</span><br><span class=\"line\">  vertical-align: -0.15em;</span><br><span class=\"line\">  fill: currentColor;   //可以接受外部color，改变svg内部currentColor的路径</span><br><span class=\"line\">  overflow: hidden;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&lt;/style&gt;</span><br></pre></td></tr></table></figure></p>\n<p>组件可以实现和iconfont一样的通过font-size，color修改图标的大小和颜色，使用方法也更加友好，只需<code>&lt;icon-svg icon-class=&quot;wechat-for-signin&quot; /&gt;</code>,在icon-class传入svg名字即可。在页面中的node节点渲染如图：<br><img src=\"/images/svg_node.png\" alt=\"svg\"></p>\n<h3 id=\"svg-vs-iconfont\"><a href=\"#svg-vs-iconfont\" class=\"headerlink\" title=\"svg vs iconfont\"></a>svg vs iconfont</h3><table>\n<thead>\n<tr>\n<th>icon-svg</th>\n<th>iconfont</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>多种色彩</td>\n<td>单一色彩</td>\n</tr>\n<tr>\n<td>真正的矢量</td>\n<td>字体文件</td>\n</tr>\n<tr>\n<td>css控制大小，颜色，甚至局部颜色</td>\n<td>css控制大小，颜色</td>\n</tr>\n<tr>\n<td>webpack实现</td>\n<td>需要借助外部工具</td>\n</tr>\n<tr>\n<td>IE9+</td>\n<td>IE6</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"SVG待解决问题\"><a href=\"#SVG待解决问题\" class=\"headerlink\" title=\"SVG待解决问题\"></a>SVG待解决问题</h3><p>通过symbol+use的方式引入svg，当<code>&lt;use xlink:href=&quot;&quot;&gt;</code>引用的是外部资源时在vue的template里v-if渲染会有问题。\b尤大大解释说这是chrome的bug。<br><a href=\"https://github.com/vuejs/vue/issues/2661\" target=\"_blank\" rel=\"noopener\">https://github.com/vuejs/vue/issues/2661</a><br><a href=\"https://github.com/vuejs/vue/issues/2782\" target=\"_blank\" rel=\"noopener\">https://github.com/vuejs/vue/issues/2782</a></p>\n<p>issue提出\b已经两年了，\b有没有官方的解决方案还需继续调研。目前的workaround有一下三种：</p>\n<ul>\n<li>将v-if改为v-show</li>\n<li>不提取sprint.svg,内联引用\b，</li>\n<li>将sprint.svg通过webpack达成chunk包,通过js引用sprint.svg。</li>\n</ul>\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>项目中4k-8k的小图片没有以iconfont方式引入的方式，原因不管是\b“多色”，“图片格式限制”。引入icon-svg后，随着设计师更新icon，我们希望尽量将图切成svg，一并合到sprite.svg中，svg文件经过gzip的压缩，会达到减少请求，增加传输的效率的目的。</p>\n<p><em>参考链接</em></p>\n<p><a href=\"https://css-tricks.com/svg-symbol-good-choice-icons/\" target=\"_blank\" rel=\"noopener\">https://css-tricks.com/svg-symbol-good-choice-icons/</a><br><a href=\"https://github.com/PanJiaChen/vue-element-admin\" target=\"_blank\" rel=\"noopener\">https://github.com/PanJiaChen/vue-element-admin</a></p>\n"},{"title":"JavaScript策略模式浅析","date":"2020-06-04T06:26:22.000Z","_content":"\n策略模式封装了针对 **特定任务** 的可选策略。在客户端（使用方）无感的前提下，它允许一个方法在运行时 **切换** 成任何其他策略。本质上，策略是一组可互换的算法。\n\n## 例1. 算法效率\n\n假设要测试不同排序算法的性能，包括希尔排序，堆排序，冒泡排序，快速排序等。应用策略模式，可以将测试代码循环所有的算法。我们可以在运行时更改数组中的每一个算法。为了使策略模式生效，所有的算法参数必须相同，这使得算法可以变换，而对测试程序无感。\n\n测试算法效率是Context，不同的算法是不同的Strategy。算法可以测试人的需求来变更。\n\n## 例2. 快递计费\n\n在本例中，我们有一个产品订单，需要从仓库发货给客户。对不同的快递公司进行评估，以确定最优价格。这对于购物车非常有用，在购物车中，客户可以选择自己的运输偏好，所选择的策略返回估算的成本。\n\n运输是Context，三家快递公司顺丰，EMS, 和圆通是Strategy。货运(策略)改变了3次，每次我们计算快递成本。在真实的场景中，计算方法可能调用快递公司的Web服务。最后我们显示了不同的成本。\n\n## 策略模式组成\n\n## 1. Context ##\n在例2中，寄快递这件事是Context，他有三个特性：\n1. 可以获取当前策略的引用（比如出发地信息，目的地信息，包裹重量等等）\n1. 根据不同策略计算不同价格\n1. 允许用户选择不同的快递公司 \n\n## 2. Strategy ##\n实现算法的接口\n\n## 策略模式流程图\n![pattern](/images/strategy_pattern.jpg)\n\n## show me your code\n\n```\nvar Shipping = function() {\n    this.company = \"\";\n};\n \nShipping.prototype = {\n    setStrategy: function(company) {\n        this.company = company;\n    },\n \n    calculate: function(package) {\n        return this.company.calculate(package);\n    }\n};\n \nvar UPS = function() {\n    this.calculate = function(package) {\n        // calculations...\n        return \"$45.95\";\n    }\n};\n \nvar USPS = function() {\n    this.calculate = function(package) {\n        // calculations...\n        return \"$39.40\";\n    }\n};\n \nvar Fedex = function() {\n    this.calculate = function(package) {\n        // calculations...\n        return \"$43.20\";\n    }\n};\n \n// log helper\n \nvar log = (function() {\n    var log = \"\";\n \n    return {\n        add: function(msg) { log += msg + \"\\n\"; },\n        show: function() { alert(log); log = \"\"; }\n    }\n})();\n \nfunction run() {\n    var package = { from: \"76712\", to: \"10012\", weigth: \"lkg\" };\n \n    // the 3 strategies\n \n    var ups = new UPS();\n    var usps = new USPS();\n    var fedex = new Fedex();\n \n    var shipping = new Shipping();\n \n    shipping.setStrategy(ups);\n    log.add(\"UPS Strategy: \" + shipping.calculate(package));\n    shipping.setStrategy(usps);\n    log.add(\"USPS Strategy: \" + shipping.calculate(package));\n    shipping.setStrategy(fedex);\n    log.add(\"Fedex Strategy: \" + shipping.calculate(package));\n \n    log.show();\n}\n```\n\n## links:\nhttps://www.dofactory.com/javascript/strategy-design-pattern\nhttps://refactoringguru.cn/design-patterns/state","source":"_posts/JavaScript策略模式浅析.md","raw":"---\ntitle: JavaScript策略模式浅析\ndate: 2020-06-04 14:26:22\ntags:\n---\n\n策略模式封装了针对 **特定任务** 的可选策略。在客户端（使用方）无感的前提下，它允许一个方法在运行时 **切换** 成任何其他策略。本质上，策略是一组可互换的算法。\n\n## 例1. 算法效率\n\n假设要测试不同排序算法的性能，包括希尔排序，堆排序，冒泡排序，快速排序等。应用策略模式，可以将测试代码循环所有的算法。我们可以在运行时更改数组中的每一个算法。为了使策略模式生效，所有的算法参数必须相同，这使得算法可以变换，而对测试程序无感。\n\n测试算法效率是Context，不同的算法是不同的Strategy。算法可以测试人的需求来变更。\n\n## 例2. 快递计费\n\n在本例中，我们有一个产品订单，需要从仓库发货给客户。对不同的快递公司进行评估，以确定最优价格。这对于购物车非常有用，在购物车中，客户可以选择自己的运输偏好，所选择的策略返回估算的成本。\n\n运输是Context，三家快递公司顺丰，EMS, 和圆通是Strategy。货运(策略)改变了3次，每次我们计算快递成本。在真实的场景中，计算方法可能调用快递公司的Web服务。最后我们显示了不同的成本。\n\n## 策略模式组成\n\n## 1. Context ##\n在例2中，寄快递这件事是Context，他有三个特性：\n1. 可以获取当前策略的引用（比如出发地信息，目的地信息，包裹重量等等）\n1. 根据不同策略计算不同价格\n1. 允许用户选择不同的快递公司 \n\n## 2. Strategy ##\n实现算法的接口\n\n## 策略模式流程图\n![pattern](/images/strategy_pattern.jpg)\n\n## show me your code\n\n```\nvar Shipping = function() {\n    this.company = \"\";\n};\n \nShipping.prototype = {\n    setStrategy: function(company) {\n        this.company = company;\n    },\n \n    calculate: function(package) {\n        return this.company.calculate(package);\n    }\n};\n \nvar UPS = function() {\n    this.calculate = function(package) {\n        // calculations...\n        return \"$45.95\";\n    }\n};\n \nvar USPS = function() {\n    this.calculate = function(package) {\n        // calculations...\n        return \"$39.40\";\n    }\n};\n \nvar Fedex = function() {\n    this.calculate = function(package) {\n        // calculations...\n        return \"$43.20\";\n    }\n};\n \n// log helper\n \nvar log = (function() {\n    var log = \"\";\n \n    return {\n        add: function(msg) { log += msg + \"\\n\"; },\n        show: function() { alert(log); log = \"\"; }\n    }\n})();\n \nfunction run() {\n    var package = { from: \"76712\", to: \"10012\", weigth: \"lkg\" };\n \n    // the 3 strategies\n \n    var ups = new UPS();\n    var usps = new USPS();\n    var fedex = new Fedex();\n \n    var shipping = new Shipping();\n \n    shipping.setStrategy(ups);\n    log.add(\"UPS Strategy: \" + shipping.calculate(package));\n    shipping.setStrategy(usps);\n    log.add(\"USPS Strategy: \" + shipping.calculate(package));\n    shipping.setStrategy(fedex);\n    log.add(\"Fedex Strategy: \" + shipping.calculate(package));\n \n    log.show();\n}\n```\n\n## links:\nhttps://www.dofactory.com/javascript/strategy-design-pattern\nhttps://refactoringguru.cn/design-patterns/state","slug":"JavaScript策略模式浅析","published":1,"updated":"2020-06-04T11:19:42.127Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckrix8zdp000jk1jfqazz3ue5","content":"<p>策略模式封装了针对 <strong>特定任务</strong> 的可选策略。在客户端（使用方）无感的前提下，它允许一个方法在运行时 <strong>切换</strong> 成任何其他策略。本质上，策略是一组可互换的算法。</p>\n<h2 id=\"例1-算法效率\"><a href=\"#例1-算法效率\" class=\"headerlink\" title=\"例1. 算法效率\"></a>例1. 算法效率</h2><p>假设要测试不同排序算法的性能，包括希尔排序，堆排序，冒泡排序，快速排序等。应用策略模式，可以将测试代码循环所有的算法。我们可以在运行时更改数组中的每一个算法。为了使策略模式生效，所有的算法参数必须相同，这使得算法可以变换，而对测试程序无感。</p>\n<p>测试算法效率是Context，不同的算法是不同的Strategy。算法可以测试人的需求来变更。</p>\n<h2 id=\"例2-快递计费\"><a href=\"#例2-快递计费\" class=\"headerlink\" title=\"例2. 快递计费\"></a>例2. 快递计费</h2><p>在本例中，我们有一个产品订单，需要从仓库发货给客户。对不同的快递公司进行评估，以确定最优价格。这对于购物车非常有用，在购物车中，客户可以选择自己的运输偏好，所选择的策略返回估算的成本。</p>\n<p>运输是Context，三家快递公司顺丰，EMS, 和圆通是Strategy。货运(策略)改变了3次，每次我们计算快递成本。在真实的场景中，计算方法可能调用快递公司的Web服务。最后我们显示了不同的成本。</p>\n<h2 id=\"策略模式组成\"><a href=\"#策略模式组成\" class=\"headerlink\" title=\"策略模式组成\"></a>策略模式组成</h2><h2 id=\"1-Context\"><a href=\"#1-Context\" class=\"headerlink\" title=\"1. Context\"></a>1. Context</h2><p>在例2中，寄快递这件事是Context，他有三个特性：</p>\n<ol>\n<li>可以获取当前策略的引用（比如出发地信息，目的地信息，包裹重量等等）</li>\n<li>根据不同策略计算不同价格</li>\n<li>允许用户选择不同的快递公司 </li>\n</ol>\n<h2 id=\"2-Strategy\"><a href=\"#2-Strategy\" class=\"headerlink\" title=\"2. Strategy\"></a>2. Strategy</h2><p>实现算法的接口</p>\n<h2 id=\"策略模式流程图\"><a href=\"#策略模式流程图\" class=\"headerlink\" title=\"策略模式流程图\"></a>策略模式流程图</h2><p><img src=\"/images/strategy_pattern.jpg\" alt=\"pattern\"></p>\n<h2 id=\"show-me-your-code\"><a href=\"#show-me-your-code\" class=\"headerlink\" title=\"show me your code\"></a>show me your code</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var Shipping = function() &#123;</span><br><span class=\"line\">    this.company = &quot;&quot;;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"> </span><br><span class=\"line\">Shipping.prototype = &#123;</span><br><span class=\"line\">    setStrategy: function(company) &#123;</span><br><span class=\"line\">        this.company = company;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\"> </span><br><span class=\"line\">    calculate: function(package) &#123;</span><br><span class=\"line\">        return this.company.calculate(package);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"> </span><br><span class=\"line\">var UPS = function() &#123;</span><br><span class=\"line\">    this.calculate = function(package) &#123;</span><br><span class=\"line\">        // calculations...</span><br><span class=\"line\">        return &quot;$45.95&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"> </span><br><span class=\"line\">var USPS = function() &#123;</span><br><span class=\"line\">    this.calculate = function(package) &#123;</span><br><span class=\"line\">        // calculations...</span><br><span class=\"line\">        return &quot;$39.40&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"> </span><br><span class=\"line\">var Fedex = function() &#123;</span><br><span class=\"line\">    this.calculate = function(package) &#123;</span><br><span class=\"line\">        // calculations...</span><br><span class=\"line\">        return &quot;$43.20&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"> </span><br><span class=\"line\">// log helper</span><br><span class=\"line\"> </span><br><span class=\"line\">var log = (function() &#123;</span><br><span class=\"line\">    var log = &quot;&quot;;</span><br><span class=\"line\"> </span><br><span class=\"line\">    return &#123;</span><br><span class=\"line\">        add: function(msg) &#123; log += msg + &quot;\\n&quot;; &#125;,</span><br><span class=\"line\">        show: function() &#123; alert(log); log = &quot;&quot;; &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;)();</span><br><span class=\"line\"> </span><br><span class=\"line\">function run() &#123;</span><br><span class=\"line\">    var package = &#123; from: &quot;76712&quot;, to: &quot;10012&quot;, weigth: &quot;lkg&quot; &#125;;</span><br><span class=\"line\"> </span><br><span class=\"line\">    // the 3 strategies</span><br><span class=\"line\"> </span><br><span class=\"line\">    var ups = new UPS();</span><br><span class=\"line\">    var usps = new USPS();</span><br><span class=\"line\">    var fedex = new Fedex();</span><br><span class=\"line\"> </span><br><span class=\"line\">    var shipping = new Shipping();</span><br><span class=\"line\"> </span><br><span class=\"line\">    shipping.setStrategy(ups);</span><br><span class=\"line\">    log.add(&quot;UPS Strategy: &quot; + shipping.calculate(package));</span><br><span class=\"line\">    shipping.setStrategy(usps);</span><br><span class=\"line\">    log.add(&quot;USPS Strategy: &quot; + shipping.calculate(package));</span><br><span class=\"line\">    shipping.setStrategy(fedex);</span><br><span class=\"line\">    log.add(&quot;Fedex Strategy: &quot; + shipping.calculate(package));</span><br><span class=\"line\"> </span><br><span class=\"line\">    log.show();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"links\"><a href=\"#links\" class=\"headerlink\" title=\"links:\"></a>links:</h2><p><a href=\"https://www.dofactory.com/javascript/strategy-design-pattern\" target=\"_blank\" rel=\"noopener\">https://www.dofactory.com/javascript/strategy-design-pattern</a><br><a href=\"https://refactoringguru.cn/design-patterns/state\" target=\"_blank\" rel=\"noopener\">https://refactoringguru.cn/design-patterns/state</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>策略模式封装了针对 <strong>特定任务</strong> 的可选策略。在客户端（使用方）无感的前提下，它允许一个方法在运行时 <strong>切换</strong> 成任何其他策略。本质上，策略是一组可互换的算法。</p>\n<h2 id=\"例1-算法效率\"><a href=\"#例1-算法效率\" class=\"headerlink\" title=\"例1. 算法效率\"></a>例1. 算法效率</h2><p>假设要测试不同排序算法的性能，包括希尔排序，堆排序，冒泡排序，快速排序等。应用策略模式，可以将测试代码循环所有的算法。我们可以在运行时更改数组中的每一个算法。为了使策略模式生效，所有的算法参数必须相同，这使得算法可以变换，而对测试程序无感。</p>\n<p>测试算法效率是Context，不同的算法是不同的Strategy。算法可以测试人的需求来变更。</p>\n<h2 id=\"例2-快递计费\"><a href=\"#例2-快递计费\" class=\"headerlink\" title=\"例2. 快递计费\"></a>例2. 快递计费</h2><p>在本例中，我们有一个产品订单，需要从仓库发货给客户。对不同的快递公司进行评估，以确定最优价格。这对于购物车非常有用，在购物车中，客户可以选择自己的运输偏好，所选择的策略返回估算的成本。</p>\n<p>运输是Context，三家快递公司顺丰，EMS, 和圆通是Strategy。货运(策略)改变了3次，每次我们计算快递成本。在真实的场景中，计算方法可能调用快递公司的Web服务。最后我们显示了不同的成本。</p>\n<h2 id=\"策略模式组成\"><a href=\"#策略模式组成\" class=\"headerlink\" title=\"策略模式组成\"></a>策略模式组成</h2><h2 id=\"1-Context\"><a href=\"#1-Context\" class=\"headerlink\" title=\"1. Context\"></a>1. Context</h2><p>在例2中，寄快递这件事是Context，他有三个特性：</p>\n<ol>\n<li>可以获取当前策略的引用（比如出发地信息，目的地信息，包裹重量等等）</li>\n<li>根据不同策略计算不同价格</li>\n<li>允许用户选择不同的快递公司 </li>\n</ol>\n<h2 id=\"2-Strategy\"><a href=\"#2-Strategy\" class=\"headerlink\" title=\"2. Strategy\"></a>2. Strategy</h2><p>实现算法的接口</p>\n<h2 id=\"策略模式流程图\"><a href=\"#策略模式流程图\" class=\"headerlink\" title=\"策略模式流程图\"></a>策略模式流程图</h2><p><img src=\"/images/strategy_pattern.jpg\" alt=\"pattern\"></p>\n<h2 id=\"show-me-your-code\"><a href=\"#show-me-your-code\" class=\"headerlink\" title=\"show me your code\"></a>show me your code</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var Shipping = function() &#123;</span><br><span class=\"line\">    this.company = &quot;&quot;;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"> </span><br><span class=\"line\">Shipping.prototype = &#123;</span><br><span class=\"line\">    setStrategy: function(company) &#123;</span><br><span class=\"line\">        this.company = company;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\"> </span><br><span class=\"line\">    calculate: function(package) &#123;</span><br><span class=\"line\">        return this.company.calculate(package);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"> </span><br><span class=\"line\">var UPS = function() &#123;</span><br><span class=\"line\">    this.calculate = function(package) &#123;</span><br><span class=\"line\">        // calculations...</span><br><span class=\"line\">        return &quot;$45.95&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"> </span><br><span class=\"line\">var USPS = function() &#123;</span><br><span class=\"line\">    this.calculate = function(package) &#123;</span><br><span class=\"line\">        // calculations...</span><br><span class=\"line\">        return &quot;$39.40&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"> </span><br><span class=\"line\">var Fedex = function() &#123;</span><br><span class=\"line\">    this.calculate = function(package) &#123;</span><br><span class=\"line\">        // calculations...</span><br><span class=\"line\">        return &quot;$43.20&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"> </span><br><span class=\"line\">// log helper</span><br><span class=\"line\"> </span><br><span class=\"line\">var log = (function() &#123;</span><br><span class=\"line\">    var log = &quot;&quot;;</span><br><span class=\"line\"> </span><br><span class=\"line\">    return &#123;</span><br><span class=\"line\">        add: function(msg) &#123; log += msg + &quot;\\n&quot;; &#125;,</span><br><span class=\"line\">        show: function() &#123; alert(log); log = &quot;&quot;; &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;)();</span><br><span class=\"line\"> </span><br><span class=\"line\">function run() &#123;</span><br><span class=\"line\">    var package = &#123; from: &quot;76712&quot;, to: &quot;10012&quot;, weigth: &quot;lkg&quot; &#125;;</span><br><span class=\"line\"> </span><br><span class=\"line\">    // the 3 strategies</span><br><span class=\"line\"> </span><br><span class=\"line\">    var ups = new UPS();</span><br><span class=\"line\">    var usps = new USPS();</span><br><span class=\"line\">    var fedex = new Fedex();</span><br><span class=\"line\"> </span><br><span class=\"line\">    var shipping = new Shipping();</span><br><span class=\"line\"> </span><br><span class=\"line\">    shipping.setStrategy(ups);</span><br><span class=\"line\">    log.add(&quot;UPS Strategy: &quot; + shipping.calculate(package));</span><br><span class=\"line\">    shipping.setStrategy(usps);</span><br><span class=\"line\">    log.add(&quot;USPS Strategy: &quot; + shipping.calculate(package));</span><br><span class=\"line\">    shipping.setStrategy(fedex);</span><br><span class=\"line\">    log.add(&quot;Fedex Strategy: &quot; + shipping.calculate(package));</span><br><span class=\"line\"> </span><br><span class=\"line\">    log.show();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"links\"><a href=\"#links\" class=\"headerlink\" title=\"links:\"></a>links:</h2><p><a href=\"https://www.dofactory.com/javascript/strategy-design-pattern\" target=\"_blank\" rel=\"noopener\">https://www.dofactory.com/javascript/strategy-design-pattern</a><br><a href=\"https://refactoringguru.cn/design-patterns/state\" target=\"_blank\" rel=\"noopener\">https://refactoringguru.cn/design-patterns/state</a></p>\n"},{"title":"angular-splitter","date":"2018-11-09T04:15:55.000Z","comments":1,"_content":"> this is a angular splitter that could drag the responsive layout, and also act like the layout of notes on mac.\n\n![drawing](/images/splitter.gif)\n![drawing](/images/macnotes.gif)\n\n## Online \n\n[https://guguji5.github.io/angular-splitter-demo](https://guguji5.github.io/angular-splitter-demo)\n\n## How to run\n```\ngit clone https://github.com/guguji5/angular-splitter.git\ncd angular-splitter\nnpm install\nng serve --open\n```\nof course you must have angular-cli installed.\n\n## Angular Support\n\nangular 5~6\n\n## Document\n\n**Component `<tam-splitter>`**\n\n@Input    | Type|Default|Details\n-------- | ---|---|---\ndirection | string|\"horizontal\"|Select split direction: \"horizontal\" or \"vertical\".\nsplitterBarWidth    | number|8|Gutters's size (dragging elements) in pixels.\nuseTransition| boolean or number| false|Use transition when collapsing or expanding. when this param is a number, it will be a millisecond value set to the property 'transition-duration', should be between 100 and 1000\ntype | string| 'standard' | it has two value(standard, macNotes), which controls the behavior of the drag, macNotes type will act like the notes on mac\n\n@Output|Param|Details\n-------- | ---|---\nsizeChange|{barNum: number, sizes: Array`<number>`}|Emit when draging, return the index of bar and the sizes of panels\n\n**Component `<tam-splitter-panel>`**\n\n@Input    | Type|Default|Details\n-------- | ---|---|---\nsize | number|null|Size of the panel in percent (value between 0 and 100).all panels sizes should be equal to 100\nmax|number|null|Max size of the panel in percent (value between 0 and 100).\nmin|number|null|Min size of the panel in percent (value between 0 and 100).\nvisible|boolean|true|Allow to toggle panel visibility\n\n@Output|Param|Details\n-------- | ---|---\ncollapsedChange|{collapsed:boolean, sizes:  Array`<number>`, collapsedComponentSize: number}|Emit when collapsed or expand, return the collapsed, the sizes of panels and the size of collapsed panel\n\nsimple demo:\n```\n<tam-splitter splitterBarWidth=3 [direction]=\"horizontal\" (sizeChange)=\"sizeChange($event)\">\n    <tam-splitter-panel [size]=\"20\" [max]=\"30\" [min]=\"10\"\n        [visible]=true (collapsedChange)=\"collapsedChange($event)\">\n        Refined By Panel\n    </tam-splitter-panel>\n    <tam-splitter-panel  [size]=\"30\" [max]=\"50\" [min]=\"20\">\n        Side List Panel\n    </tam-splitter-panel>\n    <tam-splitter-panel [size]=\"50\" [max]=\"70\" [min]=\"20\">\n        Preview Panel\n    </tam-splitter-panel>\n</tam-splitter>\n```\n\nnested demo:\n```\n<tam-splitter splitterBarWidth=3>\n    <tam-splitter-panel [size]=\"20\" [max]=\"30\" [min]=\"10\" (collapsedChange)=\"collapsedChange($event)\">\n        Refined By Panel\n    </tam-splitter-panel>\n    <tam-splitter-panel [size]=\"80\">\n        <tam-splitter splitterBarWidth=3 [direction]=\"'vertical'\">\n            <tam-splitter-panel [size]=\"30\" [max]=\"40\" [min]=\"20\">\n                Side List Panel\n            </tam-splitter-panel>\n\n            <tam-splitter-panel [size]=\"70\" [max]=\"80\" [min]=\"60\">\n                Preview Panel\n            </tam-splitter-panel>\n        </tam-splitter>\n    </tam-splitter-panel>\n</tam-splitter>\n```\n[中文README](https://blog.csdn.net/baidu_35407267/article/details/82527822)\n","source":"_posts/angular-splitter.md","raw":"---\ntitle: angular-splitter\ndate: 2018-11-09 12:15:55\ncategories: 组件\ntags: \n- angular\n- component\ncomments: true\n---\n> this is a angular splitter that could drag the responsive layout, and also act like the layout of notes on mac.\n\n![drawing](/images/splitter.gif)\n![drawing](/images/macnotes.gif)\n\n## Online \n\n[https://guguji5.github.io/angular-splitter-demo](https://guguji5.github.io/angular-splitter-demo)\n\n## How to run\n```\ngit clone https://github.com/guguji5/angular-splitter.git\ncd angular-splitter\nnpm install\nng serve --open\n```\nof course you must have angular-cli installed.\n\n## Angular Support\n\nangular 5~6\n\n## Document\n\n**Component `<tam-splitter>`**\n\n@Input    | Type|Default|Details\n-------- | ---|---|---\ndirection | string|\"horizontal\"|Select split direction: \"horizontal\" or \"vertical\".\nsplitterBarWidth    | number|8|Gutters's size (dragging elements) in pixels.\nuseTransition| boolean or number| false|Use transition when collapsing or expanding. when this param is a number, it will be a millisecond value set to the property 'transition-duration', should be between 100 and 1000\ntype | string| 'standard' | it has two value(standard, macNotes), which controls the behavior of the drag, macNotes type will act like the notes on mac\n\n@Output|Param|Details\n-------- | ---|---\nsizeChange|{barNum: number, sizes: Array`<number>`}|Emit when draging, return the index of bar and the sizes of panels\n\n**Component `<tam-splitter-panel>`**\n\n@Input    | Type|Default|Details\n-------- | ---|---|---\nsize | number|null|Size of the panel in percent (value between 0 and 100).all panels sizes should be equal to 100\nmax|number|null|Max size of the panel in percent (value between 0 and 100).\nmin|number|null|Min size of the panel in percent (value between 0 and 100).\nvisible|boolean|true|Allow to toggle panel visibility\n\n@Output|Param|Details\n-------- | ---|---\ncollapsedChange|{collapsed:boolean, sizes:  Array`<number>`, collapsedComponentSize: number}|Emit when collapsed or expand, return the collapsed, the sizes of panels and the size of collapsed panel\n\nsimple demo:\n```\n<tam-splitter splitterBarWidth=3 [direction]=\"horizontal\" (sizeChange)=\"sizeChange($event)\">\n    <tam-splitter-panel [size]=\"20\" [max]=\"30\" [min]=\"10\"\n        [visible]=true (collapsedChange)=\"collapsedChange($event)\">\n        Refined By Panel\n    </tam-splitter-panel>\n    <tam-splitter-panel  [size]=\"30\" [max]=\"50\" [min]=\"20\">\n        Side List Panel\n    </tam-splitter-panel>\n    <tam-splitter-panel [size]=\"50\" [max]=\"70\" [min]=\"20\">\n        Preview Panel\n    </tam-splitter-panel>\n</tam-splitter>\n```\n\nnested demo:\n```\n<tam-splitter splitterBarWidth=3>\n    <tam-splitter-panel [size]=\"20\" [max]=\"30\" [min]=\"10\" (collapsedChange)=\"collapsedChange($event)\">\n        Refined By Panel\n    </tam-splitter-panel>\n    <tam-splitter-panel [size]=\"80\">\n        <tam-splitter splitterBarWidth=3 [direction]=\"'vertical'\">\n            <tam-splitter-panel [size]=\"30\" [max]=\"40\" [min]=\"20\">\n                Side List Panel\n            </tam-splitter-panel>\n\n            <tam-splitter-panel [size]=\"70\" [max]=\"80\" [min]=\"60\">\n                Preview Panel\n            </tam-splitter-panel>\n        </tam-splitter>\n    </tam-splitter-panel>\n</tam-splitter>\n```\n[中文README](https://blog.csdn.net/baidu_35407267/article/details/82527822)\n","slug":"angular-splitter","published":1,"updated":"2020-02-20T02:33:28.949Z","layout":"post","photos":[],"link":"","_id":"ckrix8zdq000lk1jflmbr9xfd","content":"<blockquote>\n<p>this is a angular splitter that could drag the responsive layout, and also act like the layout of notes on mac.</p>\n</blockquote>\n<p><img src=\"/images/splitter.gif\" alt=\"drawing\"><br><img src=\"/images/macnotes.gif\" alt=\"drawing\"></p>\n<h2 id=\"Online\"><a href=\"#Online\" class=\"headerlink\" title=\"Online\"></a>Online</h2><p><a href=\"https://guguji5.github.io/angular-splitter-demo\">https://guguji5.github.io/angular-splitter-demo</a></p>\n<h2 id=\"How-to-run\"><a href=\"#How-to-run\" class=\"headerlink\" title=\"How to run\"></a>How to run</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git clone https://github.com/guguji5/angular-splitter.git</span><br><span class=\"line\">cd angular-splitter</span><br><span class=\"line\">npm install</span><br><span class=\"line\">ng serve --open</span><br></pre></td></tr></table></figure>\n<p>of course you must have angular-cli installed.</p>\n<h2 id=\"Angular-Support\"><a href=\"#Angular-Support\" class=\"headerlink\" title=\"Angular Support\"></a>Angular Support</h2><p>angular 5~6</p>\n<h2 id=\"Document\"><a href=\"#Document\" class=\"headerlink\" title=\"Document\"></a>Document</h2><p><strong>Component <code>&lt;tam-splitter&gt;</code></strong></p>\n<table>\n<thead>\n<tr>\n<th>@Input</th>\n<th>Type</th>\n<th>Default</th>\n<th>Details</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>direction</td>\n<td>string</td>\n<td>“horizontal”</td>\n<td>Select split direction: “horizontal” or “vertical”.</td>\n</tr>\n<tr>\n<td>splitterBarWidth</td>\n<td>number</td>\n<td>8</td>\n<td>Gutters’s size (dragging elements) in pixels.</td>\n</tr>\n<tr>\n<td>useTransition</td>\n<td>boolean or number</td>\n<td>false</td>\n<td>Use transition when collapsing or expanding. when this param is a number, it will be a millisecond value set to the property ‘transition-duration’, should be between 100 and 1000</td>\n</tr>\n<tr>\n<td>type</td>\n<td>string</td>\n<td>‘standard’</td>\n<td>it has two value(standard, macNotes), which controls the behavior of the drag, macNotes type will act like the notes on mac</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th>@Output</th>\n<th>Param</th>\n<th>Details</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>sizeChange</td>\n<td>{barNum: number, sizes: Array<code>&lt;number&gt;</code>}</td>\n<td>Emit when draging, return the index of bar and the sizes of panels</td>\n</tr>\n</tbody>\n</table>\n<p><strong>Component <code>&lt;tam-splitter-panel&gt;</code></strong></p>\n<table>\n<thead>\n<tr>\n<th>@Input</th>\n<th>Type</th>\n<th>Default</th>\n<th>Details</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>size</td>\n<td>number</td>\n<td>null</td>\n<td>Size of the panel in percent (value between 0 and 100).all panels sizes should be equal to 100</td>\n</tr>\n<tr>\n<td>max</td>\n<td>number</td>\n<td>null</td>\n<td>Max size of the panel in percent (value between 0 and 100).</td>\n</tr>\n<tr>\n<td>min</td>\n<td>number</td>\n<td>null</td>\n<td>Min size of the panel in percent (value between 0 and 100).</td>\n</tr>\n<tr>\n<td>visible</td>\n<td>boolean</td>\n<td>true</td>\n<td>Allow to toggle panel visibility</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th>@Output</th>\n<th>Param</th>\n<th>Details</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>collapsedChange</td>\n<td>{collapsed:boolean, sizes:  Array<code>&lt;number&gt;</code>, collapsedComponentSize: number}</td>\n<td>Emit when collapsed or expand, return the collapsed, the sizes of panels and the size of collapsed panel</td>\n</tr>\n</tbody>\n</table>\n<p>simple demo:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;tam-splitter splitterBarWidth=3 [direction]=&quot;horizontal&quot; (sizeChange)=&quot;sizeChange($event)&quot;&gt;</span><br><span class=\"line\">    &lt;tam-splitter-panel [size]=&quot;20&quot; [max]=&quot;30&quot; [min]=&quot;10&quot;</span><br><span class=\"line\">        [visible]=true (collapsedChange)=&quot;collapsedChange($event)&quot;&gt;</span><br><span class=\"line\">        Refined By Panel</span><br><span class=\"line\">    &lt;/tam-splitter-panel&gt;</span><br><span class=\"line\">    &lt;tam-splitter-panel  [size]=&quot;30&quot; [max]=&quot;50&quot; [min]=&quot;20&quot;&gt;</span><br><span class=\"line\">        Side List Panel</span><br><span class=\"line\">    &lt;/tam-splitter-panel&gt;</span><br><span class=\"line\">    &lt;tam-splitter-panel [size]=&quot;50&quot; [max]=&quot;70&quot; [min]=&quot;20&quot;&gt;</span><br><span class=\"line\">        Preview Panel</span><br><span class=\"line\">    &lt;/tam-splitter-panel&gt;</span><br><span class=\"line\">&lt;/tam-splitter&gt;</span><br></pre></td></tr></table></figure></p>\n<p>nested demo:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;tam-splitter splitterBarWidth=3&gt;</span><br><span class=\"line\">    &lt;tam-splitter-panel [size]=&quot;20&quot; [max]=&quot;30&quot; [min]=&quot;10&quot; (collapsedChange)=&quot;collapsedChange($event)&quot;&gt;</span><br><span class=\"line\">        Refined By Panel</span><br><span class=\"line\">    &lt;/tam-splitter-panel&gt;</span><br><span class=\"line\">    &lt;tam-splitter-panel [size]=&quot;80&quot;&gt;</span><br><span class=\"line\">        &lt;tam-splitter splitterBarWidth=3 [direction]=&quot;&apos;vertical&apos;&quot;&gt;</span><br><span class=\"line\">            &lt;tam-splitter-panel [size]=&quot;30&quot; [max]=&quot;40&quot; [min]=&quot;20&quot;&gt;</span><br><span class=\"line\">                Side List Panel</span><br><span class=\"line\">            &lt;/tam-splitter-panel&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">            &lt;tam-splitter-panel [size]=&quot;70&quot; [max]=&quot;80&quot; [min]=&quot;60&quot;&gt;</span><br><span class=\"line\">                Preview Panel</span><br><span class=\"line\">            &lt;/tam-splitter-panel&gt;</span><br><span class=\"line\">        &lt;/tam-splitter&gt;</span><br><span class=\"line\">    &lt;/tam-splitter-panel&gt;</span><br><span class=\"line\">&lt;/tam-splitter&gt;</span><br></pre></td></tr></table></figure></p>\n<p><a href=\"https://blog.csdn.net/baidu_35407267/article/details/82527822\" target=\"_blank\" rel=\"noopener\">中文README</a></p>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p>this is a angular splitter that could drag the responsive layout, and also act like the layout of notes on mac.</p>\n</blockquote>\n<p><img src=\"/images/splitter.gif\" alt=\"drawing\"><br><img src=\"/images/macnotes.gif\" alt=\"drawing\"></p>\n<h2 id=\"Online\"><a href=\"#Online\" class=\"headerlink\" title=\"Online\"></a>Online</h2><p><a href=\"https://guguji5.github.io/angular-splitter-demo\">https://guguji5.github.io/angular-splitter-demo</a></p>\n<h2 id=\"How-to-run\"><a href=\"#How-to-run\" class=\"headerlink\" title=\"How to run\"></a>How to run</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git clone https://github.com/guguji5/angular-splitter.git</span><br><span class=\"line\">cd angular-splitter</span><br><span class=\"line\">npm install</span><br><span class=\"line\">ng serve --open</span><br></pre></td></tr></table></figure>\n<p>of course you must have angular-cli installed.</p>\n<h2 id=\"Angular-Support\"><a href=\"#Angular-Support\" class=\"headerlink\" title=\"Angular Support\"></a>Angular Support</h2><p>angular 5~6</p>\n<h2 id=\"Document\"><a href=\"#Document\" class=\"headerlink\" title=\"Document\"></a>Document</h2><p><strong>Component <code>&lt;tam-splitter&gt;</code></strong></p>\n<table>\n<thead>\n<tr>\n<th>@Input</th>\n<th>Type</th>\n<th>Default</th>\n<th>Details</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>direction</td>\n<td>string</td>\n<td>“horizontal”</td>\n<td>Select split direction: “horizontal” or “vertical”.</td>\n</tr>\n<tr>\n<td>splitterBarWidth</td>\n<td>number</td>\n<td>8</td>\n<td>Gutters’s size (dragging elements) in pixels.</td>\n</tr>\n<tr>\n<td>useTransition</td>\n<td>boolean or number</td>\n<td>false</td>\n<td>Use transition when collapsing or expanding. when this param is a number, it will be a millisecond value set to the property ‘transition-duration’, should be between 100 and 1000</td>\n</tr>\n<tr>\n<td>type</td>\n<td>string</td>\n<td>‘standard’</td>\n<td>it has two value(standard, macNotes), which controls the behavior of the drag, macNotes type will act like the notes on mac</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th>@Output</th>\n<th>Param</th>\n<th>Details</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>sizeChange</td>\n<td>{barNum: number, sizes: Array<code>&lt;number&gt;</code>}</td>\n<td>Emit when draging, return the index of bar and the sizes of panels</td>\n</tr>\n</tbody>\n</table>\n<p><strong>Component <code>&lt;tam-splitter-panel&gt;</code></strong></p>\n<table>\n<thead>\n<tr>\n<th>@Input</th>\n<th>Type</th>\n<th>Default</th>\n<th>Details</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>size</td>\n<td>number</td>\n<td>null</td>\n<td>Size of the panel in percent (value between 0 and 100).all panels sizes should be equal to 100</td>\n</tr>\n<tr>\n<td>max</td>\n<td>number</td>\n<td>null</td>\n<td>Max size of the panel in percent (value between 0 and 100).</td>\n</tr>\n<tr>\n<td>min</td>\n<td>number</td>\n<td>null</td>\n<td>Min size of the panel in percent (value between 0 and 100).</td>\n</tr>\n<tr>\n<td>visible</td>\n<td>boolean</td>\n<td>true</td>\n<td>Allow to toggle panel visibility</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th>@Output</th>\n<th>Param</th>\n<th>Details</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>collapsedChange</td>\n<td>{collapsed:boolean, sizes:  Array<code>&lt;number&gt;</code>, collapsedComponentSize: number}</td>\n<td>Emit when collapsed or expand, return the collapsed, the sizes of panels and the size of collapsed panel</td>\n</tr>\n</tbody>\n</table>\n<p>simple demo:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;tam-splitter splitterBarWidth=3 [direction]=&quot;horizontal&quot; (sizeChange)=&quot;sizeChange($event)&quot;&gt;</span><br><span class=\"line\">    &lt;tam-splitter-panel [size]=&quot;20&quot; [max]=&quot;30&quot; [min]=&quot;10&quot;</span><br><span class=\"line\">        [visible]=true (collapsedChange)=&quot;collapsedChange($event)&quot;&gt;</span><br><span class=\"line\">        Refined By Panel</span><br><span class=\"line\">    &lt;/tam-splitter-panel&gt;</span><br><span class=\"line\">    &lt;tam-splitter-panel  [size]=&quot;30&quot; [max]=&quot;50&quot; [min]=&quot;20&quot;&gt;</span><br><span class=\"line\">        Side List Panel</span><br><span class=\"line\">    &lt;/tam-splitter-panel&gt;</span><br><span class=\"line\">    &lt;tam-splitter-panel [size]=&quot;50&quot; [max]=&quot;70&quot; [min]=&quot;20&quot;&gt;</span><br><span class=\"line\">        Preview Panel</span><br><span class=\"line\">    &lt;/tam-splitter-panel&gt;</span><br><span class=\"line\">&lt;/tam-splitter&gt;</span><br></pre></td></tr></table></figure></p>\n<p>nested demo:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;tam-splitter splitterBarWidth=3&gt;</span><br><span class=\"line\">    &lt;tam-splitter-panel [size]=&quot;20&quot; [max]=&quot;30&quot; [min]=&quot;10&quot; (collapsedChange)=&quot;collapsedChange($event)&quot;&gt;</span><br><span class=\"line\">        Refined By Panel</span><br><span class=\"line\">    &lt;/tam-splitter-panel&gt;</span><br><span class=\"line\">    &lt;tam-splitter-panel [size]=&quot;80&quot;&gt;</span><br><span class=\"line\">        &lt;tam-splitter splitterBarWidth=3 [direction]=&quot;&apos;vertical&apos;&quot;&gt;</span><br><span class=\"line\">            &lt;tam-splitter-panel [size]=&quot;30&quot; [max]=&quot;40&quot; [min]=&quot;20&quot;&gt;</span><br><span class=\"line\">                Side List Panel</span><br><span class=\"line\">            &lt;/tam-splitter-panel&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">            &lt;tam-splitter-panel [size]=&quot;70&quot; [max]=&quot;80&quot; [min]=&quot;60&quot;&gt;</span><br><span class=\"line\">                Preview Panel</span><br><span class=\"line\">            &lt;/tam-splitter-panel&gt;</span><br><span class=\"line\">        &lt;/tam-splitter&gt;</span><br><span class=\"line\">    &lt;/tam-splitter-panel&gt;</span><br><span class=\"line\">&lt;/tam-splitter&gt;</span><br></pre></td></tr></table></figure></p>\n<p><a href=\"https://blog.csdn.net/baidu_35407267/article/details/82527822\" target=\"_blank\" rel=\"noopener\">中文README</a></p>\n"},{"title":"SameSite的解释和跨域cookie问题的解决","date":"2020-11-01T12:14:41.000Z","_content":"\n### 问题提出\n\n现在大多项目的前后端都是分离的，部署在不同的 IP 及域名上，之前遇到一个测试环境的问题，虽然解决了但一直不明所以。前端项目测试环境部署在 10.155.18.1 环境的 8080 端口，而后端项目测试环境部署在 10.155.19.2 环境的 8126 端口，通过 sso 登录后回调后端的接口中 `Set-Cookie` 一个 q 字段来给前端保持登录的状态。但是，后续的后端请求都没有带上该 cookie，在浏览器的本地缓存中查看该 cookie 也是存在的。问题就是为啥明明设置了，后续请求却丢失了该 cookie。\n\n我猜想 cookie 在 IP 上是不是有什么问题，我就本地配了两个 host，分别为\n\n```\n10.155.18.1 mis.example.io\n10.155.19.2 api.example.io\n```\n\n通过`mis.example.io:8080`来访问，回调`api.example.io:8126`，cookie 中的 q 会一直带着。一直想不通，这域名跟 IP 有啥不同，反正都是跨域。为啥用 IP 不行，用域名就可以了呢？\n\n直到看到了[samesite-cookies-explained](https://web.dev/samesite-cookies-explained/)，了解到了 samesite 对 cookie 的限制。文章讲了 cookie 的由来，因为 http 协议是无状态的，而 cookie 可以使状态持久化，通过 key=value 的状态来使用，通过 headers 中的 Set-Cookie 来进行设置等等 cookie 的基本概念（这些大家都知道，而跟题目无关）\n\n### 什么是 first-party 和 third-party 的 cookie？\n\n让我们举个例子，你可能会注意到一个网站不仅仅是当前你正在访问的域名，而是有很多不同域名的 cookies 组成。Cookies 会匹配当前网站（在浏览器地址栏的网址）会被认为 first-party cookies，类似的，来自其他域名的 cookies 则被认为 third-party cookies，这不是一个绝对的概念，它会根据用户访问的站点来变化。同一个 cookie 根据当前访问站点的不同，可能会被认为 first-party 或者 third-party。\n![cross-site-set-cookie-response-header](https://webdev.imgix.net/samesite-cookies-explained/cross-site-set-cookie-response-header.png)\n\n让我们继续上边的例子，假如你的博客上有一个非常迷人的猫咪图片，它被托管在`/blog/img/amazing-cat.png`。因为它非常的特别，所以其他人会直接把地址放在自己的网站里（其实上图我就是直接粘的原博客的链接）。当有访客访问你的博客时，有一个`promo_shown`的 cookie（在原网站中可能是用来控制弹出框是否展示），然后他访问其他人的网站时，也会带上这个 cookie，但它在其网站上可能没有任何意义，所以有些多余。\n\n如果这是一个意想不到的效果，你为什么要这样做呢?当站点在第三方上下文中使用时，正是这种机制允许站点维护状态。例如，如果你在你的网站上嵌入一个 YouTube 视频，那么访问者将会在播放器中看到一个“稍后观看”的选项。如果访问者已经登录了 YouTube,该有效期的会话会使用第三方嵌入式播放器 cookie，这意味着“稍后观看”按钮将保存视频,而不是弹出对话框提示他们去注册或者迫使用户离开你的页面并导航到 YouTube。\n![cross-site-cookie-request-header](https://webdev.imgix.net/samesite-cookies-explained/cross-site-cookie-request-header.png)\n\n网络最大的特性就是开放，这也是许多人去创造和记录 blog 的原因之一，然而这也会带来一些安全和隐私方面的问题。CSRF（跨站请求伪造）的实现依赖于 cookie 的这一属性，无论谁发起的请求，它都会被携带在 http 请求上。为了更好的解释 third-party，再举一个例子，当你访问`evil.example`时，它会向`your-blog.example`发起请求，然后浏览器自然而然的会带上对应的 cookie，如果你的博客网站没有很好的验证和处理好它，那么这些请求就会做一些危险操作，比如删除博文，或者添加一些“evil”想要的内容。\n\n用户也越来越了解如何使用 cookie 在多个站点跟踪他们的活动。然而，到目前为止，还没有一种方法可以明确地说明使用 cookie 的意图。\n\n### 使用 SameSite 属性来明确 cookie 的使用范围\n\n定义在[RFC6265bis](https://tools.ietf.org/html/draft-ietf-httpbis-cookie-same-site-00)的`SameSite`允许我们声明 cookie 可以用来 first-party 或者 same-site。它会明确的给出“网站”是指哪些（哪些可以带 cookie）。网站由域名后缀和域名前部分组成，比如`www.web.dev`是`web.dev`的一部分。\n\n#### 关键概念\n\n当用户在网站`www.web.dev`，向`static.web.dev`请求一个图片，这是一个`same-site`请求。\n\n不仅仅是顶级域名例如`.com`，也包括了一些公共服务`github.io`。有一个[公共后缀名单](https://publicsuffix.org/list/)定义了 sameSite 的范围，这使的`your-project.github.io`和`my-project.github.io`为两个站点，也就是跨域。\n`SameSite`属性提供了三种不同的方式来管理 cookie，你可以不指定这个属性（`None`），或者使用`Strict`和`Lax`来限制 cookie 的 same-site 请求。\n\n#### Strict\n\n如果`SameSite`设置为`Strict`，则 cookie 只能在 first-party 的内容中传输，在用户的层面，只有当访问的 url 匹配 cookie 的站点时才会带上 cookie。可以如下设置：\n\n```\nSet-Cookie: promo_shown=1; SameSite=Strict\n```\n\n当用户通过一个链接进入你的网站，或者说从从有个你朋友发来的邮件链接中点开网站，cookie 不会起作用。这对于那些有功能性的 cookie（修改密码或者下单）很有益处，但是对于`promo_shown`这种仅仅用来展示弹出框的 cookie 来说有点过于限制了。\n\n#### Lax\n\n还记得迷人猫咪的图片么，假如猫咪的图片被人直接放在他的网站，并且放了一个链接在文章中，如下：\n\n```\n<p>Look at this amazing cat!</p>\n<img src=\"https://blog.example/blog/img/amazing-cat.png\" />\n<p>Read the <a href=\"https://blog.example/blog/cat.html\">article</a>.</p>\n```\n\ncookie 会被这样设置\n\n```\nSet-Cookie: promo_shown=1; SameSite=Lax\n```\n\n当读者打开他的网站时，请求`amazint-cat.png`的时候不会带上 cookie，然而当用户点击链接，进入你博客时，cookie 会被使用。对于仅仅影响展示的 cookie 来说 `Lax` 是一个不错的选择。\n\n#### None\n\n将`SameSite`设置为`None`意味着，你明确的表示，在 third-party 发送请求时使用 cookie，你很清楚这样做的收益和后果。\n\n```\nSet-Cookie: widget_session=abc123; SameSite=None; Secure\n```\n\n![samesite-none-lax-strict](https://webdev.imgix.net/samesite-cookies-explained/samesite-none-lax-strict.png)\n\n#### 最后两点\n\n- 没有设置`SameSite`会被认为`SameSite=Lax`\n- 当设置`SameSite=None`时，必须同时设置`Secure`\n\n谷歌浏览器在 version 84 默认开启该特性，火狐浏览器 69 可以再`about:config`中设置`network.cookie.sameSite.laxByDefault`来体验该特性。Edge 浏览器计划将该特性设为默认。\n\n**相信看到这，最开始的问题，也有了答案了吧。**\n\n### 参考链接\n\n[samesite-cookies-explained](https://web.dev/samesite-cookies-explained/)\n[https://www.chromestatus.com/feature/5088147346030592](https://www.chromestatus.com/feature/5088147346030592)\n","source":"_posts/cross-site-cookies.md","raw":"---\ntitle: SameSite的解释和跨域cookie问题的解决\ndate: 2020-11-01 20:14:41\ntags:\n---\n\n### 问题提出\n\n现在大多项目的前后端都是分离的，部署在不同的 IP 及域名上，之前遇到一个测试环境的问题，虽然解决了但一直不明所以。前端项目测试环境部署在 10.155.18.1 环境的 8080 端口，而后端项目测试环境部署在 10.155.19.2 环境的 8126 端口，通过 sso 登录后回调后端的接口中 `Set-Cookie` 一个 q 字段来给前端保持登录的状态。但是，后续的后端请求都没有带上该 cookie，在浏览器的本地缓存中查看该 cookie 也是存在的。问题就是为啥明明设置了，后续请求却丢失了该 cookie。\n\n我猜想 cookie 在 IP 上是不是有什么问题，我就本地配了两个 host，分别为\n\n```\n10.155.18.1 mis.example.io\n10.155.19.2 api.example.io\n```\n\n通过`mis.example.io:8080`来访问，回调`api.example.io:8126`，cookie 中的 q 会一直带着。一直想不通，这域名跟 IP 有啥不同，反正都是跨域。为啥用 IP 不行，用域名就可以了呢？\n\n直到看到了[samesite-cookies-explained](https://web.dev/samesite-cookies-explained/)，了解到了 samesite 对 cookie 的限制。文章讲了 cookie 的由来，因为 http 协议是无状态的，而 cookie 可以使状态持久化，通过 key=value 的状态来使用，通过 headers 中的 Set-Cookie 来进行设置等等 cookie 的基本概念（这些大家都知道，而跟题目无关）\n\n### 什么是 first-party 和 third-party 的 cookie？\n\n让我们举个例子，你可能会注意到一个网站不仅仅是当前你正在访问的域名，而是有很多不同域名的 cookies 组成。Cookies 会匹配当前网站（在浏览器地址栏的网址）会被认为 first-party cookies，类似的，来自其他域名的 cookies 则被认为 third-party cookies，这不是一个绝对的概念，它会根据用户访问的站点来变化。同一个 cookie 根据当前访问站点的不同，可能会被认为 first-party 或者 third-party。\n![cross-site-set-cookie-response-header](https://webdev.imgix.net/samesite-cookies-explained/cross-site-set-cookie-response-header.png)\n\n让我们继续上边的例子，假如你的博客上有一个非常迷人的猫咪图片，它被托管在`/blog/img/amazing-cat.png`。因为它非常的特别，所以其他人会直接把地址放在自己的网站里（其实上图我就是直接粘的原博客的链接）。当有访客访问你的博客时，有一个`promo_shown`的 cookie（在原网站中可能是用来控制弹出框是否展示），然后他访问其他人的网站时，也会带上这个 cookie，但它在其网站上可能没有任何意义，所以有些多余。\n\n如果这是一个意想不到的效果，你为什么要这样做呢?当站点在第三方上下文中使用时，正是这种机制允许站点维护状态。例如，如果你在你的网站上嵌入一个 YouTube 视频，那么访问者将会在播放器中看到一个“稍后观看”的选项。如果访问者已经登录了 YouTube,该有效期的会话会使用第三方嵌入式播放器 cookie，这意味着“稍后观看”按钮将保存视频,而不是弹出对话框提示他们去注册或者迫使用户离开你的页面并导航到 YouTube。\n![cross-site-cookie-request-header](https://webdev.imgix.net/samesite-cookies-explained/cross-site-cookie-request-header.png)\n\n网络最大的特性就是开放，这也是许多人去创造和记录 blog 的原因之一，然而这也会带来一些安全和隐私方面的问题。CSRF（跨站请求伪造）的实现依赖于 cookie 的这一属性，无论谁发起的请求，它都会被携带在 http 请求上。为了更好的解释 third-party，再举一个例子，当你访问`evil.example`时，它会向`your-blog.example`发起请求，然后浏览器自然而然的会带上对应的 cookie，如果你的博客网站没有很好的验证和处理好它，那么这些请求就会做一些危险操作，比如删除博文，或者添加一些“evil”想要的内容。\n\n用户也越来越了解如何使用 cookie 在多个站点跟踪他们的活动。然而，到目前为止，还没有一种方法可以明确地说明使用 cookie 的意图。\n\n### 使用 SameSite 属性来明确 cookie 的使用范围\n\n定义在[RFC6265bis](https://tools.ietf.org/html/draft-ietf-httpbis-cookie-same-site-00)的`SameSite`允许我们声明 cookie 可以用来 first-party 或者 same-site。它会明确的给出“网站”是指哪些（哪些可以带 cookie）。网站由域名后缀和域名前部分组成，比如`www.web.dev`是`web.dev`的一部分。\n\n#### 关键概念\n\n当用户在网站`www.web.dev`，向`static.web.dev`请求一个图片，这是一个`same-site`请求。\n\n不仅仅是顶级域名例如`.com`，也包括了一些公共服务`github.io`。有一个[公共后缀名单](https://publicsuffix.org/list/)定义了 sameSite 的范围，这使的`your-project.github.io`和`my-project.github.io`为两个站点，也就是跨域。\n`SameSite`属性提供了三种不同的方式来管理 cookie，你可以不指定这个属性（`None`），或者使用`Strict`和`Lax`来限制 cookie 的 same-site 请求。\n\n#### Strict\n\n如果`SameSite`设置为`Strict`，则 cookie 只能在 first-party 的内容中传输，在用户的层面，只有当访问的 url 匹配 cookie 的站点时才会带上 cookie。可以如下设置：\n\n```\nSet-Cookie: promo_shown=1; SameSite=Strict\n```\n\n当用户通过一个链接进入你的网站，或者说从从有个你朋友发来的邮件链接中点开网站，cookie 不会起作用。这对于那些有功能性的 cookie（修改密码或者下单）很有益处，但是对于`promo_shown`这种仅仅用来展示弹出框的 cookie 来说有点过于限制了。\n\n#### Lax\n\n还记得迷人猫咪的图片么，假如猫咪的图片被人直接放在他的网站，并且放了一个链接在文章中，如下：\n\n```\n<p>Look at this amazing cat!</p>\n<img src=\"https://blog.example/blog/img/amazing-cat.png\" />\n<p>Read the <a href=\"https://blog.example/blog/cat.html\">article</a>.</p>\n```\n\ncookie 会被这样设置\n\n```\nSet-Cookie: promo_shown=1; SameSite=Lax\n```\n\n当读者打开他的网站时，请求`amazint-cat.png`的时候不会带上 cookie，然而当用户点击链接，进入你博客时，cookie 会被使用。对于仅仅影响展示的 cookie 来说 `Lax` 是一个不错的选择。\n\n#### None\n\n将`SameSite`设置为`None`意味着，你明确的表示，在 third-party 发送请求时使用 cookie，你很清楚这样做的收益和后果。\n\n```\nSet-Cookie: widget_session=abc123; SameSite=None; Secure\n```\n\n![samesite-none-lax-strict](https://webdev.imgix.net/samesite-cookies-explained/samesite-none-lax-strict.png)\n\n#### 最后两点\n\n- 没有设置`SameSite`会被认为`SameSite=Lax`\n- 当设置`SameSite=None`时，必须同时设置`Secure`\n\n谷歌浏览器在 version 84 默认开启该特性，火狐浏览器 69 可以再`about:config`中设置`network.cookie.sameSite.laxByDefault`来体验该特性。Edge 浏览器计划将该特性设为默认。\n\n**相信看到这，最开始的问题，也有了答案了吧。**\n\n### 参考链接\n\n[samesite-cookies-explained](https://web.dev/samesite-cookies-explained/)\n[https://www.chromestatus.com/feature/5088147346030592](https://www.chromestatus.com/feature/5088147346030592)\n","slug":"cross-site-cookies","published":1,"updated":"2020-11-02T05:43:21.886Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckrix8zdr000nk1jfvl84e8c9","content":"<h3 id=\"问题提出\"><a href=\"#问题提出\" class=\"headerlink\" title=\"问题提出\"></a>问题提出</h3><p>现在大多项目的前后端都是分离的，部署在不同的 IP 及域名上，之前遇到一个测试环境的问题，虽然解决了但一直不明所以。前端项目测试环境部署在 10.155.18.1 环境的 8080 端口，而后端项目测试环境部署在 10.155.19.2 环境的 8126 端口，通过 sso 登录后回调后端的接口中 <code>Set-Cookie</code> 一个 q 字段来给前端保持登录的状态。但是，后续的后端请求都没有带上该 cookie，在浏览器的本地缓存中查看该 cookie 也是存在的。问题就是为啥明明设置了，后续请求却丢失了该 cookie。</p>\n<p>我猜想 cookie 在 IP 上是不是有什么问题，我就本地配了两个 host，分别为</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">10.155.18.1 mis.example.io</span><br><span class=\"line\">10.155.19.2 api.example.io</span><br></pre></td></tr></table></figure>\n<p>通过<code>mis.example.io:8080</code>来访问，回调<code>api.example.io:8126</code>，cookie 中的 q 会一直带着。一直想不通，这域名跟 IP 有啥不同，反正都是跨域。为啥用 IP 不行，用域名就可以了呢？</p>\n<p>直到看到了<a href=\"https://web.dev/samesite-cookies-explained/\" target=\"_blank\" rel=\"noopener\">samesite-cookies-explained</a>，了解到了 samesite 对 cookie 的限制。文章讲了 cookie 的由来，因为 http 协议是无状态的，而 cookie 可以使状态持久化，通过 key=value 的状态来使用，通过 headers 中的 Set-Cookie 来进行设置等等 cookie 的基本概念（这些大家都知道，而跟题目无关）</p>\n<h3 id=\"什么是-first-party-和-third-party-的-cookie？\"><a href=\"#什么是-first-party-和-third-party-的-cookie？\" class=\"headerlink\" title=\"什么是 first-party 和 third-party 的 cookie？\"></a>什么是 first-party 和 third-party 的 cookie？</h3><p>让我们举个例子，你可能会注意到一个网站不仅仅是当前你正在访问的域名，而是有很多不同域名的 cookies 组成。Cookies 会匹配当前网站（在浏览器地址栏的网址）会被认为 first-party cookies，类似的，来自其他域名的 cookies 则被认为 third-party cookies，这不是一个绝对的概念，它会根据用户访问的站点来变化。同一个 cookie 根据当前访问站点的不同，可能会被认为 first-party 或者 third-party。<br><img src=\"https://webdev.imgix.net/samesite-cookies-explained/cross-site-set-cookie-response-header.png\" alt=\"cross-site-set-cookie-response-header\"></p>\n<p>让我们继续上边的例子，假如你的博客上有一个非常迷人的猫咪图片，它被托管在<code>/blog/img/amazing-cat.png</code>。因为它非常的特别，所以其他人会直接把地址放在自己的网站里（其实上图我就是直接粘的原博客的链接）。当有访客访问你的博客时，有一个<code>promo_shown</code>的 cookie（在原网站中可能是用来控制弹出框是否展示），然后他访问其他人的网站时，也会带上这个 cookie，但它在其网站上可能没有任何意义，所以有些多余。</p>\n<p>如果这是一个意想不到的效果，你为什么要这样做呢?当站点在第三方上下文中使用时，正是这种机制允许站点维护状态。例如，如果你在你的网站上嵌入一个 YouTube 视频，那么访问者将会在播放器中看到一个“稍后观看”的选项。如果访问者已经登录了 YouTube,该有效期的会话会使用第三方嵌入式播放器 cookie，这意味着“稍后观看”按钮将保存视频,而不是弹出对话框提示他们去注册或者迫使用户离开你的页面并导航到 YouTube。<br><img src=\"https://webdev.imgix.net/samesite-cookies-explained/cross-site-cookie-request-header.png\" alt=\"cross-site-cookie-request-header\"></p>\n<p>网络最大的特性就是开放，这也是许多人去创造和记录 blog 的原因之一，然而这也会带来一些安全和隐私方面的问题。CSRF（跨站请求伪造）的实现依赖于 cookie 的这一属性，无论谁发起的请求，它都会被携带在 http 请求上。为了更好的解释 third-party，再举一个例子，当你访问<code>evil.example</code>时，它会向<code>your-blog.example</code>发起请求，然后浏览器自然而然的会带上对应的 cookie，如果你的博客网站没有很好的验证和处理好它，那么这些请求就会做一些危险操作，比如删除博文，或者添加一些“evil”想要的内容。</p>\n<p>用户也越来越了解如何使用 cookie 在多个站点跟踪他们的活动。然而，到目前为止，还没有一种方法可以明确地说明使用 cookie 的意图。</p>\n<h3 id=\"使用-SameSite-属性来明确-cookie-的使用范围\"><a href=\"#使用-SameSite-属性来明确-cookie-的使用范围\" class=\"headerlink\" title=\"使用 SameSite 属性来明确 cookie 的使用范围\"></a>使用 SameSite 属性来明确 cookie 的使用范围</h3><p>定义在<a href=\"https://tools.ietf.org/html/draft-ietf-httpbis-cookie-same-site-00\" target=\"_blank\" rel=\"noopener\">RFC6265bis</a>的<code>SameSite</code>允许我们声明 cookie 可以用来 first-party 或者 same-site。它会明确的给出“网站”是指哪些（哪些可以带 cookie）。网站由域名后缀和域名前部分组成，比如<code>www.web.dev</code>是<code>web.dev</code>的一部分。</p>\n<h4 id=\"关键概念\"><a href=\"#关键概念\" class=\"headerlink\" title=\"关键概念\"></a>关键概念</h4><p>当用户在网站<code>www.web.dev</code>，向<code>static.web.dev</code>请求一个图片，这是一个<code>same-site</code>请求。</p>\n<p>不仅仅是顶级域名例如<code>.com</code>，也包括了一些公共服务<code>github.io</code>。有一个<a href=\"https://publicsuffix.org/list/\" target=\"_blank\" rel=\"noopener\">公共后缀名单</a>定义了 sameSite 的范围，这使的<code>your-project.github.io</code>和<code>my-project.github.io</code>为两个站点，也就是跨域。<br><code>SameSite</code>属性提供了三种不同的方式来管理 cookie，你可以不指定这个属性（<code>None</code>），或者使用<code>Strict</code>和<code>Lax</code>来限制 cookie 的 same-site 请求。</p>\n<h4 id=\"Strict\"><a href=\"#Strict\" class=\"headerlink\" title=\"Strict\"></a>Strict</h4><p>如果<code>SameSite</code>设置为<code>Strict</code>，则 cookie 只能在 first-party 的内容中传输，在用户的层面，只有当访问的 url 匹配 cookie 的站点时才会带上 cookie。可以如下设置：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Set-Cookie: promo_shown=1; SameSite=Strict</span><br></pre></td></tr></table></figure>\n<p>当用户通过一个链接进入你的网站，或者说从从有个你朋友发来的邮件链接中点开网站，cookie 不会起作用。这对于那些有功能性的 cookie（修改密码或者下单）很有益处，但是对于<code>promo_shown</code>这种仅仅用来展示弹出框的 cookie 来说有点过于限制了。</p>\n<h4 id=\"Lax\"><a href=\"#Lax\" class=\"headerlink\" title=\"Lax\"></a>Lax</h4><p>还记得迷人猫咪的图片么，假如猫咪的图片被人直接放在他的网站，并且放了一个链接在文章中，如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;p&gt;Look at this amazing cat!&lt;/p&gt;</span><br><span class=\"line\">&lt;img src=&quot;https://blog.example/blog/img/amazing-cat.png&quot; /&gt;</span><br><span class=\"line\">&lt;p&gt;Read the &lt;a href=&quot;https://blog.example/blog/cat.html&quot;&gt;article&lt;/a&gt;.&lt;/p&gt;</span><br></pre></td></tr></table></figure>\n<p>cookie 会被这样设置</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Set-Cookie: promo_shown=1; SameSite=Lax</span><br></pre></td></tr></table></figure>\n<p>当读者打开他的网站时，请求<code>amazint-cat.png</code>的时候不会带上 cookie，然而当用户点击链接，进入你博客时，cookie 会被使用。对于仅仅影响展示的 cookie 来说 <code>Lax</code> 是一个不错的选择。</p>\n<h4 id=\"None\"><a href=\"#None\" class=\"headerlink\" title=\"None\"></a>None</h4><p>将<code>SameSite</code>设置为<code>None</code>意味着，你明确的表示，在 third-party 发送请求时使用 cookie，你很清楚这样做的收益和后果。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Set-Cookie: widget_session=abc123; SameSite=None; Secure</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://webdev.imgix.net/samesite-cookies-explained/samesite-none-lax-strict.png\" alt=\"samesite-none-lax-strict\"></p>\n<h4 id=\"最后两点\"><a href=\"#最后两点\" class=\"headerlink\" title=\"最后两点\"></a>最后两点</h4><ul>\n<li>没有设置<code>SameSite</code>会被认为<code>SameSite=Lax</code></li>\n<li>当设置<code>SameSite=None</code>时，必须同时设置<code>Secure</code></li>\n</ul>\n<p>谷歌浏览器在 version 84 默认开启该特性，火狐浏览器 69 可以再<code>about:config</code>中设置<code>network.cookie.sameSite.laxByDefault</code>来体验该特性。Edge 浏览器计划将该特性设为默认。</p>\n<p><strong>相信看到这，最开始的问题，也有了答案了吧。</strong></p>\n<h3 id=\"参考链接\"><a href=\"#参考链接\" class=\"headerlink\" title=\"参考链接\"></a>参考链接</h3><p><a href=\"https://web.dev/samesite-cookies-explained/\" target=\"_blank\" rel=\"noopener\">samesite-cookies-explained</a><br><a href=\"https://www.chromestatus.com/feature/5088147346030592\" target=\"_blank\" rel=\"noopener\">https://www.chromestatus.com/feature/5088147346030592</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"问题提出\"><a href=\"#问题提出\" class=\"headerlink\" title=\"问题提出\"></a>问题提出</h3><p>现在大多项目的前后端都是分离的，部署在不同的 IP 及域名上，之前遇到一个测试环境的问题，虽然解决了但一直不明所以。前端项目测试环境部署在 10.155.18.1 环境的 8080 端口，而后端项目测试环境部署在 10.155.19.2 环境的 8126 端口，通过 sso 登录后回调后端的接口中 <code>Set-Cookie</code> 一个 q 字段来给前端保持登录的状态。但是，后续的后端请求都没有带上该 cookie，在浏览器的本地缓存中查看该 cookie 也是存在的。问题就是为啥明明设置了，后续请求却丢失了该 cookie。</p>\n<p>我猜想 cookie 在 IP 上是不是有什么问题，我就本地配了两个 host，分别为</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">10.155.18.1 mis.example.io</span><br><span class=\"line\">10.155.19.2 api.example.io</span><br></pre></td></tr></table></figure>\n<p>通过<code>mis.example.io:8080</code>来访问，回调<code>api.example.io:8126</code>，cookie 中的 q 会一直带着。一直想不通，这域名跟 IP 有啥不同，反正都是跨域。为啥用 IP 不行，用域名就可以了呢？</p>\n<p>直到看到了<a href=\"https://web.dev/samesite-cookies-explained/\" target=\"_blank\" rel=\"noopener\">samesite-cookies-explained</a>，了解到了 samesite 对 cookie 的限制。文章讲了 cookie 的由来，因为 http 协议是无状态的，而 cookie 可以使状态持久化，通过 key=value 的状态来使用，通过 headers 中的 Set-Cookie 来进行设置等等 cookie 的基本概念（这些大家都知道，而跟题目无关）</p>\n<h3 id=\"什么是-first-party-和-third-party-的-cookie？\"><a href=\"#什么是-first-party-和-third-party-的-cookie？\" class=\"headerlink\" title=\"什么是 first-party 和 third-party 的 cookie？\"></a>什么是 first-party 和 third-party 的 cookie？</h3><p>让我们举个例子，你可能会注意到一个网站不仅仅是当前你正在访问的域名，而是有很多不同域名的 cookies 组成。Cookies 会匹配当前网站（在浏览器地址栏的网址）会被认为 first-party cookies，类似的，来自其他域名的 cookies 则被认为 third-party cookies，这不是一个绝对的概念，它会根据用户访问的站点来变化。同一个 cookie 根据当前访问站点的不同，可能会被认为 first-party 或者 third-party。<br><img src=\"https://webdev.imgix.net/samesite-cookies-explained/cross-site-set-cookie-response-header.png\" alt=\"cross-site-set-cookie-response-header\"></p>\n<p>让我们继续上边的例子，假如你的博客上有一个非常迷人的猫咪图片，它被托管在<code>/blog/img/amazing-cat.png</code>。因为它非常的特别，所以其他人会直接把地址放在自己的网站里（其实上图我就是直接粘的原博客的链接）。当有访客访问你的博客时，有一个<code>promo_shown</code>的 cookie（在原网站中可能是用来控制弹出框是否展示），然后他访问其他人的网站时，也会带上这个 cookie，但它在其网站上可能没有任何意义，所以有些多余。</p>\n<p>如果这是一个意想不到的效果，你为什么要这样做呢?当站点在第三方上下文中使用时，正是这种机制允许站点维护状态。例如，如果你在你的网站上嵌入一个 YouTube 视频，那么访问者将会在播放器中看到一个“稍后观看”的选项。如果访问者已经登录了 YouTube,该有效期的会话会使用第三方嵌入式播放器 cookie，这意味着“稍后观看”按钮将保存视频,而不是弹出对话框提示他们去注册或者迫使用户离开你的页面并导航到 YouTube。<br><img src=\"https://webdev.imgix.net/samesite-cookies-explained/cross-site-cookie-request-header.png\" alt=\"cross-site-cookie-request-header\"></p>\n<p>网络最大的特性就是开放，这也是许多人去创造和记录 blog 的原因之一，然而这也会带来一些安全和隐私方面的问题。CSRF（跨站请求伪造）的实现依赖于 cookie 的这一属性，无论谁发起的请求，它都会被携带在 http 请求上。为了更好的解释 third-party，再举一个例子，当你访问<code>evil.example</code>时，它会向<code>your-blog.example</code>发起请求，然后浏览器自然而然的会带上对应的 cookie，如果你的博客网站没有很好的验证和处理好它，那么这些请求就会做一些危险操作，比如删除博文，或者添加一些“evil”想要的内容。</p>\n<p>用户也越来越了解如何使用 cookie 在多个站点跟踪他们的活动。然而，到目前为止，还没有一种方法可以明确地说明使用 cookie 的意图。</p>\n<h3 id=\"使用-SameSite-属性来明确-cookie-的使用范围\"><a href=\"#使用-SameSite-属性来明确-cookie-的使用范围\" class=\"headerlink\" title=\"使用 SameSite 属性来明确 cookie 的使用范围\"></a>使用 SameSite 属性来明确 cookie 的使用范围</h3><p>定义在<a href=\"https://tools.ietf.org/html/draft-ietf-httpbis-cookie-same-site-00\" target=\"_blank\" rel=\"noopener\">RFC6265bis</a>的<code>SameSite</code>允许我们声明 cookie 可以用来 first-party 或者 same-site。它会明确的给出“网站”是指哪些（哪些可以带 cookie）。网站由域名后缀和域名前部分组成，比如<code>www.web.dev</code>是<code>web.dev</code>的一部分。</p>\n<h4 id=\"关键概念\"><a href=\"#关键概念\" class=\"headerlink\" title=\"关键概念\"></a>关键概念</h4><p>当用户在网站<code>www.web.dev</code>，向<code>static.web.dev</code>请求一个图片，这是一个<code>same-site</code>请求。</p>\n<p>不仅仅是顶级域名例如<code>.com</code>，也包括了一些公共服务<code>github.io</code>。有一个<a href=\"https://publicsuffix.org/list/\" target=\"_blank\" rel=\"noopener\">公共后缀名单</a>定义了 sameSite 的范围，这使的<code>your-project.github.io</code>和<code>my-project.github.io</code>为两个站点，也就是跨域。<br><code>SameSite</code>属性提供了三种不同的方式来管理 cookie，你可以不指定这个属性（<code>None</code>），或者使用<code>Strict</code>和<code>Lax</code>来限制 cookie 的 same-site 请求。</p>\n<h4 id=\"Strict\"><a href=\"#Strict\" class=\"headerlink\" title=\"Strict\"></a>Strict</h4><p>如果<code>SameSite</code>设置为<code>Strict</code>，则 cookie 只能在 first-party 的内容中传输，在用户的层面，只有当访问的 url 匹配 cookie 的站点时才会带上 cookie。可以如下设置：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Set-Cookie: promo_shown=1; SameSite=Strict</span><br></pre></td></tr></table></figure>\n<p>当用户通过一个链接进入你的网站，或者说从从有个你朋友发来的邮件链接中点开网站，cookie 不会起作用。这对于那些有功能性的 cookie（修改密码或者下单）很有益处，但是对于<code>promo_shown</code>这种仅仅用来展示弹出框的 cookie 来说有点过于限制了。</p>\n<h4 id=\"Lax\"><a href=\"#Lax\" class=\"headerlink\" title=\"Lax\"></a>Lax</h4><p>还记得迷人猫咪的图片么，假如猫咪的图片被人直接放在他的网站，并且放了一个链接在文章中，如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;p&gt;Look at this amazing cat!&lt;/p&gt;</span><br><span class=\"line\">&lt;img src=&quot;https://blog.example/blog/img/amazing-cat.png&quot; /&gt;</span><br><span class=\"line\">&lt;p&gt;Read the &lt;a href=&quot;https://blog.example/blog/cat.html&quot;&gt;article&lt;/a&gt;.&lt;/p&gt;</span><br></pre></td></tr></table></figure>\n<p>cookie 会被这样设置</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Set-Cookie: promo_shown=1; SameSite=Lax</span><br></pre></td></tr></table></figure>\n<p>当读者打开他的网站时，请求<code>amazint-cat.png</code>的时候不会带上 cookie，然而当用户点击链接，进入你博客时，cookie 会被使用。对于仅仅影响展示的 cookie 来说 <code>Lax</code> 是一个不错的选择。</p>\n<h4 id=\"None\"><a href=\"#None\" class=\"headerlink\" title=\"None\"></a>None</h4><p>将<code>SameSite</code>设置为<code>None</code>意味着，你明确的表示，在 third-party 发送请求时使用 cookie，你很清楚这样做的收益和后果。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Set-Cookie: widget_session=abc123; SameSite=None; Secure</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://webdev.imgix.net/samesite-cookies-explained/samesite-none-lax-strict.png\" alt=\"samesite-none-lax-strict\"></p>\n<h4 id=\"最后两点\"><a href=\"#最后两点\" class=\"headerlink\" title=\"最后两点\"></a>最后两点</h4><ul>\n<li>没有设置<code>SameSite</code>会被认为<code>SameSite=Lax</code></li>\n<li>当设置<code>SameSite=None</code>时，必须同时设置<code>Secure</code></li>\n</ul>\n<p>谷歌浏览器在 version 84 默认开启该特性，火狐浏览器 69 可以再<code>about:config</code>中设置<code>network.cookie.sameSite.laxByDefault</code>来体验该特性。Edge 浏览器计划将该特性设为默认。</p>\n<p><strong>相信看到这，最开始的问题，也有了答案了吧。</strong></p>\n<h3 id=\"参考链接\"><a href=\"#参考链接\" class=\"headerlink\" title=\"参考链接\"></a>参考链接</h3><p><a href=\"https://web.dev/samesite-cookies-explained/\" target=\"_blank\" rel=\"noopener\">samesite-cookies-explained</a><br><a href=\"https://www.chromestatus.com/feature/5088147346030592\" target=\"_blank\" rel=\"noopener\">https://www.chromestatus.com/feature/5088147346030592</a></p>\n"},{"title":"1.记一次koa转发请求遇到的bug","date":"2020-07-18T11:50:39.000Z","_content":"> 最近公司内某业务线清理非法请求，options请求就被归为此类，从浏览器端直接调用跨域的api必然产生options，所以需要proxy来转发。\n\n无论对于何种后端语言来说，转发都是一个基本切正常的需求，我们选择使用前端自己搭的nodejs server来做转发。在调研了 [koa-proxy](https://github.com/popomore/koa-proxy)，[koa-proxies](https://github.com/vagusX/koa-proxies)，[koa-better-http-proxy](https://github.com/nsimmons/koa-better-http-proxy)，[koa2-proxy-middleware](https://github.com/sunyongjian/koa2-proxy-middleware)等，选择了koa-proxies。用法简单，配置清晰。\n\n\n```\n// middleware\napp.use(proxy('/octocat', {\n  target: 'https://api.github.com/users',    \n  changeOrigin: true,\n  agent: new httpsProxyAgent('http://1.2.3.4:88'), // if you need or just delete this line\n  rewrite: path => path.replace(/^\\/octocat(\\/|\\/\\w+)?$/, '/vagusx'),\n  logs: true\n}))\n```\n\n可是一直超时，看了koa-proxies源码后，在其node-http-proxy里边打了断点，有输出如下报错\n```\n{\n    Error: socket hang up\n    at createHangUpError (_http_client.js:342:15)\n    at Socket.socketOnEnd (_http_client.js:437:23)\n    at emitNone (events.js:111:20)\n    at Socket.emit (events.js:208:7)\n    at endReadableNT (_stream_readable.js:1064:12)\n    at _combinedTickCallback (internal/process/next_tick.js:139:11)\n    at process._tickCallback (internal/process/next_tick.js:181:9) code: 'ECONNRESET'\n}\n```\n在node-http-proxy的issue里查了好久好久，经 [koa2-proxy-middleware](https://github.com/sunyongjian/koa2-proxy-middleware) 文档提醒，将bodyParser挪到proxy后解决问题。具体对比demo如下：\n\n```\n// this works well.\nconst Koa = require('koa');\nconst app = new Koa();\nconst proxy = require('koa-proxies')\nconst bodyParser = require('koa-bodyparser');\n\napp.use(proxy('/user', {\n  target: 'http://example.com',    \n  changeOrigin: true,\n  rewrite: path => path\n}))\napp.use(bodyParser())\napp.listen(8080);\n```\n\n```\n// this works with bug \"socket hang up\".\nconst Koa = require('koa');\nconst app = new Koa();\nconst proxy = require('koa-proxies')\nconst bodyParser = require('koa-bodyparser');\napp.use(bodyParser())\n\napp.use(proxy('/user', {\n  target: 'http://example.com',    \n  changeOrigin: true,\n  rewrite: path => path\n}))\n\napp.listen(8080);\n```\n\n这个proxy，真的是 从查找文档，拷贝粘贴，一共也就用了5分钟。但是把bodyParser从proxy上边挪到proxy下边用了many many多的hours。**这事不能这么过了，必须得找下原因看看为啥。**\n\n先从 `koa-bodyparser` 这个库说起吧，它到期对api请求过来的数据做了什么？我们都知道这个库是在koa框架下解析post put等有请求体的api时，将请求体数据转换成我们想要的格式，比如json，form，text等。\n那么它是如何做的呢？我们举一个最简单的nodejs例子来如何处理post数据\n```\nhttp.createServer(function (req, res) {\n  console.log(req.url)\n  let postData = '' \n  req.on('data', chunk => {\n    postData += chunk.toString()\n  })\n  req.on('end', () => {\n    if (postData) {\n      res.setHeader('Content-type', 'text/plain')\n      res.end('request successfully proxied!' + '\\n' + JSON.stringify(req.headers, true, 2) + postData)\n    }\n    console.log(JSON.parse(postData))\n  }) \n}).listen(9000);\n```\n很显然在bodyParser这个中间件中消费了data数据，直到它结束。**而middleware会串行的一个一个执行，并且修改ctx中的res和req。** 再到proxy这个中间件执行时req中就没有data事件了。\n\n这和使用postman请求的结果符合，使用postman请求是一直不返回数据，其实它被bodyParser接受并消费了，根本没发到proxy的target去，也就没有返回值可言了，超时后报错`hang up`,一切就通了。\n\n这次浪费这么多时间主要还是对middleware和bodyParser这个库的实现不熟悉，继续加油吧。\n","source":"_posts/1.记一次koa转发请求遇到的bug.md","raw":"---\ntitle: 1.记一次koa转发请求遇到的bug\ndate: 2020-07-18 19:50:39\ntags: Bugfix\n---\n> 最近公司内某业务线清理非法请求，options请求就被归为此类，从浏览器端直接调用跨域的api必然产生options，所以需要proxy来转发。\n\n无论对于何种后端语言来说，转发都是一个基本切正常的需求，我们选择使用前端自己搭的nodejs server来做转发。在调研了 [koa-proxy](https://github.com/popomore/koa-proxy)，[koa-proxies](https://github.com/vagusX/koa-proxies)，[koa-better-http-proxy](https://github.com/nsimmons/koa-better-http-proxy)，[koa2-proxy-middleware](https://github.com/sunyongjian/koa2-proxy-middleware)等，选择了koa-proxies。用法简单，配置清晰。\n\n\n```\n// middleware\napp.use(proxy('/octocat', {\n  target: 'https://api.github.com/users',    \n  changeOrigin: true,\n  agent: new httpsProxyAgent('http://1.2.3.4:88'), // if you need or just delete this line\n  rewrite: path => path.replace(/^\\/octocat(\\/|\\/\\w+)?$/, '/vagusx'),\n  logs: true\n}))\n```\n\n可是一直超时，看了koa-proxies源码后，在其node-http-proxy里边打了断点，有输出如下报错\n```\n{\n    Error: socket hang up\n    at createHangUpError (_http_client.js:342:15)\n    at Socket.socketOnEnd (_http_client.js:437:23)\n    at emitNone (events.js:111:20)\n    at Socket.emit (events.js:208:7)\n    at endReadableNT (_stream_readable.js:1064:12)\n    at _combinedTickCallback (internal/process/next_tick.js:139:11)\n    at process._tickCallback (internal/process/next_tick.js:181:9) code: 'ECONNRESET'\n}\n```\n在node-http-proxy的issue里查了好久好久，经 [koa2-proxy-middleware](https://github.com/sunyongjian/koa2-proxy-middleware) 文档提醒，将bodyParser挪到proxy后解决问题。具体对比demo如下：\n\n```\n// this works well.\nconst Koa = require('koa');\nconst app = new Koa();\nconst proxy = require('koa-proxies')\nconst bodyParser = require('koa-bodyparser');\n\napp.use(proxy('/user', {\n  target: 'http://example.com',    \n  changeOrigin: true,\n  rewrite: path => path\n}))\napp.use(bodyParser())\napp.listen(8080);\n```\n\n```\n// this works with bug \"socket hang up\".\nconst Koa = require('koa');\nconst app = new Koa();\nconst proxy = require('koa-proxies')\nconst bodyParser = require('koa-bodyparser');\napp.use(bodyParser())\n\napp.use(proxy('/user', {\n  target: 'http://example.com',    \n  changeOrigin: true,\n  rewrite: path => path\n}))\n\napp.listen(8080);\n```\n\n这个proxy，真的是 从查找文档，拷贝粘贴，一共也就用了5分钟。但是把bodyParser从proxy上边挪到proxy下边用了many many多的hours。**这事不能这么过了，必须得找下原因看看为啥。**\n\n先从 `koa-bodyparser` 这个库说起吧，它到期对api请求过来的数据做了什么？我们都知道这个库是在koa框架下解析post put等有请求体的api时，将请求体数据转换成我们想要的格式，比如json，form，text等。\n那么它是如何做的呢？我们举一个最简单的nodejs例子来如何处理post数据\n```\nhttp.createServer(function (req, res) {\n  console.log(req.url)\n  let postData = '' \n  req.on('data', chunk => {\n    postData += chunk.toString()\n  })\n  req.on('end', () => {\n    if (postData) {\n      res.setHeader('Content-type', 'text/plain')\n      res.end('request successfully proxied!' + '\\n' + JSON.stringify(req.headers, true, 2) + postData)\n    }\n    console.log(JSON.parse(postData))\n  }) \n}).listen(9000);\n```\n很显然在bodyParser这个中间件中消费了data数据，直到它结束。**而middleware会串行的一个一个执行，并且修改ctx中的res和req。** 再到proxy这个中间件执行时req中就没有data事件了。\n\n这和使用postman请求的结果符合，使用postman请求是一直不返回数据，其实它被bodyParser接受并消费了，根本没发到proxy的target去，也就没有返回值可言了，超时后报错`hang up`,一切就通了。\n\n这次浪费这么多时间主要还是对middleware和bodyParser这个库的实现不熟悉，继续加油吧。\n","slug":"1.记一次koa转发请求遇到的bug","published":1,"updated":"2021-01-22T02:27:20.659Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckrix8zds000qk1jfmrl0mngn","content":"<blockquote>\n<p>最近公司内某业务线清理非法请求，options请求就被归为此类，从浏览器端直接调用跨域的api必然产生options，所以需要proxy来转发。</p>\n</blockquote>\n<p>无论对于何种后端语言来说，转发都是一个基本切正常的需求，我们选择使用前端自己搭的nodejs server来做转发。在调研了 <a href=\"https://github.com/popomore/koa-proxy\" target=\"_blank\" rel=\"noopener\">koa-proxy</a>，<a href=\"https://github.com/vagusX/koa-proxies\" target=\"_blank\" rel=\"noopener\">koa-proxies</a>，<a href=\"https://github.com/nsimmons/koa-better-http-proxy\" target=\"_blank\" rel=\"noopener\">koa-better-http-proxy</a>，<a href=\"https://github.com/sunyongjian/koa2-proxy-middleware\" target=\"_blank\" rel=\"noopener\">koa2-proxy-middleware</a>等，选择了koa-proxies。用法简单，配置清晰。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// middleware</span><br><span class=\"line\">app.use(proxy(&apos;/octocat&apos;, &#123;</span><br><span class=\"line\">  target: &apos;https://api.github.com/users&apos;,    </span><br><span class=\"line\">  changeOrigin: true,</span><br><span class=\"line\">  agent: new httpsProxyAgent(&apos;http://1.2.3.4:88&apos;), // if you need or just delete this line</span><br><span class=\"line\">  rewrite: path =&gt; path.replace(/^\\/octocat(\\/|\\/\\w+)?$/, &apos;/vagusx&apos;),</span><br><span class=\"line\">  logs: true</span><br><span class=\"line\">&#125;))</span><br></pre></td></tr></table></figure>\n<p>可是一直超时，看了koa-proxies源码后，在其node-http-proxy里边打了断点，有输出如下报错<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    Error: socket hang up</span><br><span class=\"line\">    at createHangUpError (_http_client.js:342:15)</span><br><span class=\"line\">    at Socket.socketOnEnd (_http_client.js:437:23)</span><br><span class=\"line\">    at emitNone (events.js:111:20)</span><br><span class=\"line\">    at Socket.emit (events.js:208:7)</span><br><span class=\"line\">    at endReadableNT (_stream_readable.js:1064:12)</span><br><span class=\"line\">    at _combinedTickCallback (internal/process/next_tick.js:139:11)</span><br><span class=\"line\">    at process._tickCallback (internal/process/next_tick.js:181:9) code: &apos;ECONNRESET&apos;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>在node-http-proxy的issue里查了好久好久，经 <a href=\"https://github.com/sunyongjian/koa2-proxy-middleware\" target=\"_blank\" rel=\"noopener\">koa2-proxy-middleware</a> 文档提醒，将bodyParser挪到proxy后解决问题。具体对比demo如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// this works well.</span><br><span class=\"line\">const Koa = require(&apos;koa&apos;);</span><br><span class=\"line\">const app = new Koa();</span><br><span class=\"line\">const proxy = require(&apos;koa-proxies&apos;)</span><br><span class=\"line\">const bodyParser = require(&apos;koa-bodyparser&apos;);</span><br><span class=\"line\"></span><br><span class=\"line\">app.use(proxy(&apos;/user&apos;, &#123;</span><br><span class=\"line\">  target: &apos;http://example.com&apos;,    </span><br><span class=\"line\">  changeOrigin: true,</span><br><span class=\"line\">  rewrite: path =&gt; path</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\">app.use(bodyParser())</span><br><span class=\"line\">app.listen(8080);</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// this works with bug &quot;socket hang up&quot;.</span><br><span class=\"line\">const Koa = require(&apos;koa&apos;);</span><br><span class=\"line\">const app = new Koa();</span><br><span class=\"line\">const proxy = require(&apos;koa-proxies&apos;)</span><br><span class=\"line\">const bodyParser = require(&apos;koa-bodyparser&apos;);</span><br><span class=\"line\">app.use(bodyParser())</span><br><span class=\"line\"></span><br><span class=\"line\">app.use(proxy(&apos;/user&apos;, &#123;</span><br><span class=\"line\">  target: &apos;http://example.com&apos;,    </span><br><span class=\"line\">  changeOrigin: true,</span><br><span class=\"line\">  rewrite: path =&gt; path</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">app.listen(8080);</span><br></pre></td></tr></table></figure>\n<p>这个proxy，真的是 从查找文档，拷贝粘贴，一共也就用了5分钟。但是把bodyParser从proxy上边挪到proxy下边用了many many多的hours。<strong>这事不能这么过了，必须得找下原因看看为啥。</strong></p>\n<p>先从 <code>koa-bodyparser</code> 这个库说起吧，它到期对api请求过来的数据做了什么？我们都知道这个库是在koa框架下解析post put等有请求体的api时，将请求体数据转换成我们想要的格式，比如json，form，text等。<br>那么它是如何做的呢？我们举一个最简单的nodejs例子来如何处理post数据<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http.createServer(function (req, res) &#123;</span><br><span class=\"line\">  console.log(req.url)</span><br><span class=\"line\">  let postData = &apos;&apos; </span><br><span class=\"line\">  req.on(&apos;data&apos;, chunk =&gt; &#123;</span><br><span class=\"line\">    postData += chunk.toString()</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">  req.on(&apos;end&apos;, () =&gt; &#123;</span><br><span class=\"line\">    if (postData) &#123;</span><br><span class=\"line\">      res.setHeader(&apos;Content-type&apos;, &apos;text/plain&apos;)</span><br><span class=\"line\">      res.end(&apos;request successfully proxied!&apos; + &apos;\\n&apos; + JSON.stringify(req.headers, true, 2) + postData)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    console.log(JSON.parse(postData))</span><br><span class=\"line\">  &#125;) </span><br><span class=\"line\">&#125;).listen(9000);</span><br></pre></td></tr></table></figure></p>\n<p>很显然在bodyParser这个中间件中消费了data数据，直到它结束。<strong>而middleware会串行的一个一个执行，并且修改ctx中的res和req。</strong> 再到proxy这个中间件执行时req中就没有data事件了。</p>\n<p>这和使用postman请求的结果符合，使用postman请求是一直不返回数据，其实它被bodyParser接受并消费了，根本没发到proxy的target去，也就没有返回值可言了，超时后报错<code>hang up</code>,一切就通了。</p>\n<p>这次浪费这么多时间主要还是对middleware和bodyParser这个库的实现不熟悉，继续加油吧。</p>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p>最近公司内某业务线清理非法请求，options请求就被归为此类，从浏览器端直接调用跨域的api必然产生options，所以需要proxy来转发。</p>\n</blockquote>\n<p>无论对于何种后端语言来说，转发都是一个基本切正常的需求，我们选择使用前端自己搭的nodejs server来做转发。在调研了 <a href=\"https://github.com/popomore/koa-proxy\" target=\"_blank\" rel=\"noopener\">koa-proxy</a>，<a href=\"https://github.com/vagusX/koa-proxies\" target=\"_blank\" rel=\"noopener\">koa-proxies</a>，<a href=\"https://github.com/nsimmons/koa-better-http-proxy\" target=\"_blank\" rel=\"noopener\">koa-better-http-proxy</a>，<a href=\"https://github.com/sunyongjian/koa2-proxy-middleware\" target=\"_blank\" rel=\"noopener\">koa2-proxy-middleware</a>等，选择了koa-proxies。用法简单，配置清晰。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// middleware</span><br><span class=\"line\">app.use(proxy(&apos;/octocat&apos;, &#123;</span><br><span class=\"line\">  target: &apos;https://api.github.com/users&apos;,    </span><br><span class=\"line\">  changeOrigin: true,</span><br><span class=\"line\">  agent: new httpsProxyAgent(&apos;http://1.2.3.4:88&apos;), // if you need or just delete this line</span><br><span class=\"line\">  rewrite: path =&gt; path.replace(/^\\/octocat(\\/|\\/\\w+)?$/, &apos;/vagusx&apos;),</span><br><span class=\"line\">  logs: true</span><br><span class=\"line\">&#125;))</span><br></pre></td></tr></table></figure>\n<p>可是一直超时，看了koa-proxies源码后，在其node-http-proxy里边打了断点，有输出如下报错<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    Error: socket hang up</span><br><span class=\"line\">    at createHangUpError (_http_client.js:342:15)</span><br><span class=\"line\">    at Socket.socketOnEnd (_http_client.js:437:23)</span><br><span class=\"line\">    at emitNone (events.js:111:20)</span><br><span class=\"line\">    at Socket.emit (events.js:208:7)</span><br><span class=\"line\">    at endReadableNT (_stream_readable.js:1064:12)</span><br><span class=\"line\">    at _combinedTickCallback (internal/process/next_tick.js:139:11)</span><br><span class=\"line\">    at process._tickCallback (internal/process/next_tick.js:181:9) code: &apos;ECONNRESET&apos;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>在node-http-proxy的issue里查了好久好久，经 <a href=\"https://github.com/sunyongjian/koa2-proxy-middleware\" target=\"_blank\" rel=\"noopener\">koa2-proxy-middleware</a> 文档提醒，将bodyParser挪到proxy后解决问题。具体对比demo如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// this works well.</span><br><span class=\"line\">const Koa = require(&apos;koa&apos;);</span><br><span class=\"line\">const app = new Koa();</span><br><span class=\"line\">const proxy = require(&apos;koa-proxies&apos;)</span><br><span class=\"line\">const bodyParser = require(&apos;koa-bodyparser&apos;);</span><br><span class=\"line\"></span><br><span class=\"line\">app.use(proxy(&apos;/user&apos;, &#123;</span><br><span class=\"line\">  target: &apos;http://example.com&apos;,    </span><br><span class=\"line\">  changeOrigin: true,</span><br><span class=\"line\">  rewrite: path =&gt; path</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\">app.use(bodyParser())</span><br><span class=\"line\">app.listen(8080);</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// this works with bug &quot;socket hang up&quot;.</span><br><span class=\"line\">const Koa = require(&apos;koa&apos;);</span><br><span class=\"line\">const app = new Koa();</span><br><span class=\"line\">const proxy = require(&apos;koa-proxies&apos;)</span><br><span class=\"line\">const bodyParser = require(&apos;koa-bodyparser&apos;);</span><br><span class=\"line\">app.use(bodyParser())</span><br><span class=\"line\"></span><br><span class=\"line\">app.use(proxy(&apos;/user&apos;, &#123;</span><br><span class=\"line\">  target: &apos;http://example.com&apos;,    </span><br><span class=\"line\">  changeOrigin: true,</span><br><span class=\"line\">  rewrite: path =&gt; path</span><br><span class=\"line\">&#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">app.listen(8080);</span><br></pre></td></tr></table></figure>\n<p>这个proxy，真的是 从查找文档，拷贝粘贴，一共也就用了5分钟。但是把bodyParser从proxy上边挪到proxy下边用了many many多的hours。<strong>这事不能这么过了，必须得找下原因看看为啥。</strong></p>\n<p>先从 <code>koa-bodyparser</code> 这个库说起吧，它到期对api请求过来的数据做了什么？我们都知道这个库是在koa框架下解析post put等有请求体的api时，将请求体数据转换成我们想要的格式，比如json，form，text等。<br>那么它是如何做的呢？我们举一个最简单的nodejs例子来如何处理post数据<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http.createServer(function (req, res) &#123;</span><br><span class=\"line\">  console.log(req.url)</span><br><span class=\"line\">  let postData = &apos;&apos; </span><br><span class=\"line\">  req.on(&apos;data&apos;, chunk =&gt; &#123;</span><br><span class=\"line\">    postData += chunk.toString()</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">  req.on(&apos;end&apos;, () =&gt; &#123;</span><br><span class=\"line\">    if (postData) &#123;</span><br><span class=\"line\">      res.setHeader(&apos;Content-type&apos;, &apos;text/plain&apos;)</span><br><span class=\"line\">      res.end(&apos;request successfully proxied!&apos; + &apos;\\n&apos; + JSON.stringify(req.headers, true, 2) + postData)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    console.log(JSON.parse(postData))</span><br><span class=\"line\">  &#125;) </span><br><span class=\"line\">&#125;).listen(9000);</span><br></pre></td></tr></table></figure></p>\n<p>很显然在bodyParser这个中间件中消费了data数据，直到它结束。<strong>而middleware会串行的一个一个执行，并且修改ctx中的res和req。</strong> 再到proxy这个中间件执行时req中就没有data事件了。</p>\n<p>这和使用postman请求的结果符合，使用postman请求是一直不返回数据，其实它被bodyParser接受并消费了，根本没发到proxy的target去，也就没有返回值可言了，超时后报错<code>hang up</code>,一切就通了。</p>\n<p>这次浪费这么多时间主要还是对middleware和bodyParser这个库的实现不熟悉，继续加油吧。</p>\n"},{"title":"fork项目自动同步机器人","date":"2020-02-29T12:14:28.000Z","_content":"调研了一段时间微前端，发现single-spa的实现很简单清晰，就把它当做主要解决方案使用在项目中，加入其Slack后，single-spa的作者有问必答，着实让人感动，所以在其提出能否帮翻译single-spa的文档时，我也没有推辞。翻译的过程，也是一个详细了解的过程，认真求索的过程。\n\n## 脚本\n\n在参考了react团队的[翻译经验](https://reactjs.org/blog/2019/02/23/is-react-translated-yet.html)后，需要有个同步机器人，具体来讲就是当英文版文档更新后，需要同步到其他语言的文档。\n\n本来以为很难，就去看react翻译团队的[同步机制](https://github.com/reactjs/reactjs.org-translation/blob/master/scripts/sync.js)。很简单，却有一个问题，log没有存储，无法查看运行的状况，而这点log4js本身是支持的。支持了log本地输出的问题，缺引发了另一个问题，`process.exit`会中断log4js日志的写入。尝试了网上的几种解决方案后，如监听beforeExit事件和`process.exit`后通过异步事件输出log都不可信，nodejs的文档也写的非常清楚。\n\n```\n在调用 'exit' 事件监听器之后，Node.js 进程将立即退出，从而导致在事件循环中仍排队的任何其他工作被放弃。\n```\n\n所以，只好对条件进行通过IF ELSE来判断以保证所有的log都能正常输出，带来的副作用就是没有之前可读性强，\b后序有时间我再调研一下。\n\n首先需要将待翻译仓库 `git clone` 到本地，然后使用`git remote add`将英语文档的地址添加为远端仓库。\n\n具体同步的流程如下图，so easy。\n\n![同步流程](/images/sync-process.png)\n\n直接提交，会以single-spa-bot账户直接向翻译的仓库直接提交。具体就像[这样](https://github.com/single-spa/zh-hans.single-spa.js.org/commits?author=single-spa-bot)。\n\n而冲突后，会将冲突痕迹保留，等待reviewer来解决冲突。具体就像[这样](https://github.com/guguji5/zh-hans.doc/pull/25/files)。\n\n到此为止，脚本应该是ok了，仓库地址 [https://github.com/guguji5/sync-fork-repo](https://github.com/guguji5/sync-fork-repo)。\n\n*应single-spa owner的要求，后续可能将此仓库transfer到single-spa的账号下*\n\n## 部署\n\n脚本虽然ok了，但是部署却着实让我费了一番功夫。所谓机器人，无非就是一个定时任务，也没有很强的时效性，每天同步一次就可以。\n\n1. 脚本中用到了环境变量，crontab的环境变量我相信谁用谁入坑，这里不展开，google可了解。\n2. 脚本中用了一些箭头函数，模板字符串等，对node版本有一定的要求。CentOs中如何升级node，当然是n模块啦。\n3. 脚本中使用了`git rev-parse`方法，git1和git2中语法不通，再屡次尝试升级git失败后，只好使用git1语法，git2兼容git1语法。\n4. 最后学了一招如何在[同一组织下fork仓库](https://stackoverflow.com/questions/22767617/copy-fork-a-git-repo-on-github-into-same-organization)。\n\n## 结语\n\n虽然是一个很小的东西，但是做出来也是花了很多的时间，也学到了很多的东西，比如crontab定时任务，log4js日志管理后来很快就用到了，git的远程分支管理理解的更加深入。","source":"_posts/fork项目自动同步机器人.md","raw":"---\ntitle: fork项目自动同步机器人\ndate: 2020-02-29 20:14:28\ntags: 机器人\n---\n调研了一段时间微前端，发现single-spa的实现很简单清晰，就把它当做主要解决方案使用在项目中，加入其Slack后，single-spa的作者有问必答，着实让人感动，所以在其提出能否帮翻译single-spa的文档时，我也没有推辞。翻译的过程，也是一个详细了解的过程，认真求索的过程。\n\n## 脚本\n\n在参考了react团队的[翻译经验](https://reactjs.org/blog/2019/02/23/is-react-translated-yet.html)后，需要有个同步机器人，具体来讲就是当英文版文档更新后，需要同步到其他语言的文档。\n\n本来以为很难，就去看react翻译团队的[同步机制](https://github.com/reactjs/reactjs.org-translation/blob/master/scripts/sync.js)。很简单，却有一个问题，log没有存储，无法查看运行的状况，而这点log4js本身是支持的。支持了log本地输出的问题，缺引发了另一个问题，`process.exit`会中断log4js日志的写入。尝试了网上的几种解决方案后，如监听beforeExit事件和`process.exit`后通过异步事件输出log都不可信，nodejs的文档也写的非常清楚。\n\n```\n在调用 'exit' 事件监听器之后，Node.js 进程将立即退出，从而导致在事件循环中仍排队的任何其他工作被放弃。\n```\n\n所以，只好对条件进行通过IF ELSE来判断以保证所有的log都能正常输出，带来的副作用就是没有之前可读性强，\b后序有时间我再调研一下。\n\n首先需要将待翻译仓库 `git clone` 到本地，然后使用`git remote add`将英语文档的地址添加为远端仓库。\n\n具体同步的流程如下图，so easy。\n\n![同步流程](/images/sync-process.png)\n\n直接提交，会以single-spa-bot账户直接向翻译的仓库直接提交。具体就像[这样](https://github.com/single-spa/zh-hans.single-spa.js.org/commits?author=single-spa-bot)。\n\n而冲突后，会将冲突痕迹保留，等待reviewer来解决冲突。具体就像[这样](https://github.com/guguji5/zh-hans.doc/pull/25/files)。\n\n到此为止，脚本应该是ok了，仓库地址 [https://github.com/guguji5/sync-fork-repo](https://github.com/guguji5/sync-fork-repo)。\n\n*应single-spa owner的要求，后续可能将此仓库transfer到single-spa的账号下*\n\n## 部署\n\n脚本虽然ok了，但是部署却着实让我费了一番功夫。所谓机器人，无非就是一个定时任务，也没有很强的时效性，每天同步一次就可以。\n\n1. 脚本中用到了环境变量，crontab的环境变量我相信谁用谁入坑，这里不展开，google可了解。\n2. 脚本中用了一些箭头函数，模板字符串等，对node版本有一定的要求。CentOs中如何升级node，当然是n模块啦。\n3. 脚本中使用了`git rev-parse`方法，git1和git2中语法不通，再屡次尝试升级git失败后，只好使用git1语法，git2兼容git1语法。\n4. 最后学了一招如何在[同一组织下fork仓库](https://stackoverflow.com/questions/22767617/copy-fork-a-git-repo-on-github-into-same-organization)。\n\n## 结语\n\n虽然是一个很小的东西，但是做出来也是花了很多的时间，也学到了很多的东西，比如crontab定时任务，log4js日志管理后来很快就用到了，git的远程分支管理理解的更加深入。","slug":"fork项目自动同步机器人","published":1,"updated":"2020-02-29T15:50:46.100Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckrix8zdt000sk1jfiv7584ly","content":"<p>调研了一段时间微前端，发现single-spa的实现很简单清晰，就把它当做主要解决方案使用在项目中，加入其Slack后，single-spa的作者有问必答，着实让人感动，所以在其提出能否帮翻译single-spa的文档时，我也没有推辞。翻译的过程，也是一个详细了解的过程，认真求索的过程。</p>\n<h2 id=\"脚本\"><a href=\"#脚本\" class=\"headerlink\" title=\"脚本\"></a>脚本</h2><p>在参考了react团队的<a href=\"https://reactjs.org/blog/2019/02/23/is-react-translated-yet.html\" target=\"_blank\" rel=\"noopener\">翻译经验</a>后，需要有个同步机器人，具体来讲就是当英文版文档更新后，需要同步到其他语言的文档。</p>\n<p>本来以为很难，就去看react翻译团队的<a href=\"https://github.com/reactjs/reactjs.org-translation/blob/master/scripts/sync.js\" target=\"_blank\" rel=\"noopener\">同步机制</a>。很简单，却有一个问题，log没有存储，无法查看运行的状况，而这点log4js本身是支持的。支持了log本地输出的问题，缺引发了另一个问题，<code>process.exit</code>会中断log4js日志的写入。尝试了网上的几种解决方案后，如监听beforeExit事件和<code>process.exit</code>后通过异步事件输出log都不可信，nodejs的文档也写的非常清楚。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在调用 &apos;exit&apos; 事件监听器之后，Node.js 进程将立即退出，从而导致在事件循环中仍排队的任何其他工作被放弃。</span><br></pre></td></tr></table></figure>\n<p>所以，只好对条件进行通过IF ELSE来判断以保证所有的log都能正常输出，带来的副作用就是没有之前可读性强，\b后序有时间我再调研一下。</p>\n<p>首先需要将待翻译仓库 <code>git clone</code> 到本地，然后使用<code>git remote add</code>将英语文档的地址添加为远端仓库。</p>\n<p>具体同步的流程如下图，so easy。</p>\n<p><img src=\"/images/sync-process.png\" alt=\"同步流程\"></p>\n<p>直接提交，会以single-spa-bot账户直接向翻译的仓库直接提交。具体就像<a href=\"https://github.com/single-spa/zh-hans.single-spa.js.org/commits?author=single-spa-bot\" target=\"_blank\" rel=\"noopener\">这样</a>。</p>\n<p>而冲突后，会将冲突痕迹保留，等待reviewer来解决冲突。具体就像<a href=\"https://github.com/guguji5/zh-hans.doc/pull/25/files\" target=\"_blank\" rel=\"noopener\">这样</a>。</p>\n<p>到此为止，脚本应该是ok了，仓库地址 <a href=\"https://github.com/guguji5/sync-fork-repo\" target=\"_blank\" rel=\"noopener\">https://github.com/guguji5/sync-fork-repo</a>。</p>\n<p><em>应single-spa owner的要求，后续可能将此仓库transfer到single-spa的账号下</em></p>\n<h2 id=\"部署\"><a href=\"#部署\" class=\"headerlink\" title=\"部署\"></a>部署</h2><p>脚本虽然ok了，但是部署却着实让我费了一番功夫。所谓机器人，无非就是一个定时任务，也没有很强的时效性，每天同步一次就可以。</p>\n<ol>\n<li>脚本中用到了环境变量，crontab的环境变量我相信谁用谁入坑，这里不展开，google可了解。</li>\n<li>脚本中用了一些箭头函数，模板字符串等，对node版本有一定的要求。CentOs中如何升级node，当然是n模块啦。</li>\n<li>脚本中使用了<code>git rev-parse</code>方法，git1和git2中语法不通，再屡次尝试升级git失败后，只好使用git1语法，git2兼容git1语法。</li>\n<li>最后学了一招如何在<a href=\"https://stackoverflow.com/questions/22767617/copy-fork-a-git-repo-on-github-into-same-organization\" target=\"_blank\" rel=\"noopener\">同一组织下fork仓库</a>。</li>\n</ol>\n<h2 id=\"结语\"><a href=\"#结语\" class=\"headerlink\" title=\"结语\"></a>结语</h2><p>虽然是一个很小的东西，但是做出来也是花了很多的时间，也学到了很多的东西，比如crontab定时任务，log4js日志管理后来很快就用到了，git的远程分支管理理解的更加深入。</p>\n","site":{"data":{}},"excerpt":"","more":"<p>调研了一段时间微前端，发现single-spa的实现很简单清晰，就把它当做主要解决方案使用在项目中，加入其Slack后，single-spa的作者有问必答，着实让人感动，所以在其提出能否帮翻译single-spa的文档时，我也没有推辞。翻译的过程，也是一个详细了解的过程，认真求索的过程。</p>\n<h2 id=\"脚本\"><a href=\"#脚本\" class=\"headerlink\" title=\"脚本\"></a>脚本</h2><p>在参考了react团队的<a href=\"https://reactjs.org/blog/2019/02/23/is-react-translated-yet.html\" target=\"_blank\" rel=\"noopener\">翻译经验</a>后，需要有个同步机器人，具体来讲就是当英文版文档更新后，需要同步到其他语言的文档。</p>\n<p>本来以为很难，就去看react翻译团队的<a href=\"https://github.com/reactjs/reactjs.org-translation/blob/master/scripts/sync.js\" target=\"_blank\" rel=\"noopener\">同步机制</a>。很简单，却有一个问题，log没有存储，无法查看运行的状况，而这点log4js本身是支持的。支持了log本地输出的问题，缺引发了另一个问题，<code>process.exit</code>会中断log4js日志的写入。尝试了网上的几种解决方案后，如监听beforeExit事件和<code>process.exit</code>后通过异步事件输出log都不可信，nodejs的文档也写的非常清楚。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在调用 &apos;exit&apos; 事件监听器之后，Node.js 进程将立即退出，从而导致在事件循环中仍排队的任何其他工作被放弃。</span><br></pre></td></tr></table></figure>\n<p>所以，只好对条件进行通过IF ELSE来判断以保证所有的log都能正常输出，带来的副作用就是没有之前可读性强，\b后序有时间我再调研一下。</p>\n<p>首先需要将待翻译仓库 <code>git clone</code> 到本地，然后使用<code>git remote add</code>将英语文档的地址添加为远端仓库。</p>\n<p>具体同步的流程如下图，so easy。</p>\n<p><img src=\"/images/sync-process.png\" alt=\"同步流程\"></p>\n<p>直接提交，会以single-spa-bot账户直接向翻译的仓库直接提交。具体就像<a href=\"https://github.com/single-spa/zh-hans.single-spa.js.org/commits?author=single-spa-bot\" target=\"_blank\" rel=\"noopener\">这样</a>。</p>\n<p>而冲突后，会将冲突痕迹保留，等待reviewer来解决冲突。具体就像<a href=\"https://github.com/guguji5/zh-hans.doc/pull/25/files\" target=\"_blank\" rel=\"noopener\">这样</a>。</p>\n<p>到此为止，脚本应该是ok了，仓库地址 <a href=\"https://github.com/guguji5/sync-fork-repo\" target=\"_blank\" rel=\"noopener\">https://github.com/guguji5/sync-fork-repo</a>。</p>\n<p><em>应single-spa owner的要求，后续可能将此仓库transfer到single-spa的账号下</em></p>\n<h2 id=\"部署\"><a href=\"#部署\" class=\"headerlink\" title=\"部署\"></a>部署</h2><p>脚本虽然ok了，但是部署却着实让我费了一番功夫。所谓机器人，无非就是一个定时任务，也没有很强的时效性，每天同步一次就可以。</p>\n<ol>\n<li>脚本中用到了环境变量，crontab的环境变量我相信谁用谁入坑，这里不展开，google可了解。</li>\n<li>脚本中用了一些箭头函数，模板字符串等，对node版本有一定的要求。CentOs中如何升级node，当然是n模块啦。</li>\n<li>脚本中使用了<code>git rev-parse</code>方法，git1和git2中语法不通，再屡次尝试升级git失败后，只好使用git1语法，git2兼容git1语法。</li>\n<li>最后学了一招如何在<a href=\"https://stackoverflow.com/questions/22767617/copy-fork-a-git-repo-on-github-into-same-organization\" target=\"_blank\" rel=\"noopener\">同一组织下fork仓库</a>。</li>\n</ol>\n<h2 id=\"结语\"><a href=\"#结语\" class=\"headerlink\" title=\"结语\"></a>结语</h2><p>虽然是一个很小的东西，但是做出来也是花了很多的时间，也学到了很多的东西，比如crontab定时任务，log4js日志管理后来很快就用到了，git的远程分支管理理解的更加深入。</p>\n"},{"title":"一次项目合并经历","date":"2019-09-29T07:01:27.000Z","_content":"\n我所在的组有很多项目，其中一个是对外供用户使用的以下简称项目A，还有一个是对内进行资源管理提高效率的以下简称项目B。项目Acss\b解析用postcss，ui组件用element ui，项目B css解析用less，ui组件使用内部开发的一套ui库。\n\n接到一个需求：同事辛辛苦苦做的在A项目中的某个功能（六七个页面）能不能一股脑的嵌入B项目呢？最好不用开发，你们前端不都是Vue 组件么？复用一下噻？\n\n刚接到需求的时候大脑里跑过了千万匹🐴，但是遇到困难不能躲啊。冷静思考一下，先iframe被排除了，因为iframe只能整体的嵌入，而我们想要的可能只是页面\b中的一部分。第一次尝试把A整个项目手动copy到B项目中，通过相对路径来引用。最开始的报错是postcss解析报错，费了半天劲解决后就是，js重名，css覆盖，字体冲突。总结一下遇到的问题list 如下：\n1. postcss loader配置失败\n2. 嵌入A后A全局样式污染B全局样式\n3. B中嵌入的ui库和A的element组件冲突 (e.g. v-loading)\n4. 登录状态如何保持\n5. webpack alias重名，都叫utils，都叫components\n6. A引入B后样式丢失\n7. 自定义的组件覆盖了el样式\n8. B中的字体库和element中的冲突了（content: \"\\e69a\"显示了不同的图标）\n9. build failed \n\n#### 解决方法\n\n1. vue-loader的设置不熟悉，按照官网的配置不生效。原来vue文件在解析的时候会根据language解析成不同后缀名的文件。只需要 `{ test: /\\.postcss$/, use : cssLoaders('postcss') }` 即可。\n2. 如我们所知A中有很多全局样式，引入部分页面缺了这部分全局样式又没法正常渲染，借助postcss-plugin-namespace可以给postcss的文件加一个前缀，确保不因小失大，污染整个B。\n3. 因为element中的组件比内部开发的组件库健壮的多，大部分都是element覆盖之。\n4. A中页面要想正常工作首先是以登录为前提的。还有一条路就是在api上带上某个特定标识，由此也引发了一个小问题。需要改变location search,url会replace，刷新页面。还可以优化。\n5. A中的webpack alias我不敢改，我只能委曲求全改B中的，改成不重名的。\n6. A依赖了好多全局样式，一个一个引入。有些B中的样式跟A中的确实是冲突，确实影响到了。只好自己调整调整，但是需要调整的量很小，就两三处。\n7. 有同事把element的源码拿到项目中使用。而且还稍加改动了css。删掉就好了。\n8. 要想让A中页面正常渲染图标也必不可少，但是element中的字体是font-family: element-icons!important;非常强暴的把所有的图标都用自己的这套字体库。没办法，只好也把我们自己\b的字体库也加上了!important。\n9. 最终以submodule的方式引入A。A中的.postcssrc.js 和B全局的冲突了。按照官方的options配置，但是还是没成功，只好在gitlab hook中删掉submodule中的.postcssrc.js。这样不好，但是能work。（https://github.com/postcss/postcss/issues/1295）\n\n#### 思考\n最终不是太完美的上线了，还有一些地方可以优化。\n虽然嵌入的Acss样式不会影响B全局，但是B全局的样式还是会影响嵌入的A样式。\njs方法最好能互不影响。\n\n微前端的材料看了不少，但还是没找到小成本能实现的方式，可能需要在规划两个或多个项目时就已经想好了实现的方式，有主项目，有include项目等等。对于两个已经成熟的项目如何互相include，甚至不同框架的项目怎么融合，啊~啊~啊~，这个题超纲了。\n\n*参考资料*\n\nhttps://tech.meituan.com/2018/09/06/fe-tiny-spa.html\n\nhttps://forum.vuejs.org/t/advice-to-organize-multiple-vue-projects/15078\n\n","source":"_posts/一次项目合并经历.md","raw":"---\ntitle: 一次项目合并经历\ndate: 2019-09-29 15:01:27\ntags:\n---\n\n我所在的组有很多项目，其中一个是对外供用户使用的以下简称项目A，还有一个是对内进行资源管理提高效率的以下简称项目B。项目Acss\b解析用postcss，ui组件用element ui，项目B css解析用less，ui组件使用内部开发的一套ui库。\n\n接到一个需求：同事辛辛苦苦做的在A项目中的某个功能（六七个页面）能不能一股脑的嵌入B项目呢？最好不用开发，你们前端不都是Vue 组件么？复用一下噻？\n\n刚接到需求的时候大脑里跑过了千万匹🐴，但是遇到困难不能躲啊。冷静思考一下，先iframe被排除了，因为iframe只能整体的嵌入，而我们想要的可能只是页面\b中的一部分。第一次尝试把A整个项目手动copy到B项目中，通过相对路径来引用。最开始的报错是postcss解析报错，费了半天劲解决后就是，js重名，css覆盖，字体冲突。总结一下遇到的问题list 如下：\n1. postcss loader配置失败\n2. 嵌入A后A全局样式污染B全局样式\n3. B中嵌入的ui库和A的element组件冲突 (e.g. v-loading)\n4. 登录状态如何保持\n5. webpack alias重名，都叫utils，都叫components\n6. A引入B后样式丢失\n7. 自定义的组件覆盖了el样式\n8. B中的字体库和element中的冲突了（content: \"\\e69a\"显示了不同的图标）\n9. build failed \n\n#### 解决方法\n\n1. vue-loader的设置不熟悉，按照官网的配置不生效。原来vue文件在解析的时候会根据language解析成不同后缀名的文件。只需要 `{ test: /\\.postcss$/, use : cssLoaders('postcss') }` 即可。\n2. 如我们所知A中有很多全局样式，引入部分页面缺了这部分全局样式又没法正常渲染，借助postcss-plugin-namespace可以给postcss的文件加一个前缀，确保不因小失大，污染整个B。\n3. 因为element中的组件比内部开发的组件库健壮的多，大部分都是element覆盖之。\n4. A中页面要想正常工作首先是以登录为前提的。还有一条路就是在api上带上某个特定标识，由此也引发了一个小问题。需要改变location search,url会replace，刷新页面。还可以优化。\n5. A中的webpack alias我不敢改，我只能委曲求全改B中的，改成不重名的。\n6. A依赖了好多全局样式，一个一个引入。有些B中的样式跟A中的确实是冲突，确实影响到了。只好自己调整调整，但是需要调整的量很小，就两三处。\n7. 有同事把element的源码拿到项目中使用。而且还稍加改动了css。删掉就好了。\n8. 要想让A中页面正常渲染图标也必不可少，但是element中的字体是font-family: element-icons!important;非常强暴的把所有的图标都用自己的这套字体库。没办法，只好也把我们自己\b的字体库也加上了!important。\n9. 最终以submodule的方式引入A。A中的.postcssrc.js 和B全局的冲突了。按照官方的options配置，但是还是没成功，只好在gitlab hook中删掉submodule中的.postcssrc.js。这样不好，但是能work。（https://github.com/postcss/postcss/issues/1295）\n\n#### 思考\n最终不是太完美的上线了，还有一些地方可以优化。\n虽然嵌入的Acss样式不会影响B全局，但是B全局的样式还是会影响嵌入的A样式。\njs方法最好能互不影响。\n\n微前端的材料看了不少，但还是没找到小成本能实现的方式，可能需要在规划两个或多个项目时就已经想好了实现的方式，有主项目，有include项目等等。对于两个已经成熟的项目如何互相include，甚至不同框架的项目怎么融合，啊~啊~啊~，这个题超纲了。\n\n*参考资料*\n\nhttps://tech.meituan.com/2018/09/06/fe-tiny-spa.html\n\nhttps://forum.vuejs.org/t/advice-to-organize-multiple-vue-projects/15078\n\n","slug":"一次项目合并经历","published":1,"updated":"2019-09-29T07:25:04.209Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckrix8zdu000vk1jf47ihrugg","content":"<p>我所在的组有很多项目，其中一个是对外供用户使用的以下简称项目A，还有一个是对内进行资源管理提高效率的以下简称项目B。项目Acss\b解析用postcss，ui组件用element ui，项目B css解析用less，ui组件使用内部开发的一套ui库。</p>\n<p>接到一个需求：同事辛辛苦苦做的在A项目中的某个功能（六七个页面）能不能一股脑的嵌入B项目呢？最好不用开发，你们前端不都是Vue 组件么？复用一下噻？</p>\n<p>刚接到需求的时候大脑里跑过了千万匹🐴，但是遇到困难不能躲啊。冷静思考一下，先iframe被排除了，因为iframe只能整体的嵌入，而我们想要的可能只是页面\b中的一部分。第一次尝试把A整个项目手动copy到B项目中，通过相对路径来引用。最开始的报错是postcss解析报错，费了半天劲解决后就是，js重名，css覆盖，字体冲突。总结一下遇到的问题list 如下：</p>\n<ol>\n<li>postcss loader配置失败</li>\n<li>嵌入A后A全局样式污染B全局样式</li>\n<li>B中嵌入的ui库和A的element组件冲突 (e.g. v-loading)</li>\n<li>登录状态如何保持</li>\n<li>webpack alias重名，都叫utils，都叫components</li>\n<li>A引入B后样式丢失</li>\n<li>自定义的组件覆盖了el样式</li>\n<li>B中的字体库和element中的冲突了（content: “\\e69a”显示了不同的图标）</li>\n<li>build failed </li>\n</ol>\n<h4 id=\"解决方法\"><a href=\"#解决方法\" class=\"headerlink\" title=\"解决方法\"></a>解决方法</h4><ol>\n<li>vue-loader的设置不熟悉，按照官网的配置不生效。原来vue文件在解析的时候会根据language解析成不同后缀名的文件。只需要 <code>{ test: /\\.postcss$/, use : cssLoaders(&#39;postcss&#39;) }</code> 即可。</li>\n<li>如我们所知A中有很多全局样式，引入部分页面缺了这部分全局样式又没法正常渲染，借助postcss-plugin-namespace可以给postcss的文件加一个前缀，确保不因小失大，污染整个B。</li>\n<li>因为element中的组件比内部开发的组件库健壮的多，大部分都是element覆盖之。</li>\n<li>A中页面要想正常工作首先是以登录为前提的。还有一条路就是在api上带上某个特定标识，由此也引发了一个小问题。需要改变location search,url会replace，刷新页面。还可以优化。</li>\n<li>A中的webpack alias我不敢改，我只能委曲求全改B中的，改成不重名的。</li>\n<li>A依赖了好多全局样式，一个一个引入。有些B中的样式跟A中的确实是冲突，确实影响到了。只好自己调整调整，但是需要调整的量很小，就两三处。</li>\n<li>有同事把element的源码拿到项目中使用。而且还稍加改动了css。删掉就好了。</li>\n<li>要想让A中页面正常渲染图标也必不可少，但是element中的字体是font-family: element-icons!important;非常强暴的把所有的图标都用自己的这套字体库。没办法，只好也把我们自己\b的字体库也加上了!important。</li>\n<li>最终以submodule的方式引入A。A中的.postcssrc.js 和B全局的冲突了。按照官方的options配置，但是还是没成功，只好在gitlab hook中删掉submodule中的.postcssrc.js。这样不好，但是能work。（<a href=\"https://github.com/postcss/postcss/issues/1295）\" target=\"_blank\" rel=\"noopener\">https://github.com/postcss/postcss/issues/1295）</a></li>\n</ol>\n<h4 id=\"思考\"><a href=\"#思考\" class=\"headerlink\" title=\"思考\"></a>思考</h4><p>最终不是太完美的上线了，还有一些地方可以优化。<br>虽然嵌入的Acss样式不会影响B全局，但是B全局的样式还是会影响嵌入的A样式。<br>js方法最好能互不影响。</p>\n<p>微前端的材料看了不少，但还是没找到小成本能实现的方式，可能需要在规划两个或多个项目时就已经想好了实现的方式，有主项目，有include项目等等。对于两个已经成熟的项目如何互相include，甚至不同框架的项目怎么融合，啊~啊~啊~，这个题超纲了。</p>\n<p><em>参考资料</em></p>\n<p><a href=\"https://tech.meituan.com/2018/09/06/fe-tiny-spa.html\" target=\"_blank\" rel=\"noopener\">https://tech.meituan.com/2018/09/06/fe-tiny-spa.html</a></p>\n<p><a href=\"https://forum.vuejs.org/t/advice-to-organize-multiple-vue-projects/15078\" target=\"_blank\" rel=\"noopener\">https://forum.vuejs.org/t/advice-to-organize-multiple-vue-projects/15078</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>我所在的组有很多项目，其中一个是对外供用户使用的以下简称项目A，还有一个是对内进行资源管理提高效率的以下简称项目B。项目Acss\b解析用postcss，ui组件用element ui，项目B css解析用less，ui组件使用内部开发的一套ui库。</p>\n<p>接到一个需求：同事辛辛苦苦做的在A项目中的某个功能（六七个页面）能不能一股脑的嵌入B项目呢？最好不用开发，你们前端不都是Vue 组件么？复用一下噻？</p>\n<p>刚接到需求的时候大脑里跑过了千万匹🐴，但是遇到困难不能躲啊。冷静思考一下，先iframe被排除了，因为iframe只能整体的嵌入，而我们想要的可能只是页面\b中的一部分。第一次尝试把A整个项目手动copy到B项目中，通过相对路径来引用。最开始的报错是postcss解析报错，费了半天劲解决后就是，js重名，css覆盖，字体冲突。总结一下遇到的问题list 如下：</p>\n<ol>\n<li>postcss loader配置失败</li>\n<li>嵌入A后A全局样式污染B全局样式</li>\n<li>B中嵌入的ui库和A的element组件冲突 (e.g. v-loading)</li>\n<li>登录状态如何保持</li>\n<li>webpack alias重名，都叫utils，都叫components</li>\n<li>A引入B后样式丢失</li>\n<li>自定义的组件覆盖了el样式</li>\n<li>B中的字体库和element中的冲突了（content: “\\e69a”显示了不同的图标）</li>\n<li>build failed </li>\n</ol>\n<h4 id=\"解决方法\"><a href=\"#解决方法\" class=\"headerlink\" title=\"解决方法\"></a>解决方法</h4><ol>\n<li>vue-loader的设置不熟悉，按照官网的配置不生效。原来vue文件在解析的时候会根据language解析成不同后缀名的文件。只需要 <code>{ test: /\\.postcss$/, use : cssLoaders(&#39;postcss&#39;) }</code> 即可。</li>\n<li>如我们所知A中有很多全局样式，引入部分页面缺了这部分全局样式又没法正常渲染，借助postcss-plugin-namespace可以给postcss的文件加一个前缀，确保不因小失大，污染整个B。</li>\n<li>因为element中的组件比内部开发的组件库健壮的多，大部分都是element覆盖之。</li>\n<li>A中页面要想正常工作首先是以登录为前提的。还有一条路就是在api上带上某个特定标识，由此也引发了一个小问题。需要改变location search,url会replace，刷新页面。还可以优化。</li>\n<li>A中的webpack alias我不敢改，我只能委曲求全改B中的，改成不重名的。</li>\n<li>A依赖了好多全局样式，一个一个引入。有些B中的样式跟A中的确实是冲突，确实影响到了。只好自己调整调整，但是需要调整的量很小，就两三处。</li>\n<li>有同事把element的源码拿到项目中使用。而且还稍加改动了css。删掉就好了。</li>\n<li>要想让A中页面正常渲染图标也必不可少，但是element中的字体是font-family: element-icons!important;非常强暴的把所有的图标都用自己的这套字体库。没办法，只好也把我们自己\b的字体库也加上了!important。</li>\n<li>最终以submodule的方式引入A。A中的.postcssrc.js 和B全局的冲突了。按照官方的options配置，但是还是没成功，只好在gitlab hook中删掉submodule中的.postcssrc.js。这样不好，但是能work。（<a href=\"https://github.com/postcss/postcss/issues/1295）\" target=\"_blank\" rel=\"noopener\">https://github.com/postcss/postcss/issues/1295）</a></li>\n</ol>\n<h4 id=\"思考\"><a href=\"#思考\" class=\"headerlink\" title=\"思考\"></a>思考</h4><p>最终不是太完美的上线了，还有一些地方可以优化。<br>虽然嵌入的Acss样式不会影响B全局，但是B全局的样式还是会影响嵌入的A样式。<br>js方法最好能互不影响。</p>\n<p>微前端的材料看了不少，但还是没找到小成本能实现的方式，可能需要在规划两个或多个项目时就已经想好了实现的方式，有主项目，有include项目等等。对于两个已经成熟的项目如何互相include，甚至不同框架的项目怎么融合，啊~啊~啊~，这个题超纲了。</p>\n<p><em>参考资料</em></p>\n<p><a href=\"https://tech.meituan.com/2018/09/06/fe-tiny-spa.html\" target=\"_blank\" rel=\"noopener\">https://tech.meituan.com/2018/09/06/fe-tiny-spa.html</a></p>\n<p><a href=\"https://forum.vuejs.org/t/advice-to-organize-multiple-vue-projects/15078\" target=\"_blank\" rel=\"noopener\">https://forum.vuejs.org/t/advice-to-organize-multiple-vue-projects/15078</a></p>\n"},{"title":"vue-cli4加载css重复？","date":"2020-03-13T03:26:24.000Z","_content":"\nvue-cli引入css的正确姿势是什么？ vue-cli怎么避免重复引入css呢？\n\n------------\n\n### 问题\n\n最近用[single-spa](https://single-spa.js.org/)尝试重构项目,每个子项目用vue-cli初始化，瞧了一眼vue-cli都已经第四版了。我的css预编译框架选的less，本计划是像之前一样直接在main.js中直接 `import './styles/index.less';` 报错了（但是错误是啥不记得了），查了vue-cli的文档[CSS 相关](https://cli.vuejs.org/zh/guide/css.html#引用静态资源) 可以选择 [style-resources-loader](https://github.com/yenshih/style-resources-loader)  和  [vue-cli-plugin-style-resources-loader](https://www.npmjs.com/package/vue-cli-plugin-style-resources-loader) 来引用资源。（见下图一）\n\n结果在debug样式的时候发现样式重复引入了，啥叫重复了呢，就是像下边这个样子，明明是同一段css，却被加载了N多次。\n\n![重复资源](http://img-ys011.didistatic.com/static/dc2img/do1_bfuBHyFYhpB8FBBSextw)\n\n原来  `vue-cli-plugin-style-resources-loader` 是会在每个vue文件中都注入依赖的代码，一般只把less变量放进去。像我这边这样，把的入口index.less文件都引进去，相当于在每个文件中都import了index.less一遍。\n\n```javascript\n//vue.config.js 图一\npluginOptions: {\n    'style-resources-loader': {\n      preProcessor: 'less',\n      patterns: [path.resolve(__dirname, 'src/styles/index.less')]\n    }\n  }\n```\n\n```less\n//vars.less 图二\n@blue-base: #2D77EE;\n@blue-light: #6C9FF3;\n@blue-middle-light: #DDE9FC;\n@blue-extra-light: #F3F7FE;\n@blue-lightest: #E4E5EA;\n@blue-active: #2A6BD4;\n@base-color: @blue-base;\n\n```\n\n\n\n### 结论 \n\n1. 全局less样式，可以在main.js中通过import引入，需要less变量的文件手动`@import vars.less`，比较清楚明白。\n2. 单独使用 [style-resources-loader](https://github.com/yenshih/style-resources-loader) 可以按图一的方式将index.less文件的作为样式入口文件引入，不会重复。注意一定不要安装  [vue-cli-plugin-style-resources-loader](https://www.npmjs.com/package/vue-cli-plugin-style-resources-loader) 组件。\n3. [style-resources-loader](https://github.com/yenshih/style-resources-loader)  和  [vue-cli-plugin-style-resources-loader](https://www.npmjs.com/package/vue-cli-plugin-style-resources-loader)  同时安装时，`vue.config.js` 中只能引入变量（如图二）。\n4. 比较推荐的方法是，index.less在main.js中引入，vars.less 等变量在vue.config.js中引入。\n\n","source":"_posts/vue-cli4加载css重复？.md","raw":"---\ntitle: vue-cli4加载css重复？\ndate: 2020-03-13 11:26:24\ntags: CSS\n---\n\nvue-cli引入css的正确姿势是什么？ vue-cli怎么避免重复引入css呢？\n\n------------\n\n### 问题\n\n最近用[single-spa](https://single-spa.js.org/)尝试重构项目,每个子项目用vue-cli初始化，瞧了一眼vue-cli都已经第四版了。我的css预编译框架选的less，本计划是像之前一样直接在main.js中直接 `import './styles/index.less';` 报错了（但是错误是啥不记得了），查了vue-cli的文档[CSS 相关](https://cli.vuejs.org/zh/guide/css.html#引用静态资源) 可以选择 [style-resources-loader](https://github.com/yenshih/style-resources-loader)  和  [vue-cli-plugin-style-resources-loader](https://www.npmjs.com/package/vue-cli-plugin-style-resources-loader) 来引用资源。（见下图一）\n\n结果在debug样式的时候发现样式重复引入了，啥叫重复了呢，就是像下边这个样子，明明是同一段css，却被加载了N多次。\n\n![重复资源](http://img-ys011.didistatic.com/static/dc2img/do1_bfuBHyFYhpB8FBBSextw)\n\n原来  `vue-cli-plugin-style-resources-loader` 是会在每个vue文件中都注入依赖的代码，一般只把less变量放进去。像我这边这样，把的入口index.less文件都引进去，相当于在每个文件中都import了index.less一遍。\n\n```javascript\n//vue.config.js 图一\npluginOptions: {\n    'style-resources-loader': {\n      preProcessor: 'less',\n      patterns: [path.resolve(__dirname, 'src/styles/index.less')]\n    }\n  }\n```\n\n```less\n//vars.less 图二\n@blue-base: #2D77EE;\n@blue-light: #6C9FF3;\n@blue-middle-light: #DDE9FC;\n@blue-extra-light: #F3F7FE;\n@blue-lightest: #E4E5EA;\n@blue-active: #2A6BD4;\n@base-color: @blue-base;\n\n```\n\n\n\n### 结论 \n\n1. 全局less样式，可以在main.js中通过import引入，需要less变量的文件手动`@import vars.less`，比较清楚明白。\n2. 单独使用 [style-resources-loader](https://github.com/yenshih/style-resources-loader) 可以按图一的方式将index.less文件的作为样式入口文件引入，不会重复。注意一定不要安装  [vue-cli-plugin-style-resources-loader](https://www.npmjs.com/package/vue-cli-plugin-style-resources-loader) 组件。\n3. [style-resources-loader](https://github.com/yenshih/style-resources-loader)  和  [vue-cli-plugin-style-resources-loader](https://www.npmjs.com/package/vue-cli-plugin-style-resources-loader)  同时安装时，`vue.config.js` 中只能引入变量（如图二）。\n4. 比较推荐的方法是，index.less在main.js中引入，vars.less 等变量在vue.config.js中引入。\n\n","slug":"vue-cli4加载css重复？","published":1,"updated":"2020-03-13T07:19:26.380Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckrix8zdv000xk1jfbzqmgqu2","content":"<p>vue-cli引入css的正确姿势是什么？ vue-cli怎么避免重复引入css呢？</p>\n<hr>\n<h3 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h3><p>最近用<a href=\"https://single-spa.js.org/\" target=\"_blank\" rel=\"noopener\">single-spa</a>尝试重构项目,每个子项目用vue-cli初始化，瞧了一眼vue-cli都已经第四版了。我的css预编译框架选的less，本计划是像之前一样直接在main.js中直接 <code>import &#39;./styles/index.less&#39;;</code> 报错了（但是错误是啥不记得了），查了vue-cli的文档<a href=\"https://cli.vuejs.org/zh/guide/css.html#引用静态资源\" target=\"_blank\" rel=\"noopener\">CSS 相关</a> 可以选择 <a href=\"https://github.com/yenshih/style-resources-loader\" target=\"_blank\" rel=\"noopener\">style-resources-loader</a>  和  <a href=\"https://www.npmjs.com/package/vue-cli-plugin-style-resources-loader\" target=\"_blank\" rel=\"noopener\">vue-cli-plugin-style-resources-loader</a> 来引用资源。（见下图一）</p>\n<p>结果在debug样式的时候发现样式重复引入了，啥叫重复了呢，就是像下边这个样子，明明是同一段css，却被加载了N多次。</p>\n<p><img src=\"http://img-ys011.didistatic.com/static/dc2img/do1_bfuBHyFYhpB8FBBSextw\" alt=\"重复资源\"></p>\n<p>原来  <code>vue-cli-plugin-style-resources-loader</code> 是会在每个vue文件中都注入依赖的代码，一般只把less变量放进去。像我这边这样，把的入口index.less文件都引进去，相当于在每个文件中都import了index.less一遍。</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//vue.config.js 图一</span></span><br><span class=\"line\">pluginOptions: &#123;</span><br><span class=\"line\">    <span class=\"string\">'style-resources-loader'</span>: &#123;</span><br><span class=\"line\">      preProcessor: <span class=\"string\">'less'</span>,</span><br><span class=\"line\">      patterns: [path.resolve(__dirname, <span class=\"string\">'src/styles/index.less'</span>)]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//vars.less 图二</span></span><br><span class=\"line\"><span class=\"variable\">@blue-base:</span> <span class=\"number\">#2D77EE</span>;</span><br><span class=\"line\"><span class=\"variable\">@blue-light:</span> <span class=\"number\">#6C9FF3</span>;</span><br><span class=\"line\"><span class=\"variable\">@blue-middle-light:</span> <span class=\"number\">#DDE9FC</span>;</span><br><span class=\"line\"><span class=\"variable\">@blue-extra-light:</span> <span class=\"number\">#F3F7FE</span>;</span><br><span class=\"line\"><span class=\"variable\">@blue-lightest:</span> <span class=\"number\">#E4E5EA</span>;</span><br><span class=\"line\"><span class=\"variable\">@blue-active:</span> <span class=\"number\">#2A6BD4</span>;</span><br><span class=\"line\"><span class=\"variable\">@base-color:</span> <span class=\"variable\">@blue-base</span>;</span><br></pre></td></tr></table></figure>\n<h3 id=\"结论\"><a href=\"#结论\" class=\"headerlink\" title=\"结论\"></a>结论</h3><ol>\n<li>全局less样式，可以在main.js中通过import引入，需要less变量的文件手动<code>@import vars.less</code>，比较清楚明白。</li>\n<li>单独使用 <a href=\"https://github.com/yenshih/style-resources-loader\" target=\"_blank\" rel=\"noopener\">style-resources-loader</a> 可以按图一的方式将index.less文件的作为样式入口文件引入，不会重复。注意一定不要安装  <a href=\"https://www.npmjs.com/package/vue-cli-plugin-style-resources-loader\" target=\"_blank\" rel=\"noopener\">vue-cli-plugin-style-resources-loader</a> 组件。</li>\n<li><a href=\"https://github.com/yenshih/style-resources-loader\" target=\"_blank\" rel=\"noopener\">style-resources-loader</a>  和  <a href=\"https://www.npmjs.com/package/vue-cli-plugin-style-resources-loader\" target=\"_blank\" rel=\"noopener\">vue-cli-plugin-style-resources-loader</a>  同时安装时，<code>vue.config.js</code> 中只能引入变量（如图二）。</li>\n<li>比较推荐的方法是，index.less在main.js中引入，vars.less 等变量在vue.config.js中引入。</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<p>vue-cli引入css的正确姿势是什么？ vue-cli怎么避免重复引入css呢？</p>\n<hr>\n<h3 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h3><p>最近用<a href=\"https://single-spa.js.org/\" target=\"_blank\" rel=\"noopener\">single-spa</a>尝试重构项目,每个子项目用vue-cli初始化，瞧了一眼vue-cli都已经第四版了。我的css预编译框架选的less，本计划是像之前一样直接在main.js中直接 <code>import &#39;./styles/index.less&#39;;</code> 报错了（但是错误是啥不记得了），查了vue-cli的文档<a href=\"https://cli.vuejs.org/zh/guide/css.html#引用静态资源\" target=\"_blank\" rel=\"noopener\">CSS 相关</a> 可以选择 <a href=\"https://github.com/yenshih/style-resources-loader\" target=\"_blank\" rel=\"noopener\">style-resources-loader</a>  和  <a href=\"https://www.npmjs.com/package/vue-cli-plugin-style-resources-loader\" target=\"_blank\" rel=\"noopener\">vue-cli-plugin-style-resources-loader</a> 来引用资源。（见下图一）</p>\n<p>结果在debug样式的时候发现样式重复引入了，啥叫重复了呢，就是像下边这个样子，明明是同一段css，却被加载了N多次。</p>\n<p><img src=\"http://img-ys011.didistatic.com/static/dc2img/do1_bfuBHyFYhpB8FBBSextw\" alt=\"重复资源\"></p>\n<p>原来  <code>vue-cli-plugin-style-resources-loader</code> 是会在每个vue文件中都注入依赖的代码，一般只把less变量放进去。像我这边这样，把的入口index.less文件都引进去，相当于在每个文件中都import了index.less一遍。</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//vue.config.js 图一</span></span><br><span class=\"line\">pluginOptions: &#123;</span><br><span class=\"line\">    <span class=\"string\">'style-resources-loader'</span>: &#123;</span><br><span class=\"line\">      preProcessor: <span class=\"string\">'less'</span>,</span><br><span class=\"line\">      patterns: [path.resolve(__dirname, <span class=\"string\">'src/styles/index.less'</span>)]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight less\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//vars.less 图二</span></span><br><span class=\"line\"><span class=\"variable\">@blue-base:</span> <span class=\"number\">#2D77EE</span>;</span><br><span class=\"line\"><span class=\"variable\">@blue-light:</span> <span class=\"number\">#6C9FF3</span>;</span><br><span class=\"line\"><span class=\"variable\">@blue-middle-light:</span> <span class=\"number\">#DDE9FC</span>;</span><br><span class=\"line\"><span class=\"variable\">@blue-extra-light:</span> <span class=\"number\">#F3F7FE</span>;</span><br><span class=\"line\"><span class=\"variable\">@blue-lightest:</span> <span class=\"number\">#E4E5EA</span>;</span><br><span class=\"line\"><span class=\"variable\">@blue-active:</span> <span class=\"number\">#2A6BD4</span>;</span><br><span class=\"line\"><span class=\"variable\">@base-color:</span> <span class=\"variable\">@blue-base</span>;</span><br></pre></td></tr></table></figure>\n<h3 id=\"结论\"><a href=\"#结论\" class=\"headerlink\" title=\"结论\"></a>结论</h3><ol>\n<li>全局less样式，可以在main.js中通过import引入，需要less变量的文件手动<code>@import vars.less</code>，比较清楚明白。</li>\n<li>单独使用 <a href=\"https://github.com/yenshih/style-resources-loader\" target=\"_blank\" rel=\"noopener\">style-resources-loader</a> 可以按图一的方式将index.less文件的作为样式入口文件引入，不会重复。注意一定不要安装  <a href=\"https://www.npmjs.com/package/vue-cli-plugin-style-resources-loader\" target=\"_blank\" rel=\"noopener\">vue-cli-plugin-style-resources-loader</a> 组件。</li>\n<li><a href=\"https://github.com/yenshih/style-resources-loader\" target=\"_blank\" rel=\"noopener\">style-resources-loader</a>  和  <a href=\"https://www.npmjs.com/package/vue-cli-plugin-style-resources-loader\" target=\"_blank\" rel=\"noopener\">vue-cli-plugin-style-resources-loader</a>  同时安装时，<code>vue.config.js</code> 中只能引入变量（如图二）。</li>\n<li>比较推荐的方法是，index.less在main.js中引入，vars.less 等变量在vue.config.js中引入。</li>\n</ol>\n"},{"title":"bakery性能优化","date":"2018-11-11T03:15:17.000Z","comments":1,"_content":"香满苑蛋糕屋的微信站bakery运行在了亚马逊云（1G内存+1核+8G硬盘），俄亥俄洲的主机上，平均有300ms的延迟，因为是试运行所以暂时也没有换的打算。在“时间就是金钱的”21世纪，性能优化就显得更为重要，主页load时间过长会让用户失去耐心，前端后台以及mongodb数据库的优化变得不可或缺。\n\n这里分前端、后台和数据库三部分来记录一下我说做的工作。\n\n### web前端的优化\n1. 代码的合并、压缩、增加md5的版本都是webpack做的，以及把文件打包成几个bundle文件。减少请求次数。\n2. 小图标根据需要缩小，不使用大图。1024*1024的图标直减为20*20。\n2. 小图标的合并，css雪碧图的使用，减少请求次数。\n3. 大量图片（包括雪碧图）从服务器拉取比较慢，上传到新浪微博的图床。\n4. code split。\n5. webpack热重载慢，webpack2升级到webpack3速度提高10倍；开发过程中就用普通路由，懒加载路由在webpack中会使cache失效。\n\n<div align=center>\n<img src ='/images/clipboard2.png'>\n</div>\n\n   从webpack的analysis中可以看出，资源文件打包成两个包。vendor较大，230k左右，app很小几十K。手机端浏览器大部分会同时拉取4个资源，根据木桶原理，最终完毕时间肯定由最慢的一个资源决定。所以将mint-ui的内容从vendor中转移到app中，两个大小都在150k左右。\n\n<div align=center>\n<img src ='/images/clipboard1.png'>\n</div>\n\n### node后台的优化\n\n1. 设置一个设置favicon.ico，不然每次都返回404。\n2. 后台开启gzip超级有效，大概压缩率打到75%，从上边code split中可以看出159k的可以直接压缩成54k传过来。（有关gzip还专门翻译了一篇文章：[how to optimieze your site with gzip](https://github.com/guguji5/blogs/blob/master/how%20to%20optimieze%20your%20site%20with%20gzip.md)）\n3. 占据渲染时间大半壁江山的都是图片，图片缓存很重要，从新浪图床上下载下来的，新浪服务器缓存的很好。少量从我服务器上的图通过IF-Modified-since/last-modified last-modified和if-none-match/etags来设置好缓存。未过期的值或者未变化的值浏览器端直接读取缓存。\n![设置过期时间](/images/clipboard.png)\n\n### 数据库和微信（菜鸟备忘）\n\n1. 指定需要返回的键\n\n    db.users.find({},{\"username\":1,\"email\":1})   比db.users.find() 然后再解析数据肯定是要快。\n2. mongodb启动时候要加用户名密码dbpath -auth，裸奔很危险。\n3. 用户表（user ）的收货人数组的id通过生成随机数的方式来使其保证唯一，可以换成$ne或者$addToSet来将数组作为数据集使用，保证数组内的元素不会重复。\n4. 评论放在产品详情（productDetail）表，然后把name和头像url都存进去。\ndb.blog.update({\"title\":\"a blog post\"},\n{$push:{\"commit\":\n{\"name\":\"jone\",\"headimgurl\":\"www.example.com/1.jpg\",\n\"content\":\"nice post\"}}})\n5. 微信端jsapi_ticket,access_token等数据都有每日最大请求次数和过期时间，需要缓存在数据库，通过[TTL](https://docs.mongodb.com/manual/tutorial/expire-data/)的设置来实现过期expires。","source":"_posts/bakery性能优化.md","raw":"---\ntitle: bakery性能优化\ndate: 2018-11-11 11:15:17\ntags: 优化\ncomments: true\n---\n香满苑蛋糕屋的微信站bakery运行在了亚马逊云（1G内存+1核+8G硬盘），俄亥俄洲的主机上，平均有300ms的延迟，因为是试运行所以暂时也没有换的打算。在“时间就是金钱的”21世纪，性能优化就显得更为重要，主页load时间过长会让用户失去耐心，前端后台以及mongodb数据库的优化变得不可或缺。\n\n这里分前端、后台和数据库三部分来记录一下我说做的工作。\n\n### web前端的优化\n1. 代码的合并、压缩、增加md5的版本都是webpack做的，以及把文件打包成几个bundle文件。减少请求次数。\n2. 小图标根据需要缩小，不使用大图。1024*1024的图标直减为20*20。\n2. 小图标的合并，css雪碧图的使用，减少请求次数。\n3. 大量图片（包括雪碧图）从服务器拉取比较慢，上传到新浪微博的图床。\n4. code split。\n5. webpack热重载慢，webpack2升级到webpack3速度提高10倍；开发过程中就用普通路由，懒加载路由在webpack中会使cache失效。\n\n<div align=center>\n<img src ='/images/clipboard2.png'>\n</div>\n\n   从webpack的analysis中可以看出，资源文件打包成两个包。vendor较大，230k左右，app很小几十K。手机端浏览器大部分会同时拉取4个资源，根据木桶原理，最终完毕时间肯定由最慢的一个资源决定。所以将mint-ui的内容从vendor中转移到app中，两个大小都在150k左右。\n\n<div align=center>\n<img src ='/images/clipboard1.png'>\n</div>\n\n### node后台的优化\n\n1. 设置一个设置favicon.ico，不然每次都返回404。\n2. 后台开启gzip超级有效，大概压缩率打到75%，从上边code split中可以看出159k的可以直接压缩成54k传过来。（有关gzip还专门翻译了一篇文章：[how to optimieze your site with gzip](https://github.com/guguji5/blogs/blob/master/how%20to%20optimieze%20your%20site%20with%20gzip.md)）\n3. 占据渲染时间大半壁江山的都是图片，图片缓存很重要，从新浪图床上下载下来的，新浪服务器缓存的很好。少量从我服务器上的图通过IF-Modified-since/last-modified last-modified和if-none-match/etags来设置好缓存。未过期的值或者未变化的值浏览器端直接读取缓存。\n![设置过期时间](/images/clipboard.png)\n\n### 数据库和微信（菜鸟备忘）\n\n1. 指定需要返回的键\n\n    db.users.find({},{\"username\":1,\"email\":1})   比db.users.find() 然后再解析数据肯定是要快。\n2. mongodb启动时候要加用户名密码dbpath -auth，裸奔很危险。\n3. 用户表（user ）的收货人数组的id通过生成随机数的方式来使其保证唯一，可以换成$ne或者$addToSet来将数组作为数据集使用，保证数组内的元素不会重复。\n4. 评论放在产品详情（productDetail）表，然后把name和头像url都存进去。\ndb.blog.update({\"title\":\"a blog post\"},\n{$push:{\"commit\":\n{\"name\":\"jone\",\"headimgurl\":\"www.example.com/1.jpg\",\n\"content\":\"nice post\"}}})\n5. 微信端jsapi_ticket,access_token等数据都有每日最大请求次数和过期时间，需要缓存在数据库，通过[TTL](https://docs.mongodb.com/manual/tutorial/expire-data/)的设置来实现过期expires。","slug":"bakery性能优化","published":1,"updated":"2018-11-11T04:26:58.000Z","layout":"post","photos":[],"link":"","_id":"ckrix8zdw000zk1jf02ey28wi","content":"<p>香满苑蛋糕屋的微信站bakery运行在了亚马逊云（1G内存+1核+8G硬盘），俄亥俄洲的主机上，平均有300ms的延迟，因为是试运行所以暂时也没有换的打算。在“时间就是金钱的”21世纪，性能优化就显得更为重要，主页load时间过长会让用户失去耐心，前端后台以及mongodb数据库的优化变得不可或缺。</p>\n<p>这里分前端、后台和数据库三部分来记录一下我说做的工作。</p>\n<h3 id=\"web前端的优化\"><a href=\"#web前端的优化\" class=\"headerlink\" title=\"web前端的优化\"></a>web前端的优化</h3><ol>\n<li>代码的合并、压缩、增加md5的版本都是webpack做的，以及把文件打包成几个bundle文件。减少请求次数。</li>\n<li>小图标根据需要缩小，不使用大图。1024<em>1024的图标直减为20</em>20。</li>\n<li>小图标的合并，css雪碧图的使用，减少请求次数。</li>\n<li>大量图片（包括雪碧图）从服务器拉取比较慢，上传到新浪微博的图床。</li>\n<li>code split。</li>\n<li>webpack热重载慢，webpack2升级到webpack3速度提高10倍；开发过程中就用普通路由，懒加载路由在webpack中会使cache失效。</li>\n</ol>\n<div align=\"center\"><br><img src=\"/images/clipboard2.png\"><br></div>\n\n<p>   从webpack的analysis中可以看出，资源文件打包成两个包。vendor较大，230k左右，app很小几十K。手机端浏览器大部分会同时拉取4个资源，根据木桶原理，最终完毕时间肯定由最慢的一个资源决定。所以将mint-ui的内容从vendor中转移到app中，两个大小都在150k左右。</p>\n<div align=\"center\"><br><img src=\"/images/clipboard1.png\"><br></div>\n\n<h3 id=\"node后台的优化\"><a href=\"#node后台的优化\" class=\"headerlink\" title=\"node后台的优化\"></a>node后台的优化</h3><ol>\n<li>设置一个设置favicon.ico，不然每次都返回404。</li>\n<li>后台开启gzip超级有效，大概压缩率打到75%，从上边code split中可以看出159k的可以直接压缩成54k传过来。（有关gzip还专门翻译了一篇文章：<a href=\"https://github.com/guguji5/blogs/blob/master/how%20to%20optimieze%20your%20site%20with%20gzip.md\" target=\"_blank\" rel=\"noopener\">how to optimieze your site with gzip</a>）</li>\n<li>占据渲染时间大半壁江山的都是图片，图片缓存很重要，从新浪图床上下载下来的，新浪服务器缓存的很好。少量从我服务器上的图通过IF-Modified-since/last-modified last-modified和if-none-match/etags来设置好缓存。未过期的值或者未变化的值浏览器端直接读取缓存。<br><img src=\"/images/clipboard.png\" alt=\"设置过期时间\"></li>\n</ol>\n<h3 id=\"数据库和微信（菜鸟备忘）\"><a href=\"#数据库和微信（菜鸟备忘）\" class=\"headerlink\" title=\"数据库和微信（菜鸟备忘）\"></a>数据库和微信（菜鸟备忘）</h3><ol>\n<li><p>指定需要返回的键</p>\n<p> db.users.find({},{“username”:1,”email”:1})   比db.users.find() 然后再解析数据肯定是要快。</p>\n</li>\n<li>mongodb启动时候要加用户名密码dbpath -auth，裸奔很危险。</li>\n<li>用户表（user ）的收货人数组的id通过生成随机数的方式来使其保证唯一，可以换成$ne或者$addToSet来将数组作为数据集使用，保证数组内的元素不会重复。</li>\n<li>评论放在产品详情（productDetail）表，然后把name和头像url都存进去。<br>db.blog.update({“title”:”a blog post”},<br>{$push:{“commit”:<br>{“name”:”jone”,”headimgurl”:”<a href=\"http://www.example.com/1.jpg&quot;\" target=\"_blank\" rel=\"noopener\">www.example.com/1.jpg&quot;</a>,<br>“content”:”nice post”}}})</li>\n<li>微信端jsapi_ticket,access_token等数据都有每日最大请求次数和过期时间，需要缓存在数据库，通过<a href=\"https://docs.mongodb.com/manual/tutorial/expire-data/\" target=\"_blank\" rel=\"noopener\">TTL</a>的设置来实现过期expires。</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<p>香满苑蛋糕屋的微信站bakery运行在了亚马逊云（1G内存+1核+8G硬盘），俄亥俄洲的主机上，平均有300ms的延迟，因为是试运行所以暂时也没有换的打算。在“时间就是金钱的”21世纪，性能优化就显得更为重要，主页load时间过长会让用户失去耐心，前端后台以及mongodb数据库的优化变得不可或缺。</p>\n<p>这里分前端、后台和数据库三部分来记录一下我说做的工作。</p>\n<h3 id=\"web前端的优化\"><a href=\"#web前端的优化\" class=\"headerlink\" title=\"web前端的优化\"></a>web前端的优化</h3><ol>\n<li>代码的合并、压缩、增加md5的版本都是webpack做的，以及把文件打包成几个bundle文件。减少请求次数。</li>\n<li>小图标根据需要缩小，不使用大图。1024<em>1024的图标直减为20</em>20。</li>\n<li>小图标的合并，css雪碧图的使用，减少请求次数。</li>\n<li>大量图片（包括雪碧图）从服务器拉取比较慢，上传到新浪微博的图床。</li>\n<li>code split。</li>\n<li>webpack热重载慢，webpack2升级到webpack3速度提高10倍；开发过程中就用普通路由，懒加载路由在webpack中会使cache失效。</li>\n</ol>\n<div align=\"center\"><br><img src=\"/images/clipboard2.png\"><br></div>\n\n<p>   从webpack的analysis中可以看出，资源文件打包成两个包。vendor较大，230k左右，app很小几十K。手机端浏览器大部分会同时拉取4个资源，根据木桶原理，最终完毕时间肯定由最慢的一个资源决定。所以将mint-ui的内容从vendor中转移到app中，两个大小都在150k左右。</p>\n<div align=\"center\"><br><img src=\"/images/clipboard1.png\"><br></div>\n\n<h3 id=\"node后台的优化\"><a href=\"#node后台的优化\" class=\"headerlink\" title=\"node后台的优化\"></a>node后台的优化</h3><ol>\n<li>设置一个设置favicon.ico，不然每次都返回404。</li>\n<li>后台开启gzip超级有效，大概压缩率打到75%，从上边code split中可以看出159k的可以直接压缩成54k传过来。（有关gzip还专门翻译了一篇文章：<a href=\"https://github.com/guguji5/blogs/blob/master/how%20to%20optimieze%20your%20site%20with%20gzip.md\" target=\"_blank\" rel=\"noopener\">how to optimieze your site with gzip</a>）</li>\n<li>占据渲染时间大半壁江山的都是图片，图片缓存很重要，从新浪图床上下载下来的，新浪服务器缓存的很好。少量从我服务器上的图通过IF-Modified-since/last-modified last-modified和if-none-match/etags来设置好缓存。未过期的值或者未变化的值浏览器端直接读取缓存。<br><img src=\"/images/clipboard.png\" alt=\"设置过期时间\"></li>\n</ol>\n<h3 id=\"数据库和微信（菜鸟备忘）\"><a href=\"#数据库和微信（菜鸟备忘）\" class=\"headerlink\" title=\"数据库和微信（菜鸟备忘）\"></a>数据库和微信（菜鸟备忘）</h3><ol>\n<li><p>指定需要返回的键</p>\n<p> db.users.find({},{“username”:1,”email”:1})   比db.users.find() 然后再解析数据肯定是要快。</p>\n</li>\n<li>mongodb启动时候要加用户名密码dbpath -auth，裸奔很危险。</li>\n<li>用户表（user ）的收货人数组的id通过生成随机数的方式来使其保证唯一，可以换成$ne或者$addToSet来将数组作为数据集使用，保证数组内的元素不会重复。</li>\n<li>评论放在产品详情（productDetail）表，然后把name和头像url都存进去。<br>db.blog.update({“title”:”a blog post”},<br>{$push:{“commit”:<br>{“name”:”jone”,”headimgurl”:”<a href=\"http://www.example.com/1.jpg&quot;\" target=\"_blank\" rel=\"noopener\">www.example.com/1.jpg&quot;</a>,<br>“content”:”nice post”}}})</li>\n<li>微信端jsapi_ticket,access_token等数据都有每日最大请求次数和过期时间，需要缓存在数据库，通过<a href=\"https://docs.mongodb.com/manual/tutorial/expire-data/\" target=\"_blank\" rel=\"noopener\">TTL</a>的设置来实现过期expires。</li>\n</ol>\n"},{"title":"信封弹出特效(可能是从业以来最复杂的效果)","date":"2020-09-29T06:09:41.000Z","comments":1,"_content":"\n作为一个前端，也是希望可以实现各种炫酷的效果的，比如[3D效果](https://guguji5.js.org/3d/)，但是一直供职于toB的公司，实现炫酷效果的机会很少，这个信封弹出可能是从业以来实现的最复杂的一个效果。设计给的效果如下：\n\n<video id=\"video\" controls=\"\" preload=\"none\" poster=\"http://img-ys011.didistatic.com/static/dc2img/envelop.png\">\n    <source id=\"mp4\" src=\"http://img-ys011.didistatic.com/static/dc2img/envelop-effect.mp4\" type=\"video/mp4\">\n</video>\n\n刚开始心里一慌，先把其他表单，表格，弹窗等简单的实现完以后，再来冷静的分析了一波。其实设计给的效果和日常我们打开信封的动作是一样的，所以不存在理解的上的成本。将mp4慢放后分析后，发现信封的上，下，前 以及信纸都会动，还有信封上的徽章和button都有渐变和移动效果，所以需要将信封的拆成各个部分，分别做绝对定位。\n\n# 动画\n\n- 点击\"敬启\"后高亮，并向上移动10px\n- 整个信封向下平移100px\n- \"敬启\"消失，滴滴云logo消失\n- 信封上半部沿Z轴向外旋转180度，同时z-index下降，信封正面慢慢向下\n- 信封下半部分沿Z轴转动小幅度\n- 信纸弹出，\"随便看看\"淡入\n\n还有一个点需要注意，刚开始是信封上边压着信封下边，一起压着信纸，但是弹开后信纸需要压在信封上面。所以就需要z-index的变化。\n\n因为信封是有多个图片构成，所以首次展示会出现展示慢的情况,如下图，信纸先于信封展示出来，不符合预期，需要优化。\n![](/images/envelop-mess.png)\n\n# 优化思路：\n- 信纸内元素有文案和icon，而信封图片较大，所以一方面先将信纸隐藏，信封打开前再展示\n- 信封图片有1.1M，压缩之\n- 大图片存放cdn\n\n# 预览\n\n效果链接：https://guguji5.js.org/envelop-popup/","source":"_posts/信封弹出特效-可能是从业以来最复杂的效果.md","raw":"---\ntitle: 信封弹出特效(可能是从业以来最复杂的效果)\ndate: 2020-09-29 14:09:41\ntags:\ncomments: true\n---\n\n作为一个前端，也是希望可以实现各种炫酷的效果的，比如[3D效果](https://guguji5.js.org/3d/)，但是一直供职于toB的公司，实现炫酷效果的机会很少，这个信封弹出可能是从业以来实现的最复杂的一个效果。设计给的效果如下：\n\n<video id=\"video\" controls=\"\" preload=\"none\" poster=\"http://img-ys011.didistatic.com/static/dc2img/envelop.png\">\n    <source id=\"mp4\" src=\"http://img-ys011.didistatic.com/static/dc2img/envelop-effect.mp4\" type=\"video/mp4\">\n</video>\n\n刚开始心里一慌，先把其他表单，表格，弹窗等简单的实现完以后，再来冷静的分析了一波。其实设计给的效果和日常我们打开信封的动作是一样的，所以不存在理解的上的成本。将mp4慢放后分析后，发现信封的上，下，前 以及信纸都会动，还有信封上的徽章和button都有渐变和移动效果，所以需要将信封的拆成各个部分，分别做绝对定位。\n\n# 动画\n\n- 点击\"敬启\"后高亮，并向上移动10px\n- 整个信封向下平移100px\n- \"敬启\"消失，滴滴云logo消失\n- 信封上半部沿Z轴向外旋转180度，同时z-index下降，信封正面慢慢向下\n- 信封下半部分沿Z轴转动小幅度\n- 信纸弹出，\"随便看看\"淡入\n\n还有一个点需要注意，刚开始是信封上边压着信封下边，一起压着信纸，但是弹开后信纸需要压在信封上面。所以就需要z-index的变化。\n\n因为信封是有多个图片构成，所以首次展示会出现展示慢的情况,如下图，信纸先于信封展示出来，不符合预期，需要优化。\n![](/images/envelop-mess.png)\n\n# 优化思路：\n- 信纸内元素有文案和icon，而信封图片较大，所以一方面先将信纸隐藏，信封打开前再展示\n- 信封图片有1.1M，压缩之\n- 大图片存放cdn\n\n# 预览\n\n效果链接：https://guguji5.js.org/envelop-popup/","slug":"信封弹出特效-可能是从业以来最复杂的效果","published":1,"updated":"2020-09-29T10:09:25.081Z","layout":"post","photos":[],"link":"","_id":"ckrix8zdx0011k1jfmtq2gfgg","content":"<p>作为一个前端，也是希望可以实现各种炫酷的效果的，比如<a href=\"https://guguji5.js.org/3d/\" target=\"_blank\" rel=\"noopener\">3D效果</a>，但是一直供职于toB的公司，实现炫酷效果的机会很少，这个信封弹出可能是从业以来实现的最复杂的一个效果。设计给的效果如下：</p>\n<video id=\"video\" controls preload=\"none\" poster=\"http://img-ys011.didistatic.com/static/dc2img/envelop.png\"><br>    <source id=\"mp4\" src=\"http://img-ys011.didistatic.com/static/dc2img/envelop-effect.mp4\" type=\"video/mp4\"><br></video>\n\n<p>刚开始心里一慌，先把其他表单，表格，弹窗等简单的实现完以后，再来冷静的分析了一波。其实设计给的效果和日常我们打开信封的动作是一样的，所以不存在理解的上的成本。将mp4慢放后分析后，发现信封的上，下，前 以及信纸都会动，还有信封上的徽章和button都有渐变和移动效果，所以需要将信封的拆成各个部分，分别做绝对定位。</p>\n<h1 id=\"动画\"><a href=\"#动画\" class=\"headerlink\" title=\"动画\"></a>动画</h1><ul>\n<li>点击”敬启”后高亮，并向上移动10px</li>\n<li>整个信封向下平移100px</li>\n<li>“敬启”消失，滴滴云logo消失</li>\n<li>信封上半部沿Z轴向外旋转180度，同时z-index下降，信封正面慢慢向下</li>\n<li>信封下半部分沿Z轴转动小幅度</li>\n<li>信纸弹出，”随便看看”淡入</li>\n</ul>\n<p>还有一个点需要注意，刚开始是信封上边压着信封下边，一起压着信纸，但是弹开后信纸需要压在信封上面。所以就需要z-index的变化。</p>\n<p>因为信封是有多个图片构成，所以首次展示会出现展示慢的情况,如下图，信纸先于信封展示出来，不符合预期，需要优化。<br><img src=\"/images/envelop-mess.png\" alt=\"\"></p>\n<h1 id=\"优化思路：\"><a href=\"#优化思路：\" class=\"headerlink\" title=\"优化思路：\"></a>优化思路：</h1><ul>\n<li>信纸内元素有文案和icon，而信封图片较大，所以一方面先将信纸隐藏，信封打开前再展示</li>\n<li>信封图片有1.1M，压缩之</li>\n<li>大图片存放cdn</li>\n</ul>\n<h1 id=\"预览\"><a href=\"#预览\" class=\"headerlink\" title=\"预览\"></a>预览</h1><p>效果链接：<a href=\"https://guguji5.js.org/envelop-popup/\" target=\"_blank\" rel=\"noopener\">https://guguji5.js.org/envelop-popup/</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>作为一个前端，也是希望可以实现各种炫酷的效果的，比如<a href=\"https://guguji5.js.org/3d/\" target=\"_blank\" rel=\"noopener\">3D效果</a>，但是一直供职于toB的公司，实现炫酷效果的机会很少，这个信封弹出可能是从业以来实现的最复杂的一个效果。设计给的效果如下：</p>\n<video id=\"video\" controls preload=\"none\" poster=\"http://img-ys011.didistatic.com/static/dc2img/envelop.png\"><br>    <source id=\"mp4\" src=\"http://img-ys011.didistatic.com/static/dc2img/envelop-effect.mp4\" type=\"video/mp4\"><br></video>\n\n<p>刚开始心里一慌，先把其他表单，表格，弹窗等简单的实现完以后，再来冷静的分析了一波。其实设计给的效果和日常我们打开信封的动作是一样的，所以不存在理解的上的成本。将mp4慢放后分析后，发现信封的上，下，前 以及信纸都会动，还有信封上的徽章和button都有渐变和移动效果，所以需要将信封的拆成各个部分，分别做绝对定位。</p>\n<h1 id=\"动画\"><a href=\"#动画\" class=\"headerlink\" title=\"动画\"></a>动画</h1><ul>\n<li>点击”敬启”后高亮，并向上移动10px</li>\n<li>整个信封向下平移100px</li>\n<li>“敬启”消失，滴滴云logo消失</li>\n<li>信封上半部沿Z轴向外旋转180度，同时z-index下降，信封正面慢慢向下</li>\n<li>信封下半部分沿Z轴转动小幅度</li>\n<li>信纸弹出，”随便看看”淡入</li>\n</ul>\n<p>还有一个点需要注意，刚开始是信封上边压着信封下边，一起压着信纸，但是弹开后信纸需要压在信封上面。所以就需要z-index的变化。</p>\n<p>因为信封是有多个图片构成，所以首次展示会出现展示慢的情况,如下图，信纸先于信封展示出来，不符合预期，需要优化。<br><img src=\"/images/envelop-mess.png\" alt=\"\"></p>\n<h1 id=\"优化思路：\"><a href=\"#优化思路：\" class=\"headerlink\" title=\"优化思路：\"></a>优化思路：</h1><ul>\n<li>信纸内元素有文案和icon，而信封图片较大，所以一方面先将信纸隐藏，信封打开前再展示</li>\n<li>信封图片有1.1M，压缩之</li>\n<li>大图片存放cdn</li>\n</ul>\n<h1 id=\"预览\"><a href=\"#预览\" class=\"headerlink\" title=\"预览\"></a>预览</h1><p>效果链接：<a href=\"https://guguji5.js.org/envelop-popup/\" target=\"_blank\" rel=\"noopener\">https://guguji5.js.org/envelop-popup/</a></p>\n"},{"title":"前端需要知道的nginx知识","date":"2020-05-08T08:12:53.000Z","_content":"看来我必须得写点前端需要掌握的nginx知识了，每次都浪费我好多好多的时间。\n\n# 1. proxy_pass\n具体的可以见 https://blog.csdn.net/u010433704/article/details/99945557 这个链接，使用场景是，当我们有很多机器，但是只有一个域名时，可以通过不同的location来转发到不同的机器上。\n\n# 2. gzip\n有关gzip的介绍，可以参考这个[如何使用GZIP来优化你的网站](https://guguji5.js.org/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8GZIP%E6%9D%A5%E4%BC%98%E5%8C%96%E4%BD%A0%E7%9A%84%E7%BD%91%E7%AB%99/)，在nginx开启gzip很简单，但是proxy_pass 和 gzip配合起来，有些好坑，https://reinout.vanrees.org/weblog/2015/11/19/nginx-proxy-gzip.html 这个链接解释了如何操作。\n\n# 3. upstream 负载均衡\nnginx的一个重要功能就是负载均衡，可以使用upstream来实现。负载均衡的策略可以有很多种，hash，requestUrl，轮询等待。\n```\nupstream helloworld {\n  server 10.133.25.1:8080;\n  server 10.160.60.75:8080;\n}\n\nserver {\n    listen 8080;\n    server_name www.example.com;\n    root /home/demo/public;\n\n    location / {\n        add_header Access-Control-Allow-Origin *;\n        add_header 'Access-Control-Allow-Credentials' 'true';\n        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';\n        try_files $uri $uri.html /index.html =404;\n    }\n\n    location /home/ {\n        proxy_pass http://helloworld/;\n    }\n\n}\n```","source":"_posts/前端需要知道的nginx知识.md","raw":"---\ntitle: 前端需要知道的nginx知识\ndate: 2020-05-08 16:12:53\ntags: nginx\n---\n看来我必须得写点前端需要掌握的nginx知识了，每次都浪费我好多好多的时间。\n\n# 1. proxy_pass\n具体的可以见 https://blog.csdn.net/u010433704/article/details/99945557 这个链接，使用场景是，当我们有很多机器，但是只有一个域名时，可以通过不同的location来转发到不同的机器上。\n\n# 2. gzip\n有关gzip的介绍，可以参考这个[如何使用GZIP来优化你的网站](https://guguji5.js.org/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8GZIP%E6%9D%A5%E4%BC%98%E5%8C%96%E4%BD%A0%E7%9A%84%E7%BD%91%E7%AB%99/)，在nginx开启gzip很简单，但是proxy_pass 和 gzip配合起来，有些好坑，https://reinout.vanrees.org/weblog/2015/11/19/nginx-proxy-gzip.html 这个链接解释了如何操作。\n\n# 3. upstream 负载均衡\nnginx的一个重要功能就是负载均衡，可以使用upstream来实现。负载均衡的策略可以有很多种，hash，requestUrl，轮询等待。\n```\nupstream helloworld {\n  server 10.133.25.1:8080;\n  server 10.160.60.75:8080;\n}\n\nserver {\n    listen 8080;\n    server_name www.example.com;\n    root /home/demo/public;\n\n    location / {\n        add_header Access-Control-Allow-Origin *;\n        add_header 'Access-Control-Allow-Credentials' 'true';\n        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';\n        try_files $uri $uri.html /index.html =404;\n    }\n\n    location /home/ {\n        proxy_pass http://helloworld/;\n    }\n\n}\n```","slug":"前端需要知道的nginx知识","published":1,"updated":"2020-05-17T15:05:11.223Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckrix8zdy0013k1jf386kpyq1","content":"<p>看来我必须得写点前端需要掌握的nginx知识了，每次都浪费我好多好多的时间。</p>\n<h1 id=\"1-proxy-pass\"><a href=\"#1-proxy-pass\" class=\"headerlink\" title=\"1. proxy_pass\"></a>1. proxy_pass</h1><p>具体的可以见 <a href=\"https://blog.csdn.net/u010433704/article/details/99945557\" target=\"_blank\" rel=\"noopener\">https://blog.csdn.net/u010433704/article/details/99945557</a> 这个链接，使用场景是，当我们有很多机器，但是只有一个域名时，可以通过不同的location来转发到不同的机器上。</p>\n<h1 id=\"2-gzip\"><a href=\"#2-gzip\" class=\"headerlink\" title=\"2. gzip\"></a>2. gzip</h1><p>有关gzip的介绍，可以参考这个<a href=\"https://guguji5.js.org/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8GZIP%E6%9D%A5%E4%BC%98%E5%8C%96%E4%BD%A0%E7%9A%84%E7%BD%91%E7%AB%99/\" target=\"_blank\" rel=\"noopener\">如何使用GZIP来优化你的网站</a>，在nginx开启gzip很简单，但是proxy_pass 和 gzip配合起来，有些好坑，<a href=\"https://reinout.vanrees.org/weblog/2015/11/19/nginx-proxy-gzip.html\" target=\"_blank\" rel=\"noopener\">https://reinout.vanrees.org/weblog/2015/11/19/nginx-proxy-gzip.html</a> 这个链接解释了如何操作。</p>\n<h1 id=\"3-upstream-负载均衡\"><a href=\"#3-upstream-负载均衡\" class=\"headerlink\" title=\"3. upstream 负载均衡\"></a>3. upstream 负载均衡</h1><p>nginx的一个重要功能就是负载均衡，可以使用upstream来实现。负载均衡的策略可以有很多种，hash，requestUrl，轮询等待。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">upstream helloworld &#123;</span><br><span class=\"line\">  server 10.133.25.1:8080;</span><br><span class=\"line\">  server 10.160.60.75:8080;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen 8080;</span><br><span class=\"line\">    server_name www.example.com;</span><br><span class=\"line\">    root /home/demo/public;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        add_header Access-Control-Allow-Origin *;</span><br><span class=\"line\">        add_header &apos;Access-Control-Allow-Credentials&apos; &apos;true&apos;;</span><br><span class=\"line\">        add_header &apos;Access-Control-Allow-Methods&apos; &apos;GET, POST, OPTIONS&apos;;</span><br><span class=\"line\">        try_files $uri $uri.html /index.html =404;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    location /home/ &#123;</span><br><span class=\"line\">        proxy_pass http://helloworld/;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n","site":{"data":{}},"excerpt":"","more":"<p>看来我必须得写点前端需要掌握的nginx知识了，每次都浪费我好多好多的时间。</p>\n<h1 id=\"1-proxy-pass\"><a href=\"#1-proxy-pass\" class=\"headerlink\" title=\"1. proxy_pass\"></a>1. proxy_pass</h1><p>具体的可以见 <a href=\"https://blog.csdn.net/u010433704/article/details/99945557\" target=\"_blank\" rel=\"noopener\">https://blog.csdn.net/u010433704/article/details/99945557</a> 这个链接，使用场景是，当我们有很多机器，但是只有一个域名时，可以通过不同的location来转发到不同的机器上。</p>\n<h1 id=\"2-gzip\"><a href=\"#2-gzip\" class=\"headerlink\" title=\"2. gzip\"></a>2. gzip</h1><p>有关gzip的介绍，可以参考这个<a href=\"https://guguji5.js.org/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8GZIP%E6%9D%A5%E4%BC%98%E5%8C%96%E4%BD%A0%E7%9A%84%E7%BD%91%E7%AB%99/\" target=\"_blank\" rel=\"noopener\">如何使用GZIP来优化你的网站</a>，在nginx开启gzip很简单，但是proxy_pass 和 gzip配合起来，有些好坑，<a href=\"https://reinout.vanrees.org/weblog/2015/11/19/nginx-proxy-gzip.html\" target=\"_blank\" rel=\"noopener\">https://reinout.vanrees.org/weblog/2015/11/19/nginx-proxy-gzip.html</a> 这个链接解释了如何操作。</p>\n<h1 id=\"3-upstream-负载均衡\"><a href=\"#3-upstream-负载均衡\" class=\"headerlink\" title=\"3. upstream 负载均衡\"></a>3. upstream 负载均衡</h1><p>nginx的一个重要功能就是负载均衡，可以使用upstream来实现。负载均衡的策略可以有很多种，hash，requestUrl，轮询等待。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">upstream helloworld &#123;</span><br><span class=\"line\">  server 10.133.25.1:8080;</span><br><span class=\"line\">  server 10.160.60.75:8080;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen 8080;</span><br><span class=\"line\">    server_name www.example.com;</span><br><span class=\"line\">    root /home/demo/public;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        add_header Access-Control-Allow-Origin *;</span><br><span class=\"line\">        add_header &apos;Access-Control-Allow-Credentials&apos; &apos;true&apos;;</span><br><span class=\"line\">        add_header &apos;Access-Control-Allow-Methods&apos; &apos;GET, POST, OPTIONS&apos;;</span><br><span class=\"line\">        try_files $uri $uri.html /index.html =404;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    location /home/ &#123;</span><br><span class=\"line\">        proxy_pass http://helloworld/;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n"},{"title":"证明：Click是一个EventLoop宏任务","date":"2021-01-26T01:39:14.000Z","_content":"\n#### 如题，证明Click是一个EventLoop宏任务\n\nJavaScript中事件根据同步异步可以分为哪些类型呢，无非就是 同步（立马执行）和 异步（延迟执行）。而异步又分为宏任务（marcoTask 有的地方也叫Task）和微任务（microTask）。综上，JavaScript中的事件可以分为同步，宏任务和微任务。\n\nEventLoop的讲解可以看看[阮一峰博客event-loop](http://www.ruanyifeng.com/blog/2014/10/event-loop.html)或[MDN的解释](https://developer.mozilla.org/en-US/docs/Web/JavaScript/EventLoop)\n\n那么如何证明，Click是一个宏任务呢，它似乎也没有一个定义，那让我们用反证法来证明一下吧。首先让我们看个例子。 https://guguji5.github.io/clickIsMacroEvent/\n```\n<div id=\"outter\">\n    outter\n    <div id=\"inner\">\n        <span>inner</span>\n        点我，猜猜console\n    </div>\n</div>\n\nvar out = document.getElementById('outter')\nvar inner = document.getElementById('inner')\nout.addEventListener('click', function(){\n    console.log('outter')\n    setTimeout(function() {\n        console.log('this is outter settimeout')\n    })\n    Promise.resolve(111).then(res =>{\n        console.log('this is outter promise')\n    })\n})\n\ninner.addEventListener('click', function(){\n    console.log('inner')\n    setTimeout(function() {\n        console.log('this is inner settimeout')\n    })\n    Promise.resolve(111).then(res =>{\n        console.log('this is inner promise')\n    })\n})\n```\n![](http://img-ys011.didistatic.com/static/dc2img/clickismarcoevent.png)\n\n#### 如果Click事件是同步的\n```\ninner\noutter\nthis is inner promise\nthis is outter promise\nthis is inner settimeout\nthis is outter settimeout\n```\n\n#### 如果Click事件是微任务的\n```\n// 如果click是微任务，刚开始则 微任务队列中为[inner listener, outter listener]，宏任务队列为[]\ninner //执行inner的click listener，console.log同步代码立即执行，微任务队列中push进promise的then 为 [outter listener, inner then]，宏任务中push为 [inner setTimeout]\noutter //执行outter的click listener，console.log同步代码立即执行，微任务队列中push进promise的then 为 [inner then, outter then]，宏任务中再push进setTimeout，为[inner setTimeout, outter setTimeout]\nthis is inner promise\nthis is outter promise //先情况微任务队列，再执行宏任务\nthis is inner settimeout\nthis is outter settimeout\n```\n\n哪个是真的呢，可以试验一下 https://guguji5.github.io/clickIsMacroEvent/ \n**显然同步是不对的，毕竟是IO，肯定异步的。如果是微任务，则输出应该是第二种，也不相符，由此得出是宏任务。**\n\n#### 如果Click事件是宏任务的\n```\n// 如果click是宏任务 宏任务队列中为[inner listener, outter listener]，微任务队列为[]\ninner //执行inner的click listener，console.log同步代码立即执行，微任务队列中push进promise的then 为 [inner then]，宏任务中push进setTimeout 为 [outter listener, inner setTimeout]\n// 如果是click是一个宏任务，那么应该先清空微任务队列，再执行宏任务，则执行then\nthis is inner promise\n// 微任务队列为空，执行一个宏任务task：outter listener\noutter //执行outter的click listener，console.log同步代码立即执行，微任务队列中push进promise的then，宏任务中再push进setTimeout，为两个setTimeout\nthis is outter promise //先情况微任务队列，再执行宏任务\nthis is inner settimeout\nthis is outter settimeout\n```\n\n*https://developer.mozilla.org/en-US/docs/Web/JavaScript/EventLoop*\n*http://www.ruanyifeng.com/blog/2014/10/event-loop.html*\n","source":"_posts/证明：Click是一个EventLoop宏任务.md","raw":"---\ntitle: 证明：Click是一个EventLoop宏任务\ndate: 2021-01-26 9:39:14\ntags: \n---\n\n#### 如题，证明Click是一个EventLoop宏任务\n\nJavaScript中事件根据同步异步可以分为哪些类型呢，无非就是 同步（立马执行）和 异步（延迟执行）。而异步又分为宏任务（marcoTask 有的地方也叫Task）和微任务（microTask）。综上，JavaScript中的事件可以分为同步，宏任务和微任务。\n\nEventLoop的讲解可以看看[阮一峰博客event-loop](http://www.ruanyifeng.com/blog/2014/10/event-loop.html)或[MDN的解释](https://developer.mozilla.org/en-US/docs/Web/JavaScript/EventLoop)\n\n那么如何证明，Click是一个宏任务呢，它似乎也没有一个定义，那让我们用反证法来证明一下吧。首先让我们看个例子。 https://guguji5.github.io/clickIsMacroEvent/\n```\n<div id=\"outter\">\n    outter\n    <div id=\"inner\">\n        <span>inner</span>\n        点我，猜猜console\n    </div>\n</div>\n\nvar out = document.getElementById('outter')\nvar inner = document.getElementById('inner')\nout.addEventListener('click', function(){\n    console.log('outter')\n    setTimeout(function() {\n        console.log('this is outter settimeout')\n    })\n    Promise.resolve(111).then(res =>{\n        console.log('this is outter promise')\n    })\n})\n\ninner.addEventListener('click', function(){\n    console.log('inner')\n    setTimeout(function() {\n        console.log('this is inner settimeout')\n    })\n    Promise.resolve(111).then(res =>{\n        console.log('this is inner promise')\n    })\n})\n```\n![](http://img-ys011.didistatic.com/static/dc2img/clickismarcoevent.png)\n\n#### 如果Click事件是同步的\n```\ninner\noutter\nthis is inner promise\nthis is outter promise\nthis is inner settimeout\nthis is outter settimeout\n```\n\n#### 如果Click事件是微任务的\n```\n// 如果click是微任务，刚开始则 微任务队列中为[inner listener, outter listener]，宏任务队列为[]\ninner //执行inner的click listener，console.log同步代码立即执行，微任务队列中push进promise的then 为 [outter listener, inner then]，宏任务中push为 [inner setTimeout]\noutter //执行outter的click listener，console.log同步代码立即执行，微任务队列中push进promise的then 为 [inner then, outter then]，宏任务中再push进setTimeout，为[inner setTimeout, outter setTimeout]\nthis is inner promise\nthis is outter promise //先情况微任务队列，再执行宏任务\nthis is inner settimeout\nthis is outter settimeout\n```\n\n哪个是真的呢，可以试验一下 https://guguji5.github.io/clickIsMacroEvent/ \n**显然同步是不对的，毕竟是IO，肯定异步的。如果是微任务，则输出应该是第二种，也不相符，由此得出是宏任务。**\n\n#### 如果Click事件是宏任务的\n```\n// 如果click是宏任务 宏任务队列中为[inner listener, outter listener]，微任务队列为[]\ninner //执行inner的click listener，console.log同步代码立即执行，微任务队列中push进promise的then 为 [inner then]，宏任务中push进setTimeout 为 [outter listener, inner setTimeout]\n// 如果是click是一个宏任务，那么应该先清空微任务队列，再执行宏任务，则执行then\nthis is inner promise\n// 微任务队列为空，执行一个宏任务task：outter listener\noutter //执行outter的click listener，console.log同步代码立即执行，微任务队列中push进promise的then，宏任务中再push进setTimeout，为两个setTimeout\nthis is outter promise //先情况微任务队列，再执行宏任务\nthis is inner settimeout\nthis is outter settimeout\n```\n\n*https://developer.mozilla.org/en-US/docs/Web/JavaScript/EventLoop*\n*http://www.ruanyifeng.com/blog/2014/10/event-loop.html*\n","slug":"证明：Click是一个EventLoop宏任务","published":1,"updated":"2021-01-26T02:12:07.351Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckrix8zdz0016k1jf2pbzfo11","content":"<h4 id=\"如题，证明Click是一个EventLoop宏任务\"><a href=\"#如题，证明Click是一个EventLoop宏任务\" class=\"headerlink\" title=\"如题，证明Click是一个EventLoop宏任务\"></a>如题，证明Click是一个EventLoop宏任务</h4><p>JavaScript中事件根据同步异步可以分为哪些类型呢，无非就是 同步（立马执行）和 异步（延迟执行）。而异步又分为宏任务（marcoTask 有的地方也叫Task）和微任务（microTask）。综上，JavaScript中的事件可以分为同步，宏任务和微任务。</p>\n<p>EventLoop的讲解可以看看<a href=\"http://www.ruanyifeng.com/blog/2014/10/event-loop.html\" target=\"_blank\" rel=\"noopener\">阮一峰博客event-loop</a>或<a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/EventLoop\" target=\"_blank\" rel=\"noopener\">MDN的解释</a></p>\n<p>那么如何证明，Click是一个宏任务呢，它似乎也没有一个定义，那让我们用反证法来证明一下吧。首先让我们看个例子。 <a href=\"https://guguji5.github.io/clickIsMacroEvent/\">https://guguji5.github.io/clickIsMacroEvent/</a><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;div id=&quot;outter&quot;&gt;</span><br><span class=\"line\">    outter</span><br><span class=\"line\">    &lt;div id=&quot;inner&quot;&gt;</span><br><span class=\"line\">        &lt;span&gt;inner&lt;/span&gt;</span><br><span class=\"line\">        点我，猜猜console</span><br><span class=\"line\">    &lt;/div&gt;</span><br><span class=\"line\">&lt;/div&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">var out = document.getElementById(&apos;outter&apos;)</span><br><span class=\"line\">var inner = document.getElementById(&apos;inner&apos;)</span><br><span class=\"line\">out.addEventListener(&apos;click&apos;, function()&#123;</span><br><span class=\"line\">    console.log(&apos;outter&apos;)</span><br><span class=\"line\">    setTimeout(function() &#123;</span><br><span class=\"line\">        console.log(&apos;this is outter settimeout&apos;)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    Promise.resolve(111).then(res =&gt;&#123;</span><br><span class=\"line\">        console.log(&apos;this is outter promise&apos;)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">inner.addEventListener(&apos;click&apos;, function()&#123;</span><br><span class=\"line\">    console.log(&apos;inner&apos;)</span><br><span class=\"line\">    setTimeout(function() &#123;</span><br><span class=\"line\">        console.log(&apos;this is inner settimeout&apos;)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    Promise.resolve(111).then(res =&gt;&#123;</span><br><span class=\"line\">        console.log(&apos;this is inner promise&apos;)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure></p>\n<p><img src=\"http://img-ys011.didistatic.com/static/dc2img/clickismarcoevent.png\" alt=\"\"></p>\n<h4 id=\"如果Click事件是同步的\"><a href=\"#如果Click事件是同步的\" class=\"headerlink\" title=\"如果Click事件是同步的\"></a>如果Click事件是同步的</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">inner</span><br><span class=\"line\">outter</span><br><span class=\"line\">this is inner promise</span><br><span class=\"line\">this is outter promise</span><br><span class=\"line\">this is inner settimeout</span><br><span class=\"line\">this is outter settimeout</span><br></pre></td></tr></table></figure>\n<h4 id=\"如果Click事件是微任务的\"><a href=\"#如果Click事件是微任务的\" class=\"headerlink\" title=\"如果Click事件是微任务的\"></a>如果Click事件是微任务的</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// 如果click是微任务，刚开始则 微任务队列中为[inner listener, outter listener]，宏任务队列为[]</span><br><span class=\"line\">inner //执行inner的click listener，console.log同步代码立即执行，微任务队列中push进promise的then 为 [outter listener, inner then]，宏任务中push为 [inner setTimeout]</span><br><span class=\"line\">outter //执行outter的click listener，console.log同步代码立即执行，微任务队列中push进promise的then 为 [inner then, outter then]，宏任务中再push进setTimeout，为[inner setTimeout, outter setTimeout]</span><br><span class=\"line\">this is inner promise</span><br><span class=\"line\">this is outter promise //先情况微任务队列，再执行宏任务</span><br><span class=\"line\">this is inner settimeout</span><br><span class=\"line\">this is outter settimeout</span><br></pre></td></tr></table></figure>\n<p>哪个是真的呢，可以试验一下 <a href=\"https://guguji5.github.io/clickIsMacroEvent/\">https://guguji5.github.io/clickIsMacroEvent/</a><br><strong>显然同步是不对的，毕竟是IO，肯定异步的。如果是微任务，则输出应该是第二种，也不相符，由此得出是宏任务。</strong></p>\n<h4 id=\"如果Click事件是宏任务的\"><a href=\"#如果Click事件是宏任务的\" class=\"headerlink\" title=\"如果Click事件是宏任务的\"></a>如果Click事件是宏任务的</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// 如果click是宏任务 宏任务队列中为[inner listener, outter listener]，微任务队列为[]</span><br><span class=\"line\">inner //执行inner的click listener，console.log同步代码立即执行，微任务队列中push进promise的then 为 [inner then]，宏任务中push进setTimeout 为 [outter listener, inner setTimeout]</span><br><span class=\"line\">// 如果是click是一个宏任务，那么应该先清空微任务队列，再执行宏任务，则执行then</span><br><span class=\"line\">this is inner promise</span><br><span class=\"line\">// 微任务队列为空，执行一个宏任务task：outter listener</span><br><span class=\"line\">outter //执行outter的click listener，console.log同步代码立即执行，微任务队列中push进promise的then，宏任务中再push进setTimeout，为两个setTimeout</span><br><span class=\"line\">this is outter promise //先情况微任务队列，再执行宏任务</span><br><span class=\"line\">this is inner settimeout</span><br><span class=\"line\">this is outter settimeout</span><br></pre></td></tr></table></figure>\n<p><em><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/EventLoop\" target=\"_blank\" rel=\"noopener\">https://developer.mozilla.org/en-US/docs/Web/JavaScript/EventLoop</a></em><br><em><a href=\"http://www.ruanyifeng.com/blog/2014/10/event-loop.html\" target=\"_blank\" rel=\"noopener\">http://www.ruanyifeng.com/blog/2014/10/event-loop.html</a></em></p>\n","site":{"data":{}},"excerpt":"","more":"<h4 id=\"如题，证明Click是一个EventLoop宏任务\"><a href=\"#如题，证明Click是一个EventLoop宏任务\" class=\"headerlink\" title=\"如题，证明Click是一个EventLoop宏任务\"></a>如题，证明Click是一个EventLoop宏任务</h4><p>JavaScript中事件根据同步异步可以分为哪些类型呢，无非就是 同步（立马执行）和 异步（延迟执行）。而异步又分为宏任务（marcoTask 有的地方也叫Task）和微任务（microTask）。综上，JavaScript中的事件可以分为同步，宏任务和微任务。</p>\n<p>EventLoop的讲解可以看看<a href=\"http://www.ruanyifeng.com/blog/2014/10/event-loop.html\" target=\"_blank\" rel=\"noopener\">阮一峰博客event-loop</a>或<a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/EventLoop\" target=\"_blank\" rel=\"noopener\">MDN的解释</a></p>\n<p>那么如何证明，Click是一个宏任务呢，它似乎也没有一个定义，那让我们用反证法来证明一下吧。首先让我们看个例子。 <a href=\"https://guguji5.github.io/clickIsMacroEvent/\">https://guguji5.github.io/clickIsMacroEvent/</a><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;div id=&quot;outter&quot;&gt;</span><br><span class=\"line\">    outter</span><br><span class=\"line\">    &lt;div id=&quot;inner&quot;&gt;</span><br><span class=\"line\">        &lt;span&gt;inner&lt;/span&gt;</span><br><span class=\"line\">        点我，猜猜console</span><br><span class=\"line\">    &lt;/div&gt;</span><br><span class=\"line\">&lt;/div&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">var out = document.getElementById(&apos;outter&apos;)</span><br><span class=\"line\">var inner = document.getElementById(&apos;inner&apos;)</span><br><span class=\"line\">out.addEventListener(&apos;click&apos;, function()&#123;</span><br><span class=\"line\">    console.log(&apos;outter&apos;)</span><br><span class=\"line\">    setTimeout(function() &#123;</span><br><span class=\"line\">        console.log(&apos;this is outter settimeout&apos;)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    Promise.resolve(111).then(res =&gt;&#123;</span><br><span class=\"line\">        console.log(&apos;this is outter promise&apos;)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">inner.addEventListener(&apos;click&apos;, function()&#123;</span><br><span class=\"line\">    console.log(&apos;inner&apos;)</span><br><span class=\"line\">    setTimeout(function() &#123;</span><br><span class=\"line\">        console.log(&apos;this is inner settimeout&apos;)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    Promise.resolve(111).then(res =&gt;&#123;</span><br><span class=\"line\">        console.log(&apos;this is inner promise&apos;)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure></p>\n<p><img src=\"http://img-ys011.didistatic.com/static/dc2img/clickismarcoevent.png\" alt=\"\"></p>\n<h4 id=\"如果Click事件是同步的\"><a href=\"#如果Click事件是同步的\" class=\"headerlink\" title=\"如果Click事件是同步的\"></a>如果Click事件是同步的</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">inner</span><br><span class=\"line\">outter</span><br><span class=\"line\">this is inner promise</span><br><span class=\"line\">this is outter promise</span><br><span class=\"line\">this is inner settimeout</span><br><span class=\"line\">this is outter settimeout</span><br></pre></td></tr></table></figure>\n<h4 id=\"如果Click事件是微任务的\"><a href=\"#如果Click事件是微任务的\" class=\"headerlink\" title=\"如果Click事件是微任务的\"></a>如果Click事件是微任务的</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// 如果click是微任务，刚开始则 微任务队列中为[inner listener, outter listener]，宏任务队列为[]</span><br><span class=\"line\">inner //执行inner的click listener，console.log同步代码立即执行，微任务队列中push进promise的then 为 [outter listener, inner then]，宏任务中push为 [inner setTimeout]</span><br><span class=\"line\">outter //执行outter的click listener，console.log同步代码立即执行，微任务队列中push进promise的then 为 [inner then, outter then]，宏任务中再push进setTimeout，为[inner setTimeout, outter setTimeout]</span><br><span class=\"line\">this is inner promise</span><br><span class=\"line\">this is outter promise //先情况微任务队列，再执行宏任务</span><br><span class=\"line\">this is inner settimeout</span><br><span class=\"line\">this is outter settimeout</span><br></pre></td></tr></table></figure>\n<p>哪个是真的呢，可以试验一下 <a href=\"https://guguji5.github.io/clickIsMacroEvent/\">https://guguji5.github.io/clickIsMacroEvent/</a><br><strong>显然同步是不对的，毕竟是IO，肯定异步的。如果是微任务，则输出应该是第二种，也不相符，由此得出是宏任务。</strong></p>\n<h4 id=\"如果Click事件是宏任务的\"><a href=\"#如果Click事件是宏任务的\" class=\"headerlink\" title=\"如果Click事件是宏任务的\"></a>如果Click事件是宏任务的</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// 如果click是宏任务 宏任务队列中为[inner listener, outter listener]，微任务队列为[]</span><br><span class=\"line\">inner //执行inner的click listener，console.log同步代码立即执行，微任务队列中push进promise的then 为 [inner then]，宏任务中push进setTimeout 为 [outter listener, inner setTimeout]</span><br><span class=\"line\">// 如果是click是一个宏任务，那么应该先清空微任务队列，再执行宏任务，则执行then</span><br><span class=\"line\">this is inner promise</span><br><span class=\"line\">// 微任务队列为空，执行一个宏任务task：outter listener</span><br><span class=\"line\">outter //执行outter的click listener，console.log同步代码立即执行，微任务队列中push进promise的then，宏任务中再push进setTimeout，为两个setTimeout</span><br><span class=\"line\">this is outter promise //先情况微任务队列，再执行宏任务</span><br><span class=\"line\">this is inner settimeout</span><br><span class=\"line\">this is outter settimeout</span><br></pre></td></tr></table></figure>\n<p><em><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/EventLoop\" target=\"_blank\" rel=\"noopener\">https://developer.mozilla.org/en-US/docs/Web/JavaScript/EventLoop</a></em><br><em><a href=\"http://www.ruanyifeng.com/blog/2014/10/event-loop.html\" target=\"_blank\" rel=\"noopener\">http://www.ruanyifeng.com/blog/2014/10/event-loop.html</a></em></p>\n"},{"title":"滴滴云MIS Single-spa微服务化项目总结","date":"2020-05-30T07:42:15.000Z","_content":"\n## 我们为什么要用微前端 ？\n\n当然微前端的优势有很多，具体到我们应用大概就以下三点：\n\n- 因为滴滴云有三个项目，滴滴云官网，滴滴云控制台，滴滴云MIS。滴滴云官网和控制台是对外提供服务，MIS是对内提供服务。MIS如何复用控制台和官网的组件？在单页应用的架构下，目前没有能力，从去年冬天，我们开始探索微前端的结构。\n- MIS中功能较为独立，一部分模块改动频繁，另外一些可以说基本不更新。作为一个整体应用，这些原本不需要改动的代码既增加了整体编译，发布，开发时热部署的耗时，多个功能并行开发，也增加了产生BUG的可能性。\n- 前端技术栈更迭非常快，微前端可以让我们更自由的选择我们感兴趣的，更新更强的技术栈及配套。\n\n所以我们决定拆分MIS，一方面做优化，另一方面为滴滴云控制台这个庞然大物探索一个解决方案。\n\n## Why single-spa ?\n\n其实微前端的实现方案有很多，这方面无论Way社区还是掘金知乎上讲的很多了。我们不想失去单页应用优秀的用户体验，不想去触碰容易导致各种诡异问题的iframe，也不想去尝试目前兼容性还有待提高的Web Components。在我们体验了single-spa 在线demo，开箱即用的脚手架，再加上其核心团队快速的响应能力，我们决定试水single-spa。\n\n打动我的还有作者[文档上的一段话](https://single-spa.js.org/docs/getting-started-overview#architectural-overview) :\n\n> single-spa takes inspiration from modern framework component lifecycles by applying lifecycles to entire applications. It was born out of Canopy's desire to use React + react-router instead of being forever stuck with our AngularJS + ui-router application, and now single-spa supports almost any framework. Since JavaScript is notorious for the short-life of its many frameworks, we decided to make it easy to use whichever frameworks you want.\n\n这正是在我之前公司遇到的困境，如何把AngularJS升级到Angular 5.0 ，简直是雷锋和雷峰塔的区别。我们选择了重写了项目，新旧项目双线作战，而single-spa的做法却别出心裁。\n\n## 使用single-spa我们需要了解什么\n\n首先简单看一下single-spa重构项目的结构，有一个基座html，多个子应用按需插入基础，不需要的子应用，从基座拔出。\n\n![gitlab-runner](/images/how_single-spa_works.png)\n\n在了解single-spa本身Api之前，我觉得有必要了解一下[SystemJs](https://github.com/systemjs/systemjs)，import maps的使用，[不同构建版本包的使用]([https://cn.vuejs.org/v2/guide/installation.html#%E5%AF%B9%E4%B8%8D%E5%90%8C%E6%9E%84%E5%BB%BA%E7%89%88%E6%9C%AC%E7%9A%84%E8%A7%A3%E9%87%8A](https://cn.vuejs.org/v2/guide/installation.html#对不同构建版本的解释))。single-spa的核心团队的Joel Denning录了一系列讲解视频在[YouTube](https://www.youtube.com/playlist?list=PLLUD8RtHvsAOhtHnyGx57EYXoaNsxGrTU)和[Bilibili](https://space.bilibili.com/495254378/)，非常推荐。\n\n## 实施single-spa遇到的问题\n1. 子应用打包格式错误\nsingle-spa 加载子应用的库是systemjs,并不是所有的js文件都可以加载，推荐使用 `libraryTarget: 'system'`,`umd` 和 `amd` 亦可。[参考链接](https://webpack.js.org/configuration/output/#outputlibrarytarget)\n  <details>\n  <summary>了解更多</summary>\n  Now, there are also various other formats and working with them all is a pain so systemjs has the 'extras' it uses in order to interop between them. umd and amd are good formats because they're designed to work in the browser. But that means there's a layer to unwrap/interop with so system should be preferred if possible.( from Carlos )\n  </details>\n\n\n2. 跨域问题\n这应该是single-spa开发中一定会遇到的一个问题，因为同时启动多个项目肯定在localhost的不同端口，将不同端口的服务加载到root-html中势必会跨域，所以解决它就好了。需要在webpack配置中中添加\n`\"Access-Control-Allow-Origin\": “*”`即可。\n\n\n3. single-spa 子应用挂载时把挂载的dom节点替换掉？\n拿single-spa-vue为例，1.7.0 会把挂载节点替换掉。而1.8.0 会把挂载节点保留。根据自己的需要选择版本，可以在package-lock.json中锁定版本。\n\n\n4. single-spa 的项目如何部署在nginx服务器？\nsingle-spa，顾名思义，还是一个单页应用。我们不希望切换路由的时候浏览器发生跳转或者刷新。可以尝试如下配置：\n```\nlocation / {\n      try_files $uri $uri.html /index.html =404;\n  }\n```\n\n5. System-importmap 存在哪里，如何修改？\n根据官方的推荐，importmap建议存在S3存储，目前我们使用的内部gift服务，gift上目前没有一个支持https协议的域名，所以使用了cdn的域名。但这个cdn的下发有延迟，导致页面的刷新有些问题，后期考虑存到数据库。\n\n\n6. 有关public path，external 和 systemjs-webpack-interop的解释\n首先publicPath是配置项目中所有资源的一个基础路径；\nexternals提供了运行时从外部获取依赖的方法，external可以接受多种模块类型的资源；\nsystemjs-webpack-interop是一个搭配single-spa使用的组件，提供了简单方便修改运行时publicPath的方法。\n  <details>\n  <summary>了解更多</summary>\n  相信下边的链接一定能让你搞明白这两个概念。\n  https://www.webpackjs.com/configuration/externals/\n  https://www.webpackjs.com/guides/public-path/#on-the-fly\n  https://github.com/joeldenning/systemjs-webpack-interop\n  https://stackoverflow.com/questions/28846814/what-does-publicpath-in-webpack-do\n  https://tomasalabes.me/blog/web-development/2016/12/11/Webpack-and-the-public-path.html\n  </details>\n\n\n7. 多个子应用共同依赖的css，组件如何共享，权限如何控制，全局状态如何维护？\n根据[官方的推荐](https://single-spa.js.org/docs/recommended-setup/#utility-modules-styleguide-api-etc)，可以专门创建一个子应用来做这些事，公共样式，封装http服务，一些不想暴露在全局的状态也可以在这个应用里维护。这个模块可以配合external被其他模块引用。\n  <details>\n  <summary>了解更多</summary>\n  https://single-spa.js.org/docs/faq/#how-can-i-share-application-state-between-applications\n  </details>\n\n\n8. Css 冲突怎么解决呢？\n  1. Namespace the CSS belonging to each app with a class, and wrap the app in that container class (such as BEM).\n  2. Use CSS modules in your components https://create-react-app.dev/docs/adding-a-css-modules-stylesheet/( https://vue-loader.vuejs.org/guide/css-modules.html#usage)\n  3. Use a CSS-in-JS library like https://styled-components.com/\n  4. The 'scoped' attribute in style tag\n我选的第一种，postcss-plugin-namespace 可以方便的将项目中所有的postcss 加一个prefix，成本很小。其他的都需要改造代码。\n\n\n9. 不同子应用切换的时候白屏如何解决？\n一种思路使用预加载；另一种思路是在侦测到有新应用加载时增加一个loading的过渡页；我选第二种。[single-spa api文档](https://single-spa.js.org/docs/api) 提供了 `single-spa:before-app-change` 和 `single-spa:app-change` 事件，可以在两个事件中间增加一个loading。(single-spa 5.5.0版本才支持，[具体请见issue](https://github.com/single-spa/single-spa/issues/545))\n\n\n10. 一个完整spa项目想放入single-spa要做什么更改？\n根据[官方的推荐](https://single-spa.js.org/docs/migrating-existing-spas),需要两步。一，实现single-spa所需要的bootstrap，mount，unmount等生命周期钩子函数。二，保证你的外部链接报错css，JavaScript等可以独立工作。** 除此之外 **，如果你使用了webpack抽取了很多chunk，这可能会导致失败，因为不同的chunk包不会加载其他依赖的包。Joeldenning建议按路由懒加载进行拆包。\n\n\n11. 子应用如何部署，上线时如何更新importMap？\n微前端的子应用可以独立部署，目前经过OE打包后，在弹性云或odin部署；目前importMap存储在gift，但是弹性云现有的镜像没有提供部署完后继续shell脚本的执行，所以自己做了一个镜像 registry.xiaojukeji.com/didionline/didiyun-mis-nginx-main:stable，它只不过在内部拉起nginx服务后，执行了一个shell脚本，它会更新gift链接中的内容。\n\n\n12. 不同子应用访问路径如何配置？\n不同的子应用跑在不同的弹性云节点，可以通过不同的子域名来进行映射，odin的微前端就是采用这种方案。也可以通过不同的path映射到不同的ip机器上，地图团队的微前端使用的这种方案。我选的后者。\n```\nupstream misaccount {\n  server 10.1.2.3:8080;\n  server 10.4.5.6:8080;\n}\n\nlocation /mis-account/ {\n    proxy_pass http://misaccount/;\n}\n```\n\n## 收益\n\n1. 探索了使用single-spa的成本和难度，为改造滴滴云控制台提供了一种解决方案。\n2. 拆分后的项目更独立，为技术栈的改造和升级降低了门槛。\n3. 最最重要的给复用滴滴云控制台的代码提供了一种可维护的方案，目前滴滴云MIS中费用中心使用的是滴滴云控制台中现成的视图组件。\n4. 改版后的MIS懒加载更合理，不同的用户使用MIS中某些特定的功能，真正做到不使用的应用不加载。\n5. 给团队的同学分享和实践了一种可落地的微前端解决方案。\n6. 全新的开发体验，做到开发哪里，替换哪里。([import-map-overrides新体验](https://github.com/joeldenning/import-map-overrides))\n\n## 写在最后的话\n\nsingle-spa核心团队的Joeldenning是一个非常热情，阅历丰富，技术扎实的开发人员。在探索single-spa的过程中，向他学习到很多东西，他也总是能第一时间给出合理的解决方案，并且也是很热心的把再Youtube上的single-spa的介绍视频上传到bilibili一份，投桃报李，我们团队也利用周末时间，进行了[single-spa的中文翻译](https://zh-hans.single-spa.js.org/docs/getting-started-overview)工作，收获良多。\n\n\n\n\n\n\n","source":"_posts/Single-spa微服务化前端项目总结.md","raw":"---\ntitle: 滴滴云MIS Single-spa微服务化项目总结\ndate: 2020-05-30 15:42:15\ntags: 微前端 single-spa\n---\n\n## 我们为什么要用微前端 ？\n\n当然微前端的优势有很多，具体到我们应用大概就以下三点：\n\n- 因为滴滴云有三个项目，滴滴云官网，滴滴云控制台，滴滴云MIS。滴滴云官网和控制台是对外提供服务，MIS是对内提供服务。MIS如何复用控制台和官网的组件？在单页应用的架构下，目前没有能力，从去年冬天，我们开始探索微前端的结构。\n- MIS中功能较为独立，一部分模块改动频繁，另外一些可以说基本不更新。作为一个整体应用，这些原本不需要改动的代码既增加了整体编译，发布，开发时热部署的耗时，多个功能并行开发，也增加了产生BUG的可能性。\n- 前端技术栈更迭非常快，微前端可以让我们更自由的选择我们感兴趣的，更新更强的技术栈及配套。\n\n所以我们决定拆分MIS，一方面做优化，另一方面为滴滴云控制台这个庞然大物探索一个解决方案。\n\n## Why single-spa ?\n\n其实微前端的实现方案有很多，这方面无论Way社区还是掘金知乎上讲的很多了。我们不想失去单页应用优秀的用户体验，不想去触碰容易导致各种诡异问题的iframe，也不想去尝试目前兼容性还有待提高的Web Components。在我们体验了single-spa 在线demo，开箱即用的脚手架，再加上其核心团队快速的响应能力，我们决定试水single-spa。\n\n打动我的还有作者[文档上的一段话](https://single-spa.js.org/docs/getting-started-overview#architectural-overview) :\n\n> single-spa takes inspiration from modern framework component lifecycles by applying lifecycles to entire applications. It was born out of Canopy's desire to use React + react-router instead of being forever stuck with our AngularJS + ui-router application, and now single-spa supports almost any framework. Since JavaScript is notorious for the short-life of its many frameworks, we decided to make it easy to use whichever frameworks you want.\n\n这正是在我之前公司遇到的困境，如何把AngularJS升级到Angular 5.0 ，简直是雷锋和雷峰塔的区别。我们选择了重写了项目，新旧项目双线作战，而single-spa的做法却别出心裁。\n\n## 使用single-spa我们需要了解什么\n\n首先简单看一下single-spa重构项目的结构，有一个基座html，多个子应用按需插入基础，不需要的子应用，从基座拔出。\n\n![gitlab-runner](/images/how_single-spa_works.png)\n\n在了解single-spa本身Api之前，我觉得有必要了解一下[SystemJs](https://github.com/systemjs/systemjs)，import maps的使用，[不同构建版本包的使用]([https://cn.vuejs.org/v2/guide/installation.html#%E5%AF%B9%E4%B8%8D%E5%90%8C%E6%9E%84%E5%BB%BA%E7%89%88%E6%9C%AC%E7%9A%84%E8%A7%A3%E9%87%8A](https://cn.vuejs.org/v2/guide/installation.html#对不同构建版本的解释))。single-spa的核心团队的Joel Denning录了一系列讲解视频在[YouTube](https://www.youtube.com/playlist?list=PLLUD8RtHvsAOhtHnyGx57EYXoaNsxGrTU)和[Bilibili](https://space.bilibili.com/495254378/)，非常推荐。\n\n## 实施single-spa遇到的问题\n1. 子应用打包格式错误\nsingle-spa 加载子应用的库是systemjs,并不是所有的js文件都可以加载，推荐使用 `libraryTarget: 'system'`,`umd` 和 `amd` 亦可。[参考链接](https://webpack.js.org/configuration/output/#outputlibrarytarget)\n  <details>\n  <summary>了解更多</summary>\n  Now, there are also various other formats and working with them all is a pain so systemjs has the 'extras' it uses in order to interop between them. umd and amd are good formats because they're designed to work in the browser. But that means there's a layer to unwrap/interop with so system should be preferred if possible.( from Carlos )\n  </details>\n\n\n2. 跨域问题\n这应该是single-spa开发中一定会遇到的一个问题，因为同时启动多个项目肯定在localhost的不同端口，将不同端口的服务加载到root-html中势必会跨域，所以解决它就好了。需要在webpack配置中中添加\n`\"Access-Control-Allow-Origin\": “*”`即可。\n\n\n3. single-spa 子应用挂载时把挂载的dom节点替换掉？\n拿single-spa-vue为例，1.7.0 会把挂载节点替换掉。而1.8.0 会把挂载节点保留。根据自己的需要选择版本，可以在package-lock.json中锁定版本。\n\n\n4. single-spa 的项目如何部署在nginx服务器？\nsingle-spa，顾名思义，还是一个单页应用。我们不希望切换路由的时候浏览器发生跳转或者刷新。可以尝试如下配置：\n```\nlocation / {\n      try_files $uri $uri.html /index.html =404;\n  }\n```\n\n5. System-importmap 存在哪里，如何修改？\n根据官方的推荐，importmap建议存在S3存储，目前我们使用的内部gift服务，gift上目前没有一个支持https协议的域名，所以使用了cdn的域名。但这个cdn的下发有延迟，导致页面的刷新有些问题，后期考虑存到数据库。\n\n\n6. 有关public path，external 和 systemjs-webpack-interop的解释\n首先publicPath是配置项目中所有资源的一个基础路径；\nexternals提供了运行时从外部获取依赖的方法，external可以接受多种模块类型的资源；\nsystemjs-webpack-interop是一个搭配single-spa使用的组件，提供了简单方便修改运行时publicPath的方法。\n  <details>\n  <summary>了解更多</summary>\n  相信下边的链接一定能让你搞明白这两个概念。\n  https://www.webpackjs.com/configuration/externals/\n  https://www.webpackjs.com/guides/public-path/#on-the-fly\n  https://github.com/joeldenning/systemjs-webpack-interop\n  https://stackoverflow.com/questions/28846814/what-does-publicpath-in-webpack-do\n  https://tomasalabes.me/blog/web-development/2016/12/11/Webpack-and-the-public-path.html\n  </details>\n\n\n7. 多个子应用共同依赖的css，组件如何共享，权限如何控制，全局状态如何维护？\n根据[官方的推荐](https://single-spa.js.org/docs/recommended-setup/#utility-modules-styleguide-api-etc)，可以专门创建一个子应用来做这些事，公共样式，封装http服务，一些不想暴露在全局的状态也可以在这个应用里维护。这个模块可以配合external被其他模块引用。\n  <details>\n  <summary>了解更多</summary>\n  https://single-spa.js.org/docs/faq/#how-can-i-share-application-state-between-applications\n  </details>\n\n\n8. Css 冲突怎么解决呢？\n  1. Namespace the CSS belonging to each app with a class, and wrap the app in that container class (such as BEM).\n  2. Use CSS modules in your components https://create-react-app.dev/docs/adding-a-css-modules-stylesheet/( https://vue-loader.vuejs.org/guide/css-modules.html#usage)\n  3. Use a CSS-in-JS library like https://styled-components.com/\n  4. The 'scoped' attribute in style tag\n我选的第一种，postcss-plugin-namespace 可以方便的将项目中所有的postcss 加一个prefix，成本很小。其他的都需要改造代码。\n\n\n9. 不同子应用切换的时候白屏如何解决？\n一种思路使用预加载；另一种思路是在侦测到有新应用加载时增加一个loading的过渡页；我选第二种。[single-spa api文档](https://single-spa.js.org/docs/api) 提供了 `single-spa:before-app-change` 和 `single-spa:app-change` 事件，可以在两个事件中间增加一个loading。(single-spa 5.5.0版本才支持，[具体请见issue](https://github.com/single-spa/single-spa/issues/545))\n\n\n10. 一个完整spa项目想放入single-spa要做什么更改？\n根据[官方的推荐](https://single-spa.js.org/docs/migrating-existing-spas),需要两步。一，实现single-spa所需要的bootstrap，mount，unmount等生命周期钩子函数。二，保证你的外部链接报错css，JavaScript等可以独立工作。** 除此之外 **，如果你使用了webpack抽取了很多chunk，这可能会导致失败，因为不同的chunk包不会加载其他依赖的包。Joeldenning建议按路由懒加载进行拆包。\n\n\n11. 子应用如何部署，上线时如何更新importMap？\n微前端的子应用可以独立部署，目前经过OE打包后，在弹性云或odin部署；目前importMap存储在gift，但是弹性云现有的镜像没有提供部署完后继续shell脚本的执行，所以自己做了一个镜像 registry.xiaojukeji.com/didionline/didiyun-mis-nginx-main:stable，它只不过在内部拉起nginx服务后，执行了一个shell脚本，它会更新gift链接中的内容。\n\n\n12. 不同子应用访问路径如何配置？\n不同的子应用跑在不同的弹性云节点，可以通过不同的子域名来进行映射，odin的微前端就是采用这种方案。也可以通过不同的path映射到不同的ip机器上，地图团队的微前端使用的这种方案。我选的后者。\n```\nupstream misaccount {\n  server 10.1.2.3:8080;\n  server 10.4.5.6:8080;\n}\n\nlocation /mis-account/ {\n    proxy_pass http://misaccount/;\n}\n```\n\n## 收益\n\n1. 探索了使用single-spa的成本和难度，为改造滴滴云控制台提供了一种解决方案。\n2. 拆分后的项目更独立，为技术栈的改造和升级降低了门槛。\n3. 最最重要的给复用滴滴云控制台的代码提供了一种可维护的方案，目前滴滴云MIS中费用中心使用的是滴滴云控制台中现成的视图组件。\n4. 改版后的MIS懒加载更合理，不同的用户使用MIS中某些特定的功能，真正做到不使用的应用不加载。\n5. 给团队的同学分享和实践了一种可落地的微前端解决方案。\n6. 全新的开发体验，做到开发哪里，替换哪里。([import-map-overrides新体验](https://github.com/joeldenning/import-map-overrides))\n\n## 写在最后的话\n\nsingle-spa核心团队的Joeldenning是一个非常热情，阅历丰富，技术扎实的开发人员。在探索single-spa的过程中，向他学习到很多东西，他也总是能第一时间给出合理的解决方案，并且也是很热心的把再Youtube上的single-spa的介绍视频上传到bilibili一份，投桃报李，我们团队也利用周末时间，进行了[single-spa的中文翻译](https://zh-hans.single-spa.js.org/docs/getting-started-overview)工作，收获良多。\n\n\n\n\n\n\n","slug":"Single-spa微服务化前端项目总结","published":1,"updated":"2020-06-14T07:28:40.531Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckrix8zew001dk1jfszgfktgw","content":"<h2 id=\"我们为什么要用微前端-？\"><a href=\"#我们为什么要用微前端-？\" class=\"headerlink\" title=\"我们为什么要用微前端 ？\"></a>我们为什么要用微前端 ？</h2><p>当然微前端的优势有很多，具体到我们应用大概就以下三点：</p>\n<ul>\n<li>因为滴滴云有三个项目，滴滴云官网，滴滴云控制台，滴滴云MIS。滴滴云官网和控制台是对外提供服务，MIS是对内提供服务。MIS如何复用控制台和官网的组件？在单页应用的架构下，目前没有能力，从去年冬天，我们开始探索微前端的结构。</li>\n<li>MIS中功能较为独立，一部分模块改动频繁，另外一些可以说基本不更新。作为一个整体应用，这些原本不需要改动的代码既增加了整体编译，发布，开发时热部署的耗时，多个功能并行开发，也增加了产生BUG的可能性。</li>\n<li>前端技术栈更迭非常快，微前端可以让我们更自由的选择我们感兴趣的，更新更强的技术栈及配套。</li>\n</ul>\n<p>所以我们决定拆分MIS，一方面做优化，另一方面为滴滴云控制台这个庞然大物探索一个解决方案。</p>\n<h2 id=\"Why-single-spa\"><a href=\"#Why-single-spa\" class=\"headerlink\" title=\"Why single-spa ?\"></a>Why single-spa ?</h2><p>其实微前端的实现方案有很多，这方面无论Way社区还是掘金知乎上讲的很多了。我们不想失去单页应用优秀的用户体验，不想去触碰容易导致各种诡异问题的iframe，也不想去尝试目前兼容性还有待提高的Web Components。在我们体验了single-spa 在线demo，开箱即用的脚手架，再加上其核心团队快速的响应能力，我们决定试水single-spa。</p>\n<p>打动我的还有作者<a href=\"https://single-spa.js.org/docs/getting-started-overview#architectural-overview\" target=\"_blank\" rel=\"noopener\">文档上的一段话</a> :</p>\n<blockquote>\n<p>single-spa takes inspiration from modern framework component lifecycles by applying lifecycles to entire applications. It was born out of Canopy’s desire to use React + react-router instead of being forever stuck with our AngularJS + ui-router application, and now single-spa supports almost any framework. Since JavaScript is notorious for the short-life of its many frameworks, we decided to make it easy to use whichever frameworks you want.</p>\n</blockquote>\n<p>这正是在我之前公司遇到的困境，如何把AngularJS升级到Angular 5.0 ，简直是雷锋和雷峰塔的区别。我们选择了重写了项目，新旧项目双线作战，而single-spa的做法却别出心裁。</p>\n<h2 id=\"使用single-spa我们需要了解什么\"><a href=\"#使用single-spa我们需要了解什么\" class=\"headerlink\" title=\"使用single-spa我们需要了解什么\"></a>使用single-spa我们需要了解什么</h2><p>首先简单看一下single-spa重构项目的结构，有一个基座html，多个子应用按需插入基础，不需要的子应用，从基座拔出。</p>\n<p><img src=\"/images/how_single-spa_works.png\" alt=\"gitlab-runner\"></p>\n<p>在了解single-spa本身Api之前，我觉得有必要了解一下<a href=\"https://github.com/systemjs/systemjs\" target=\"_blank\" rel=\"noopener\">SystemJs</a>，import maps的使用，<a href=\"[https://cn.vuejs.org/v2/guide/installation.html#%E5%AF%B9%E4%B8%8D%E5%90%8C%E6%9E%84%E5%BB%BA%E7%89%88%E6%9C%AC%E7%9A%84%E8%A7%A3%E9%87%8A](https://cn.vuejs.org/v2/guide/installation.html#对不同构建版本的解释\">不同构建版本包的使用</a>)。single-spa的核心团队的Joel Denning录了一系列讲解视频在<a href=\"https://www.youtube.com/playlist?list=PLLUD8RtHvsAOhtHnyGx57EYXoaNsxGrTU\" target=\"_blank\" rel=\"noopener\">YouTube</a>和<a href=\"https://space.bilibili.com/495254378/\" target=\"_blank\" rel=\"noopener\">Bilibili</a>，非常推荐。</p>\n<h2 id=\"实施single-spa遇到的问题\"><a href=\"#实施single-spa遇到的问题\" class=\"headerlink\" title=\"实施single-spa遇到的问题\"></a>实施single-spa遇到的问题</h2><ol>\n<li>子应用打包格式错误<br>single-spa 加载子应用的库是systemjs,并不是所有的js文件都可以加载，推荐使用 <code>libraryTarget: &#39;system&#39;</code>,<code>umd</code> 和 <code>amd</code> 亦可。<a href=\"https://webpack.js.org/configuration/output/#outputlibrarytarget\" target=\"_blank\" rel=\"noopener\">参考链接</a><details><br><summary>了解更多</summary><br>Now, there are also various other formats and working with them all is a pain so systemjs has the ‘extras’ it uses in order to interop between them. umd and amd are good formats because they’re designed to work in the browser. But that means there’s a layer to unwrap/interop with so system should be preferred if possible.( from Carlos )<br></details>\n\n\n</li>\n</ol>\n<ol start=\"2\">\n<li>跨域问题<br>这应该是single-spa开发中一定会遇到的一个问题，因为同时启动多个项目肯定在localhost的不同端口，将不同端口的服务加载到root-html中势必会跨域，所以解决它就好了。需要在webpack配置中中添加<br><code>&quot;Access-Control-Allow-Origin&quot;: “*”</code>即可。</li>\n</ol>\n<ol start=\"3\">\n<li>single-spa 子应用挂载时把挂载的dom节点替换掉？<br>拿single-spa-vue为例，1.7.0 会把挂载节点替换掉。而1.8.0 会把挂载节点保留。根据自己的需要选择版本，可以在package-lock.json中锁定版本。</li>\n</ol>\n<ol start=\"4\">\n<li><p>single-spa 的项目如何部署在nginx服务器？<br>single-spa，顾名思义，还是一个单页应用。我们不希望切换路由的时候浏览器发生跳转或者刷新。可以尝试如下配置：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">location / &#123;</span><br><span class=\"line\">      try_files $uri $uri.html /index.html =404;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>System-importmap 存在哪里，如何修改？<br>根据官方的推荐，importmap建议存在S3存储，目前我们使用的内部gift服务，gift上目前没有一个支持https协议的域名，所以使用了cdn的域名。但这个cdn的下发有延迟，导致页面的刷新有些问题，后期考虑存到数据库。</p>\n</li>\n</ol>\n<ol start=\"6\">\n<li>有关public path，external 和 systemjs-webpack-interop的解释<br>首先publicPath是配置项目中所有资源的一个基础路径；<br>externals提供了运行时从外部获取依赖的方法，external可以接受多种模块类型的资源；<br>systemjs-webpack-interop是一个搭配single-spa使用的组件，提供了简单方便修改运行时publicPath的方法。<details><br><summary>了解更多</summary><br>相信下边的链接一定能让你搞明白这两个概念。<br><a href=\"https://www.webpackjs.com/configuration/externals/\" target=\"_blank\" rel=\"noopener\">https://www.webpackjs.com/configuration/externals/</a><br><a href=\"https://www.webpackjs.com/guides/public-path/#on-the-fly\" target=\"_blank\" rel=\"noopener\">https://www.webpackjs.com/guides/public-path/#on-the-fly</a><br><a href=\"https://github.com/joeldenning/systemjs-webpack-interop\" target=\"_blank\" rel=\"noopener\">https://github.com/joeldenning/systemjs-webpack-interop</a><br><a href=\"https://stackoverflow.com/questions/28846814/what-does-publicpath-in-webpack-do\" target=\"_blank\" rel=\"noopener\">https://stackoverflow.com/questions/28846814/what-does-publicpath-in-webpack-do</a><br><a href=\"https://tomasalabes.me/blog/web-development/2016/12/11/Webpack-and-the-public-path.html\" target=\"_blank\" rel=\"noopener\">https://tomasalabes.me/blog/web-development/2016/12/11/Webpack-and-the-public-path.html</a><br></details>\n\n\n</li>\n</ol>\n<ol start=\"7\">\n<li>多个子应用共同依赖的css，组件如何共享，权限如何控制，全局状态如何维护？<br>根据<a href=\"https://single-spa.js.org/docs/recommended-setup/#utility-modules-styleguide-api-etc\" target=\"_blank\" rel=\"noopener\">官方的推荐</a>，可以专门创建一个子应用来做这些事，公共样式，封装http服务，一些不想暴露在全局的状态也可以在这个应用里维护。这个模块可以配合external被其他模块引用。<details><br><summary>了解更多</summary><br><a href=\"https://single-spa.js.org/docs/faq/#how-can-i-share-application-state-between-applications\" target=\"_blank\" rel=\"noopener\">https://single-spa.js.org/docs/faq/#how-can-i-share-application-state-between-applications</a><br></details>\n\n\n</li>\n</ol>\n<ol start=\"8\">\n<li>Css 冲突怎么解决呢？<ol>\n<li>Namespace the CSS belonging to each app with a class, and wrap the app in that container class (such as BEM).</li>\n<li>Use CSS modules in your components <a href=\"https://create-react-app.dev/docs/adding-a-css-modules-stylesheet/\" target=\"_blank\" rel=\"noopener\">https://create-react-app.dev/docs/adding-a-css-modules-stylesheet/</a>( <a href=\"https://vue-loader.vuejs.org/guide/css-modules.html#usage\" target=\"_blank\" rel=\"noopener\">https://vue-loader.vuejs.org/guide/css-modules.html#usage</a>)</li>\n<li>Use a CSS-in-JS library like <a href=\"https://styled-components.com/\" target=\"_blank\" rel=\"noopener\">https://styled-components.com/</a></li>\n<li>The ‘scoped’ attribute in style tag<br>我选的第一种，postcss-plugin-namespace 可以方便的将项目中所有的postcss 加一个prefix，成本很小。其他的都需要改造代码。</li>\n</ol>\n</li>\n</ol>\n<ol start=\"9\">\n<li>不同子应用切换的时候白屏如何解决？<br>一种思路使用预加载；另一种思路是在侦测到有新应用加载时增加一个loading的过渡页；我选第二种。<a href=\"https://single-spa.js.org/docs/api\" target=\"_blank\" rel=\"noopener\">single-spa api文档</a> 提供了 <code>single-spa:before-app-change</code> 和 <code>single-spa:app-change</code> 事件，可以在两个事件中间增加一个loading。(single-spa 5.5.0版本才支持，<a href=\"https://github.com/single-spa/single-spa/issues/545\" target=\"_blank\" rel=\"noopener\">具体请见issue</a>)</li>\n</ol>\n<ol start=\"10\">\n<li>一个完整spa项目想放入single-spa要做什么更改？<br>根据<a href=\"https://single-spa.js.org/docs/migrating-existing-spas\" target=\"_blank\" rel=\"noopener\">官方的推荐</a>,需要两步。一，实现single-spa所需要的bootstrap，mount，unmount等生命周期钩子函数。二，保证你的外部链接报错css，JavaScript等可以独立工作。<strong> 除此之外 </strong>，如果你使用了webpack抽取了很多chunk，这可能会导致失败，因为不同的chunk包不会加载其他依赖的包。Joeldenning建议按路由懒加载进行拆包。</li>\n</ol>\n<ol start=\"11\">\n<li>子应用如何部署，上线时如何更新importMap？<br>微前端的子应用可以独立部署，目前经过OE打包后，在弹性云或odin部署；目前importMap存储在gift，但是弹性云现有的镜像没有提供部署完后继续shell脚本的执行，所以自己做了一个镜像 registry.xiaojukeji.com/didionline/didiyun-mis-nginx-main:stable，它只不过在内部拉起nginx服务后，执行了一个shell脚本，它会更新gift链接中的内容。</li>\n</ol>\n<ol start=\"12\">\n<li>不同子应用访问路径如何配置？<br>不同的子应用跑在不同的弹性云节点，可以通过不同的子域名来进行映射，odin的微前端就是采用这种方案。也可以通过不同的path映射到不同的ip机器上，地图团队的微前端使用的这种方案。我选的后者。<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">upstream misaccount &#123;</span><br><span class=\"line\">  server 10.1.2.3:8080;</span><br><span class=\"line\">  server 10.4.5.6:8080;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">location /mis-account/ &#123;</span><br><span class=\"line\">    proxy_pass http://misaccount/;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<h2 id=\"收益\"><a href=\"#收益\" class=\"headerlink\" title=\"收益\"></a>收益</h2><ol>\n<li>探索了使用single-spa的成本和难度，为改造滴滴云控制台提供了一种解决方案。</li>\n<li>拆分后的项目更独立，为技术栈的改造和升级降低了门槛。</li>\n<li>最最重要的给复用滴滴云控制台的代码提供了一种可维护的方案，目前滴滴云MIS中费用中心使用的是滴滴云控制台中现成的视图组件。</li>\n<li>改版后的MIS懒加载更合理，不同的用户使用MIS中某些特定的功能，真正做到不使用的应用不加载。</li>\n<li>给团队的同学分享和实践了一种可落地的微前端解决方案。</li>\n<li>全新的开发体验，做到开发哪里，替换哪里。(<a href=\"https://github.com/joeldenning/import-map-overrides\" target=\"_blank\" rel=\"noopener\">import-map-overrides新体验</a>)</li>\n</ol>\n<h2 id=\"写在最后的话\"><a href=\"#写在最后的话\" class=\"headerlink\" title=\"写在最后的话\"></a>写在最后的话</h2><p>single-spa核心团队的Joeldenning是一个非常热情，阅历丰富，技术扎实的开发人员。在探索single-spa的过程中，向他学习到很多东西，他也总是能第一时间给出合理的解决方案，并且也是很热心的把再Youtube上的single-spa的介绍视频上传到bilibili一份，投桃报李，我们团队也利用周末时间，进行了<a href=\"https://zh-hans.single-spa.js.org/docs/getting-started-overview\" target=\"_blank\" rel=\"noopener\">single-spa的中文翻译</a>工作，收获良多。</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"我们为什么要用微前端-？\"><a href=\"#我们为什么要用微前端-？\" class=\"headerlink\" title=\"我们为什么要用微前端 ？\"></a>我们为什么要用微前端 ？</h2><p>当然微前端的优势有很多，具体到我们应用大概就以下三点：</p>\n<ul>\n<li>因为滴滴云有三个项目，滴滴云官网，滴滴云控制台，滴滴云MIS。滴滴云官网和控制台是对外提供服务，MIS是对内提供服务。MIS如何复用控制台和官网的组件？在单页应用的架构下，目前没有能力，从去年冬天，我们开始探索微前端的结构。</li>\n<li>MIS中功能较为独立，一部分模块改动频繁，另外一些可以说基本不更新。作为一个整体应用，这些原本不需要改动的代码既增加了整体编译，发布，开发时热部署的耗时，多个功能并行开发，也增加了产生BUG的可能性。</li>\n<li>前端技术栈更迭非常快，微前端可以让我们更自由的选择我们感兴趣的，更新更强的技术栈及配套。</li>\n</ul>\n<p>所以我们决定拆分MIS，一方面做优化，另一方面为滴滴云控制台这个庞然大物探索一个解决方案。</p>\n<h2 id=\"Why-single-spa\"><a href=\"#Why-single-spa\" class=\"headerlink\" title=\"Why single-spa ?\"></a>Why single-spa ?</h2><p>其实微前端的实现方案有很多，这方面无论Way社区还是掘金知乎上讲的很多了。我们不想失去单页应用优秀的用户体验，不想去触碰容易导致各种诡异问题的iframe，也不想去尝试目前兼容性还有待提高的Web Components。在我们体验了single-spa 在线demo，开箱即用的脚手架，再加上其核心团队快速的响应能力，我们决定试水single-spa。</p>\n<p>打动我的还有作者<a href=\"https://single-spa.js.org/docs/getting-started-overview#architectural-overview\" target=\"_blank\" rel=\"noopener\">文档上的一段话</a> :</p>\n<blockquote>\n<p>single-spa takes inspiration from modern framework component lifecycles by applying lifecycles to entire applications. It was born out of Canopy’s desire to use React + react-router instead of being forever stuck with our AngularJS + ui-router application, and now single-spa supports almost any framework. Since JavaScript is notorious for the short-life of its many frameworks, we decided to make it easy to use whichever frameworks you want.</p>\n</blockquote>\n<p>这正是在我之前公司遇到的困境，如何把AngularJS升级到Angular 5.0 ，简直是雷锋和雷峰塔的区别。我们选择了重写了项目，新旧项目双线作战，而single-spa的做法却别出心裁。</p>\n<h2 id=\"使用single-spa我们需要了解什么\"><a href=\"#使用single-spa我们需要了解什么\" class=\"headerlink\" title=\"使用single-spa我们需要了解什么\"></a>使用single-spa我们需要了解什么</h2><p>首先简单看一下single-spa重构项目的结构，有一个基座html，多个子应用按需插入基础，不需要的子应用，从基座拔出。</p>\n<p><img src=\"/images/how_single-spa_works.png\" alt=\"gitlab-runner\"></p>\n<p>在了解single-spa本身Api之前，我觉得有必要了解一下<a href=\"https://github.com/systemjs/systemjs\" target=\"_blank\" rel=\"noopener\">SystemJs</a>，import maps的使用，<a href=\"[https://cn.vuejs.org/v2/guide/installation.html#%E5%AF%B9%E4%B8%8D%E5%90%8C%E6%9E%84%E5%BB%BA%E7%89%88%E6%9C%AC%E7%9A%84%E8%A7%A3%E9%87%8A](https://cn.vuejs.org/v2/guide/installation.html#对不同构建版本的解释\">不同构建版本包的使用</a>)。single-spa的核心团队的Joel Denning录了一系列讲解视频在<a href=\"https://www.youtube.com/playlist?list=PLLUD8RtHvsAOhtHnyGx57EYXoaNsxGrTU\" target=\"_blank\" rel=\"noopener\">YouTube</a>和<a href=\"https://space.bilibili.com/495254378/\" target=\"_blank\" rel=\"noopener\">Bilibili</a>，非常推荐。</p>\n<h2 id=\"实施single-spa遇到的问题\"><a href=\"#实施single-spa遇到的问题\" class=\"headerlink\" title=\"实施single-spa遇到的问题\"></a>实施single-spa遇到的问题</h2><ol>\n<li>子应用打包格式错误<br>single-spa 加载子应用的库是systemjs,并不是所有的js文件都可以加载，推荐使用 <code>libraryTarget: &#39;system&#39;</code>,<code>umd</code> 和 <code>amd</code> 亦可。<a href=\"https://webpack.js.org/configuration/output/#outputlibrarytarget\" target=\"_blank\" rel=\"noopener\">参考链接</a><details><br><summary>了解更多</summary><br>Now, there are also various other formats and working with them all is a pain so systemjs has the ‘extras’ it uses in order to interop between them. umd and amd are good formats because they’re designed to work in the browser. But that means there’s a layer to unwrap/interop with so system should be preferred if possible.( from Carlos )<br></details>\n\n\n</li>\n</ol>\n<ol start=\"2\">\n<li>跨域问题<br>这应该是single-spa开发中一定会遇到的一个问题，因为同时启动多个项目肯定在localhost的不同端口，将不同端口的服务加载到root-html中势必会跨域，所以解决它就好了。需要在webpack配置中中添加<br><code>&quot;Access-Control-Allow-Origin&quot;: “*”</code>即可。</li>\n</ol>\n<ol start=\"3\">\n<li>single-spa 子应用挂载时把挂载的dom节点替换掉？<br>拿single-spa-vue为例，1.7.0 会把挂载节点替换掉。而1.8.0 会把挂载节点保留。根据自己的需要选择版本，可以在package-lock.json中锁定版本。</li>\n</ol>\n<ol start=\"4\">\n<li><p>single-spa 的项目如何部署在nginx服务器？<br>single-spa，顾名思义，还是一个单页应用。我们不希望切换路由的时候浏览器发生跳转或者刷新。可以尝试如下配置：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">location / &#123;</span><br><span class=\"line\">      try_files $uri $uri.html /index.html =404;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>System-importmap 存在哪里，如何修改？<br>根据官方的推荐，importmap建议存在S3存储，目前我们使用的内部gift服务，gift上目前没有一个支持https协议的域名，所以使用了cdn的域名。但这个cdn的下发有延迟，导致页面的刷新有些问题，后期考虑存到数据库。</p>\n</li>\n</ol>\n<ol start=\"6\">\n<li>有关public path，external 和 systemjs-webpack-interop的解释<br>首先publicPath是配置项目中所有资源的一个基础路径；<br>externals提供了运行时从外部获取依赖的方法，external可以接受多种模块类型的资源；<br>systemjs-webpack-interop是一个搭配single-spa使用的组件，提供了简单方便修改运行时publicPath的方法。<details><br><summary>了解更多</summary><br>相信下边的链接一定能让你搞明白这两个概念。<br><a href=\"https://www.webpackjs.com/configuration/externals/\" target=\"_blank\" rel=\"noopener\">https://www.webpackjs.com/configuration/externals/</a><br><a href=\"https://www.webpackjs.com/guides/public-path/#on-the-fly\" target=\"_blank\" rel=\"noopener\">https://www.webpackjs.com/guides/public-path/#on-the-fly</a><br><a href=\"https://github.com/joeldenning/systemjs-webpack-interop\" target=\"_blank\" rel=\"noopener\">https://github.com/joeldenning/systemjs-webpack-interop</a><br><a href=\"https://stackoverflow.com/questions/28846814/what-does-publicpath-in-webpack-do\" target=\"_blank\" rel=\"noopener\">https://stackoverflow.com/questions/28846814/what-does-publicpath-in-webpack-do</a><br><a href=\"https://tomasalabes.me/blog/web-development/2016/12/11/Webpack-and-the-public-path.html\" target=\"_blank\" rel=\"noopener\">https://tomasalabes.me/blog/web-development/2016/12/11/Webpack-and-the-public-path.html</a><br></details>\n\n\n</li>\n</ol>\n<ol start=\"7\">\n<li>多个子应用共同依赖的css，组件如何共享，权限如何控制，全局状态如何维护？<br>根据<a href=\"https://single-spa.js.org/docs/recommended-setup/#utility-modules-styleguide-api-etc\" target=\"_blank\" rel=\"noopener\">官方的推荐</a>，可以专门创建一个子应用来做这些事，公共样式，封装http服务，一些不想暴露在全局的状态也可以在这个应用里维护。这个模块可以配合external被其他模块引用。<details><br><summary>了解更多</summary><br><a href=\"https://single-spa.js.org/docs/faq/#how-can-i-share-application-state-between-applications\" target=\"_blank\" rel=\"noopener\">https://single-spa.js.org/docs/faq/#how-can-i-share-application-state-between-applications</a><br></details>\n\n\n</li>\n</ol>\n<ol start=\"8\">\n<li>Css 冲突怎么解决呢？<ol>\n<li>Namespace the CSS belonging to each app with a class, and wrap the app in that container class (such as BEM).</li>\n<li>Use CSS modules in your components <a href=\"https://create-react-app.dev/docs/adding-a-css-modules-stylesheet/\" target=\"_blank\" rel=\"noopener\">https://create-react-app.dev/docs/adding-a-css-modules-stylesheet/</a>( <a href=\"https://vue-loader.vuejs.org/guide/css-modules.html#usage\" target=\"_blank\" rel=\"noopener\">https://vue-loader.vuejs.org/guide/css-modules.html#usage</a>)</li>\n<li>Use a CSS-in-JS library like <a href=\"https://styled-components.com/\" target=\"_blank\" rel=\"noopener\">https://styled-components.com/</a></li>\n<li>The ‘scoped’ attribute in style tag<br>我选的第一种，postcss-plugin-namespace 可以方便的将项目中所有的postcss 加一个prefix，成本很小。其他的都需要改造代码。</li>\n</ol>\n</li>\n</ol>\n<ol start=\"9\">\n<li>不同子应用切换的时候白屏如何解决？<br>一种思路使用预加载；另一种思路是在侦测到有新应用加载时增加一个loading的过渡页；我选第二种。<a href=\"https://single-spa.js.org/docs/api\" target=\"_blank\" rel=\"noopener\">single-spa api文档</a> 提供了 <code>single-spa:before-app-change</code> 和 <code>single-spa:app-change</code> 事件，可以在两个事件中间增加一个loading。(single-spa 5.5.0版本才支持，<a href=\"https://github.com/single-spa/single-spa/issues/545\" target=\"_blank\" rel=\"noopener\">具体请见issue</a>)</li>\n</ol>\n<ol start=\"10\">\n<li>一个完整spa项目想放入single-spa要做什么更改？<br>根据<a href=\"https://single-spa.js.org/docs/migrating-existing-spas\" target=\"_blank\" rel=\"noopener\">官方的推荐</a>,需要两步。一，实现single-spa所需要的bootstrap，mount，unmount等生命周期钩子函数。二，保证你的外部链接报错css，JavaScript等可以独立工作。<strong> 除此之外 </strong>，如果你使用了webpack抽取了很多chunk，这可能会导致失败，因为不同的chunk包不会加载其他依赖的包。Joeldenning建议按路由懒加载进行拆包。</li>\n</ol>\n<ol start=\"11\">\n<li>子应用如何部署，上线时如何更新importMap？<br>微前端的子应用可以独立部署，目前经过OE打包后，在弹性云或odin部署；目前importMap存储在gift，但是弹性云现有的镜像没有提供部署完后继续shell脚本的执行，所以自己做了一个镜像 registry.xiaojukeji.com/didionline/didiyun-mis-nginx-main:stable，它只不过在内部拉起nginx服务后，执行了一个shell脚本，它会更新gift链接中的内容。</li>\n</ol>\n<ol start=\"12\">\n<li>不同子应用访问路径如何配置？<br>不同的子应用跑在不同的弹性云节点，可以通过不同的子域名来进行映射，odin的微前端就是采用这种方案。也可以通过不同的path映射到不同的ip机器上，地图团队的微前端使用的这种方案。我选的后者。<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">upstream misaccount &#123;</span><br><span class=\"line\">  server 10.1.2.3:8080;</span><br><span class=\"line\">  server 10.4.5.6:8080;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">location /mis-account/ &#123;</span><br><span class=\"line\">    proxy_pass http://misaccount/;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<h2 id=\"收益\"><a href=\"#收益\" class=\"headerlink\" title=\"收益\"></a>收益</h2><ol>\n<li>探索了使用single-spa的成本和难度，为改造滴滴云控制台提供了一种解决方案。</li>\n<li>拆分后的项目更独立，为技术栈的改造和升级降低了门槛。</li>\n<li>最最重要的给复用滴滴云控制台的代码提供了一种可维护的方案，目前滴滴云MIS中费用中心使用的是滴滴云控制台中现成的视图组件。</li>\n<li>改版后的MIS懒加载更合理，不同的用户使用MIS中某些特定的功能，真正做到不使用的应用不加载。</li>\n<li>给团队的同学分享和实践了一种可落地的微前端解决方案。</li>\n<li>全新的开发体验，做到开发哪里，替换哪里。(<a href=\"https://github.com/joeldenning/import-map-overrides\" target=\"_blank\" rel=\"noopener\">import-map-overrides新体验</a>)</li>\n</ol>\n<h2 id=\"写在最后的话\"><a href=\"#写在最后的话\" class=\"headerlink\" title=\"写在最后的话\"></a>写在最后的话</h2><p>single-spa核心团队的Joeldenning是一个非常热情，阅历丰富，技术扎实的开发人员。在探索single-spa的过程中，向他学习到很多东西，他也总是能第一时间给出合理的解决方案，并且也是很热心的把再Youtube上的single-spa的介绍视频上传到bilibili一份，投桃报李，我们团队也利用周末时间，进行了<a href=\"https://zh-hans.single-spa.js.org/docs/getting-started-overview\" target=\"_blank\" rel=\"noopener\">single-spa的中文翻译</a>工作，收获良多。</p>\n"},{"title":"gitlab-CI和Docker前端自动化","date":"2019-10-14T12:15:59.000Z","_content":"\nDevOps已经不是什么新概念了，现在前端开发人员多，分支多，测试环境多，前端自动化的重要性不（无)言（形）而（装）喻（比）。本博客的目的是实现在代码更新后，通过gitlab的webhook自动将部署文件打包成docker镜像。然后通过拿镜像名称去服务器上部署。这里我们分三步走，第一步配置Dockerfile先在本地测试docker build的流程；第二部注册gitlab-runner；第三部配置.gitlab-ci.yml监听代码更新后触发docker build流程并push到docker的hub。\n\n## <a name=\"docker_config\">docker 配置</a>\n前端的部署环境很简单，无论你是react，vue还是Angular，部署的时候都是启动一个nginx，然后将build的静态文件放到nginx的共享目录就好了。这里我们不关心前端功能的具体打包过程，直接打包一个简单的html文件到镜像里就好。\n\n#### 1. 安装\ndocker安装很简单，针对不同的系统提供了不同的方法，参照官方文档[Install Docker](https://docs.docker.com/v17.09/engine/installation/)安装即可。\n```\n➜  ~ docker\n\nUsage:\tdocker [OPTIONS] COMMAND\n\nA self-sufficient runtime for containers\n\nOptions:\n      --config string      Location of client config files (default \"/Users/dida/.docker\")\n  -D, --debug              Enable debug mode\n  -H, --host list          Daemon socket(s) to connect to\n  -l, --log-level string   Set the logging level (\"debug\"|\"info\"|\"warn\"|\"error\"|\"fatal\") (default \"info\")\n      --tls                Use TLS; implied by --tlsverify\n      --tlscacert string   Trust certs signed only by this CA (default \"/Users/dida/.docker/ca.pem\")\n      --tlscert string     Path to TLS certificate file (default \"/Users/dida/.docker/cert.pem\")\n      --tlskey string      Path to TLS key file (default \"/Users/dida/.docker/key.pem\")\n      --tlsverify          Use TLS and verify the remote\n  -v, --version            Print version information and quit\n\nManagement Commands:\n  builder     Manage builds\n  config      Manage Docker configs\n  container   Manage containers\n  image       Manage images\n  network     Manage networks\n  node        Manage Swarm nodes\n  plugin      Manage plugins\n  secret      Manage Docker secrets\n  service     Manage services\n  stack       Manage Docker stacks\n  swarm       Manage Swarm\n  system      Manage Docker\n  trust       Manage trust on Docker images\n  volume      Manage volumes\n  ...\n```\n执行`docker`即为安装成功。\n\n#### 2. 镜像制作\n我们需要一个有nginx的镜像，可以nginx依赖一个操作系统。我们用ubuntu为base镜像，在里边安装nginx，然后再讲我们准备好的html（假设其为build后的前端工程）放到nginx的目录。docker build镜像可以用docker commit 也可以用Dockerfile，后者更为灵活，使用也更为广泛。\n\n```\nFROM ubuntu:14.04\nRUN apt-get -yqq update && apt-get -yqq install nginx\nRUN mkdir -p /var/www/html/website\nADD index.html /var/www/html/website\nRUN chmod -R 777 /var/www/html/website\nADD nginx/global.conf /etc/nginx/conf.d/\nADD nginx/nginx.conf /etc/nginx/nginx.conf\nEXPOSE 80\n```\nDockerfile的内容包括以下几项：\n- 使用ubuntu 14.04为基础镜像\n- 更新并安装nginx\n- 在容器中创建一个/var/www/html/website目录\n- 将静态html文件拷贝到上述目录\n- 将上述目录权限改为可读，可写，可执行\n- 将准备好的nginx配置copy到容器中\n- 暴露出来80端口\n\n```\n# global.conf\nserver {\n        listen          0.0.0.0:80;\n        server_name     _;\n\n        root            /var/www/html/website;\n        index           index.html index.htm;\n\n        access_log      /var/log/nginx/default_access.log;\n        error_log       /var/log/nginx/default_error.log;\n}\n```\n\n```\n# nginx.conf\nuser www-data;\nworker_processes 4;\npid /run/nginx.pid;\ndaemon off;\n\nevents {  }\n\nhttp {\n  sendfile on;\n  tcp_nopush on;\n  tcp_nodelay on;\n  keepalive_timeout 65;\n  types_hash_max_size 2048;\n  include /etc/nginx/mime.types;\n  default_type application/octet-stream;\n  access_log /var/log/nginx/access.log;\n  error_log /var/log/nginx/error.log;\n  gzip on;\n  gzip_disable \"msie6\";\n  include /etc/nginx/conf.d/*.conf;\n}\n```\n具体代码可见 https://github.com/guguji5/demo/tree/master/try-ci\n\n打包命令`docker build -t [name]:[tag] .`\n然后`docker images`查看本地镜像\n\n#### 2. 镜像上传\n\b制作好的镜像需要推到远端，就像我们的代码需要git push到仓库一样。首先你需要注册一个[docker账号](https://hub.docker.com/)，`docker login`测试是否登录成功，成功后`docker push [name]:[tag]`推到远端\n\n#### 3. 测试镜像\n```\ndocker run -d -p 8081:80 [name]:[tag] nginx\n```\n查看本地8081端口是否能访问到镜像中的80服务\n\n## gitlab-runner注册\n#### 1.安装\n根据https://docs.gitlab.com/runner/install/ 选择对应平台安装\n根据https://docs.gitlab.com/runner/register/ 进行注册,Runner executor选择shell就好。\n注册成功后可以在Settings下边的CI/CD中的Runners看到刚注册的机器。\n![gitlab-runner](/images/gitlab-runner.jpg)\n#### 2.测试\n新建.gitlab-ci.yml并写入如下简单的命令测试job是否能执行成功\n\n```\n# 执行job的阶段 按顺序串行执行\nstages:\n  - upload\njob2: # 自定义名字\n  stage: upload # 指定这阶段操作的名称\n  only: # 指定那些分支会进入该处理流程\n    - master # 正式环境\n  variables:\n    VERSION: 'damon' # 除了后面会说到的私密变量 还可以在这里定义变量\n  before_script:\n\n  script:\n    - echo \"It is a job2,\"\n    - echo ${VERSION}\n    - your_name=\"qinjx\"\n    - echo $your_name\n    - echo ${your_name}\n\n```\n\n每当master有新的提交时，出触发上述脚本的运行。我们可以在CI/CD - Pipelines中看到对应的job。\n\n![gitlab-runner-job](/images/gitlab-runner-job.png)\n\n## 自动化打包镜像\n我们的最终目的是每当代码更新后，自动打包成docker镜像，部署的每台服务器都用同一镜像部署就好。Build Once, Deploy Everywhere.\n\n每当代码更新后gitlab 的hook会自动触发，我们只需要把<a href=\"#docker_config\">第一步</a>中的打包和上传的流程放到hook中即可。.gitlab-ci.yml如下：\n```\nstages:\n  - build\n \n# 自定义阶段build的job流程\njob1: # 自定义名字\n  stage: build # 指定这阶段操作的名称\n  only: # 指定那些分支会进入该处理流程\n    - master # 正式环境\n    - pre # 预发环境\n  before_script:\n\n  script:\n    - docker login -u $USERNAME -p $PASSWORD\n    - IMAGE_ID=`docker build . | tail -n 1 | awk -F \"Successfully built \" '{print $2}' | sed 's/^ *\\| *$//g'`\n    - echo \"IMAGE_ID=$IMAGE_ID\"\n    - DATE=`date +%Y%m%d`;\n    - docker tag $IMAGE_ID guguji/forth:$DATE.$CI_JOB_ID;\n    - docker push guguji/forth:$DATE.$CI_JOB_ID;\n    - docker rmi guguji/forth:$DATE.$CI_JOB_ID;\n    - echo \"--------------------------------------------------------------------------------\";\n    - echo \"guguji/forth:$DATE.$CI_JOB_ID\";\n```\n\n其中的$USERNAME $PASSWORD是Setting - CI/CD - Variables 中存入的变量。其含义依次是：\n- 登录docker\n- 执行docker build 并将输出的将镜像ID赋值给IMAGE_ID\n- 给上述镜像打上标签\n- 上传到docker hub\n- 删除本地镜像\n- 输出镜像名称\n\n结果如下\n```\nRunning with gitlab-runner 12.3.0 (a8a019e0)\n  on damon test xXUC7Le6\nUsing Shell executor...\nRunning on 10-254-203-137...\nFetching changes...\nReinitialized existing Git repository in /home/gitlab-runner/builds/xXUC7Le6/0/guguji5/try-ci/.git/\nFrom https://gitlab.com/guguji5/try-ci\n * [new ref]         refs/pipelines/89119102 -> refs/pipelines/89119102\n   7aeff9e..6d585aa  master     -> origin/master\nChecking out 6d585aa7 as master...\nSkipping Git submodules setup\n$ docker login -u $USERNAME -p $PASSWORD\nWARNING! Using --password via the CLI is insecure. Use --password-stdin.\nWARNING! Your password will be stored unencrypted in /home/gitlab-runner/.docker/config.json.\nConfigure a credential helper to remove this warning. See\nhttps://docs.docker.com/engine/reference/commandline/login/#credentials-store\n\nLogin Succeeded\n$ IMAGE_ID=`docker build . | tail -n 1 | awk -F \"Successfully built \" '{print $2}' | sed 's/^ *\\| *$//g'`\n$ echo \"IMAGE_ID=$IMAGE_ID\"\nIMAGE_ID=41555aab3b76\n$ DATE=`date +%Y%m%d`;\n$ docker tag $IMAGE_ID guguji/forth:$DATE.$CI_JOB_ID;\n$ docker push guguji/forth:$DATE.$CI_JOB_ID;\nThe push refers to repository [docker.io/guguji/forth]\n82ce84f6435c: Preparing\n8f360e1cf4bb: Preparing\n8f360e1cf4bb: Pushed\n29c9093a1ab9: Pushed\n66285ac4bf24: Layer already exists\n48334332ed8d: Layer already exists\n82ce84f6435c: Pushed\nb057ab380990: Layer already exists\nbc89fbcf9125: Pushed\n46c1a22ffea5: Layer already exists\nb17e63608209: Layer already exists\n20191016.322211021: digest: sha256:971e8c83827b10e1ffb9d109f7b2507e26622b56113f5ee183b92bdc8e0acd8a size: 2401\n$ docker rmi guguji/forth:$DATE.$CI_JOB_ID;\nUntagged: guguji/forth:20191016.322211021\nUntagged: guguji/forth@sha256:971e8c83827b10e1ffb9d109f7b2507e26622b56113f5ee183b92bdc8e0acd8a\nDeleted: sha256:41555aab3b76a88fbde71a02afd7c400973d8ec9f1ab7ce533d4d7cc6dfdb17e\nDeleted: sha256:854ac28d0ceabc1b910aa58e96d1fabe577a63a60c3459ca7ee6152f00630cc1\n$ echo \"--------------------------------------------------------------------------------\";\n--------------------------------------------------------------------------------\n$ echo \"guguji/forth:$DATE.$CI_JOB_ID\";\nguguji/forth:20191016.322211021\nJob succeeded\n```\n\n*如果有如下报错*\n```\nGot permission denied while trying to connect to the Docker daemon socket\n```\n原因是gitlab-runner执行时 是以 gitlab-runner用户来执行的 该用户不属于docker group，需将该用户加入该组。\n首先查询 是否有该用户 `cut -d : -f 1 /etc/passwd`\n然后查询 是否存在docker组`sudo groupadd docker`\n然后执行 将gitlab-runner加入docker组 `sudo gpasswd -a gitlab-runner docker`\n\n**我们想要的效果**是在服务器上拉取我们刚build并上传的镜像，并run 起来就好。我们可以在本地用如下命令测试刚打包的镜像\n\n```\ndocker pull guguji/forth:20191016.322211021\ndocker run -d -p 8080:80 guguji/forth:20191016.322211021 nginx\n```\n效果如下\n```\n➜  ~ docker pull guguji/forth:20191016.322211021\n20191016.322211021: Pulling from guguji/forth\na7344f52cb74: Already exists\n515c9bb51536: Already exists\ne1eabe0537eb: Already exists\n4701f1215c13: Already exists\nb9999057545e: Pull complete\n57c313e6fd56: Pull complete\n76ac29208590: Pull complete\nebec49c77172: Pull complete\nc514c1fe8afa: Pull complete\nde4ad1f5b5dc: Pull complete\nDigest: sha256:971e8c83827b10e1ffb9d109f7b2507e26622b56113f5ee183b92bdc8e0acd8a\nStatus: Downloaded newer image for guguji/forth:20191016.322211021\n➜  ~ docker run -d -p 8080:80 guguji/forth:20191016.322211021 nginx\n330efb99cafab59b46ddaf61a62221bf94722e9c76be59523b538cb3a49bd651\n➜  ~\n```\n![gitlab-runner-sample](/images/gitlab-runner-sample.png)\n","source":"_posts/gitlab-CI和Docker前端自动化.md","raw":"---\ntitle: gitlab-CI和Docker前端自动化\ndate: 2019-10-14 20:15:59\ntags:\n---\n\nDevOps已经不是什么新概念了，现在前端开发人员多，分支多，测试环境多，前端自动化的重要性不（无)言（形）而（装）喻（比）。本博客的目的是实现在代码更新后，通过gitlab的webhook自动将部署文件打包成docker镜像。然后通过拿镜像名称去服务器上部署。这里我们分三步走，第一步配置Dockerfile先在本地测试docker build的流程；第二部注册gitlab-runner；第三部配置.gitlab-ci.yml监听代码更新后触发docker build流程并push到docker的hub。\n\n## <a name=\"docker_config\">docker 配置</a>\n前端的部署环境很简单，无论你是react，vue还是Angular，部署的时候都是启动一个nginx，然后将build的静态文件放到nginx的共享目录就好了。这里我们不关心前端功能的具体打包过程，直接打包一个简单的html文件到镜像里就好。\n\n#### 1. 安装\ndocker安装很简单，针对不同的系统提供了不同的方法，参照官方文档[Install Docker](https://docs.docker.com/v17.09/engine/installation/)安装即可。\n```\n➜  ~ docker\n\nUsage:\tdocker [OPTIONS] COMMAND\n\nA self-sufficient runtime for containers\n\nOptions:\n      --config string      Location of client config files (default \"/Users/dida/.docker\")\n  -D, --debug              Enable debug mode\n  -H, --host list          Daemon socket(s) to connect to\n  -l, --log-level string   Set the logging level (\"debug\"|\"info\"|\"warn\"|\"error\"|\"fatal\") (default \"info\")\n      --tls                Use TLS; implied by --tlsverify\n      --tlscacert string   Trust certs signed only by this CA (default \"/Users/dida/.docker/ca.pem\")\n      --tlscert string     Path to TLS certificate file (default \"/Users/dida/.docker/cert.pem\")\n      --tlskey string      Path to TLS key file (default \"/Users/dida/.docker/key.pem\")\n      --tlsverify          Use TLS and verify the remote\n  -v, --version            Print version information and quit\n\nManagement Commands:\n  builder     Manage builds\n  config      Manage Docker configs\n  container   Manage containers\n  image       Manage images\n  network     Manage networks\n  node        Manage Swarm nodes\n  plugin      Manage plugins\n  secret      Manage Docker secrets\n  service     Manage services\n  stack       Manage Docker stacks\n  swarm       Manage Swarm\n  system      Manage Docker\n  trust       Manage trust on Docker images\n  volume      Manage volumes\n  ...\n```\n执行`docker`即为安装成功。\n\n#### 2. 镜像制作\n我们需要一个有nginx的镜像，可以nginx依赖一个操作系统。我们用ubuntu为base镜像，在里边安装nginx，然后再讲我们准备好的html（假设其为build后的前端工程）放到nginx的目录。docker build镜像可以用docker commit 也可以用Dockerfile，后者更为灵活，使用也更为广泛。\n\n```\nFROM ubuntu:14.04\nRUN apt-get -yqq update && apt-get -yqq install nginx\nRUN mkdir -p /var/www/html/website\nADD index.html /var/www/html/website\nRUN chmod -R 777 /var/www/html/website\nADD nginx/global.conf /etc/nginx/conf.d/\nADD nginx/nginx.conf /etc/nginx/nginx.conf\nEXPOSE 80\n```\nDockerfile的内容包括以下几项：\n- 使用ubuntu 14.04为基础镜像\n- 更新并安装nginx\n- 在容器中创建一个/var/www/html/website目录\n- 将静态html文件拷贝到上述目录\n- 将上述目录权限改为可读，可写，可执行\n- 将准备好的nginx配置copy到容器中\n- 暴露出来80端口\n\n```\n# global.conf\nserver {\n        listen          0.0.0.0:80;\n        server_name     _;\n\n        root            /var/www/html/website;\n        index           index.html index.htm;\n\n        access_log      /var/log/nginx/default_access.log;\n        error_log       /var/log/nginx/default_error.log;\n}\n```\n\n```\n# nginx.conf\nuser www-data;\nworker_processes 4;\npid /run/nginx.pid;\ndaemon off;\n\nevents {  }\n\nhttp {\n  sendfile on;\n  tcp_nopush on;\n  tcp_nodelay on;\n  keepalive_timeout 65;\n  types_hash_max_size 2048;\n  include /etc/nginx/mime.types;\n  default_type application/octet-stream;\n  access_log /var/log/nginx/access.log;\n  error_log /var/log/nginx/error.log;\n  gzip on;\n  gzip_disable \"msie6\";\n  include /etc/nginx/conf.d/*.conf;\n}\n```\n具体代码可见 https://github.com/guguji5/demo/tree/master/try-ci\n\n打包命令`docker build -t [name]:[tag] .`\n然后`docker images`查看本地镜像\n\n#### 2. 镜像上传\n\b制作好的镜像需要推到远端，就像我们的代码需要git push到仓库一样。首先你需要注册一个[docker账号](https://hub.docker.com/)，`docker login`测试是否登录成功，成功后`docker push [name]:[tag]`推到远端\n\n#### 3. 测试镜像\n```\ndocker run -d -p 8081:80 [name]:[tag] nginx\n```\n查看本地8081端口是否能访问到镜像中的80服务\n\n## gitlab-runner注册\n#### 1.安装\n根据https://docs.gitlab.com/runner/install/ 选择对应平台安装\n根据https://docs.gitlab.com/runner/register/ 进行注册,Runner executor选择shell就好。\n注册成功后可以在Settings下边的CI/CD中的Runners看到刚注册的机器。\n![gitlab-runner](/images/gitlab-runner.jpg)\n#### 2.测试\n新建.gitlab-ci.yml并写入如下简单的命令测试job是否能执行成功\n\n```\n# 执行job的阶段 按顺序串行执行\nstages:\n  - upload\njob2: # 自定义名字\n  stage: upload # 指定这阶段操作的名称\n  only: # 指定那些分支会进入该处理流程\n    - master # 正式环境\n  variables:\n    VERSION: 'damon' # 除了后面会说到的私密变量 还可以在这里定义变量\n  before_script:\n\n  script:\n    - echo \"It is a job2,\"\n    - echo ${VERSION}\n    - your_name=\"qinjx\"\n    - echo $your_name\n    - echo ${your_name}\n\n```\n\n每当master有新的提交时，出触发上述脚本的运行。我们可以在CI/CD - Pipelines中看到对应的job。\n\n![gitlab-runner-job](/images/gitlab-runner-job.png)\n\n## 自动化打包镜像\n我们的最终目的是每当代码更新后，自动打包成docker镜像，部署的每台服务器都用同一镜像部署就好。Build Once, Deploy Everywhere.\n\n每当代码更新后gitlab 的hook会自动触发，我们只需要把<a href=\"#docker_config\">第一步</a>中的打包和上传的流程放到hook中即可。.gitlab-ci.yml如下：\n```\nstages:\n  - build\n \n# 自定义阶段build的job流程\njob1: # 自定义名字\n  stage: build # 指定这阶段操作的名称\n  only: # 指定那些分支会进入该处理流程\n    - master # 正式环境\n    - pre # 预发环境\n  before_script:\n\n  script:\n    - docker login -u $USERNAME -p $PASSWORD\n    - IMAGE_ID=`docker build . | tail -n 1 | awk -F \"Successfully built \" '{print $2}' | sed 's/^ *\\| *$//g'`\n    - echo \"IMAGE_ID=$IMAGE_ID\"\n    - DATE=`date +%Y%m%d`;\n    - docker tag $IMAGE_ID guguji/forth:$DATE.$CI_JOB_ID;\n    - docker push guguji/forth:$DATE.$CI_JOB_ID;\n    - docker rmi guguji/forth:$DATE.$CI_JOB_ID;\n    - echo \"--------------------------------------------------------------------------------\";\n    - echo \"guguji/forth:$DATE.$CI_JOB_ID\";\n```\n\n其中的$USERNAME $PASSWORD是Setting - CI/CD - Variables 中存入的变量。其含义依次是：\n- 登录docker\n- 执行docker build 并将输出的将镜像ID赋值给IMAGE_ID\n- 给上述镜像打上标签\n- 上传到docker hub\n- 删除本地镜像\n- 输出镜像名称\n\n结果如下\n```\nRunning with gitlab-runner 12.3.0 (a8a019e0)\n  on damon test xXUC7Le6\nUsing Shell executor...\nRunning on 10-254-203-137...\nFetching changes...\nReinitialized existing Git repository in /home/gitlab-runner/builds/xXUC7Le6/0/guguji5/try-ci/.git/\nFrom https://gitlab.com/guguji5/try-ci\n * [new ref]         refs/pipelines/89119102 -> refs/pipelines/89119102\n   7aeff9e..6d585aa  master     -> origin/master\nChecking out 6d585aa7 as master...\nSkipping Git submodules setup\n$ docker login -u $USERNAME -p $PASSWORD\nWARNING! Using --password via the CLI is insecure. Use --password-stdin.\nWARNING! Your password will be stored unencrypted in /home/gitlab-runner/.docker/config.json.\nConfigure a credential helper to remove this warning. See\nhttps://docs.docker.com/engine/reference/commandline/login/#credentials-store\n\nLogin Succeeded\n$ IMAGE_ID=`docker build . | tail -n 1 | awk -F \"Successfully built \" '{print $2}' | sed 's/^ *\\| *$//g'`\n$ echo \"IMAGE_ID=$IMAGE_ID\"\nIMAGE_ID=41555aab3b76\n$ DATE=`date +%Y%m%d`;\n$ docker tag $IMAGE_ID guguji/forth:$DATE.$CI_JOB_ID;\n$ docker push guguji/forth:$DATE.$CI_JOB_ID;\nThe push refers to repository [docker.io/guguji/forth]\n82ce84f6435c: Preparing\n8f360e1cf4bb: Preparing\n8f360e1cf4bb: Pushed\n29c9093a1ab9: Pushed\n66285ac4bf24: Layer already exists\n48334332ed8d: Layer already exists\n82ce84f6435c: Pushed\nb057ab380990: Layer already exists\nbc89fbcf9125: Pushed\n46c1a22ffea5: Layer already exists\nb17e63608209: Layer already exists\n20191016.322211021: digest: sha256:971e8c83827b10e1ffb9d109f7b2507e26622b56113f5ee183b92bdc8e0acd8a size: 2401\n$ docker rmi guguji/forth:$DATE.$CI_JOB_ID;\nUntagged: guguji/forth:20191016.322211021\nUntagged: guguji/forth@sha256:971e8c83827b10e1ffb9d109f7b2507e26622b56113f5ee183b92bdc8e0acd8a\nDeleted: sha256:41555aab3b76a88fbde71a02afd7c400973d8ec9f1ab7ce533d4d7cc6dfdb17e\nDeleted: sha256:854ac28d0ceabc1b910aa58e96d1fabe577a63a60c3459ca7ee6152f00630cc1\n$ echo \"--------------------------------------------------------------------------------\";\n--------------------------------------------------------------------------------\n$ echo \"guguji/forth:$DATE.$CI_JOB_ID\";\nguguji/forth:20191016.322211021\nJob succeeded\n```\n\n*如果有如下报错*\n```\nGot permission denied while trying to connect to the Docker daemon socket\n```\n原因是gitlab-runner执行时 是以 gitlab-runner用户来执行的 该用户不属于docker group，需将该用户加入该组。\n首先查询 是否有该用户 `cut -d : -f 1 /etc/passwd`\n然后查询 是否存在docker组`sudo groupadd docker`\n然后执行 将gitlab-runner加入docker组 `sudo gpasswd -a gitlab-runner docker`\n\n**我们想要的效果**是在服务器上拉取我们刚build并上传的镜像，并run 起来就好。我们可以在本地用如下命令测试刚打包的镜像\n\n```\ndocker pull guguji/forth:20191016.322211021\ndocker run -d -p 8080:80 guguji/forth:20191016.322211021 nginx\n```\n效果如下\n```\n➜  ~ docker pull guguji/forth:20191016.322211021\n20191016.322211021: Pulling from guguji/forth\na7344f52cb74: Already exists\n515c9bb51536: Already exists\ne1eabe0537eb: Already exists\n4701f1215c13: Already exists\nb9999057545e: Pull complete\n57c313e6fd56: Pull complete\n76ac29208590: Pull complete\nebec49c77172: Pull complete\nc514c1fe8afa: Pull complete\nde4ad1f5b5dc: Pull complete\nDigest: sha256:971e8c83827b10e1ffb9d109f7b2507e26622b56113f5ee183b92bdc8e0acd8a\nStatus: Downloaded newer image for guguji/forth:20191016.322211021\n➜  ~ docker run -d -p 8080:80 guguji/forth:20191016.322211021 nginx\n330efb99cafab59b46ddaf61a62221bf94722e9c76be59523b538cb3a49bd651\n➜  ~\n```\n![gitlab-runner-sample](/images/gitlab-runner-sample.png)\n","slug":"gitlab-CI和Docker前端自动化","published":1,"updated":"2019-10-16T08:32:02.048Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckrix8zey001ek1jfed8i66tm","content":"<p>DevOps已经不是什么新概念了，现在前端开发人员多，分支多，测试环境多，前端自动化的重要性不（无)言（形）而（装）喻（比）。本博客的目的是实现在代码更新后，通过gitlab的webhook自动将部署文件打包成docker镜像。然后通过拿镜像名称去服务器上部署。这里我们分三步走，第一步配置Dockerfile先在本地测试docker build的流程；第二部注册gitlab-runner；第三部配置.gitlab-ci.yml监听代码更新后触发docker build流程并push到docker的hub。</p>\n<h2 id=\"docker-配置\"><a href=\"#docker-配置\" class=\"headerlink\" title=\"docker 配置\"></a><a name=\"docker_config\">docker 配置</a></h2><p>前端的部署环境很简单，无论你是react，vue还是Angular，部署的时候都是启动一个nginx，然后将build的静态文件放到nginx的共享目录就好了。这里我们不关心前端功能的具体打包过程，直接打包一个简单的html文件到镜像里就好。</p>\n<h4 id=\"1-安装\"><a href=\"#1-安装\" class=\"headerlink\" title=\"1. 安装\"></a>1. 安装</h4><p>docker安装很简单，针对不同的系统提供了不同的方法，参照官方文档<a href=\"https://docs.docker.com/v17.09/engine/installation/\" target=\"_blank\" rel=\"noopener\">Install Docker</a>安装即可。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  ~ docker</span><br><span class=\"line\"></span><br><span class=\"line\">Usage:\tdocker [OPTIONS] COMMAND</span><br><span class=\"line\"></span><br><span class=\"line\">A self-sufficient runtime for containers</span><br><span class=\"line\"></span><br><span class=\"line\">Options:</span><br><span class=\"line\">      --config string      Location of client config files (default &quot;/Users/dida/.docker&quot;)</span><br><span class=\"line\">  -D, --debug              Enable debug mode</span><br><span class=\"line\">  -H, --host list          Daemon socket(s) to connect to</span><br><span class=\"line\">  -l, --log-level string   Set the logging level (&quot;debug&quot;|&quot;info&quot;|&quot;warn&quot;|&quot;error&quot;|&quot;fatal&quot;) (default &quot;info&quot;)</span><br><span class=\"line\">      --tls                Use TLS; implied by --tlsverify</span><br><span class=\"line\">      --tlscacert string   Trust certs signed only by this CA (default &quot;/Users/dida/.docker/ca.pem&quot;)</span><br><span class=\"line\">      --tlscert string     Path to TLS certificate file (default &quot;/Users/dida/.docker/cert.pem&quot;)</span><br><span class=\"line\">      --tlskey string      Path to TLS key file (default &quot;/Users/dida/.docker/key.pem&quot;)</span><br><span class=\"line\">      --tlsverify          Use TLS and verify the remote</span><br><span class=\"line\">  -v, --version            Print version information and quit</span><br><span class=\"line\"></span><br><span class=\"line\">Management Commands:</span><br><span class=\"line\">  builder     Manage builds</span><br><span class=\"line\">  config      Manage Docker configs</span><br><span class=\"line\">  container   Manage containers</span><br><span class=\"line\">  image       Manage images</span><br><span class=\"line\">  network     Manage networks</span><br><span class=\"line\">  node        Manage Swarm nodes</span><br><span class=\"line\">  plugin      Manage plugins</span><br><span class=\"line\">  secret      Manage Docker secrets</span><br><span class=\"line\">  service     Manage services</span><br><span class=\"line\">  stack       Manage Docker stacks</span><br><span class=\"line\">  swarm       Manage Swarm</span><br><span class=\"line\">  system      Manage Docker</span><br><span class=\"line\">  trust       Manage trust on Docker images</span><br><span class=\"line\">  volume      Manage volumes</span><br><span class=\"line\">  ...</span><br></pre></td></tr></table></figure></p>\n<p>执行<code>docker</code>即为安装成功。</p>\n<h4 id=\"2-镜像制作\"><a href=\"#2-镜像制作\" class=\"headerlink\" title=\"2. 镜像制作\"></a>2. 镜像制作</h4><p>我们需要一个有nginx的镜像，可以nginx依赖一个操作系统。我们用ubuntu为base镜像，在里边安装nginx，然后再讲我们准备好的html（假设其为build后的前端工程）放到nginx的目录。docker build镜像可以用docker commit 也可以用Dockerfile，后者更为灵活，使用也更为广泛。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">FROM ubuntu:14.04</span><br><span class=\"line\">RUN apt-get -yqq update &amp;&amp; apt-get -yqq install nginx</span><br><span class=\"line\">RUN mkdir -p /var/www/html/website</span><br><span class=\"line\">ADD index.html /var/www/html/website</span><br><span class=\"line\">RUN chmod -R 777 /var/www/html/website</span><br><span class=\"line\">ADD nginx/global.conf /etc/nginx/conf.d/</span><br><span class=\"line\">ADD nginx/nginx.conf /etc/nginx/nginx.conf</span><br><span class=\"line\">EXPOSE 80</span><br></pre></td></tr></table></figure>\n<p>Dockerfile的内容包括以下几项：</p>\n<ul>\n<li>使用ubuntu 14.04为基础镜像</li>\n<li>更新并安装nginx</li>\n<li>在容器中创建一个/var/www/html/website目录</li>\n<li>将静态html文件拷贝到上述目录</li>\n<li>将上述目录权限改为可读，可写，可执行</li>\n<li>将准备好的nginx配置copy到容器中</li>\n<li>暴露出来80端口</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># global.conf</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen          0.0.0.0:80;</span><br><span class=\"line\">        server_name     _;</span><br><span class=\"line\"></span><br><span class=\"line\">        root            /var/www/html/website;</span><br><span class=\"line\">        index           index.html index.htm;</span><br><span class=\"line\"></span><br><span class=\"line\">        access_log      /var/log/nginx/default_access.log;</span><br><span class=\"line\">        error_log       /var/log/nginx/default_error.log;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># nginx.conf</span><br><span class=\"line\">user www-data;</span><br><span class=\"line\">worker_processes 4;</span><br><span class=\"line\">pid /run/nginx.pid;</span><br><span class=\"line\">daemon off;</span><br><span class=\"line\"></span><br><span class=\"line\">events &#123;  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">http &#123;</span><br><span class=\"line\">  sendfile on;</span><br><span class=\"line\">  tcp_nopush on;</span><br><span class=\"line\">  tcp_nodelay on;</span><br><span class=\"line\">  keepalive_timeout 65;</span><br><span class=\"line\">  types_hash_max_size 2048;</span><br><span class=\"line\">  include /etc/nginx/mime.types;</span><br><span class=\"line\">  default_type application/octet-stream;</span><br><span class=\"line\">  access_log /var/log/nginx/access.log;</span><br><span class=\"line\">  error_log /var/log/nginx/error.log;</span><br><span class=\"line\">  gzip on;</span><br><span class=\"line\">  gzip_disable &quot;msie6&quot;;</span><br><span class=\"line\">  include /etc/nginx/conf.d/*.conf;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>具体代码可见 <a href=\"https://github.com/guguji5/demo/tree/master/try-ci\" target=\"_blank\" rel=\"noopener\">https://github.com/guguji5/demo/tree/master/try-ci</a></p>\n<p>打包命令<code>docker build -t [name]:[tag] .</code><br>然后<code>docker images</code>查看本地镜像</p>\n<h4 id=\"2-镜像上传\"><a href=\"#2-镜像上传\" class=\"headerlink\" title=\"2. 镜像上传\"></a>2. 镜像上传</h4><p>\b制作好的镜像需要推到远端，就像我们的代码需要git push到仓库一样。首先你需要注册一个<a href=\"https://hub.docker.com/\" target=\"_blank\" rel=\"noopener\">docker账号</a>，<code>docker login</code>测试是否登录成功，成功后<code>docker push [name]:[tag]</code>推到远端</p>\n<h4 id=\"3-测试镜像\"><a href=\"#3-测试镜像\" class=\"headerlink\" title=\"3. 测试镜像\"></a>3. 测试镜像</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -d -p 8081:80 [name]:[tag] nginx</span><br></pre></td></tr></table></figure>\n<p>查看本地8081端口是否能访问到镜像中的80服务</p>\n<h2 id=\"gitlab-runner注册\"><a href=\"#gitlab-runner注册\" class=\"headerlink\" title=\"gitlab-runner注册\"></a>gitlab-runner注册</h2><h4 id=\"1-安装-1\"><a href=\"#1-安装-1\" class=\"headerlink\" title=\"1.安装\"></a>1.安装</h4><p>根据<a href=\"https://docs.gitlab.com/runner/install/\" target=\"_blank\" rel=\"noopener\">https://docs.gitlab.com/runner/install/</a> 选择对应平台安装<br>根据<a href=\"https://docs.gitlab.com/runner/register/\" target=\"_blank\" rel=\"noopener\">https://docs.gitlab.com/runner/register/</a> 进行注册,Runner executor选择shell就好。<br>注册成功后可以在Settings下边的CI/CD中的Runners看到刚注册的机器。<br><img src=\"/images/gitlab-runner.jpg\" alt=\"gitlab-runner\"></p>\n<h4 id=\"2-测试\"><a href=\"#2-测试\" class=\"headerlink\" title=\"2.测试\"></a>2.测试</h4><p>新建.gitlab-ci.yml并写入如下简单的命令测试job是否能执行成功</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 执行job的阶段 按顺序串行执行</span><br><span class=\"line\">stages:</span><br><span class=\"line\">  - upload</span><br><span class=\"line\">job2: # 自定义名字</span><br><span class=\"line\">  stage: upload # 指定这阶段操作的名称</span><br><span class=\"line\">  only: # 指定那些分支会进入该处理流程</span><br><span class=\"line\">    - master # 正式环境</span><br><span class=\"line\">  variables:</span><br><span class=\"line\">    VERSION: &apos;damon&apos; # 除了后面会说到的私密变量 还可以在这里定义变量</span><br><span class=\"line\">  before_script:</span><br><span class=\"line\"></span><br><span class=\"line\">  script:</span><br><span class=\"line\">    - echo &quot;It is a job2,&quot;</span><br><span class=\"line\">    - echo $&#123;VERSION&#125;</span><br><span class=\"line\">    - your_name=&quot;qinjx&quot;</span><br><span class=\"line\">    - echo $your_name</span><br><span class=\"line\">    - echo $&#123;your_name&#125;</span><br></pre></td></tr></table></figure>\n<p>每当master有新的提交时，出触发上述脚本的运行。我们可以在CI/CD - Pipelines中看到对应的job。</p>\n<p><img src=\"/images/gitlab-runner-job.png\" alt=\"gitlab-runner-job\"></p>\n<h2 id=\"自动化打包镜像\"><a href=\"#自动化打包镜像\" class=\"headerlink\" title=\"自动化打包镜像\"></a>自动化打包镜像</h2><p>我们的最终目的是每当代码更新后，自动打包成docker镜像，部署的每台服务器都用同一镜像部署就好。Build Once, Deploy Everywhere.</p>\n<p>每当代码更新后gitlab 的hook会自动触发，我们只需要把<a href=\"#docker_config\">第一步</a>中的打包和上传的流程放到hook中即可。.gitlab-ci.yml如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">stages:</span><br><span class=\"line\">  - build</span><br><span class=\"line\"> </span><br><span class=\"line\"># 自定义阶段build的job流程</span><br><span class=\"line\">job1: # 自定义名字</span><br><span class=\"line\">  stage: build # 指定这阶段操作的名称</span><br><span class=\"line\">  only: # 指定那些分支会进入该处理流程</span><br><span class=\"line\">    - master # 正式环境</span><br><span class=\"line\">    - pre # 预发环境</span><br><span class=\"line\">  before_script:</span><br><span class=\"line\"></span><br><span class=\"line\">  script:</span><br><span class=\"line\">    - docker login -u $USERNAME -p $PASSWORD</span><br><span class=\"line\">    - IMAGE_ID=`docker build . | tail -n 1 | awk -F &quot;Successfully built &quot; &apos;&#123;print $2&#125;&apos; | sed &apos;s/^ *\\| *$//g&apos;`</span><br><span class=\"line\">    - echo &quot;IMAGE_ID=$IMAGE_ID&quot;</span><br><span class=\"line\">    - DATE=`date +%Y%m%d`;</span><br><span class=\"line\">    - docker tag $IMAGE_ID guguji/forth:$DATE.$CI_JOB_ID;</span><br><span class=\"line\">    - docker push guguji/forth:$DATE.$CI_JOB_ID;</span><br><span class=\"line\">    - docker rmi guguji/forth:$DATE.$CI_JOB_ID;</span><br><span class=\"line\">    - echo &quot;--------------------------------------------------------------------------------&quot;;</span><br><span class=\"line\">    - echo &quot;guguji/forth:$DATE.$CI_JOB_ID&quot;;</span><br></pre></td></tr></table></figure></p>\n<p>其中的$USERNAME $PASSWORD是Setting - CI/CD - Variables 中存入的变量。其含义依次是：</p>\n<ul>\n<li>登录docker</li>\n<li>执行docker build 并将输出的将镜像ID赋值给IMAGE_ID</li>\n<li>给上述镜像打上标签</li>\n<li>上传到docker hub</li>\n<li>删除本地镜像</li>\n<li>输出镜像名称</li>\n</ul>\n<p>结果如下<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Running with gitlab-runner 12.3.0 (a8a019e0)</span><br><span class=\"line\">  on damon test xXUC7Le6</span><br><span class=\"line\">Using Shell executor...</span><br><span class=\"line\">Running on 10-254-203-137...</span><br><span class=\"line\">Fetching changes...</span><br><span class=\"line\">Reinitialized existing Git repository in /home/gitlab-runner/builds/xXUC7Le6/0/guguji5/try-ci/.git/</span><br><span class=\"line\">From https://gitlab.com/guguji5/try-ci</span><br><span class=\"line\"> * [new ref]         refs/pipelines/89119102 -&gt; refs/pipelines/89119102</span><br><span class=\"line\">   7aeff9e..6d585aa  master     -&gt; origin/master</span><br><span class=\"line\">Checking out 6d585aa7 as master...</span><br><span class=\"line\">Skipping Git submodules setup</span><br><span class=\"line\">$ docker login -u $USERNAME -p $PASSWORD</span><br><span class=\"line\">WARNING! Using --password via the CLI is insecure. Use --password-stdin.</span><br><span class=\"line\">WARNING! Your password will be stored unencrypted in /home/gitlab-runner/.docker/config.json.</span><br><span class=\"line\">Configure a credential helper to remove this warning. See</span><br><span class=\"line\">https://docs.docker.com/engine/reference/commandline/login/#credentials-store</span><br><span class=\"line\"></span><br><span class=\"line\">Login Succeeded</span><br><span class=\"line\">$ IMAGE_ID=`docker build . | tail -n 1 | awk -F &quot;Successfully built &quot; &apos;&#123;print $2&#125;&apos; | sed &apos;s/^ *\\| *$//g&apos;`</span><br><span class=\"line\">$ echo &quot;IMAGE_ID=$IMAGE_ID&quot;</span><br><span class=\"line\">IMAGE_ID=41555aab3b76</span><br><span class=\"line\">$ DATE=`date +%Y%m%d`;</span><br><span class=\"line\">$ docker tag $IMAGE_ID guguji/forth:$DATE.$CI_JOB_ID;</span><br><span class=\"line\">$ docker push guguji/forth:$DATE.$CI_JOB_ID;</span><br><span class=\"line\">The push refers to repository [docker.io/guguji/forth]</span><br><span class=\"line\">82ce84f6435c: Preparing</span><br><span class=\"line\">8f360e1cf4bb: Preparing</span><br><span class=\"line\">8f360e1cf4bb: Pushed</span><br><span class=\"line\">29c9093a1ab9: Pushed</span><br><span class=\"line\">66285ac4bf24: Layer already exists</span><br><span class=\"line\">48334332ed8d: Layer already exists</span><br><span class=\"line\">82ce84f6435c: Pushed</span><br><span class=\"line\">b057ab380990: Layer already exists</span><br><span class=\"line\">bc89fbcf9125: Pushed</span><br><span class=\"line\">46c1a22ffea5: Layer already exists</span><br><span class=\"line\">b17e63608209: Layer already exists</span><br><span class=\"line\">20191016.322211021: digest: sha256:971e8c83827b10e1ffb9d109f7b2507e26622b56113f5ee183b92bdc8e0acd8a size: 2401</span><br><span class=\"line\">$ docker rmi guguji/forth:$DATE.$CI_JOB_ID;</span><br><span class=\"line\">Untagged: guguji/forth:20191016.322211021</span><br><span class=\"line\">Untagged: guguji/forth@sha256:971e8c83827b10e1ffb9d109f7b2507e26622b56113f5ee183b92bdc8e0acd8a</span><br><span class=\"line\">Deleted: sha256:41555aab3b76a88fbde71a02afd7c400973d8ec9f1ab7ce533d4d7cc6dfdb17e</span><br><span class=\"line\">Deleted: sha256:854ac28d0ceabc1b910aa58e96d1fabe577a63a60c3459ca7ee6152f00630cc1</span><br><span class=\"line\">$ echo &quot;--------------------------------------------------------------------------------&quot;;</span><br><span class=\"line\">--------------------------------------------------------------------------------</span><br><span class=\"line\">$ echo &quot;guguji/forth:$DATE.$CI_JOB_ID&quot;;</span><br><span class=\"line\">guguji/forth:20191016.322211021</span><br><span class=\"line\">Job succeeded</span><br></pre></td></tr></table></figure></p>\n<p><em>如果有如下报错</em><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Got permission denied while trying to connect to the Docker daemon socket</span><br></pre></td></tr></table></figure></p>\n<p>原因是gitlab-runner执行时 是以 gitlab-runner用户来执行的 该用户不属于docker group，需将该用户加入该组。<br>首先查询 是否有该用户 <code>cut -d : -f 1 /etc/passwd</code><br>然后查询 是否存在docker组<code>sudo groupadd docker</code><br>然后执行 将gitlab-runner加入docker组 <code>sudo gpasswd -a gitlab-runner docker</code></p>\n<p><strong>我们想要的效果</strong>是在服务器上拉取我们刚build并上传的镜像，并run 起来就好。我们可以在本地用如下命令测试刚打包的镜像</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pull guguji/forth:20191016.322211021</span><br><span class=\"line\">docker run -d -p 8080:80 guguji/forth:20191016.322211021 nginx</span><br></pre></td></tr></table></figure>\n<p>效果如下<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  ~ docker pull guguji/forth:20191016.322211021</span><br><span class=\"line\">20191016.322211021: Pulling from guguji/forth</span><br><span class=\"line\">a7344f52cb74: Already exists</span><br><span class=\"line\">515c9bb51536: Already exists</span><br><span class=\"line\">e1eabe0537eb: Already exists</span><br><span class=\"line\">4701f1215c13: Already exists</span><br><span class=\"line\">b9999057545e: Pull complete</span><br><span class=\"line\">57c313e6fd56: Pull complete</span><br><span class=\"line\">76ac29208590: Pull complete</span><br><span class=\"line\">ebec49c77172: Pull complete</span><br><span class=\"line\">c514c1fe8afa: Pull complete</span><br><span class=\"line\">de4ad1f5b5dc: Pull complete</span><br><span class=\"line\">Digest: sha256:971e8c83827b10e1ffb9d109f7b2507e26622b56113f5ee183b92bdc8e0acd8a</span><br><span class=\"line\">Status: Downloaded newer image for guguji/forth:20191016.322211021</span><br><span class=\"line\">➜  ~ docker run -d -p 8080:80 guguji/forth:20191016.322211021 nginx</span><br><span class=\"line\">330efb99cafab59b46ddaf61a62221bf94722e9c76be59523b538cb3a49bd651</span><br><span class=\"line\">➜  ~</span><br></pre></td></tr></table></figure></p>\n<p><img src=\"/images/gitlab-runner-sample.png\" alt=\"gitlab-runner-sample\"></p>\n","site":{"data":{}},"excerpt":"","more":"<p>DevOps已经不是什么新概念了，现在前端开发人员多，分支多，测试环境多，前端自动化的重要性不（无)言（形）而（装）喻（比）。本博客的目的是实现在代码更新后，通过gitlab的webhook自动将部署文件打包成docker镜像。然后通过拿镜像名称去服务器上部署。这里我们分三步走，第一步配置Dockerfile先在本地测试docker build的流程；第二部注册gitlab-runner；第三部配置.gitlab-ci.yml监听代码更新后触发docker build流程并push到docker的hub。</p>\n<h2 id=\"docker-配置\"><a href=\"#docker-配置\" class=\"headerlink\" title=\"docker 配置\"></a><a name=\"docker_config\">docker 配置</a></h2><p>前端的部署环境很简单，无论你是react，vue还是Angular，部署的时候都是启动一个nginx，然后将build的静态文件放到nginx的共享目录就好了。这里我们不关心前端功能的具体打包过程，直接打包一个简单的html文件到镜像里就好。</p>\n<h4 id=\"1-安装\"><a href=\"#1-安装\" class=\"headerlink\" title=\"1. 安装\"></a>1. 安装</h4><p>docker安装很简单，针对不同的系统提供了不同的方法，参照官方文档<a href=\"https://docs.docker.com/v17.09/engine/installation/\" target=\"_blank\" rel=\"noopener\">Install Docker</a>安装即可。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  ~ docker</span><br><span class=\"line\"></span><br><span class=\"line\">Usage:\tdocker [OPTIONS] COMMAND</span><br><span class=\"line\"></span><br><span class=\"line\">A self-sufficient runtime for containers</span><br><span class=\"line\"></span><br><span class=\"line\">Options:</span><br><span class=\"line\">      --config string      Location of client config files (default &quot;/Users/dida/.docker&quot;)</span><br><span class=\"line\">  -D, --debug              Enable debug mode</span><br><span class=\"line\">  -H, --host list          Daemon socket(s) to connect to</span><br><span class=\"line\">  -l, --log-level string   Set the logging level (&quot;debug&quot;|&quot;info&quot;|&quot;warn&quot;|&quot;error&quot;|&quot;fatal&quot;) (default &quot;info&quot;)</span><br><span class=\"line\">      --tls                Use TLS; implied by --tlsverify</span><br><span class=\"line\">      --tlscacert string   Trust certs signed only by this CA (default &quot;/Users/dida/.docker/ca.pem&quot;)</span><br><span class=\"line\">      --tlscert string     Path to TLS certificate file (default &quot;/Users/dida/.docker/cert.pem&quot;)</span><br><span class=\"line\">      --tlskey string      Path to TLS key file (default &quot;/Users/dida/.docker/key.pem&quot;)</span><br><span class=\"line\">      --tlsverify          Use TLS and verify the remote</span><br><span class=\"line\">  -v, --version            Print version information and quit</span><br><span class=\"line\"></span><br><span class=\"line\">Management Commands:</span><br><span class=\"line\">  builder     Manage builds</span><br><span class=\"line\">  config      Manage Docker configs</span><br><span class=\"line\">  container   Manage containers</span><br><span class=\"line\">  image       Manage images</span><br><span class=\"line\">  network     Manage networks</span><br><span class=\"line\">  node        Manage Swarm nodes</span><br><span class=\"line\">  plugin      Manage plugins</span><br><span class=\"line\">  secret      Manage Docker secrets</span><br><span class=\"line\">  service     Manage services</span><br><span class=\"line\">  stack       Manage Docker stacks</span><br><span class=\"line\">  swarm       Manage Swarm</span><br><span class=\"line\">  system      Manage Docker</span><br><span class=\"line\">  trust       Manage trust on Docker images</span><br><span class=\"line\">  volume      Manage volumes</span><br><span class=\"line\">  ...</span><br></pre></td></tr></table></figure></p>\n<p>执行<code>docker</code>即为安装成功。</p>\n<h4 id=\"2-镜像制作\"><a href=\"#2-镜像制作\" class=\"headerlink\" title=\"2. 镜像制作\"></a>2. 镜像制作</h4><p>我们需要一个有nginx的镜像，可以nginx依赖一个操作系统。我们用ubuntu为base镜像，在里边安装nginx，然后再讲我们准备好的html（假设其为build后的前端工程）放到nginx的目录。docker build镜像可以用docker commit 也可以用Dockerfile，后者更为灵活，使用也更为广泛。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">FROM ubuntu:14.04</span><br><span class=\"line\">RUN apt-get -yqq update &amp;&amp; apt-get -yqq install nginx</span><br><span class=\"line\">RUN mkdir -p /var/www/html/website</span><br><span class=\"line\">ADD index.html /var/www/html/website</span><br><span class=\"line\">RUN chmod -R 777 /var/www/html/website</span><br><span class=\"line\">ADD nginx/global.conf /etc/nginx/conf.d/</span><br><span class=\"line\">ADD nginx/nginx.conf /etc/nginx/nginx.conf</span><br><span class=\"line\">EXPOSE 80</span><br></pre></td></tr></table></figure>\n<p>Dockerfile的内容包括以下几项：</p>\n<ul>\n<li>使用ubuntu 14.04为基础镜像</li>\n<li>更新并安装nginx</li>\n<li>在容器中创建一个/var/www/html/website目录</li>\n<li>将静态html文件拷贝到上述目录</li>\n<li>将上述目录权限改为可读，可写，可执行</li>\n<li>将准备好的nginx配置copy到容器中</li>\n<li>暴露出来80端口</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># global.conf</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen          0.0.0.0:80;</span><br><span class=\"line\">        server_name     _;</span><br><span class=\"line\"></span><br><span class=\"line\">        root            /var/www/html/website;</span><br><span class=\"line\">        index           index.html index.htm;</span><br><span class=\"line\"></span><br><span class=\"line\">        access_log      /var/log/nginx/default_access.log;</span><br><span class=\"line\">        error_log       /var/log/nginx/default_error.log;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># nginx.conf</span><br><span class=\"line\">user www-data;</span><br><span class=\"line\">worker_processes 4;</span><br><span class=\"line\">pid /run/nginx.pid;</span><br><span class=\"line\">daemon off;</span><br><span class=\"line\"></span><br><span class=\"line\">events &#123;  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">http &#123;</span><br><span class=\"line\">  sendfile on;</span><br><span class=\"line\">  tcp_nopush on;</span><br><span class=\"line\">  tcp_nodelay on;</span><br><span class=\"line\">  keepalive_timeout 65;</span><br><span class=\"line\">  types_hash_max_size 2048;</span><br><span class=\"line\">  include /etc/nginx/mime.types;</span><br><span class=\"line\">  default_type application/octet-stream;</span><br><span class=\"line\">  access_log /var/log/nginx/access.log;</span><br><span class=\"line\">  error_log /var/log/nginx/error.log;</span><br><span class=\"line\">  gzip on;</span><br><span class=\"line\">  gzip_disable &quot;msie6&quot;;</span><br><span class=\"line\">  include /etc/nginx/conf.d/*.conf;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>具体代码可见 <a href=\"https://github.com/guguji5/demo/tree/master/try-ci\" target=\"_blank\" rel=\"noopener\">https://github.com/guguji5/demo/tree/master/try-ci</a></p>\n<p>打包命令<code>docker build -t [name]:[tag] .</code><br>然后<code>docker images</code>查看本地镜像</p>\n<h4 id=\"2-镜像上传\"><a href=\"#2-镜像上传\" class=\"headerlink\" title=\"2. 镜像上传\"></a>2. 镜像上传</h4><p>\b制作好的镜像需要推到远端，就像我们的代码需要git push到仓库一样。首先你需要注册一个<a href=\"https://hub.docker.com/\" target=\"_blank\" rel=\"noopener\">docker账号</a>，<code>docker login</code>测试是否登录成功，成功后<code>docker push [name]:[tag]</code>推到远端</p>\n<h4 id=\"3-测试镜像\"><a href=\"#3-测试镜像\" class=\"headerlink\" title=\"3. 测试镜像\"></a>3. 测试镜像</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -d -p 8081:80 [name]:[tag] nginx</span><br></pre></td></tr></table></figure>\n<p>查看本地8081端口是否能访问到镜像中的80服务</p>\n<h2 id=\"gitlab-runner注册\"><a href=\"#gitlab-runner注册\" class=\"headerlink\" title=\"gitlab-runner注册\"></a>gitlab-runner注册</h2><h4 id=\"1-安装-1\"><a href=\"#1-安装-1\" class=\"headerlink\" title=\"1.安装\"></a>1.安装</h4><p>根据<a href=\"https://docs.gitlab.com/runner/install/\" target=\"_blank\" rel=\"noopener\">https://docs.gitlab.com/runner/install/</a> 选择对应平台安装<br>根据<a href=\"https://docs.gitlab.com/runner/register/\" target=\"_blank\" rel=\"noopener\">https://docs.gitlab.com/runner/register/</a> 进行注册,Runner executor选择shell就好。<br>注册成功后可以在Settings下边的CI/CD中的Runners看到刚注册的机器。<br><img src=\"/images/gitlab-runner.jpg\" alt=\"gitlab-runner\"></p>\n<h4 id=\"2-测试\"><a href=\"#2-测试\" class=\"headerlink\" title=\"2.测试\"></a>2.测试</h4><p>新建.gitlab-ci.yml并写入如下简单的命令测试job是否能执行成功</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 执行job的阶段 按顺序串行执行</span><br><span class=\"line\">stages:</span><br><span class=\"line\">  - upload</span><br><span class=\"line\">job2: # 自定义名字</span><br><span class=\"line\">  stage: upload # 指定这阶段操作的名称</span><br><span class=\"line\">  only: # 指定那些分支会进入该处理流程</span><br><span class=\"line\">    - master # 正式环境</span><br><span class=\"line\">  variables:</span><br><span class=\"line\">    VERSION: &apos;damon&apos; # 除了后面会说到的私密变量 还可以在这里定义变量</span><br><span class=\"line\">  before_script:</span><br><span class=\"line\"></span><br><span class=\"line\">  script:</span><br><span class=\"line\">    - echo &quot;It is a job2,&quot;</span><br><span class=\"line\">    - echo $&#123;VERSION&#125;</span><br><span class=\"line\">    - your_name=&quot;qinjx&quot;</span><br><span class=\"line\">    - echo $your_name</span><br><span class=\"line\">    - echo $&#123;your_name&#125;</span><br></pre></td></tr></table></figure>\n<p>每当master有新的提交时，出触发上述脚本的运行。我们可以在CI/CD - Pipelines中看到对应的job。</p>\n<p><img src=\"/images/gitlab-runner-job.png\" alt=\"gitlab-runner-job\"></p>\n<h2 id=\"自动化打包镜像\"><a href=\"#自动化打包镜像\" class=\"headerlink\" title=\"自动化打包镜像\"></a>自动化打包镜像</h2><p>我们的最终目的是每当代码更新后，自动打包成docker镜像，部署的每台服务器都用同一镜像部署就好。Build Once, Deploy Everywhere.</p>\n<p>每当代码更新后gitlab 的hook会自动触发，我们只需要把<a href=\"#docker_config\">第一步</a>中的打包和上传的流程放到hook中即可。.gitlab-ci.yml如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">stages:</span><br><span class=\"line\">  - build</span><br><span class=\"line\"> </span><br><span class=\"line\"># 自定义阶段build的job流程</span><br><span class=\"line\">job1: # 自定义名字</span><br><span class=\"line\">  stage: build # 指定这阶段操作的名称</span><br><span class=\"line\">  only: # 指定那些分支会进入该处理流程</span><br><span class=\"line\">    - master # 正式环境</span><br><span class=\"line\">    - pre # 预发环境</span><br><span class=\"line\">  before_script:</span><br><span class=\"line\"></span><br><span class=\"line\">  script:</span><br><span class=\"line\">    - docker login -u $USERNAME -p $PASSWORD</span><br><span class=\"line\">    - IMAGE_ID=`docker build . | tail -n 1 | awk -F &quot;Successfully built &quot; &apos;&#123;print $2&#125;&apos; | sed &apos;s/^ *\\| *$//g&apos;`</span><br><span class=\"line\">    - echo &quot;IMAGE_ID=$IMAGE_ID&quot;</span><br><span class=\"line\">    - DATE=`date +%Y%m%d`;</span><br><span class=\"line\">    - docker tag $IMAGE_ID guguji/forth:$DATE.$CI_JOB_ID;</span><br><span class=\"line\">    - docker push guguji/forth:$DATE.$CI_JOB_ID;</span><br><span class=\"line\">    - docker rmi guguji/forth:$DATE.$CI_JOB_ID;</span><br><span class=\"line\">    - echo &quot;--------------------------------------------------------------------------------&quot;;</span><br><span class=\"line\">    - echo &quot;guguji/forth:$DATE.$CI_JOB_ID&quot;;</span><br></pre></td></tr></table></figure></p>\n<p>其中的$USERNAME $PASSWORD是Setting - CI/CD - Variables 中存入的变量。其含义依次是：</p>\n<ul>\n<li>登录docker</li>\n<li>执行docker build 并将输出的将镜像ID赋值给IMAGE_ID</li>\n<li>给上述镜像打上标签</li>\n<li>上传到docker hub</li>\n<li>删除本地镜像</li>\n<li>输出镜像名称</li>\n</ul>\n<p>结果如下<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Running with gitlab-runner 12.3.0 (a8a019e0)</span><br><span class=\"line\">  on damon test xXUC7Le6</span><br><span class=\"line\">Using Shell executor...</span><br><span class=\"line\">Running on 10-254-203-137...</span><br><span class=\"line\">Fetching changes...</span><br><span class=\"line\">Reinitialized existing Git repository in /home/gitlab-runner/builds/xXUC7Le6/0/guguji5/try-ci/.git/</span><br><span class=\"line\">From https://gitlab.com/guguji5/try-ci</span><br><span class=\"line\"> * [new ref]         refs/pipelines/89119102 -&gt; refs/pipelines/89119102</span><br><span class=\"line\">   7aeff9e..6d585aa  master     -&gt; origin/master</span><br><span class=\"line\">Checking out 6d585aa7 as master...</span><br><span class=\"line\">Skipping Git submodules setup</span><br><span class=\"line\">$ docker login -u $USERNAME -p $PASSWORD</span><br><span class=\"line\">WARNING! Using --password via the CLI is insecure. Use --password-stdin.</span><br><span class=\"line\">WARNING! Your password will be stored unencrypted in /home/gitlab-runner/.docker/config.json.</span><br><span class=\"line\">Configure a credential helper to remove this warning. See</span><br><span class=\"line\">https://docs.docker.com/engine/reference/commandline/login/#credentials-store</span><br><span class=\"line\"></span><br><span class=\"line\">Login Succeeded</span><br><span class=\"line\">$ IMAGE_ID=`docker build . | tail -n 1 | awk -F &quot;Successfully built &quot; &apos;&#123;print $2&#125;&apos; | sed &apos;s/^ *\\| *$//g&apos;`</span><br><span class=\"line\">$ echo &quot;IMAGE_ID=$IMAGE_ID&quot;</span><br><span class=\"line\">IMAGE_ID=41555aab3b76</span><br><span class=\"line\">$ DATE=`date +%Y%m%d`;</span><br><span class=\"line\">$ docker tag $IMAGE_ID guguji/forth:$DATE.$CI_JOB_ID;</span><br><span class=\"line\">$ docker push guguji/forth:$DATE.$CI_JOB_ID;</span><br><span class=\"line\">The push refers to repository [docker.io/guguji/forth]</span><br><span class=\"line\">82ce84f6435c: Preparing</span><br><span class=\"line\">8f360e1cf4bb: Preparing</span><br><span class=\"line\">8f360e1cf4bb: Pushed</span><br><span class=\"line\">29c9093a1ab9: Pushed</span><br><span class=\"line\">66285ac4bf24: Layer already exists</span><br><span class=\"line\">48334332ed8d: Layer already exists</span><br><span class=\"line\">82ce84f6435c: Pushed</span><br><span class=\"line\">b057ab380990: Layer already exists</span><br><span class=\"line\">bc89fbcf9125: Pushed</span><br><span class=\"line\">46c1a22ffea5: Layer already exists</span><br><span class=\"line\">b17e63608209: Layer already exists</span><br><span class=\"line\">20191016.322211021: digest: sha256:971e8c83827b10e1ffb9d109f7b2507e26622b56113f5ee183b92bdc8e0acd8a size: 2401</span><br><span class=\"line\">$ docker rmi guguji/forth:$DATE.$CI_JOB_ID;</span><br><span class=\"line\">Untagged: guguji/forth:20191016.322211021</span><br><span class=\"line\">Untagged: guguji/forth@sha256:971e8c83827b10e1ffb9d109f7b2507e26622b56113f5ee183b92bdc8e0acd8a</span><br><span class=\"line\">Deleted: sha256:41555aab3b76a88fbde71a02afd7c400973d8ec9f1ab7ce533d4d7cc6dfdb17e</span><br><span class=\"line\">Deleted: sha256:854ac28d0ceabc1b910aa58e96d1fabe577a63a60c3459ca7ee6152f00630cc1</span><br><span class=\"line\">$ echo &quot;--------------------------------------------------------------------------------&quot;;</span><br><span class=\"line\">--------------------------------------------------------------------------------</span><br><span class=\"line\">$ echo &quot;guguji/forth:$DATE.$CI_JOB_ID&quot;;</span><br><span class=\"line\">guguji/forth:20191016.322211021</span><br><span class=\"line\">Job succeeded</span><br></pre></td></tr></table></figure></p>\n<p><em>如果有如下报错</em><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Got permission denied while trying to connect to the Docker daemon socket</span><br></pre></td></tr></table></figure></p>\n<p>原因是gitlab-runner执行时 是以 gitlab-runner用户来执行的 该用户不属于docker group，需将该用户加入该组。<br>首先查询 是否有该用户 <code>cut -d : -f 1 /etc/passwd</code><br>然后查询 是否存在docker组<code>sudo groupadd docker</code><br>然后执行 将gitlab-runner加入docker组 <code>sudo gpasswd -a gitlab-runner docker</code></p>\n<p><strong>我们想要的效果</strong>是在服务器上拉取我们刚build并上传的镜像，并run 起来就好。我们可以在本地用如下命令测试刚打包的镜像</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pull guguji/forth:20191016.322211021</span><br><span class=\"line\">docker run -d -p 8080:80 guguji/forth:20191016.322211021 nginx</span><br></pre></td></tr></table></figure>\n<p>效果如下<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  ~ docker pull guguji/forth:20191016.322211021</span><br><span class=\"line\">20191016.322211021: Pulling from guguji/forth</span><br><span class=\"line\">a7344f52cb74: Already exists</span><br><span class=\"line\">515c9bb51536: Already exists</span><br><span class=\"line\">e1eabe0537eb: Already exists</span><br><span class=\"line\">4701f1215c13: Already exists</span><br><span class=\"line\">b9999057545e: Pull complete</span><br><span class=\"line\">57c313e6fd56: Pull complete</span><br><span class=\"line\">76ac29208590: Pull complete</span><br><span class=\"line\">ebec49c77172: Pull complete</span><br><span class=\"line\">c514c1fe8afa: Pull complete</span><br><span class=\"line\">de4ad1f5b5dc: Pull complete</span><br><span class=\"line\">Digest: sha256:971e8c83827b10e1ffb9d109f7b2507e26622b56113f5ee183b92bdc8e0acd8a</span><br><span class=\"line\">Status: Downloaded newer image for guguji/forth:20191016.322211021</span><br><span class=\"line\">➜  ~ docker run -d -p 8080:80 guguji/forth:20191016.322211021 nginx</span><br><span class=\"line\">330efb99cafab59b46ddaf61a62221bf94722e9c76be59523b538cb3a49bd651</span><br><span class=\"line\">➜  ~</span><br></pre></td></tr></table></figure></p>\n<p><img src=\"/images/gitlab-runner-sample.png\" alt=\"gitlab-runner-sample\"></p>\n"},{"title":"如何使用GZIP来优化你的网站","date":"2018-11-09T05:22:55.000Z","comments":1,"_content":"如果你想节省带宽提高网站速度，压缩是一种简单有效的方法。当我打算提高JavaScript的传输速率来开启GZIP压缩的时候，我犹豫了因为有旧版本浏览器的存在（IE6）。\n\n然而在二十一世纪，我们大部分的流量来自于现代浏览器，坦白的讲，我们大部分的用户都是很懂技术的。我们不想让任何一个人在访问我们网站的时候卡顿，哪怕是他在用IE4.0和Wdinows95.谷歌和雅虎都开启了gzip压缩。一个现代的浏览器要想不仅要享受到现代网络信息还要享受到现代互联网的速度，就必须开启gzip压缩。以下是如何设置。\n\n## 等等，为什么我们要开启gzip压缩\n在此之前，我有必要解释一下什么编码。当你在互联网上想请求一个文件时,比如http://www.yahoo.com/index.html，你的浏览器会和服务器有一个会话，大概如下如所示。\n![](https://betterexplained.com/wp-content/uploads/compression/HTTP_request.png)\n\n1. 浏览器：嘿，给我来一个 index.html文件\n2. 服务器：好的，让我去找找它是不是在~\n3. 服务器：找到它了，我会返回一个成功的状态码（200 ok），我正在发送文件……\n4. 浏览器：100kb？ 我滴天……等啊……等啊，好的，下载下来了\n\n当然，实际的请求头和协议会更加正规一点。\n\n但是，它生效了，我拿到了index.html文件。\n\n## 那现在问题在哪呢？\n好吧，这系统是正常的，但是太低效了，坦白讲100kb是一大段的文字，HTML是冗余的，每一个<html>,<table>,<div>都有一个几乎相同的闭合标签。虽然通篇文字都有重复，但是只要你砍掉任何的内容，html（以及它的一奶同胞xml）都不会正常显示。\n\n当文件太大的时候有什么好办法呢，就是gzip压缩它。\n\n如果我们传输一个替代原始大文件的zip的压缩文件给浏览器，就会节省带宽和下载时间。当浏览器可以下载zip文件，解压，并且渲染给用户。下载很快，页面加载也很快，用户心情就会very good。这个浏览器--服务器的会话大概是酱紫的：\n![](https://betterexplained.com/wp-content/uploads/compression/HTTP_request_compressed.png)\n1. 浏览器：嘿，给我来一个index.html，如果要有，给我来一个压缩版的可以吗\n2. 服务器：容我找找……好，满足你，如果找到了给你压缩以下，gzip格式的哦\n3. 服务器：yep，找到了，正在压缩，马上传给你。\n4. 浏览器：太棒了，只有10kb，我来解压，并且渲染给用户。\n\n情况很简单：文件越小，下载更快，用户感受更好。\n\n不相信我？雅虎主页的html部分通过压缩从101kb直接压到了15kb：\n![](https://betterexplained.com/wp-content/uploads/compression/yahoo.png)\n\n## 残（淡）酷（定）的现实\n变化的部分在于浏览器和服务器，它成功的发送过去一个压缩文件。对于gzip压缩的要点有两点：\n\n- 浏览器发送一个请求头，告诉服务器接受压缩版本的文件（gzip和deflate是两种压缩算法）Accept-Encoding:gzip,deflate\n- 如果文件压缩了,服务器返回一个头信息:Content-Encoding:gzip\n\n如果服务器没有返回Content-Encoding的头信息，意味着这文件是没压缩的（浏览器可以直接解析的）。请求头Accept-Encoding只是浏览器的一个请求，而不是命令。如果服务器不返回压缩文件，浏览器就不得不处理那庞大的源文件。\n\n## 服务器设置\n“好消息”是我们没办法控制浏览器。他发“Accept-encoding: gzip, deflat”或者不发，请求头就在那里，不增不减。\n\n我们需要做的只是给服务器配置，让它返回压缩版本。如果浏览器控制，我们可以为每一个人节省带宽。\n\n对于IIS服务器，启动压缩在“设置”里。\n\n如果你像我一样用nodejs来搭建服务器，那你中奖了，nodejs开启gzip非常的简单，只需增加两行代码搞定。\n\n\n```\nconst express = require('express');\nconst app = express();\n\n//express框架，前边肯定都是必要的，也就是只需安装compression组件，然后添加一下两句代码就好\nconst compression = require('compression');\napp.use(compression());\n```\n\n\n对于Apache服务器，我们可以启动压缩输出也很简单直接。在你的.htaccess文件里增加如下代码：\n\n```\n# compress text, html, javascript, css, xml:\nAddOutputFilterByType DEFLATE text/plain\nAddOutputFilterByType DEFLATE text/html\nAddOutputFilterByType DEFLATE text/xml\nAddOutputFilterByType DEFLATE text/css\nAddOutputFilterByType DEFLATE application/xml\nAddOutputFilterByType DEFLATE application/xhtml+xml\nAddOutputFilterByType DEFLATE application/rss+xml\nAddOutputFilterByType DEFLATE application/javascript\nAddOutputFilterByType DEFLATE application/x-javascript\n\n# Or, compress certain file types by extension:\n<files *.html>\nSetOutputFilter DEFLATE\n</files>\n```\nApache服务器有两个压缩选择：\n\n- mod_deflate 更简单设置更加标准。\n- mod_gzip 看起来更加强大，可以预预缩文件。\n\nDeflate更快，所以我用的它；当然如果想更爽，用mod_gzip。无论你选那种，Apache会检查浏览器是否发送“Accept-encoding”请求头来判断是返回压缩文件还是源文件。然而，一些旧版本浏览器会带来麻烦，需要一些特别的指令来纠正它。\n\n如果你不能改你的.htaccess 文件，你可以用PHP来返回压缩的内容，给你的HTML文件一个.php 文件，把下边文件加在文件的最上边。\nIN PHP :\n```\n<?php if (substr_count($_SERVER[‘HTTP_ACCEPT_ENCODING’], ‘gzip’)) ob_start(“ob_gzhandler”); else ob_start(); ?>\n```\n我们会检查“Accept-encoding”头，返回gzip压缩版本的文件（不然就返回源文件）。这简直像是在建设你自己的web服务器。如果你确实在搭建服务器，请用Apache来压缩你的文件。你肯定不想下载你的文件 just like bearing。\n\n*这有点给apache打广告的意思啊*\n\n## 验证压缩的效果\n一旦你配置好了你的服务器，检查他是不是生效了。\n- 在线查看：用[online gzip test](http://www.gidnetwork.com/tools/gzip-test.php)来检查你的网页是不是确实压缩了。\n- 浏览器查看：在chrome谷歌浏览器，F12打开 开发者工具--> network页签（火狐和IE浏览器也是相似的）。刷新你的页面，点击这network航信息来查看。这“Content-encoding: gzip” 的头信息意味着内容压缩了传过来的。\n\n![image](https://betterexplained.com/wp-content/uploads/2007/04/chrome-gzip-header.png)\n\n点击“use large rows”表情来查看更多信息。包含了压缩以后的大小和源文件的大小。\n\n![image](https://betterexplained.com/wp-content/uploads/2007/04/request-size.png)\n\n奇迹般的，主页从187kb压缩到了59kb。\n\n## 试试几个小栗子\n我做了个几个页和一个下载demo：\n- [index.html](https://betterexplained.com/examples/compressed/index.html) —— 默认压缩\n- [index.htm](https://betterexplained.com/examples/compressed/index.htm) —— 通过在Apache上的.htaccess文件 增加 *.htm规则来压缩\n- [index.php](https://betterexplained.com/examples/compressed/index.php) —— 通过php的头信息来压缩\n\n随意下载这些文件，放到你的服务器，调整你的服务器设置。\n\n## 警告\ngzip压缩的出现如此的令人振奋，但是还有以下三个注意点：\n- 低版本浏览器：一些浏览器接受压缩文件还是有问题（他们说他们可以但是他们并不行），如果你的站点必须在window95的网景1.0浏览器上，你可能不想要压缩文件。Apache mod_deflate设置了一些忽略规则来专门为旧浏览器。\n- 已经压缩过的文件:大多数的图片，音乐和视频都已经压缩过了，不要浪费时间来压缩他们了。事实上，你可以只压缩那三巨头（HTML,CSS AND JAVARSCRIPT)。\n- CPU负载：在传输过程中压缩文件耗费CPU但是节省带宽（用空间换时间）。通常压缩速率的选择需要权衡利弊。也存在一些预压缩静态文件的方法，但这要求更多的资源。考虑了cpu的耗费，压缩文件也是利大于弊。通过压缩实现更好的用户体验，更短的留白时间，值！\n\n\n---\n\n开启gzip压缩是优化网站最快的方法之一。大胆的用吧，让你的用户体验更棒。\n\n\n*本文为翻译文章，欲了解原文请点击[原文链接](https://betterexplained.com/articles/how-to-optimize-your-site-with-gzip-compression/)*","source":"_posts/如何使用GZIP来优化你的网站.md","raw":"---\ntitle: 如何使用GZIP来优化你的网站\ndate: 2018-11-09 13:22:55\ntags: 优化\ncomments: true\n---\n如果你想节省带宽提高网站速度，压缩是一种简单有效的方法。当我打算提高JavaScript的传输速率来开启GZIP压缩的时候，我犹豫了因为有旧版本浏览器的存在（IE6）。\n\n然而在二十一世纪，我们大部分的流量来自于现代浏览器，坦白的讲，我们大部分的用户都是很懂技术的。我们不想让任何一个人在访问我们网站的时候卡顿，哪怕是他在用IE4.0和Wdinows95.谷歌和雅虎都开启了gzip压缩。一个现代的浏览器要想不仅要享受到现代网络信息还要享受到现代互联网的速度，就必须开启gzip压缩。以下是如何设置。\n\n## 等等，为什么我们要开启gzip压缩\n在此之前，我有必要解释一下什么编码。当你在互联网上想请求一个文件时,比如http://www.yahoo.com/index.html，你的浏览器会和服务器有一个会话，大概如下如所示。\n![](https://betterexplained.com/wp-content/uploads/compression/HTTP_request.png)\n\n1. 浏览器：嘿，给我来一个 index.html文件\n2. 服务器：好的，让我去找找它是不是在~\n3. 服务器：找到它了，我会返回一个成功的状态码（200 ok），我正在发送文件……\n4. 浏览器：100kb？ 我滴天……等啊……等啊，好的，下载下来了\n\n当然，实际的请求头和协议会更加正规一点。\n\n但是，它生效了，我拿到了index.html文件。\n\n## 那现在问题在哪呢？\n好吧，这系统是正常的，但是太低效了，坦白讲100kb是一大段的文字，HTML是冗余的，每一个<html>,<table>,<div>都有一个几乎相同的闭合标签。虽然通篇文字都有重复，但是只要你砍掉任何的内容，html（以及它的一奶同胞xml）都不会正常显示。\n\n当文件太大的时候有什么好办法呢，就是gzip压缩它。\n\n如果我们传输一个替代原始大文件的zip的压缩文件给浏览器，就会节省带宽和下载时间。当浏览器可以下载zip文件，解压，并且渲染给用户。下载很快，页面加载也很快，用户心情就会very good。这个浏览器--服务器的会话大概是酱紫的：\n![](https://betterexplained.com/wp-content/uploads/compression/HTTP_request_compressed.png)\n1. 浏览器：嘿，给我来一个index.html，如果要有，给我来一个压缩版的可以吗\n2. 服务器：容我找找……好，满足你，如果找到了给你压缩以下，gzip格式的哦\n3. 服务器：yep，找到了，正在压缩，马上传给你。\n4. 浏览器：太棒了，只有10kb，我来解压，并且渲染给用户。\n\n情况很简单：文件越小，下载更快，用户感受更好。\n\n不相信我？雅虎主页的html部分通过压缩从101kb直接压到了15kb：\n![](https://betterexplained.com/wp-content/uploads/compression/yahoo.png)\n\n## 残（淡）酷（定）的现实\n变化的部分在于浏览器和服务器，它成功的发送过去一个压缩文件。对于gzip压缩的要点有两点：\n\n- 浏览器发送一个请求头，告诉服务器接受压缩版本的文件（gzip和deflate是两种压缩算法）Accept-Encoding:gzip,deflate\n- 如果文件压缩了,服务器返回一个头信息:Content-Encoding:gzip\n\n如果服务器没有返回Content-Encoding的头信息，意味着这文件是没压缩的（浏览器可以直接解析的）。请求头Accept-Encoding只是浏览器的一个请求，而不是命令。如果服务器不返回压缩文件，浏览器就不得不处理那庞大的源文件。\n\n## 服务器设置\n“好消息”是我们没办法控制浏览器。他发“Accept-encoding: gzip, deflat”或者不发，请求头就在那里，不增不减。\n\n我们需要做的只是给服务器配置，让它返回压缩版本。如果浏览器控制，我们可以为每一个人节省带宽。\n\n对于IIS服务器，启动压缩在“设置”里。\n\n如果你像我一样用nodejs来搭建服务器，那你中奖了，nodejs开启gzip非常的简单，只需增加两行代码搞定。\n\n\n```\nconst express = require('express');\nconst app = express();\n\n//express框架，前边肯定都是必要的，也就是只需安装compression组件，然后添加一下两句代码就好\nconst compression = require('compression');\napp.use(compression());\n```\n\n\n对于Apache服务器，我们可以启动压缩输出也很简单直接。在你的.htaccess文件里增加如下代码：\n\n```\n# compress text, html, javascript, css, xml:\nAddOutputFilterByType DEFLATE text/plain\nAddOutputFilterByType DEFLATE text/html\nAddOutputFilterByType DEFLATE text/xml\nAddOutputFilterByType DEFLATE text/css\nAddOutputFilterByType DEFLATE application/xml\nAddOutputFilterByType DEFLATE application/xhtml+xml\nAddOutputFilterByType DEFLATE application/rss+xml\nAddOutputFilterByType DEFLATE application/javascript\nAddOutputFilterByType DEFLATE application/x-javascript\n\n# Or, compress certain file types by extension:\n<files *.html>\nSetOutputFilter DEFLATE\n</files>\n```\nApache服务器有两个压缩选择：\n\n- mod_deflate 更简单设置更加标准。\n- mod_gzip 看起来更加强大，可以预预缩文件。\n\nDeflate更快，所以我用的它；当然如果想更爽，用mod_gzip。无论你选那种，Apache会检查浏览器是否发送“Accept-encoding”请求头来判断是返回压缩文件还是源文件。然而，一些旧版本浏览器会带来麻烦，需要一些特别的指令来纠正它。\n\n如果你不能改你的.htaccess 文件，你可以用PHP来返回压缩的内容，给你的HTML文件一个.php 文件，把下边文件加在文件的最上边。\nIN PHP :\n```\n<?php if (substr_count($_SERVER[‘HTTP_ACCEPT_ENCODING’], ‘gzip’)) ob_start(“ob_gzhandler”); else ob_start(); ?>\n```\n我们会检查“Accept-encoding”头，返回gzip压缩版本的文件（不然就返回源文件）。这简直像是在建设你自己的web服务器。如果你确实在搭建服务器，请用Apache来压缩你的文件。你肯定不想下载你的文件 just like bearing。\n\n*这有点给apache打广告的意思啊*\n\n## 验证压缩的效果\n一旦你配置好了你的服务器，检查他是不是生效了。\n- 在线查看：用[online gzip test](http://www.gidnetwork.com/tools/gzip-test.php)来检查你的网页是不是确实压缩了。\n- 浏览器查看：在chrome谷歌浏览器，F12打开 开发者工具--> network页签（火狐和IE浏览器也是相似的）。刷新你的页面，点击这network航信息来查看。这“Content-encoding: gzip” 的头信息意味着内容压缩了传过来的。\n\n![image](https://betterexplained.com/wp-content/uploads/2007/04/chrome-gzip-header.png)\n\n点击“use large rows”表情来查看更多信息。包含了压缩以后的大小和源文件的大小。\n\n![image](https://betterexplained.com/wp-content/uploads/2007/04/request-size.png)\n\n奇迹般的，主页从187kb压缩到了59kb。\n\n## 试试几个小栗子\n我做了个几个页和一个下载demo：\n- [index.html](https://betterexplained.com/examples/compressed/index.html) —— 默认压缩\n- [index.htm](https://betterexplained.com/examples/compressed/index.htm) —— 通过在Apache上的.htaccess文件 增加 *.htm规则来压缩\n- [index.php](https://betterexplained.com/examples/compressed/index.php) —— 通过php的头信息来压缩\n\n随意下载这些文件，放到你的服务器，调整你的服务器设置。\n\n## 警告\ngzip压缩的出现如此的令人振奋，但是还有以下三个注意点：\n- 低版本浏览器：一些浏览器接受压缩文件还是有问题（他们说他们可以但是他们并不行），如果你的站点必须在window95的网景1.0浏览器上，你可能不想要压缩文件。Apache mod_deflate设置了一些忽略规则来专门为旧浏览器。\n- 已经压缩过的文件:大多数的图片，音乐和视频都已经压缩过了，不要浪费时间来压缩他们了。事实上，你可以只压缩那三巨头（HTML,CSS AND JAVARSCRIPT)。\n- CPU负载：在传输过程中压缩文件耗费CPU但是节省带宽（用空间换时间）。通常压缩速率的选择需要权衡利弊。也存在一些预压缩静态文件的方法，但这要求更多的资源。考虑了cpu的耗费，压缩文件也是利大于弊。通过压缩实现更好的用户体验，更短的留白时间，值！\n\n\n---\n\n开启gzip压缩是优化网站最快的方法之一。大胆的用吧，让你的用户体验更棒。\n\n\n*本文为翻译文章，欲了解原文请点击[原文链接](https://betterexplained.com/articles/how-to-optimize-your-site-with-gzip-compression/)*","slug":"如何使用GZIP来优化你的网站","published":1,"updated":"2018-11-11T04:27:07.000Z","layout":"post","photos":[],"link":"","_id":"ckrix8zf3001gk1jfe0i1afb2","content":"<p>如果你想节省带宽提高网站速度，压缩是一种简单有效的方法。当我打算提高JavaScript的传输速率来开启GZIP压缩的时候，我犹豫了因为有旧版本浏览器的存在（IE6）。</p>\n<p>然而在二十一世纪，我们大部分的流量来自于现代浏览器，坦白的讲，我们大部分的用户都是很懂技术的。我们不想让任何一个人在访问我们网站的时候卡顿，哪怕是他在用IE4.0和Wdinows95.谷歌和雅虎都开启了gzip压缩。一个现代的浏览器要想不仅要享受到现代网络信息还要享受到现代互联网的速度，就必须开启gzip压缩。以下是如何设置。</p>\n<h2 id=\"等等，为什么我们要开启gzip压缩\"><a href=\"#等等，为什么我们要开启gzip压缩\" class=\"headerlink\" title=\"等等，为什么我们要开启gzip压缩\"></a>等等，为什么我们要开启gzip压缩</h2><p>在此之前，我有必要解释一下什么编码。当你在互联网上想请求一个文件时,比如<a href=\"http://www.yahoo.com/index.html，你的浏览器会和服务器有一个会话，大概如下如所示。\" target=\"_blank\" rel=\"noopener\">http://www.yahoo.com/index.html，你的浏览器会和服务器有一个会话，大概如下如所示。</a><br><img src=\"https://betterexplained.com/wp-content/uploads/compression/HTTP_request.png\" alt=\"\"></p>\n<ol>\n<li>浏览器：嘿，给我来一个 index.html文件</li>\n<li>服务器：好的，让我去找找它是不是在~</li>\n<li>服务器：找到它了，我会返回一个成功的状态码（200 ok），我正在发送文件……</li>\n<li>浏览器：100kb？ 我滴天……等啊……等啊，好的，下载下来了</li>\n</ol>\n<p>当然，实际的请求头和协议会更加正规一点。</p>\n<p>但是，它生效了，我拿到了index.html文件。</p>\n<h2 id=\"那现在问题在哪呢？\"><a href=\"#那现在问题在哪呢？\" class=\"headerlink\" title=\"那现在问题在哪呢？\"></a>那现在问题在哪呢？</h2><p>好吧，这系统是正常的，但是太低效了，坦白讲100kb是一大段的文字，HTML是冗余的，每一个<html>,<table>,<div>都有一个几乎相同的闭合标签。虽然通篇文字都有重复，但是只要你砍掉任何的内容，html（以及它的一奶同胞xml）都不会正常显示。</div></table></html></p>\n<p>当文件太大的时候有什么好办法呢，就是gzip压缩它。</p>\n<p>如果我们传输一个替代原始大文件的zip的压缩文件给浏览器，就会节省带宽和下载时间。当浏览器可以下载zip文件，解压，并且渲染给用户。下载很快，页面加载也很快，用户心情就会very good。这个浏览器–服务器的会话大概是酱紫的：<br><img src=\"https://betterexplained.com/wp-content/uploads/compression/HTTP_request_compressed.png\" alt=\"\"></p>\n<ol>\n<li>浏览器：嘿，给我来一个index.html，如果要有，给我来一个压缩版的可以吗</li>\n<li>服务器：容我找找……好，满足你，如果找到了给你压缩以下，gzip格式的哦</li>\n<li>服务器：yep，找到了，正在压缩，马上传给你。</li>\n<li>浏览器：太棒了，只有10kb，我来解压，并且渲染给用户。</li>\n</ol>\n<p>情况很简单：文件越小，下载更快，用户感受更好。</p>\n<p>不相信我？雅虎主页的html部分通过压缩从101kb直接压到了15kb：<br><img src=\"https://betterexplained.com/wp-content/uploads/compression/yahoo.png\" alt=\"\"></p>\n<h2 id=\"残（淡）酷（定）的现实\"><a href=\"#残（淡）酷（定）的现实\" class=\"headerlink\" title=\"残（淡）酷（定）的现实\"></a>残（淡）酷（定）的现实</h2><p>变化的部分在于浏览器和服务器，它成功的发送过去一个压缩文件。对于gzip压缩的要点有两点：</p>\n<ul>\n<li>浏览器发送一个请求头，告诉服务器接受压缩版本的文件（gzip和deflate是两种压缩算法）Accept-Encoding:gzip,deflate</li>\n<li>如果文件压缩了,服务器返回一个头信息:Content-Encoding:gzip</li>\n</ul>\n<p>如果服务器没有返回Content-Encoding的头信息，意味着这文件是没压缩的（浏览器可以直接解析的）。请求头Accept-Encoding只是浏览器的一个请求，而不是命令。如果服务器不返回压缩文件，浏览器就不得不处理那庞大的源文件。</p>\n<h2 id=\"服务器设置\"><a href=\"#服务器设置\" class=\"headerlink\" title=\"服务器设置\"></a>服务器设置</h2><p>“好消息”是我们没办法控制浏览器。他发“Accept-encoding: gzip, deflat”或者不发，请求头就在那里，不增不减。</p>\n<p>我们需要做的只是给服务器配置，让它返回压缩版本。如果浏览器控制，我们可以为每一个人节省带宽。</p>\n<p>对于IIS服务器，启动压缩在“设置”里。</p>\n<p>如果你像我一样用nodejs来搭建服务器，那你中奖了，nodejs开启gzip非常的简单，只需增加两行代码搞定。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">const express = require(&apos;express&apos;);</span><br><span class=\"line\">const app = express();</span><br><span class=\"line\"></span><br><span class=\"line\">//express框架，前边肯定都是必要的，也就是只需安装compression组件，然后添加一下两句代码就好</span><br><span class=\"line\">const compression = require(&apos;compression&apos;);</span><br><span class=\"line\">app.use(compression());</span><br></pre></td></tr></table></figure>\n<p>对于Apache服务器，我们可以启动压缩输出也很简单直接。在你的.htaccess文件里增加如下代码：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># compress text, html, javascript, css, xml:</span><br><span class=\"line\">AddOutputFilterByType DEFLATE text/plain</span><br><span class=\"line\">AddOutputFilterByType DEFLATE text/html</span><br><span class=\"line\">AddOutputFilterByType DEFLATE text/xml</span><br><span class=\"line\">AddOutputFilterByType DEFLATE text/css</span><br><span class=\"line\">AddOutputFilterByType DEFLATE application/xml</span><br><span class=\"line\">AddOutputFilterByType DEFLATE application/xhtml+xml</span><br><span class=\"line\">AddOutputFilterByType DEFLATE application/rss+xml</span><br><span class=\"line\">AddOutputFilterByType DEFLATE application/javascript</span><br><span class=\"line\">AddOutputFilterByType DEFLATE application/x-javascript</span><br><span class=\"line\"></span><br><span class=\"line\"># Or, compress certain file types by extension:</span><br><span class=\"line\">&lt;files *.html&gt;</span><br><span class=\"line\">SetOutputFilter DEFLATE</span><br><span class=\"line\">&lt;/files&gt;</span><br></pre></td></tr></table></figure>\n<p>Apache服务器有两个压缩选择：</p>\n<ul>\n<li>mod_deflate 更简单设置更加标准。</li>\n<li>mod_gzip 看起来更加强大，可以预预缩文件。</li>\n</ul>\n<p>Deflate更快，所以我用的它；当然如果想更爽，用mod_gzip。无论你选那种，Apache会检查浏览器是否发送“Accept-encoding”请求头来判断是返回压缩文件还是源文件。然而，一些旧版本浏览器会带来麻烦，需要一些特别的指令来纠正它。</p>\n<p>如果你不能改你的.htaccess 文件，你可以用PHP来返回压缩的内容，给你的HTML文件一个.php 文件，把下边文件加在文件的最上边。<br>IN PHP :<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php if (substr_count($_SERVER[‘HTTP_ACCEPT_ENCODING’], ‘gzip’)) ob_start(“ob_gzhandler”); else ob_start(); ?&gt;</span><br></pre></td></tr></table></figure></p>\n<p>我们会检查“Accept-encoding”头，返回gzip压缩版本的文件（不然就返回源文件）。这简直像是在建设你自己的web服务器。如果你确实在搭建服务器，请用Apache来压缩你的文件。你肯定不想下载你的文件 just like bearing。</p>\n<p><em>这有点给apache打广告的意思啊</em></p>\n<h2 id=\"验证压缩的效果\"><a href=\"#验证压缩的效果\" class=\"headerlink\" title=\"验证压缩的效果\"></a>验证压缩的效果</h2><p>一旦你配置好了你的服务器，检查他是不是生效了。</p>\n<ul>\n<li>在线查看：用<a href=\"http://www.gidnetwork.com/tools/gzip-test.php\" target=\"_blank\" rel=\"noopener\">online gzip test</a>来检查你的网页是不是确实压缩了。</li>\n<li>浏览器查看：在chrome谷歌浏览器，F12打开 开发者工具–&gt; network页签（火狐和IE浏览器也是相似的）。刷新你的页面，点击这network航信息来查看。这“Content-encoding: gzip” 的头信息意味着内容压缩了传过来的。</li>\n</ul>\n<p><img src=\"https://betterexplained.com/wp-content/uploads/2007/04/chrome-gzip-header.png\" alt=\"image\"></p>\n<p>点击“use large rows”表情来查看更多信息。包含了压缩以后的大小和源文件的大小。</p>\n<p><img src=\"https://betterexplained.com/wp-content/uploads/2007/04/request-size.png\" alt=\"image\"></p>\n<p>奇迹般的，主页从187kb压缩到了59kb。</p>\n<h2 id=\"试试几个小栗子\"><a href=\"#试试几个小栗子\" class=\"headerlink\" title=\"试试几个小栗子\"></a>试试几个小栗子</h2><p>我做了个几个页和一个下载demo：</p>\n<ul>\n<li><a href=\"https://betterexplained.com/examples/compressed/index.html\" target=\"_blank\" rel=\"noopener\">index.html</a> —— 默认压缩</li>\n<li><a href=\"https://betterexplained.com/examples/compressed/index.htm\" target=\"_blank\" rel=\"noopener\">index.htm</a> —— 通过在Apache上的.htaccess文件 增加 *.htm规则来压缩</li>\n<li><a href=\"https://betterexplained.com/examples/compressed/index.php\" target=\"_blank\" rel=\"noopener\">index.php</a> —— 通过php的头信息来压缩</li>\n</ul>\n<p>随意下载这些文件，放到你的服务器，调整你的服务器设置。</p>\n<h2 id=\"警告\"><a href=\"#警告\" class=\"headerlink\" title=\"警告\"></a>警告</h2><p>gzip压缩的出现如此的令人振奋，但是还有以下三个注意点：</p>\n<ul>\n<li>低版本浏览器：一些浏览器接受压缩文件还是有问题（他们说他们可以但是他们并不行），如果你的站点必须在window95的网景1.0浏览器上，你可能不想要压缩文件。Apache mod_deflate设置了一些忽略规则来专门为旧浏览器。</li>\n<li>已经压缩过的文件:大多数的图片，音乐和视频都已经压缩过了，不要浪费时间来压缩他们了。事实上，你可以只压缩那三巨头（HTML,CSS AND JAVARSCRIPT)。</li>\n<li>CPU负载：在传输过程中压缩文件耗费CPU但是节省带宽（用空间换时间）。通常压缩速率的选择需要权衡利弊。也存在一些预压缩静态文件的方法，但这要求更多的资源。考虑了cpu的耗费，压缩文件也是利大于弊。通过压缩实现更好的用户体验，更短的留白时间，值！</li>\n</ul>\n<hr>\n<p>开启gzip压缩是优化网站最快的方法之一。大胆的用吧，让你的用户体验更棒。</p>\n<p><em>本文为翻译文章，欲了解原文请点击<a href=\"https://betterexplained.com/articles/how-to-optimize-your-site-with-gzip-compression/\" target=\"_blank\" rel=\"noopener\">原文链接</a></em></p>\n","site":{"data":{}},"excerpt":"","more":"<p>如果你想节省带宽提高网站速度，压缩是一种简单有效的方法。当我打算提高JavaScript的传输速率来开启GZIP压缩的时候，我犹豫了因为有旧版本浏览器的存在（IE6）。</p>\n<p>然而在二十一世纪，我们大部分的流量来自于现代浏览器，坦白的讲，我们大部分的用户都是很懂技术的。我们不想让任何一个人在访问我们网站的时候卡顿，哪怕是他在用IE4.0和Wdinows95.谷歌和雅虎都开启了gzip压缩。一个现代的浏览器要想不仅要享受到现代网络信息还要享受到现代互联网的速度，就必须开启gzip压缩。以下是如何设置。</p>\n<h2 id=\"等等，为什么我们要开启gzip压缩\"><a href=\"#等等，为什么我们要开启gzip压缩\" class=\"headerlink\" title=\"等等，为什么我们要开启gzip压缩\"></a>等等，为什么我们要开启gzip压缩</h2><p>在此之前，我有必要解释一下什么编码。当你在互联网上想请求一个文件时,比如<a href=\"http://www.yahoo.com/index.html，你的浏览器会和服务器有一个会话，大概如下如所示。\" target=\"_blank\" rel=\"noopener\">http://www.yahoo.com/index.html，你的浏览器会和服务器有一个会话，大概如下如所示。</a><br><img src=\"https://betterexplained.com/wp-content/uploads/compression/HTTP_request.png\" alt=\"\"></p>\n<ol>\n<li>浏览器：嘿，给我来一个 index.html文件</li>\n<li>服务器：好的，让我去找找它是不是在~</li>\n<li>服务器：找到它了，我会返回一个成功的状态码（200 ok），我正在发送文件……</li>\n<li>浏览器：100kb？ 我滴天……等啊……等啊，好的，下载下来了</li>\n</ol>\n<p>当然，实际的请求头和协议会更加正规一点。</p>\n<p>但是，它生效了，我拿到了index.html文件。</p>\n<h2 id=\"那现在问题在哪呢？\"><a href=\"#那现在问题在哪呢？\" class=\"headerlink\" title=\"那现在问题在哪呢？\"></a>那现在问题在哪呢？</h2><p>好吧，这系统是正常的，但是太低效了，坦白讲100kb是一大段的文字，HTML是冗余的，每一个<html>,<table>,<div>都有一个几乎相同的闭合标签。虽然通篇文字都有重复，但是只要你砍掉任何的内容，html（以及它的一奶同胞xml）都不会正常显示。</div></table></html></p>\n<p>当文件太大的时候有什么好办法呢，就是gzip压缩它。</p>\n<p>如果我们传输一个替代原始大文件的zip的压缩文件给浏览器，就会节省带宽和下载时间。当浏览器可以下载zip文件，解压，并且渲染给用户。下载很快，页面加载也很快，用户心情就会very good。这个浏览器–服务器的会话大概是酱紫的：<br><img src=\"https://betterexplained.com/wp-content/uploads/compression/HTTP_request_compressed.png\" alt=\"\"></p>\n<ol>\n<li>浏览器：嘿，给我来一个index.html，如果要有，给我来一个压缩版的可以吗</li>\n<li>服务器：容我找找……好，满足你，如果找到了给你压缩以下，gzip格式的哦</li>\n<li>服务器：yep，找到了，正在压缩，马上传给你。</li>\n<li>浏览器：太棒了，只有10kb，我来解压，并且渲染给用户。</li>\n</ol>\n<p>情况很简单：文件越小，下载更快，用户感受更好。</p>\n<p>不相信我？雅虎主页的html部分通过压缩从101kb直接压到了15kb：<br><img src=\"https://betterexplained.com/wp-content/uploads/compression/yahoo.png\" alt=\"\"></p>\n<h2 id=\"残（淡）酷（定）的现实\"><a href=\"#残（淡）酷（定）的现实\" class=\"headerlink\" title=\"残（淡）酷（定）的现实\"></a>残（淡）酷（定）的现实</h2><p>变化的部分在于浏览器和服务器，它成功的发送过去一个压缩文件。对于gzip压缩的要点有两点：</p>\n<ul>\n<li>浏览器发送一个请求头，告诉服务器接受压缩版本的文件（gzip和deflate是两种压缩算法）Accept-Encoding:gzip,deflate</li>\n<li>如果文件压缩了,服务器返回一个头信息:Content-Encoding:gzip</li>\n</ul>\n<p>如果服务器没有返回Content-Encoding的头信息，意味着这文件是没压缩的（浏览器可以直接解析的）。请求头Accept-Encoding只是浏览器的一个请求，而不是命令。如果服务器不返回压缩文件，浏览器就不得不处理那庞大的源文件。</p>\n<h2 id=\"服务器设置\"><a href=\"#服务器设置\" class=\"headerlink\" title=\"服务器设置\"></a>服务器设置</h2><p>“好消息”是我们没办法控制浏览器。他发“Accept-encoding: gzip, deflat”或者不发，请求头就在那里，不增不减。</p>\n<p>我们需要做的只是给服务器配置，让它返回压缩版本。如果浏览器控制，我们可以为每一个人节省带宽。</p>\n<p>对于IIS服务器，启动压缩在“设置”里。</p>\n<p>如果你像我一样用nodejs来搭建服务器，那你中奖了，nodejs开启gzip非常的简单，只需增加两行代码搞定。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">const express = require(&apos;express&apos;);</span><br><span class=\"line\">const app = express();</span><br><span class=\"line\"></span><br><span class=\"line\">//express框架，前边肯定都是必要的，也就是只需安装compression组件，然后添加一下两句代码就好</span><br><span class=\"line\">const compression = require(&apos;compression&apos;);</span><br><span class=\"line\">app.use(compression());</span><br></pre></td></tr></table></figure>\n<p>对于Apache服务器，我们可以启动压缩输出也很简单直接。在你的.htaccess文件里增加如下代码：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># compress text, html, javascript, css, xml:</span><br><span class=\"line\">AddOutputFilterByType DEFLATE text/plain</span><br><span class=\"line\">AddOutputFilterByType DEFLATE text/html</span><br><span class=\"line\">AddOutputFilterByType DEFLATE text/xml</span><br><span class=\"line\">AddOutputFilterByType DEFLATE text/css</span><br><span class=\"line\">AddOutputFilterByType DEFLATE application/xml</span><br><span class=\"line\">AddOutputFilterByType DEFLATE application/xhtml+xml</span><br><span class=\"line\">AddOutputFilterByType DEFLATE application/rss+xml</span><br><span class=\"line\">AddOutputFilterByType DEFLATE application/javascript</span><br><span class=\"line\">AddOutputFilterByType DEFLATE application/x-javascript</span><br><span class=\"line\"></span><br><span class=\"line\"># Or, compress certain file types by extension:</span><br><span class=\"line\">&lt;files *.html&gt;</span><br><span class=\"line\">SetOutputFilter DEFLATE</span><br><span class=\"line\">&lt;/files&gt;</span><br></pre></td></tr></table></figure>\n<p>Apache服务器有两个压缩选择：</p>\n<ul>\n<li>mod_deflate 更简单设置更加标准。</li>\n<li>mod_gzip 看起来更加强大，可以预预缩文件。</li>\n</ul>\n<p>Deflate更快，所以我用的它；当然如果想更爽，用mod_gzip。无论你选那种，Apache会检查浏览器是否发送“Accept-encoding”请求头来判断是返回压缩文件还是源文件。然而，一些旧版本浏览器会带来麻烦，需要一些特别的指令来纠正它。</p>\n<p>如果你不能改你的.htaccess 文件，你可以用PHP来返回压缩的内容，给你的HTML文件一个.php 文件，把下边文件加在文件的最上边。<br>IN PHP :<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php if (substr_count($_SERVER[‘HTTP_ACCEPT_ENCODING’], ‘gzip’)) ob_start(“ob_gzhandler”); else ob_start(); ?&gt;</span><br></pre></td></tr></table></figure></p>\n<p>我们会检查“Accept-encoding”头，返回gzip压缩版本的文件（不然就返回源文件）。这简直像是在建设你自己的web服务器。如果你确实在搭建服务器，请用Apache来压缩你的文件。你肯定不想下载你的文件 just like bearing。</p>\n<p><em>这有点给apache打广告的意思啊</em></p>\n<h2 id=\"验证压缩的效果\"><a href=\"#验证压缩的效果\" class=\"headerlink\" title=\"验证压缩的效果\"></a>验证压缩的效果</h2><p>一旦你配置好了你的服务器，检查他是不是生效了。</p>\n<ul>\n<li>在线查看：用<a href=\"http://www.gidnetwork.com/tools/gzip-test.php\" target=\"_blank\" rel=\"noopener\">online gzip test</a>来检查你的网页是不是确实压缩了。</li>\n<li>浏览器查看：在chrome谷歌浏览器，F12打开 开发者工具–&gt; network页签（火狐和IE浏览器也是相似的）。刷新你的页面，点击这network航信息来查看。这“Content-encoding: gzip” 的头信息意味着内容压缩了传过来的。</li>\n</ul>\n<p><img src=\"https://betterexplained.com/wp-content/uploads/2007/04/chrome-gzip-header.png\" alt=\"image\"></p>\n<p>点击“use large rows”表情来查看更多信息。包含了压缩以后的大小和源文件的大小。</p>\n<p><img src=\"https://betterexplained.com/wp-content/uploads/2007/04/request-size.png\" alt=\"image\"></p>\n<p>奇迹般的，主页从187kb压缩到了59kb。</p>\n<h2 id=\"试试几个小栗子\"><a href=\"#试试几个小栗子\" class=\"headerlink\" title=\"试试几个小栗子\"></a>试试几个小栗子</h2><p>我做了个几个页和一个下载demo：</p>\n<ul>\n<li><a href=\"https://betterexplained.com/examples/compressed/index.html\" target=\"_blank\" rel=\"noopener\">index.html</a> —— 默认压缩</li>\n<li><a href=\"https://betterexplained.com/examples/compressed/index.htm\" target=\"_blank\" rel=\"noopener\">index.htm</a> —— 通过在Apache上的.htaccess文件 增加 *.htm规则来压缩</li>\n<li><a href=\"https://betterexplained.com/examples/compressed/index.php\" target=\"_blank\" rel=\"noopener\">index.php</a> —— 通过php的头信息来压缩</li>\n</ul>\n<p>随意下载这些文件，放到你的服务器，调整你的服务器设置。</p>\n<h2 id=\"警告\"><a href=\"#警告\" class=\"headerlink\" title=\"警告\"></a>警告</h2><p>gzip压缩的出现如此的令人振奋，但是还有以下三个注意点：</p>\n<ul>\n<li>低版本浏览器：一些浏览器接受压缩文件还是有问题（他们说他们可以但是他们并不行），如果你的站点必须在window95的网景1.0浏览器上，你可能不想要压缩文件。Apache mod_deflate设置了一些忽略规则来专门为旧浏览器。</li>\n<li>已经压缩过的文件:大多数的图片，音乐和视频都已经压缩过了，不要浪费时间来压缩他们了。事实上，你可以只压缩那三巨头（HTML,CSS AND JAVARSCRIPT)。</li>\n<li>CPU负载：在传输过程中压缩文件耗费CPU但是节省带宽（用空间换时间）。通常压缩速率的选择需要权衡利弊。也存在一些预压缩静态文件的方法，但这要求更多的资源。考虑了cpu的耗费，压缩文件也是利大于弊。通过压缩实现更好的用户体验，更短的留白时间，值！</li>\n</ul>\n<hr>\n<p>开启gzip压缩是优化网站最快的方法之一。大胆的用吧，让你的用户体验更棒。</p>\n<p><em>本文为翻译文章，欲了解原文请点击<a href=\"https://betterexplained.com/articles/how-to-optimize-your-site-with-gzip-compression/\" target=\"_blank\" rel=\"noopener\">原文链接</a></em></p>\n"},{"title":"滴滴云控制台Selenium自动化测试初探","date":"2019-02-13T06:23:21.000Z","comments":1,"_content":"Selenium是一系列基于Web的自动化工具，提供一套测试函数，用于支持Web自动化测试。函数非常灵活，能够完成界面元素定位、窗口跳转、结果比较。具有如下特点：\n\n1. 多浏览器支持。如IE、Firefox、Safari、Chrome、Android手机浏览器等。\n2. 支持多种语言。如Java、C#、Python、Ruby、PHP等。\n3. 支持多种操作系统。如Windows、Linux、IOS、Android等。\n4. 开源免费。官网：http://www.seleniumhg.org/\n\n## Selenium组成部分\n### 一、Selenium IDE\n该工具是一个用于构建脚本的初级工具，其实是FireFox的一个插件，拥有一个易于使用的界面。它拥有记录功能，能够记录用户执行的操作，并可以导出为可重复使用的脚本。如果没有编程经验，可以通过Selenium IDE来快速熟悉Selenium的命令。较少使用。\n\n### 二、Selenium RC\nSelenium RC是selenium家族核心部分。Selenium RC支持多种不同的语言编写自动化测试脚本，通过SeleniumRC的服务器作为代理服务器去访问应用，从而达到测试的目的。\n\n### 三、Selenium WebDriver\n当Selenium2.x提出了WebDriver的概念之后，它提供了完全另外的一种方式与浏览器交互。那就是利用浏览器原生的API，封装成一套更加面向对象的SeleniumWebDriver API，直接操作浏览器页面里的元素，甚至操作浏览器本身（截屏，窗口大小，启动，关闭，安装插件，配置证书之类的）。由于使用的是浏览器原生的API，速度大大提高，而且调用的稳定性交给了浏览器厂商本身，显然是更加科学。然而带来的一些副作用就是，不同的浏览器厂商，对Web元素的操作和呈现多少会有一些差异，这就直接导致了Selenium WebDriver要分浏览器厂商不同，而提供不同的实现。例如Firefox就有专门的FirefoxDriver，Chrome就有专门的ChromeDriver等等。（甚至包括了AndroidDriver和iOS WebDriver）\n\n### 四、Selenium Grid\nSelenium Grid通过在许多服务器上同时运行测试，将Selenium Remote Control带到另一个层次，从而减少了测试多个浏览器或操作系统所需的时间。\n\n----\n\n这里借助Selenium WebDriver，以[滴滴云控制台](https://app.didiyun.com/#/)的**默认选中**为例\b展示Selenium如何解放测试人员的双手。\n\n[滴滴云控制台](https://app.didiyun.com/#/)的\b[DC2创建页](https://app.didiyun.com/#/dc2/add)承载着复杂的业务逻辑，众多页面都需要跳转到此，并\b需要根据URL上的参数\b而对DC2的配置做默认选中。当多人开发对\b业务逻辑耦合时，众多逻辑均会对默认选中的结果造成影响，难以避免导致BUG的产生。在手动测试的\b情况下，需要回归测试整个页面的所有功能点，而用Selenium如何如何保证页面的稳定呢？\n\n### Selenium安装\n\nSelenium支持多种语言，python\b\b最受欢迎，\b安装也比较简单。\n```\npip install selenium\n```\n然后需要根据[链接](https://sites.google.com/a/chromium.org/chromedriver/downloads)下载chromedriver 到/usr/local/bin。\n\n执行以下代码检测你的环境已经安装完毕\n```\n# coding = utf-8\nfrom selenium import webdriver\nimport time\n\nbrowser = webdriver.Chrome()\nbrowser.get(\"http://www.baidu.com\")\nbrowser.find_element_by_id(\"kw\").send_keys(\"selenium\")\nbrowser.find_element_by_id(\"su\").click()\ntime.sleep(3)\nbrowser.quit()\n```\n如果程序能正常打开你的\bChrome浏览器，输入selenium并搜索，则说明Selenium安装成功。\n\n### Selenium定位页面元素\n\nwebdriver提供了一系列的对象定位方法，常用的有id,name,class name,link text,partial link text,tag name,xpath,css selector，针对百度的网页可以有一下多种方法定位页面元素。\n\n```\n#coding=utf-8\n\nfrom selenium import webdriver\nimport time\n\nbrowser = webdriver.Chrome()\n\nbrowser.get(\"http://www.baidu.com\")\ntime.sleep(2)\n\n#########百度输入框的定位方式##########\n\n#通过id方式定位\nbrowser.find_element_by_id(\"kw\").send_keys(\"selenium\")\n\n#通过name方式定位\nbrowser.find_element_by_name(\"wd\").send_keys(\"selenium\")\n\n#通过tag name方式定位\nbrowser.find_element_by_tag_name(\"input\").send_keys(\"selenium\")\n\n#通过class name 方式定位\nbrowser.find_element_by_class_name(\"s_ipt\").send_keys(\"selenium\")\n\n#通过CSS方式定位\nbrowser.find_element_by_css_selector(\"#kw\").send_keys(\"selenium\")\n\n#通过xpath方式定位\nbrowser.find_element_by_xpath(\"//input[@id='kw']\").send_keys(\"selenium\")\n\n############################################\n\nbrowser.find_element_by_id(\"su\").click()\ntime.sleep(3)\nbrowser.quit()\n```\n### 测试登录\b \n因为滴滴云控制台部分页面需登录后方可打开，所以测试的第一步打开首页，\b填入用户名密码。\n\n```\n#coding=utf-8\nfrom selenium import webdriver\n\nimport time\n\ndriver = webdriver.Chrome()\ndriver.get(\"http://app.didiyun.com\")\n\ndriver.find_element_by_css_selector('input[type=\"text\"]').send_keys(\"189****3932\")\ndriver.find_element_by_css_selector('input[type=\"password\"]').send_keys(\"3e****FV\")\ntime.sleep(2)\n\nsubbutton=driver.find_element_by_css_selector('button[type=\"submit\"]')\n\nsubbutton.click()\n\ntime.sleep(3)\n\n```\n检查程序可以打开滴滴云控制台首页，并成功登录dashboard页，则登录验证成功。\n\n### 测试默认项选中\n\n本次自动化测试的目的为检测从官网跳转到控制台时，进入https://app.didiyun.com/#/dc2/add?srvType=ebs&systemDiskType=HE&zoneId=gz01 页，\b能否默认选中广州一区，标准云服务器，\b系统盘为高效云盘。\n\n```\n#coding=utf-8\nfrom selenium import webdriver\n\nimport time\n\ndriver = webdriver.Chrome()\ndriver.get(\"http://app.didiyun.com\")\n\ndriver.find_element_by_css_selector('input[type=\"text\"]').send_keys(\"18903393932\")\ndriver.find_element_by_css_selector('input[type=\"password\"]').send_keys(\"3edc$RFV%TGB\")\ntime.sleep(2)\n\n#测试的最终结果\nTEST_PASS = True\n\nsubbutton=driver.find_element_by_css_selector('button[type=\"submit\"]')\n\nsubbutton.click()\n\ntime.sleep(3)\nif (driver.current_url == 'https://app.didiyun.com/#/'):\n\tprint 'Success our dashboard login'\n\nprint \"Opening our target page\"\ndriver.get('https://app.didiyun.com/#/dc2/add?srvType=ebs&systemDiskType=HE&zoneId=gz01')\n\n#浏览器打开需要时间\ntime.sleep(3)\nif (driver.current_url == 'https://app.didiyun.com/#/dc2/add?srvType=ebs&systemDiskType=HE&zoneId=gz01'):\n\tprint 'Opened the dc2 add page'\n#################################################\nregionName = driver.find_element_by_css_selector('div.region-select3-item.active .region-head span').text\n\nzoneName = driver.find_element_by_css_selector('div.region-select3-item.active .zone-item.active span').text\nif(regionName != u'广州'):\n\tTEST_PASS = False\n\tprint u\"期望区域是广州，但实际选中是%s\" %(regionName)\nelse:\n\tif(zoneName != '1'):\n\t\tTEST_PASS = False\n\t\tprint u\"期望1区，但实际选中是%s区\" %(zoneName)\n#################################################\nserverType = driver.find_elements_by_xpath('//*[@id=\"app\"]/div[2]/div/form/div[3]/div[1]/div/div[1]/div/div[2]/div/span[1]')[0].text\n\nif(serverType != u'标准云服务器'):\n\t TEST_PASS = False\n\t print u\"期望服务器类型是标准云服务器，但实际选中是%s\" %(serverType)\n##################################################\nserverVerion = driver.find_elements_by_xpath('//*[@id=\"app\"]/div[2]/div/form/div[3]/div[2]/div[1]/div/label[1]/span/span')[0].text\n\nif(serverVerion != u'通用型'):\n\tTEST_PASS = False\n\tprint u\"期望服务器类型是通用型，但实际选中是%s\" %(serverVerion)\n#################################################\ndiskType = driver.find_element_by_css_selector('div.selector-wrapper input').get_attribute('value')\nif(diskType != u'高效云盘'):\n\tTEST_PASS = False\n\tprint u\"期望的系统盘类型是高效云盘，但实际选中是%s\" %(diskType)\n\nif(TEST_PASS):\n\tprint 'SUCCESS 从官网跳到控制台dc2创建页，选中了对应的配置'\nelse:\n\tprint 'FAIL 从官网跳到控制台dc2创建页，未选中了对应的配置'\n\n\ntime.sleep(3)\ndriver.close()\n```\n如果有如下输出，则测试失败，需要我们手动进入对应页面查看默认选中项的情况。\n\n```\n(venv) ➜  ~ python test.py\nSuccess our dashboard login\nOpening our target page\n期望的系统盘类型是高效云盘，但实际选中是普通云盘\nFAIL 从官网跳到控制台dc2创建页，未选中了对应的配置\n(venv) ➜  ~ \n```\n如果有如下输出，则通过测试。\n```\n(venv) ➜  ~ python test.py\nSuccess our dashboard login\nOpening our target page\nOpened the dc2 add page\nSUCCESS 从官网跳到控制台dc2创建页，选中了对应的配置\n(venv) ➜  ~\n```\n\n### 后记\n\n我们知道，selenium是一个很优秀的web框架，提供了很丰富的API，使用它结合进行做web的自动化测试真的很完美，但是在实际的情况中，理想与现实总是存在那么一点距离，这点距离主要是难维护，难维护的最核心是页面元素经常改变，测试过程中数据很多，不知道怎么进行维护，页面元素确实经常改变，很难改变，另外一个就是数据问题，比如我们验证N个表单在不同输入情况下的提示信息，会有不同的提示信息，都得需要验证。\n\n本文只是一个菜鸡前端为减少重复劳动而对自动化测试所做的一个探索，专业的自动化测试肯定会封装的更加\b易用，可读，可维护。断言，日志都会用更加专业的框架。\b\n\n期待自动化测试可以为滴滴云的稳定性\b出一份力。\n\n参考链接：\n\nSelenium官网：https://www.seleniumhq.org\n\n\n\n\n\n\n\n\n\n","source":"_posts/滴滴云控制台Selenium自动化测试初探.md","raw":"---\ntitle: 滴滴云控制台Selenium自动化测试初探\ndate: 2019-02-13 14:23:21\ntags: 自动化测试\ncomments: true\n---\nSelenium是一系列基于Web的自动化工具，提供一套测试函数，用于支持Web自动化测试。函数非常灵活，能够完成界面元素定位、窗口跳转、结果比较。具有如下特点：\n\n1. 多浏览器支持。如IE、Firefox、Safari、Chrome、Android手机浏览器等。\n2. 支持多种语言。如Java、C#、Python、Ruby、PHP等。\n3. 支持多种操作系统。如Windows、Linux、IOS、Android等。\n4. 开源免费。官网：http://www.seleniumhg.org/\n\n## Selenium组成部分\n### 一、Selenium IDE\n该工具是一个用于构建脚本的初级工具，其实是FireFox的一个插件，拥有一个易于使用的界面。它拥有记录功能，能够记录用户执行的操作，并可以导出为可重复使用的脚本。如果没有编程经验，可以通过Selenium IDE来快速熟悉Selenium的命令。较少使用。\n\n### 二、Selenium RC\nSelenium RC是selenium家族核心部分。Selenium RC支持多种不同的语言编写自动化测试脚本，通过SeleniumRC的服务器作为代理服务器去访问应用，从而达到测试的目的。\n\n### 三、Selenium WebDriver\n当Selenium2.x提出了WebDriver的概念之后，它提供了完全另外的一种方式与浏览器交互。那就是利用浏览器原生的API，封装成一套更加面向对象的SeleniumWebDriver API，直接操作浏览器页面里的元素，甚至操作浏览器本身（截屏，窗口大小，启动，关闭，安装插件，配置证书之类的）。由于使用的是浏览器原生的API，速度大大提高，而且调用的稳定性交给了浏览器厂商本身，显然是更加科学。然而带来的一些副作用就是，不同的浏览器厂商，对Web元素的操作和呈现多少会有一些差异，这就直接导致了Selenium WebDriver要分浏览器厂商不同，而提供不同的实现。例如Firefox就有专门的FirefoxDriver，Chrome就有专门的ChromeDriver等等。（甚至包括了AndroidDriver和iOS WebDriver）\n\n### 四、Selenium Grid\nSelenium Grid通过在许多服务器上同时运行测试，将Selenium Remote Control带到另一个层次，从而减少了测试多个浏览器或操作系统所需的时间。\n\n----\n\n这里借助Selenium WebDriver，以[滴滴云控制台](https://app.didiyun.com/#/)的**默认选中**为例\b展示Selenium如何解放测试人员的双手。\n\n[滴滴云控制台](https://app.didiyun.com/#/)的\b[DC2创建页](https://app.didiyun.com/#/dc2/add)承载着复杂的业务逻辑，众多页面都需要跳转到此，并\b需要根据URL上的参数\b而对DC2的配置做默认选中。当多人开发对\b业务逻辑耦合时，众多逻辑均会对默认选中的结果造成影响，难以避免导致BUG的产生。在手动测试的\b情况下，需要回归测试整个页面的所有功能点，而用Selenium如何如何保证页面的稳定呢？\n\n### Selenium安装\n\nSelenium支持多种语言，python\b\b最受欢迎，\b安装也比较简单。\n```\npip install selenium\n```\n然后需要根据[链接](https://sites.google.com/a/chromium.org/chromedriver/downloads)下载chromedriver 到/usr/local/bin。\n\n执行以下代码检测你的环境已经安装完毕\n```\n# coding = utf-8\nfrom selenium import webdriver\nimport time\n\nbrowser = webdriver.Chrome()\nbrowser.get(\"http://www.baidu.com\")\nbrowser.find_element_by_id(\"kw\").send_keys(\"selenium\")\nbrowser.find_element_by_id(\"su\").click()\ntime.sleep(3)\nbrowser.quit()\n```\n如果程序能正常打开你的\bChrome浏览器，输入selenium并搜索，则说明Selenium安装成功。\n\n### Selenium定位页面元素\n\nwebdriver提供了一系列的对象定位方法，常用的有id,name,class name,link text,partial link text,tag name,xpath,css selector，针对百度的网页可以有一下多种方法定位页面元素。\n\n```\n#coding=utf-8\n\nfrom selenium import webdriver\nimport time\n\nbrowser = webdriver.Chrome()\n\nbrowser.get(\"http://www.baidu.com\")\ntime.sleep(2)\n\n#########百度输入框的定位方式##########\n\n#通过id方式定位\nbrowser.find_element_by_id(\"kw\").send_keys(\"selenium\")\n\n#通过name方式定位\nbrowser.find_element_by_name(\"wd\").send_keys(\"selenium\")\n\n#通过tag name方式定位\nbrowser.find_element_by_tag_name(\"input\").send_keys(\"selenium\")\n\n#通过class name 方式定位\nbrowser.find_element_by_class_name(\"s_ipt\").send_keys(\"selenium\")\n\n#通过CSS方式定位\nbrowser.find_element_by_css_selector(\"#kw\").send_keys(\"selenium\")\n\n#通过xpath方式定位\nbrowser.find_element_by_xpath(\"//input[@id='kw']\").send_keys(\"selenium\")\n\n############################################\n\nbrowser.find_element_by_id(\"su\").click()\ntime.sleep(3)\nbrowser.quit()\n```\n### 测试登录\b \n因为滴滴云控制台部分页面需登录后方可打开，所以测试的第一步打开首页，\b填入用户名密码。\n\n```\n#coding=utf-8\nfrom selenium import webdriver\n\nimport time\n\ndriver = webdriver.Chrome()\ndriver.get(\"http://app.didiyun.com\")\n\ndriver.find_element_by_css_selector('input[type=\"text\"]').send_keys(\"189****3932\")\ndriver.find_element_by_css_selector('input[type=\"password\"]').send_keys(\"3e****FV\")\ntime.sleep(2)\n\nsubbutton=driver.find_element_by_css_selector('button[type=\"submit\"]')\n\nsubbutton.click()\n\ntime.sleep(3)\n\n```\n检查程序可以打开滴滴云控制台首页，并成功登录dashboard页，则登录验证成功。\n\n### 测试默认项选中\n\n本次自动化测试的目的为检测从官网跳转到控制台时，进入https://app.didiyun.com/#/dc2/add?srvType=ebs&systemDiskType=HE&zoneId=gz01 页，\b能否默认选中广州一区，标准云服务器，\b系统盘为高效云盘。\n\n```\n#coding=utf-8\nfrom selenium import webdriver\n\nimport time\n\ndriver = webdriver.Chrome()\ndriver.get(\"http://app.didiyun.com\")\n\ndriver.find_element_by_css_selector('input[type=\"text\"]').send_keys(\"18903393932\")\ndriver.find_element_by_css_selector('input[type=\"password\"]').send_keys(\"3edc$RFV%TGB\")\ntime.sleep(2)\n\n#测试的最终结果\nTEST_PASS = True\n\nsubbutton=driver.find_element_by_css_selector('button[type=\"submit\"]')\n\nsubbutton.click()\n\ntime.sleep(3)\nif (driver.current_url == 'https://app.didiyun.com/#/'):\n\tprint 'Success our dashboard login'\n\nprint \"Opening our target page\"\ndriver.get('https://app.didiyun.com/#/dc2/add?srvType=ebs&systemDiskType=HE&zoneId=gz01')\n\n#浏览器打开需要时间\ntime.sleep(3)\nif (driver.current_url == 'https://app.didiyun.com/#/dc2/add?srvType=ebs&systemDiskType=HE&zoneId=gz01'):\n\tprint 'Opened the dc2 add page'\n#################################################\nregionName = driver.find_element_by_css_selector('div.region-select3-item.active .region-head span').text\n\nzoneName = driver.find_element_by_css_selector('div.region-select3-item.active .zone-item.active span').text\nif(regionName != u'广州'):\n\tTEST_PASS = False\n\tprint u\"期望区域是广州，但实际选中是%s\" %(regionName)\nelse:\n\tif(zoneName != '1'):\n\t\tTEST_PASS = False\n\t\tprint u\"期望1区，但实际选中是%s区\" %(zoneName)\n#################################################\nserverType = driver.find_elements_by_xpath('//*[@id=\"app\"]/div[2]/div/form/div[3]/div[1]/div/div[1]/div/div[2]/div/span[1]')[0].text\n\nif(serverType != u'标准云服务器'):\n\t TEST_PASS = False\n\t print u\"期望服务器类型是标准云服务器，但实际选中是%s\" %(serverType)\n##################################################\nserverVerion = driver.find_elements_by_xpath('//*[@id=\"app\"]/div[2]/div/form/div[3]/div[2]/div[1]/div/label[1]/span/span')[0].text\n\nif(serverVerion != u'通用型'):\n\tTEST_PASS = False\n\tprint u\"期望服务器类型是通用型，但实际选中是%s\" %(serverVerion)\n#################################################\ndiskType = driver.find_element_by_css_selector('div.selector-wrapper input').get_attribute('value')\nif(diskType != u'高效云盘'):\n\tTEST_PASS = False\n\tprint u\"期望的系统盘类型是高效云盘，但实际选中是%s\" %(diskType)\n\nif(TEST_PASS):\n\tprint 'SUCCESS 从官网跳到控制台dc2创建页，选中了对应的配置'\nelse:\n\tprint 'FAIL 从官网跳到控制台dc2创建页，未选中了对应的配置'\n\n\ntime.sleep(3)\ndriver.close()\n```\n如果有如下输出，则测试失败，需要我们手动进入对应页面查看默认选中项的情况。\n\n```\n(venv) ➜  ~ python test.py\nSuccess our dashboard login\nOpening our target page\n期望的系统盘类型是高效云盘，但实际选中是普通云盘\nFAIL 从官网跳到控制台dc2创建页，未选中了对应的配置\n(venv) ➜  ~ \n```\n如果有如下输出，则通过测试。\n```\n(venv) ➜  ~ python test.py\nSuccess our dashboard login\nOpening our target page\nOpened the dc2 add page\nSUCCESS 从官网跳到控制台dc2创建页，选中了对应的配置\n(venv) ➜  ~\n```\n\n### 后记\n\n我们知道，selenium是一个很优秀的web框架，提供了很丰富的API，使用它结合进行做web的自动化测试真的很完美，但是在实际的情况中，理想与现实总是存在那么一点距离，这点距离主要是难维护，难维护的最核心是页面元素经常改变，测试过程中数据很多，不知道怎么进行维护，页面元素确实经常改变，很难改变，另外一个就是数据问题，比如我们验证N个表单在不同输入情况下的提示信息，会有不同的提示信息，都得需要验证。\n\n本文只是一个菜鸡前端为减少重复劳动而对自动化测试所做的一个探索，专业的自动化测试肯定会封装的更加\b易用，可读，可维护。断言，日志都会用更加专业的框架。\b\n\n期待自动化测试可以为滴滴云的稳定性\b出一份力。\n\n参考链接：\n\nSelenium官网：https://www.seleniumhq.org\n\n\n\n\n\n\n\n\n\n","slug":"滴滴云控制台Selenium自动化测试初探","published":1,"updated":"2019-02-14T10:07:53.225Z","layout":"post","photos":[],"link":"","_id":"ckrix8zf4001hk1jf8hhn8677","content":"<p>Selenium是一系列基于Web的自动化工具，提供一套测试函数，用于支持Web自动化测试。函数非常灵活，能够完成界面元素定位、窗口跳转、结果比较。具有如下特点：</p>\n<ol>\n<li>多浏览器支持。如IE、Firefox、Safari、Chrome、Android手机浏览器等。</li>\n<li>支持多种语言。如Java、C#、Python、Ruby、PHP等。</li>\n<li>支持多种操作系统。如Windows、Linux、IOS、Android等。</li>\n<li>开源免费。官网：<a href=\"http://www.seleniumhg.org/\" target=\"_blank\" rel=\"noopener\">http://www.seleniumhg.org/</a></li>\n</ol>\n<h2 id=\"Selenium组成部分\"><a href=\"#Selenium组成部分\" class=\"headerlink\" title=\"Selenium组成部分\"></a>Selenium组成部分</h2><h3 id=\"一、Selenium-IDE\"><a href=\"#一、Selenium-IDE\" class=\"headerlink\" title=\"一、Selenium IDE\"></a>一、Selenium IDE</h3><p>该工具是一个用于构建脚本的初级工具，其实是FireFox的一个插件，拥有一个易于使用的界面。它拥有记录功能，能够记录用户执行的操作，并可以导出为可重复使用的脚本。如果没有编程经验，可以通过Selenium IDE来快速熟悉Selenium的命令。较少使用。</p>\n<h3 id=\"二、Selenium-RC\"><a href=\"#二、Selenium-RC\" class=\"headerlink\" title=\"二、Selenium RC\"></a>二、Selenium RC</h3><p>Selenium RC是selenium家族核心部分。Selenium RC支持多种不同的语言编写自动化测试脚本，通过SeleniumRC的服务器作为代理服务器去访问应用，从而达到测试的目的。</p>\n<h3 id=\"三、Selenium-WebDriver\"><a href=\"#三、Selenium-WebDriver\" class=\"headerlink\" title=\"三、Selenium WebDriver\"></a>三、Selenium WebDriver</h3><p>当Selenium2.x提出了WebDriver的概念之后，它提供了完全另外的一种方式与浏览器交互。那就是利用浏览器原生的API，封装成一套更加面向对象的SeleniumWebDriver API，直接操作浏览器页面里的元素，甚至操作浏览器本身（截屏，窗口大小，启动，关闭，安装插件，配置证书之类的）。由于使用的是浏览器原生的API，速度大大提高，而且调用的稳定性交给了浏览器厂商本身，显然是更加科学。然而带来的一些副作用就是，不同的浏览器厂商，对Web元素的操作和呈现多少会有一些差异，这就直接导致了Selenium WebDriver要分浏览器厂商不同，而提供不同的实现。例如Firefox就有专门的FirefoxDriver，Chrome就有专门的ChromeDriver等等。（甚至包括了AndroidDriver和iOS WebDriver）</p>\n<h3 id=\"四、Selenium-Grid\"><a href=\"#四、Selenium-Grid\" class=\"headerlink\" title=\"四、Selenium Grid\"></a>四、Selenium Grid</h3><p>Selenium Grid通过在许多服务器上同时运行测试，将Selenium Remote Control带到另一个层次，从而减少了测试多个浏览器或操作系统所需的时间。</p>\n<hr>\n<p>这里借助Selenium WebDriver，以<a href=\"https://app.didiyun.com/#/\" target=\"_blank\" rel=\"noopener\">滴滴云控制台</a>的<strong>默认选中</strong>为例\b展示Selenium如何解放测试人员的双手。</p>\n<p><a href=\"https://app.didiyun.com/#/\" target=\"_blank\" rel=\"noopener\">滴滴云控制台</a>的\b<a href=\"https://app.didiyun.com/#/dc2/add\" target=\"_blank\" rel=\"noopener\">DC2创建页</a>承载着复杂的业务逻辑，众多页面都需要跳转到此，并\b需要根据URL上的参数\b而对DC2的配置做默认选中。当多人开发对\b业务逻辑耦合时，众多逻辑均会对默认选中的结果造成影响，难以避免导致BUG的产生。在手动测试的\b情况下，需要回归测试整个页面的所有功能点，而用Selenium如何如何保证页面的稳定呢？</p>\n<h3 id=\"Selenium安装\"><a href=\"#Selenium安装\" class=\"headerlink\" title=\"Selenium安装\"></a>Selenium安装</h3><p>Selenium支持多种语言，python\b\b最受欢迎，\b安装也比较简单。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install selenium</span><br></pre></td></tr></table></figure></p>\n<p>然后需要根据<a href=\"https://sites.google.com/a/chromium.org/chromedriver/downloads\" target=\"_blank\" rel=\"noopener\">链接</a>下载chromedriver 到/usr/local/bin。</p>\n<p>执行以下代码检测你的环境已经安装完毕<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># coding = utf-8</span><br><span class=\"line\">from selenium import webdriver</span><br><span class=\"line\">import time</span><br><span class=\"line\"></span><br><span class=\"line\">browser = webdriver.Chrome()</span><br><span class=\"line\">browser.get(&quot;http://www.baidu.com&quot;)</span><br><span class=\"line\">browser.find_element_by_id(&quot;kw&quot;).send_keys(&quot;selenium&quot;)</span><br><span class=\"line\">browser.find_element_by_id(&quot;su&quot;).click()</span><br><span class=\"line\">time.sleep(3)</span><br><span class=\"line\">browser.quit()</span><br></pre></td></tr></table></figure></p>\n<p>如果程序能正常打开你的\bChrome浏览器，输入selenium并搜索，则说明Selenium安装成功。</p>\n<h3 id=\"Selenium定位页面元素\"><a href=\"#Selenium定位页面元素\" class=\"headerlink\" title=\"Selenium定位页面元素\"></a>Selenium定位页面元素</h3><p>webdriver提供了一系列的对象定位方法，常用的有id,name,class name,link text,partial link text,tag name,xpath,css selector，针对百度的网页可以有一下多种方法定位页面元素。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#coding=utf-8</span><br><span class=\"line\"></span><br><span class=\"line\">from selenium import webdriver</span><br><span class=\"line\">import time</span><br><span class=\"line\"></span><br><span class=\"line\">browser = webdriver.Chrome()</span><br><span class=\"line\"></span><br><span class=\"line\">browser.get(&quot;http://www.baidu.com&quot;)</span><br><span class=\"line\">time.sleep(2)</span><br><span class=\"line\"></span><br><span class=\"line\">#########百度输入框的定位方式##########</span><br><span class=\"line\"></span><br><span class=\"line\">#通过id方式定位</span><br><span class=\"line\">browser.find_element_by_id(&quot;kw&quot;).send_keys(&quot;selenium&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">#通过name方式定位</span><br><span class=\"line\">browser.find_element_by_name(&quot;wd&quot;).send_keys(&quot;selenium&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">#通过tag name方式定位</span><br><span class=\"line\">browser.find_element_by_tag_name(&quot;input&quot;).send_keys(&quot;selenium&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">#通过class name 方式定位</span><br><span class=\"line\">browser.find_element_by_class_name(&quot;s_ipt&quot;).send_keys(&quot;selenium&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">#通过CSS方式定位</span><br><span class=\"line\">browser.find_element_by_css_selector(&quot;#kw&quot;).send_keys(&quot;selenium&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">#通过xpath方式定位</span><br><span class=\"line\">browser.find_element_by_xpath(&quot;//input[@id=&apos;kw&apos;]&quot;).send_keys(&quot;selenium&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">############################################</span><br><span class=\"line\"></span><br><span class=\"line\">browser.find_element_by_id(&quot;su&quot;).click()</span><br><span class=\"line\">time.sleep(3)</span><br><span class=\"line\">browser.quit()</span><br></pre></td></tr></table></figure>\n<h3 id=\"测试登录\"><a href=\"#测试登录\" class=\"headerlink\" title=\"测试登录\b\"></a>测试登录\b</h3><p>因为滴滴云控制台部分页面需登录后方可打开，所以测试的第一步打开首页，\b填入用户名密码。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#coding=utf-8</span><br><span class=\"line\">from selenium import webdriver</span><br><span class=\"line\"></span><br><span class=\"line\">import time</span><br><span class=\"line\"></span><br><span class=\"line\">driver = webdriver.Chrome()</span><br><span class=\"line\">driver.get(&quot;http://app.didiyun.com&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">driver.find_element_by_css_selector(&apos;input[type=&quot;text&quot;]&apos;).send_keys(&quot;189****3932&quot;)</span><br><span class=\"line\">driver.find_element_by_css_selector(&apos;input[type=&quot;password&quot;]&apos;).send_keys(&quot;3e****FV&quot;)</span><br><span class=\"line\">time.sleep(2)</span><br><span class=\"line\"></span><br><span class=\"line\">subbutton=driver.find_element_by_css_selector(&apos;button[type=&quot;submit&quot;]&apos;)</span><br><span class=\"line\"></span><br><span class=\"line\">subbutton.click()</span><br><span class=\"line\"></span><br><span class=\"line\">time.sleep(3)</span><br></pre></td></tr></table></figure>\n<p>检查程序可以打开滴滴云控制台首页，并成功登录dashboard页，则登录验证成功。</p>\n<h3 id=\"测试默认项选中\"><a href=\"#测试默认项选中\" class=\"headerlink\" title=\"测试默认项选中\"></a>测试默认项选中</h3><p>本次自动化测试的目的为检测从官网跳转到控制台时，进入<a href=\"https://app.didiyun.com/#/dc2/add?srvType=ebs&amp;systemDiskType=HE&amp;zoneId=gz01\" target=\"_blank\" rel=\"noopener\">https://app.didiyun.com/#/dc2/add?srvType=ebs&amp;systemDiskType=HE&amp;zoneId=gz01</a> 页，\b能否默认选中广州一区，标准云服务器，\b系统盘为高效云盘。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#coding=utf-8</span><br><span class=\"line\">from selenium import webdriver</span><br><span class=\"line\"></span><br><span class=\"line\">import time</span><br><span class=\"line\"></span><br><span class=\"line\">driver = webdriver.Chrome()</span><br><span class=\"line\">driver.get(&quot;http://app.didiyun.com&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">driver.find_element_by_css_selector(&apos;input[type=&quot;text&quot;]&apos;).send_keys(&quot;18903393932&quot;)</span><br><span class=\"line\">driver.find_element_by_css_selector(&apos;input[type=&quot;password&quot;]&apos;).send_keys(&quot;3edc$RFV%TGB&quot;)</span><br><span class=\"line\">time.sleep(2)</span><br><span class=\"line\"></span><br><span class=\"line\">#测试的最终结果</span><br><span class=\"line\">TEST_PASS = True</span><br><span class=\"line\"></span><br><span class=\"line\">subbutton=driver.find_element_by_css_selector(&apos;button[type=&quot;submit&quot;]&apos;)</span><br><span class=\"line\"></span><br><span class=\"line\">subbutton.click()</span><br><span class=\"line\"></span><br><span class=\"line\">time.sleep(3)</span><br><span class=\"line\">if (driver.current_url == &apos;https://app.didiyun.com/#/&apos;):</span><br><span class=\"line\">\tprint &apos;Success our dashboard login&apos;</span><br><span class=\"line\"></span><br><span class=\"line\">print &quot;Opening our target page&quot;</span><br><span class=\"line\">driver.get(&apos;https://app.didiyun.com/#/dc2/add?srvType=ebs&amp;systemDiskType=HE&amp;zoneId=gz01&apos;)</span><br><span class=\"line\"></span><br><span class=\"line\">#浏览器打开需要时间</span><br><span class=\"line\">time.sleep(3)</span><br><span class=\"line\">if (driver.current_url == &apos;https://app.didiyun.com/#/dc2/add?srvType=ebs&amp;systemDiskType=HE&amp;zoneId=gz01&apos;):</span><br><span class=\"line\">\tprint &apos;Opened the dc2 add page&apos;</span><br><span class=\"line\">#################################################</span><br><span class=\"line\">regionName = driver.find_element_by_css_selector(&apos;div.region-select3-item.active .region-head span&apos;).text</span><br><span class=\"line\"></span><br><span class=\"line\">zoneName = driver.find_element_by_css_selector(&apos;div.region-select3-item.active .zone-item.active span&apos;).text</span><br><span class=\"line\">if(regionName != u&apos;广州&apos;):</span><br><span class=\"line\">\tTEST_PASS = False</span><br><span class=\"line\">\tprint u&quot;期望区域是广州，但实际选中是%s&quot; %(regionName)</span><br><span class=\"line\">else:</span><br><span class=\"line\">\tif(zoneName != &apos;1&apos;):</span><br><span class=\"line\">\t\tTEST_PASS = False</span><br><span class=\"line\">\t\tprint u&quot;期望1区，但实际选中是%s区&quot; %(zoneName)</span><br><span class=\"line\">#################################################</span><br><span class=\"line\">serverType = driver.find_elements_by_xpath(&apos;//*[@id=&quot;app&quot;]/div[2]/div/form/div[3]/div[1]/div/div[1]/div/div[2]/div/span[1]&apos;)[0].text</span><br><span class=\"line\"></span><br><span class=\"line\">if(serverType != u&apos;标准云服务器&apos;):</span><br><span class=\"line\">\t TEST_PASS = False</span><br><span class=\"line\">\t print u&quot;期望服务器类型是标准云服务器，但实际选中是%s&quot; %(serverType)</span><br><span class=\"line\">##################################################</span><br><span class=\"line\">serverVerion = driver.find_elements_by_xpath(&apos;//*[@id=&quot;app&quot;]/div[2]/div/form/div[3]/div[2]/div[1]/div/label[1]/span/span&apos;)[0].text</span><br><span class=\"line\"></span><br><span class=\"line\">if(serverVerion != u&apos;通用型&apos;):</span><br><span class=\"line\">\tTEST_PASS = False</span><br><span class=\"line\">\tprint u&quot;期望服务器类型是通用型，但实际选中是%s&quot; %(serverVerion)</span><br><span class=\"line\">#################################################</span><br><span class=\"line\">diskType = driver.find_element_by_css_selector(&apos;div.selector-wrapper input&apos;).get_attribute(&apos;value&apos;)</span><br><span class=\"line\">if(diskType != u&apos;高效云盘&apos;):</span><br><span class=\"line\">\tTEST_PASS = False</span><br><span class=\"line\">\tprint u&quot;期望的系统盘类型是高效云盘，但实际选中是%s&quot; %(diskType)</span><br><span class=\"line\"></span><br><span class=\"line\">if(TEST_PASS):</span><br><span class=\"line\">\tprint &apos;SUCCESS 从官网跳到控制台dc2创建页，选中了对应的配置&apos;</span><br><span class=\"line\">else:</span><br><span class=\"line\">\tprint &apos;FAIL 从官网跳到控制台dc2创建页，未选中了对应的配置&apos;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">time.sleep(3)</span><br><span class=\"line\">driver.close()</span><br></pre></td></tr></table></figure>\n<p>如果有如下输出，则测试失败，需要我们手动进入对应页面查看默认选中项的情况。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(venv) ➜  ~ python test.py</span><br><span class=\"line\">Success our dashboard login</span><br><span class=\"line\">Opening our target page</span><br><span class=\"line\">期望的系统盘类型是高效云盘，但实际选中是普通云盘</span><br><span class=\"line\">FAIL 从官网跳到控制台dc2创建页，未选中了对应的配置</span><br><span class=\"line\">(venv) ➜  ~</span><br></pre></td></tr></table></figure>\n<p>如果有如下输出，则通过测试。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(venv) ➜  ~ python test.py</span><br><span class=\"line\">Success our dashboard login</span><br><span class=\"line\">Opening our target page</span><br><span class=\"line\">Opened the dc2 add page</span><br><span class=\"line\">SUCCESS 从官网跳到控制台dc2创建页，选中了对应的配置</span><br><span class=\"line\">(venv) ➜  ~</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"后记\"><a href=\"#后记\" class=\"headerlink\" title=\"后记\"></a>后记</h3><p>我们知道，selenium是一个很优秀的web框架，提供了很丰富的API，使用它结合进行做web的自动化测试真的很完美，但是在实际的情况中，理想与现实总是存在那么一点距离，这点距离主要是难维护，难维护的最核心是页面元素经常改变，测试过程中数据很多，不知道怎么进行维护，页面元素确实经常改变，很难改变，另外一个就是数据问题，比如我们验证N个表单在不同输入情况下的提示信息，会有不同的提示信息，都得需要验证。</p>\n<p>本文只是一个菜鸡前端为减少重复劳动而对自动化测试所做的一个探索，专业的自动化测试肯定会封装的更加\b易用，可读，可维护。断言，日志都会用更加专业的框架。\b</p>\n<p>期待自动化测试可以为滴滴云的稳定性\b出一份力。</p>\n<p>参考链接：</p>\n<p>Selenium官网：<a href=\"https://www.seleniumhq.org\" target=\"_blank\" rel=\"noopener\">https://www.seleniumhq.org</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>Selenium是一系列基于Web的自动化工具，提供一套测试函数，用于支持Web自动化测试。函数非常灵活，能够完成界面元素定位、窗口跳转、结果比较。具有如下特点：</p>\n<ol>\n<li>多浏览器支持。如IE、Firefox、Safari、Chrome、Android手机浏览器等。</li>\n<li>支持多种语言。如Java、C#、Python、Ruby、PHP等。</li>\n<li>支持多种操作系统。如Windows、Linux、IOS、Android等。</li>\n<li>开源免费。官网：<a href=\"http://www.seleniumhg.org/\" target=\"_blank\" rel=\"noopener\">http://www.seleniumhg.org/</a></li>\n</ol>\n<h2 id=\"Selenium组成部分\"><a href=\"#Selenium组成部分\" class=\"headerlink\" title=\"Selenium组成部分\"></a>Selenium组成部分</h2><h3 id=\"一、Selenium-IDE\"><a href=\"#一、Selenium-IDE\" class=\"headerlink\" title=\"一、Selenium IDE\"></a>一、Selenium IDE</h3><p>该工具是一个用于构建脚本的初级工具，其实是FireFox的一个插件，拥有一个易于使用的界面。它拥有记录功能，能够记录用户执行的操作，并可以导出为可重复使用的脚本。如果没有编程经验，可以通过Selenium IDE来快速熟悉Selenium的命令。较少使用。</p>\n<h3 id=\"二、Selenium-RC\"><a href=\"#二、Selenium-RC\" class=\"headerlink\" title=\"二、Selenium RC\"></a>二、Selenium RC</h3><p>Selenium RC是selenium家族核心部分。Selenium RC支持多种不同的语言编写自动化测试脚本，通过SeleniumRC的服务器作为代理服务器去访问应用，从而达到测试的目的。</p>\n<h3 id=\"三、Selenium-WebDriver\"><a href=\"#三、Selenium-WebDriver\" class=\"headerlink\" title=\"三、Selenium WebDriver\"></a>三、Selenium WebDriver</h3><p>当Selenium2.x提出了WebDriver的概念之后，它提供了完全另外的一种方式与浏览器交互。那就是利用浏览器原生的API，封装成一套更加面向对象的SeleniumWebDriver API，直接操作浏览器页面里的元素，甚至操作浏览器本身（截屏，窗口大小，启动，关闭，安装插件，配置证书之类的）。由于使用的是浏览器原生的API，速度大大提高，而且调用的稳定性交给了浏览器厂商本身，显然是更加科学。然而带来的一些副作用就是，不同的浏览器厂商，对Web元素的操作和呈现多少会有一些差异，这就直接导致了Selenium WebDriver要分浏览器厂商不同，而提供不同的实现。例如Firefox就有专门的FirefoxDriver，Chrome就有专门的ChromeDriver等等。（甚至包括了AndroidDriver和iOS WebDriver）</p>\n<h3 id=\"四、Selenium-Grid\"><a href=\"#四、Selenium-Grid\" class=\"headerlink\" title=\"四、Selenium Grid\"></a>四、Selenium Grid</h3><p>Selenium Grid通过在许多服务器上同时运行测试，将Selenium Remote Control带到另一个层次，从而减少了测试多个浏览器或操作系统所需的时间。</p>\n<hr>\n<p>这里借助Selenium WebDriver，以<a href=\"https://app.didiyun.com/#/\" target=\"_blank\" rel=\"noopener\">滴滴云控制台</a>的<strong>默认选中</strong>为例\b展示Selenium如何解放测试人员的双手。</p>\n<p><a href=\"https://app.didiyun.com/#/\" target=\"_blank\" rel=\"noopener\">滴滴云控制台</a>的\b<a href=\"https://app.didiyun.com/#/dc2/add\" target=\"_blank\" rel=\"noopener\">DC2创建页</a>承载着复杂的业务逻辑，众多页面都需要跳转到此，并\b需要根据URL上的参数\b而对DC2的配置做默认选中。当多人开发对\b业务逻辑耦合时，众多逻辑均会对默认选中的结果造成影响，难以避免导致BUG的产生。在手动测试的\b情况下，需要回归测试整个页面的所有功能点，而用Selenium如何如何保证页面的稳定呢？</p>\n<h3 id=\"Selenium安装\"><a href=\"#Selenium安装\" class=\"headerlink\" title=\"Selenium安装\"></a>Selenium安装</h3><p>Selenium支持多种语言，python\b\b最受欢迎，\b安装也比较简单。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install selenium</span><br></pre></td></tr></table></figure></p>\n<p>然后需要根据<a href=\"https://sites.google.com/a/chromium.org/chromedriver/downloads\" target=\"_blank\" rel=\"noopener\">链接</a>下载chromedriver 到/usr/local/bin。</p>\n<p>执行以下代码检测你的环境已经安装完毕<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># coding = utf-8</span><br><span class=\"line\">from selenium import webdriver</span><br><span class=\"line\">import time</span><br><span class=\"line\"></span><br><span class=\"line\">browser = webdriver.Chrome()</span><br><span class=\"line\">browser.get(&quot;http://www.baidu.com&quot;)</span><br><span class=\"line\">browser.find_element_by_id(&quot;kw&quot;).send_keys(&quot;selenium&quot;)</span><br><span class=\"line\">browser.find_element_by_id(&quot;su&quot;).click()</span><br><span class=\"line\">time.sleep(3)</span><br><span class=\"line\">browser.quit()</span><br></pre></td></tr></table></figure></p>\n<p>如果程序能正常打开你的\bChrome浏览器，输入selenium并搜索，则说明Selenium安装成功。</p>\n<h3 id=\"Selenium定位页面元素\"><a href=\"#Selenium定位页面元素\" class=\"headerlink\" title=\"Selenium定位页面元素\"></a>Selenium定位页面元素</h3><p>webdriver提供了一系列的对象定位方法，常用的有id,name,class name,link text,partial link text,tag name,xpath,css selector，针对百度的网页可以有一下多种方法定位页面元素。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#coding=utf-8</span><br><span class=\"line\"></span><br><span class=\"line\">from selenium import webdriver</span><br><span class=\"line\">import time</span><br><span class=\"line\"></span><br><span class=\"line\">browser = webdriver.Chrome()</span><br><span class=\"line\"></span><br><span class=\"line\">browser.get(&quot;http://www.baidu.com&quot;)</span><br><span class=\"line\">time.sleep(2)</span><br><span class=\"line\"></span><br><span class=\"line\">#########百度输入框的定位方式##########</span><br><span class=\"line\"></span><br><span class=\"line\">#通过id方式定位</span><br><span class=\"line\">browser.find_element_by_id(&quot;kw&quot;).send_keys(&quot;selenium&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">#通过name方式定位</span><br><span class=\"line\">browser.find_element_by_name(&quot;wd&quot;).send_keys(&quot;selenium&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">#通过tag name方式定位</span><br><span class=\"line\">browser.find_element_by_tag_name(&quot;input&quot;).send_keys(&quot;selenium&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">#通过class name 方式定位</span><br><span class=\"line\">browser.find_element_by_class_name(&quot;s_ipt&quot;).send_keys(&quot;selenium&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">#通过CSS方式定位</span><br><span class=\"line\">browser.find_element_by_css_selector(&quot;#kw&quot;).send_keys(&quot;selenium&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">#通过xpath方式定位</span><br><span class=\"line\">browser.find_element_by_xpath(&quot;//input[@id=&apos;kw&apos;]&quot;).send_keys(&quot;selenium&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">############################################</span><br><span class=\"line\"></span><br><span class=\"line\">browser.find_element_by_id(&quot;su&quot;).click()</span><br><span class=\"line\">time.sleep(3)</span><br><span class=\"line\">browser.quit()</span><br></pre></td></tr></table></figure>\n<h3 id=\"测试登录\"><a href=\"#测试登录\" class=\"headerlink\" title=\"测试登录\b\"></a>测试登录\b</h3><p>因为滴滴云控制台部分页面需登录后方可打开，所以测试的第一步打开首页，\b填入用户名密码。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#coding=utf-8</span><br><span class=\"line\">from selenium import webdriver</span><br><span class=\"line\"></span><br><span class=\"line\">import time</span><br><span class=\"line\"></span><br><span class=\"line\">driver = webdriver.Chrome()</span><br><span class=\"line\">driver.get(&quot;http://app.didiyun.com&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">driver.find_element_by_css_selector(&apos;input[type=&quot;text&quot;]&apos;).send_keys(&quot;189****3932&quot;)</span><br><span class=\"line\">driver.find_element_by_css_selector(&apos;input[type=&quot;password&quot;]&apos;).send_keys(&quot;3e****FV&quot;)</span><br><span class=\"line\">time.sleep(2)</span><br><span class=\"line\"></span><br><span class=\"line\">subbutton=driver.find_element_by_css_selector(&apos;button[type=&quot;submit&quot;]&apos;)</span><br><span class=\"line\"></span><br><span class=\"line\">subbutton.click()</span><br><span class=\"line\"></span><br><span class=\"line\">time.sleep(3)</span><br></pre></td></tr></table></figure>\n<p>检查程序可以打开滴滴云控制台首页，并成功登录dashboard页，则登录验证成功。</p>\n<h3 id=\"测试默认项选中\"><a href=\"#测试默认项选中\" class=\"headerlink\" title=\"测试默认项选中\"></a>测试默认项选中</h3><p>本次自动化测试的目的为检测从官网跳转到控制台时，进入<a href=\"https://app.didiyun.com/#/dc2/add?srvType=ebs&amp;systemDiskType=HE&amp;zoneId=gz01\" target=\"_blank\" rel=\"noopener\">https://app.didiyun.com/#/dc2/add?srvType=ebs&amp;systemDiskType=HE&amp;zoneId=gz01</a> 页，\b能否默认选中广州一区，标准云服务器，\b系统盘为高效云盘。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#coding=utf-8</span><br><span class=\"line\">from selenium import webdriver</span><br><span class=\"line\"></span><br><span class=\"line\">import time</span><br><span class=\"line\"></span><br><span class=\"line\">driver = webdriver.Chrome()</span><br><span class=\"line\">driver.get(&quot;http://app.didiyun.com&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">driver.find_element_by_css_selector(&apos;input[type=&quot;text&quot;]&apos;).send_keys(&quot;18903393932&quot;)</span><br><span class=\"line\">driver.find_element_by_css_selector(&apos;input[type=&quot;password&quot;]&apos;).send_keys(&quot;3edc$RFV%TGB&quot;)</span><br><span class=\"line\">time.sleep(2)</span><br><span class=\"line\"></span><br><span class=\"line\">#测试的最终结果</span><br><span class=\"line\">TEST_PASS = True</span><br><span class=\"line\"></span><br><span class=\"line\">subbutton=driver.find_element_by_css_selector(&apos;button[type=&quot;submit&quot;]&apos;)</span><br><span class=\"line\"></span><br><span class=\"line\">subbutton.click()</span><br><span class=\"line\"></span><br><span class=\"line\">time.sleep(3)</span><br><span class=\"line\">if (driver.current_url == &apos;https://app.didiyun.com/#/&apos;):</span><br><span class=\"line\">\tprint &apos;Success our dashboard login&apos;</span><br><span class=\"line\"></span><br><span class=\"line\">print &quot;Opening our target page&quot;</span><br><span class=\"line\">driver.get(&apos;https://app.didiyun.com/#/dc2/add?srvType=ebs&amp;systemDiskType=HE&amp;zoneId=gz01&apos;)</span><br><span class=\"line\"></span><br><span class=\"line\">#浏览器打开需要时间</span><br><span class=\"line\">time.sleep(3)</span><br><span class=\"line\">if (driver.current_url == &apos;https://app.didiyun.com/#/dc2/add?srvType=ebs&amp;systemDiskType=HE&amp;zoneId=gz01&apos;):</span><br><span class=\"line\">\tprint &apos;Opened the dc2 add page&apos;</span><br><span class=\"line\">#################################################</span><br><span class=\"line\">regionName = driver.find_element_by_css_selector(&apos;div.region-select3-item.active .region-head span&apos;).text</span><br><span class=\"line\"></span><br><span class=\"line\">zoneName = driver.find_element_by_css_selector(&apos;div.region-select3-item.active .zone-item.active span&apos;).text</span><br><span class=\"line\">if(regionName != u&apos;广州&apos;):</span><br><span class=\"line\">\tTEST_PASS = False</span><br><span class=\"line\">\tprint u&quot;期望区域是广州，但实际选中是%s&quot; %(regionName)</span><br><span class=\"line\">else:</span><br><span class=\"line\">\tif(zoneName != &apos;1&apos;):</span><br><span class=\"line\">\t\tTEST_PASS = False</span><br><span class=\"line\">\t\tprint u&quot;期望1区，但实际选中是%s区&quot; %(zoneName)</span><br><span class=\"line\">#################################################</span><br><span class=\"line\">serverType = driver.find_elements_by_xpath(&apos;//*[@id=&quot;app&quot;]/div[2]/div/form/div[3]/div[1]/div/div[1]/div/div[2]/div/span[1]&apos;)[0].text</span><br><span class=\"line\"></span><br><span class=\"line\">if(serverType != u&apos;标准云服务器&apos;):</span><br><span class=\"line\">\t TEST_PASS = False</span><br><span class=\"line\">\t print u&quot;期望服务器类型是标准云服务器，但实际选中是%s&quot; %(serverType)</span><br><span class=\"line\">##################################################</span><br><span class=\"line\">serverVerion = driver.find_elements_by_xpath(&apos;//*[@id=&quot;app&quot;]/div[2]/div/form/div[3]/div[2]/div[1]/div/label[1]/span/span&apos;)[0].text</span><br><span class=\"line\"></span><br><span class=\"line\">if(serverVerion != u&apos;通用型&apos;):</span><br><span class=\"line\">\tTEST_PASS = False</span><br><span class=\"line\">\tprint u&quot;期望服务器类型是通用型，但实际选中是%s&quot; %(serverVerion)</span><br><span class=\"line\">#################################################</span><br><span class=\"line\">diskType = driver.find_element_by_css_selector(&apos;div.selector-wrapper input&apos;).get_attribute(&apos;value&apos;)</span><br><span class=\"line\">if(diskType != u&apos;高效云盘&apos;):</span><br><span class=\"line\">\tTEST_PASS = False</span><br><span class=\"line\">\tprint u&quot;期望的系统盘类型是高效云盘，但实际选中是%s&quot; %(diskType)</span><br><span class=\"line\"></span><br><span class=\"line\">if(TEST_PASS):</span><br><span class=\"line\">\tprint &apos;SUCCESS 从官网跳到控制台dc2创建页，选中了对应的配置&apos;</span><br><span class=\"line\">else:</span><br><span class=\"line\">\tprint &apos;FAIL 从官网跳到控制台dc2创建页，未选中了对应的配置&apos;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">time.sleep(3)</span><br><span class=\"line\">driver.close()</span><br></pre></td></tr></table></figure>\n<p>如果有如下输出，则测试失败，需要我们手动进入对应页面查看默认选中项的情况。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(venv) ➜  ~ python test.py</span><br><span class=\"line\">Success our dashboard login</span><br><span class=\"line\">Opening our target page</span><br><span class=\"line\">期望的系统盘类型是高效云盘，但实际选中是普通云盘</span><br><span class=\"line\">FAIL 从官网跳到控制台dc2创建页，未选中了对应的配置</span><br><span class=\"line\">(venv) ➜  ~</span><br></pre></td></tr></table></figure>\n<p>如果有如下输出，则通过测试。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(venv) ➜  ~ python test.py</span><br><span class=\"line\">Success our dashboard login</span><br><span class=\"line\">Opening our target page</span><br><span class=\"line\">Opened the dc2 add page</span><br><span class=\"line\">SUCCESS 从官网跳到控制台dc2创建页，选中了对应的配置</span><br><span class=\"line\">(venv) ➜  ~</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"后记\"><a href=\"#后记\" class=\"headerlink\" title=\"后记\"></a>后记</h3><p>我们知道，selenium是一个很优秀的web框架，提供了很丰富的API，使用它结合进行做web的自动化测试真的很完美，但是在实际的情况中，理想与现实总是存在那么一点距离，这点距离主要是难维护，难维护的最核心是页面元素经常改变，测试过程中数据很多，不知道怎么进行维护，页面元素确实经常改变，很难改变，另外一个就是数据问题，比如我们验证N个表单在不同输入情况下的提示信息，会有不同的提示信息，都得需要验证。</p>\n<p>本文只是一个菜鸡前端为减少重复劳动而对自动化测试所做的一个探索，专业的自动化测试肯定会封装的更加\b易用，可读，可维护。断言，日志都会用更加专业的框架。\b</p>\n<p>期待自动化测试可以为滴滴云的稳定性\b出一份力。</p>\n<p>参考链接：</p>\n<p>Selenium官网：<a href=\"https://www.seleniumhq.org\" target=\"_blank\" rel=\"noopener\">https://www.seleniumhq.org</a></p>\n"}],"PostAsset":[],"PostCategory":[{"post_id":"ckrix8zdq000lk1jflmbr9xfd","category_id":"ckrix8zds000pk1jf2ftye6on","_id":"ckrix8zdx0010k1jfs9msg0ys"}],"PostTag":[{"post_id":"ckrix8zdf0007k1jfmaj7lfai","tag_id":"ckrix8zdb0004k1jf4rkjn58f","_id":"ckrix8zdj000bk1jfz445fw3f"},{"post_id":"ckrix8zd10000k1jfj1fxpc6r","tag_id":"ckrix8zdb0004k1jf4rkjn58f","_id":"ckrix8zdm000dk1jfy3v4ybz1"},{"post_id":"ckrix8zdc0005k1jf2c3ytiva","tag_id":"ckrix8zdb0004k1jf4rkjn58f","_id":"ckrix8zdo000gk1jfwcvjoej3"},{"post_id":"ckrix8zdm000ek1jfvexyi5gx","tag_id":"ckrix8zdb0004k1jf4rkjn58f","_id":"ckrix8zdp000ik1jf86e7j4wl"},{"post_id":"ckrix8zdg0009k1jfj2bwme1k","tag_id":"ckrix8zdn000fk1jfsrf6ymkv","_id":"ckrix8zdr000mk1jf7mldipn5"},{"post_id":"ckrix8zdk000ck1jfityp9138","tag_id":"ckrix8zdn000fk1jfsrf6ymkv","_id":"ckrix8zdt000rk1jfh5mwgfhs"},{"post_id":"ckrix8zds000qk1jfmrl0mngn","tag_id":"ckrix8zdb0004k1jf4rkjn58f","_id":"ckrix8zdu000uk1jfg80wn2jb"},{"post_id":"ckrix8zdo000hk1jf0ej3hhdh","tag_id":"ckrix8zds000ok1jf0o6w53bw","_id":"ckrix8zdv000wk1jfk67w96g3"},{"post_id":"ckrix8zdw000zk1jf02ey28wi","tag_id":"ckrix8zds000ok1jf0o6w53bw","_id":"ckrix8zdy0012k1jfha8fs6z9"},{"post_id":"ckrix8zdq000lk1jflmbr9xfd","tag_id":"ckrix8zdu000tk1jf2nrojmzc","_id":"ckrix8zdz0015k1jf4rinlalw"},{"post_id":"ckrix8zdq000lk1jflmbr9xfd","tag_id":"ckrix8zdw000yk1jft494jf28","_id":"ckrix8ze00017k1jfbhro1z5e"},{"post_id":"ckrix8zdt000sk1jfiv7584ly","tag_id":"ckrix8zdz0014k1jf1bhiiy04","_id":"ckrix8ze00019k1jfhy52vkyp"},{"post_id":"ckrix8zdv000xk1jfbzqmgqu2","tag_id":"ckrix8ze00018k1jfkqdsc66m","_id":"ckrix8ze1001bk1jfikrv2wmh"},{"post_id":"ckrix8zdy0013k1jf386kpyq1","tag_id":"ckrix8ze0001ak1jf76ndfc84","_id":"ckrix8ze1001ck1jfl7p81706"},{"post_id":"ckrix8zf3001gk1jfe0i1afb2","tag_id":"ckrix8zds000ok1jf0o6w53bw","_id":"ckrix8zf4001ik1jf9pmuyt0q"},{"post_id":"ckrix8zew001dk1jfszgfktgw","tag_id":"ckrix8zf2001fk1jf9dk3gzii","_id":"ckrix8zf5001kk1jfaa429srg"},{"post_id":"ckrix8zf4001hk1jf8hhn8677","tag_id":"ckrix8zf5001jk1jfn624wbep","_id":"ckrix8zf5001lk1jfjlhhdf46"}],"Tag":[{"name":"Bugfix","_id":"ckrix8zdb0004k1jf4rkjn58f"},{"name":"Hexo","_id":"ckrix8zdn000fk1jfsrf6ymkv"},{"name":"优化","_id":"ckrix8zds000ok1jf0o6w53bw"},{"name":"angular","_id":"ckrix8zdu000tk1jf2nrojmzc"},{"name":"component","_id":"ckrix8zdw000yk1jft494jf28"},{"name":"机器人","_id":"ckrix8zdz0014k1jf1bhiiy04"},{"name":"CSS","_id":"ckrix8ze00018k1jfkqdsc66m"},{"name":"nginx","_id":"ckrix8ze0001ak1jf76ndfc84"},{"name":"微前端 single-spa","_id":"ckrix8zf2001fk1jf9dk3gzii"},{"name":"自动化测试","_id":"ckrix8zf5001jk1jfn624wbep"}]}}